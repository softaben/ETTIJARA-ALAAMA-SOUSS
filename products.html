<!DOCTYPE html>
<html lang="fr" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETTIJARA ALAAMA SOUSS - Gestion des Produits</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --accent: #1565c0;
            --light: #e3f2fd;
            --bg: #f5f7fa;
            --text: #333333;
            --text-light: #666666;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --info: #0288d1;
            --purple: #7b1fa2;
            --cyan: #0097a7;
            --shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --primary: #3949ab;
            --secondary: #1565c0;
            --accent: #42a5f5;
            --light: #1e293b;
            --bg: #0f172a;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --card-bg: #1e293b;
            --border: #334155;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #ef5350;
            --info: #29b6f6;
            --purple: #ba68c8;
            --cyan: #26c6da;
            --shadow: 0 3px 15px rgba(0,0,0,0.3);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text);
            direction: rtl; 
            min-height: 100vh;
        }

        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 30px; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .logo i { 
            font-size: 28px; 
        }
        
        .logo h1 { 
            font-size: 22px; 
            font-weight: 700; 
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-item {
            padding: 8px 20px;
            border-radius: 6px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(30deg);
        }

        .theme-toggle .fa-sun {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .fa-sun {
            display: block;
        }

        [data-theme="dark"] .theme-toggle .fa-moon {
            display: none;
        }
        
        /* Main Content */
        .main-content { 
            padding: 90px 30px 30px; 
            min-height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-header h2 {
            font-size: 28px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-icon.products {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .stat-icon.low-stock {
            background: linear-gradient(135deg, var(--warning), #ff9800);
        }

        .stat-icon.value {
            background: linear-gradient(135deg, var(--success), #4caf50);
        }

        .stat-icon.categories {
            background: linear-gradient(135deg, var(--purple), #ba68c8);
        }

        .stat-info h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-info .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 5px;
        }

        .stat-info .details {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Products Section */
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h3 {
            font-size: 18px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            padding-right: 45px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .filter-select {
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            min-width: 150px;
        }

        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff9800);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 124, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #ef5350);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 83, 80, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #29b6f6);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(41, 182, 246, 0.3);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        th {
            background: var(--light);
            padding: 15px;
            border-bottom: 2px solid var(--border);
            text-align: center;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            color: var(--text);
            font-weight: 500;
            font-size: 14px;
        }
        
        tr:hover {
            background-color: var(--light);
        }

        /* Stock Status */
        .stock-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .stock-high {
            background-color: rgba(6, 95, 70, 0.1);
            color: #065f46;
        }
        
        .stock-medium {
            background-color: rgba(217, 119, 6, 0.1);
            color: #d97706;
        }
        
        .stock-low {
            background-color: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }
        
        .stock-out {
            background-color: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .edit-btn {
            background: var(--light);
            color: var(--primary);
        }

        .edit-btn:hover {
            background: var(--primary);
            color: white;
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        .stock-btn {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .stock-btn:hover {
            background: #22c55e;
            color: white;
        }

        /* Category Badge */
        .category-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: var(--light);
            color: var(--text);
            display: inline-block;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .loading i {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Stock Alert */
        .stock-alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert-warning .alert-icon {
            color: var(--warning);
        }

        .alert-danger .alert-icon {
            color: var(--danger);
        }

        .alert-content {
            flex: 1;
        }

        .alert-content h4 {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .alert-content p {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { 
                padding: 0 15px; 
                height: 60px;
            }
            
            .main-content { 
                padding: 80px 15px 15px; 
            }
            
            .logo h1 {
                font-size: 18px;
            }

            .nav {
                display: none;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: stretch;
            }

            .header-actions .btn {
                flex: 1;
            }

            .search-filter {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .filter-select {
                width: 100%;
            }

            .modal {
                max-height: 95vh;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 16px;
            }

            .page-header h2 {
                font-size: 22px;
            }

            .section {
                padding: 15px;
            }

            .modal-body {
                padding: 20px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Stock Movements */
        .movement-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .movement-in {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .movement-out {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 25px;
            border: none;
            background: none;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .action-card {
            flex: 1;
            min-width: 200px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }

        .action-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 20px;
            color: var(--primary);
            transition: all 0.3s;
        }

        .action-card:hover .action-icon {
            background: var(--primary);
            color: white;
        }

        .action-card h4 {
            font-size: 15px;
            margin-bottom: 8px;
            color: var(--text);
        }

        .action-card p {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Categories List */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--purple), #ba68c8);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            color: white;
        }

        .category-card h4 {
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--text);
        }

        .category-stats {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .category-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* Color Picker */
        .color-picker {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .color-option.selected {
            border-color: var(--text);
            transform: scale(1.1);
        }

        /* Color Classes for Categories */
        .color-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .color-success { background: linear-gradient(135deg, var(--success), #4caf50); }
        .color-warning { background: linear-gradient(135deg, var(--warning), #ff9800); }
        .color-danger { background: linear-gradient(135deg, var(--danger), #ef5350); }
        .color-info { background: linear-gradient(135deg, var(--info), #29b6f6); }
        .color-purple { background: linear-gradient(135deg, var(--purple), #ba68c8); }
        .color-cyan { background: linear-gradient(135deg, var(--cyan), #26c6da); }

        /* Product Count in Category */
        .product-count {
            display: inline-block;
            background: var(--light);
            color: var(--text);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <i class="fas fa-boxes"></i>
            <h1>ETTIJARA ALAAMA SOUSS - PRODUITS</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <nav class="nav">
                <a href="deliveries.html" class="nav-item">
                    <i class="fas fa-truck"></i>
                    Livraisons
                </a>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard
                </a>
                <a href="clients.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    Clients
                </a>
                <a href="products.html" class="nav-item active">
                    <i class="fas fa-boxes"></i>
                    Produits
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    Param√®tres
                </a>
            </nav>
            <button class="theme-toggle" id="themeToggle" title="Changer le th√®me">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
            <div id="connectionStatus" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;" title="Statut de connexion"></div>
        </div>
    </header>

    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h2>
                <i class="fas fa-boxes"></i>
                Gestion des Produits en Stock
            </h2>
            <div class="header-actions">
                <button class="btn btn-success" id="openAddProductModal">
                    <i class="fas fa-plus"></i>
                    Nouveau Produit
                </button>
                <button class="btn btn-primary" id="openStockInModal">
                    <i class="fas fa-arrow-down"></i>
                    Entr√©e Stock
                </button>
                <button class="btn btn-info" id="openCategoriesModal">
                    <i class="fas fa-tags"></i>
                    Cat√©gories
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon products">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Produits</h3>
                    <div class="value" id="totalProducts">0</div>
                    <div class="details" id="productsDetails">0 actifs</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon low-stock">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-info">
                    <h3>Stock Bas</h3>
                    <div class="value" id="lowStockCount">0</div>
                    <div class="details" id="lowStockDetails">Produits √† r√©approvisionner</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon value">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3>Valeur Stock</h3>
                    <div class="value" id="stockValue">0 DH</div>
                    <div class="details" id="stockValueDetails">Valeur totale</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon categories">
                    <i class="fas fa-tags"></i>
                </div>
                <div class="stat-info">
                    <h3>Cat√©gories</h3>
                    <div class="value" id="categoriesCount">0</div>
                    <div class="details" id="categoriesDetails">Cat√©gories actives</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('products-tab')">
                <i class="fas fa-box"></i>
                Produits
            </button>
            <button class="tab" onclick="switchTab('movements-tab')">
                <i class="fas fa-exchange-alt"></i>
                Mouvements
            </button>
            <button class="tab" onclick="switchTab('alerts-tab')">
                <i class="fas fa-bell"></i>
                Alertes
            </button>
            <button class="tab" onclick="switchTab('categories-tab')">
                <i class="fas fa-tags"></i>
                Cat√©gories
            </button>
        </div>

        <!-- Products Tab -->
        <div class="tab-content active" id="products-tab">
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card" onclick="openAddProductModal()">
                    <div class="action-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h4>Ajouter Produit</h4>
                    <p>Ajouter un nouveau produit au catalogue</p>
                </div>
                
                <div class="action-card" onclick="openStockInModal()">
                    <div class="action-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <h4>Entr√©e Stock</h4>
                    <p>Enregistrer une nouvelle entr√©e en stock</p>
                </div>
                
                <div class="action-card" onclick="exportProducts()">
                    <div class="action-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h4>Exporter</h4>
                    <p>Exporter la liste des produits</p>
                </div>
                
                <div class="action-card" onclick="refreshProducts()">
                    <div class="action-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h4>Actualiser</h4>
                    <p>Mettre √† jour la liste</p>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="section">
                <div class="search-filter">
                    <div class="search-box">
                        <input type="text" id="productSearch" class="search-input" placeholder="Rechercher un produit...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <select id="categoryFilter" class="filter-select">
                        <option value="">Toutes cat√©gories</option>
                    </select>
                    <select id="stockFilter" class="filter-select">
                        <option value="">Tous les stocks</option>
                        <option value="high">Stock √âlev√©</option>
                        <option value="medium">Stock Moyen</option>
                        <option value="low">Stock Bas</option>
                        <option value="out">Rupture</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchProducts()">
                        <i class="fas fa-search"></i>
                        Rechercher
                    </button>
                </div>
            </div>

            <!-- Products List -->
            <div class="section">
                <div class="section-header">
                    <h3><i class="fas fa-list"></i> Liste des Produits</h3>
                    <div id="productsCount">0 produits trouv√©s</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Cat√©gorie</th>
                                <th>Prix (DH)</th>
                                <th>Stock</th>
                                <th>Stock Min</th>
                                <th>Valeur</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Chargement des produits...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Movements Tab -->
        <div class="tab-content" id="movements-tab">
            <div class="section">
                <div class="section-header">
                    <h3><i class="fas fa-exchange-alt"></i> Historique des Mouvements</h3>
                    <div class="search-filter">
                        <select id="movementTypeFilter" class="filter-select">
                            <option value="">Tous types</option>
                            <option value="in">Entr√©es</option>
                            <option value="out">Sorties</option>
                        </select>
                        <input type="date" id="movementDateFilter" class="filter-select">
                        <button class="btn btn-primary btn-small" onclick="filterMovements()">
                            <i class="fas fa-filter"></i>
                            Filtrer
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Type</th>
                                <th>Quantit√©</th>
                                <th>Prix Unitaire</th>
                                <th>Total</th>
                                <th>R√©f√©rence</th>
                                <th>Utilisateur</th>
                            </tr>
                        </thead>
                        <tbody id="movementsTable">
                            <tr>
                                <td colspan="8" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Chargement des mouvements...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div class="tab-content" id="alerts-tab">
            <div class="section">
                <div class="section-header">
                    <h3><i class="fas fa-bell"></i> Alertes Stock</h3>
                    <button class="btn btn-warning" onclick="checkStockAlerts()">
                        <i class="fas fa-sync-alt"></i>
                        V√©rifier Alertes
                    </button>
                </div>
                
                <div id="alertsContainer">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement des alertes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-content" id="categories-tab">
            <!-- Quick Actions for Categories -->
            <div class="quick-actions">
                <div class="action-card" onclick="openAddCategoryModal()">
                    <div class="action-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h4>Nouvelle Cat√©gorie</h4>
                    <p>Cr√©er une nouvelle cat√©gorie</p>
                </div>
                
                <div class="action-card" onclick="reorderCategories()">
                    <div class="action-icon">
                        <i class="fas fa-sort-alpha-down"></i>
                    </div>
                    <h4>Trier</h4>
                    <p>Trier les cat√©gories par nom</p>
                </div>
                
                <div class="action-card" onclick="exportCategories()">
                    <div class="action-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h4>Exporter</h4>
                    <p>Exporter la liste des cat√©gories</p>
                </div>
                
                <div class="action-card" onclick="refreshCategories()">
                    <div class="action-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <h4>Actualiser</h4>
                    <p>Actualiser les cat√©gories</p>
                </div>
            </div>

            <!-- Categories Grid -->
            <div class="section">
                <div class="section-header">
                    <h3><i class="fas fa-tags"></i> Toutes les Cat√©gories</h3>
                    <div id="categoriesCountDisplay">0 cat√©gories</div>
                </div>
                
                <div id="categoriesContainer">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement des cat√©gories...</p>
                    </div>
                </div>
            </div>

            <!-- Uncategorized Products -->
            <div class="section">
                <div class="section-header">
                    <h3><i class="fas fa-question-circle"></i> Produits Sans Cat√©gorie</h3>
                    <div id="uncategorizedCount">0 produits</div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Stock</th>
                                <th>Prix (DH)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="uncategorizedTable">
                            <tr>
                                <td colspan="4" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Chargement des produits sans cat√©gorie...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal pour Ajouter/Modifier Produit -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-box"></i> <span id="modalTitle">Nouveau Produit</span></h3>
                <button class="close-modal" onclick="closeProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">Nom du Produit *</label>
                            <input type="text" id="productName" class="form-control" required placeholder="Ex: Ciment 50kg">
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Cat√©gorie *</label>
                            <select id="productCategory" class="form-control" required>
                                <option value="">S√©lectionner une cat√©gorie</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productPrice">Prix de Vente (DH) *</label>
                            <input type="number" id="productPrice" class="form-control" required step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="productCost">Prix d'Achat (DH)</label>
                            <input type="number" id="productCost" class="form-control" step="0.01" min="0" placeholder="Prix d'achat">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productStock">Stock Initial</label>
                            <input type="number" id="productStock" class="form-control" min="0" value="0" placeholder="Quantit√© en stock">
                        </div>
                        <div class="form-group">
                            <label for="productMinStock">Stock Minimum *</label>
                            <input type="number" id="productMinStock" class="form-control" required min="0" value="10" placeholder="Alerte √† partir de">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="productUnit">Unit√© de Mesure</label>
                        <select id="productUnit" class="form-control">
                            <option value="unit">Unit√©</option>
                            <option value="kg">Kilogramme</option>
                            <option value="g">Gramme</option>
                            <option value="L">Litre</option>
                            <option value="m">M√®tre</option>
                            <option value="m2">M√®tre Carr√©</option>
                            <option value="m3">M√®tre Cube</option>
                            <option value="sac">Sac</option>
                            <option value="carton">Carton</option>
                            <option value="palette">Palette</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" class="form-control" rows="3" placeholder="Description du produit..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeProductModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitProductBtn">
                            <i class="fas fa-save"></i>
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pour Ajouter/Modifier Cat√©gorie -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-tag"></i> <span id="categoryModalTitle">Nouvelle Cat√©gorie</span></h3>
                <button class="close-modal" onclick="closeCategoryModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <input type="hidden" id="categoryOldName">
                    
                    <div class="form-group">
                        <label for="categoryName">Nom de la Cat√©gorie *</label>
                        <input type="text" id="categoryName" class="form-control" required placeholder="Ex: Mat√©riaux de Construction">
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryDescription">Description</label>
                        <textarea id="categoryDescription" class="form-control" rows="3" placeholder="Description de la cat√©gorie..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Couleur de la Cat√©gorie</label>
                        <div class="color-picker">
                            <div class="color-option color-primary selected" data-color="primary" onclick="selectColor('primary')"></div>
                            <div class="color-option color-success" data-color="success" onclick="selectColor('success')"></div>
                            <div class="color-option color-warning" data-color="warning" onclick="selectColor('warning')"></div>
                            <div class="color-option color-danger" data-color="danger" onclick="selectColor('danger')"></div>
                            <div class="color-option color-info" data-color="info" onclick="selectColor('info')"></div>
                            <div class="color-option color-purple" data-color="purple" onclick="selectColor('purple')"></div>
                            <div class="color-option color-cyan" data-color="cyan" onclick="selectColor('cyan')"></div>
                        </div>
                        <input type="hidden" id="categoryColor" value="primary">
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryIcon">Ic√¥ne</label>
                        <select id="categoryIcon" class="form-control">
                            <option value="fas fa-box">üì¶ Bo√Æte</option>
                            <option value="fas fa-toolbox">üß∞ Outils</option>
                            <option value="fas fa-paint-roller">üé® Peinture</option>
                            <option value="fas fa-bolt">‚ö° √âlectricit√©</option>
                            <option value="fas fa-tint">üíß Plomberie</option>
                            <option value="fas fa-home">üè† Maison</option>
                            <option value="fas fa-cube">üßä Cube</option>
                            <option value="fas fa-weight-hanging">‚öñÔ∏è Poids</option>
                            <option value="fas fa-ruler">üìè R√®gle</option>
                            <option value="fas fa-industry">üè≠ Industrie</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pour Entr√©e Stock -->
    <div class="modal-overlay" id="stockInModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-arrow-down"></i> Entr√©e en Stock</h3>
                <button class="close-modal" onclick="closeStockInModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="stockInForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockInProduct">Produit *</label>
                            <select id="stockInProduct" class="form-control" required onchange="updateStockInProduct()">
                                <option value="">S√©lectionner un produit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="stockInDate">Date *</label>
                            <input type="datetime-local" id="stockInDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockInQuantity">Quantit√© *</label>
                            <input type="number" id="stockInQuantity" class="form-control" required min="1" value="1" placeholder="Quantit√© √† ajouter">
                        </div>
                        <div class="form-group">
                            <label for="stockInUnitPrice">Prix Unitaire d'Achat (DH) *</label>
                            <input type="number" id="stockInUnitPrice" class="form-control" required step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockInSupplier">Fournisseur</label>
                            <input type="text" id="stockInSupplier" class="form-control" placeholder="Nom du fournisseur">
                        </div>
                        <div class="form-group">
                            <label for="stockInReference">R√©f√©rence</label>
                            <input type="text" id="stockInReference" class="form-control" placeholder="N¬∞ Facture / Bon">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stockInNotes">Notes</label>
                        <textarea id="stockInNotes" class="form-control" rows="3" placeholder="Notes suppl√©mentaires..."></textarea>
                    </div>
                    
                    <div style="padding: 15px; background: var(--light); border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">Stock actuel:</div>
                                <div id="currentStockDisplay" style="font-weight: 600; font-size: 16px;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">Nouveau stock:</div>
                                <div id="newStockDisplay" style="font-weight: 600; font-size: 16px; color: var(--success);">--</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">Total:</div>
                                <div id="stockInTotal" style="font-weight: 600; font-size: 16px; color: var(--primary);">0.00 DH</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeStockInModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i>
                            Enregistrer l'Entr√©e
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pour Sortie Stock -->
    <div class="modal-overlay" id="stockOutModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-arrow-up"></i> Sortie de Stock</h3>
                <button class="close-modal" onclick="closeStockOutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="stockOutForm">
                    <input type="hidden" id="stockOutProductId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockOutProductName">Produit *</label>
                            <input type="text" id="stockOutProductName" class="form-control" readonly>
                        </div>
                        <div class="form-group">
                            <label for="stockOutDate">Date *</label>
                            <input type="datetime-local" id="stockOutDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockOutQuantity">Quantit√© *</label>
                            <input type="number" id="stockOutQuantity" class="form-control" required min="1" value="1" 
                                   placeholder="Quantit√© √† retirer" oninput="updateStockOutCalculations()">
                        </div>
                        <div class="form-group">
                            <label for="stockOutReason">Raison *</label>
                            <select id="stockOutReason" class="form-control" required>
                                <option value="sale">Vente</option>
                                <option value="transfer">Transfert</option>
                                <option value="damage">D√©t√©rioration</option>
                                <option value="return">Retour fournisseur</option>
                                <option value="adjustment">Ajustement</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="stockOutReference">R√©f√©rence</label>
                            <input type="text" id="stockOutReference" class="form-control" placeholder="N¬∞ Bon / Client">
                        </div>
                        <div class="form-group">
                            <label for="stockOutPrice">Prix de Vente (DH)</label>
                            <input type="number" id="stockOutPrice" class="form-control" step="0.01" min="0" 
                                   placeholder="Prix unitaire" oninput="updateStockOutCalculations()">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stockOutNotes">Notes</label>
                        <textarea id="stockOutNotes" class="form-control" rows="3" placeholder="Notes suppl√©mentaires..."></textarea>
                    </div>
                    
                    <div style="padding: 15px; background: var(--light); border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">Stock actuel:</div>
                                <div id="stockOutCurrentStock" style="font-weight: 600; font-size: 16px;">--</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">Nouveau stock:</div>
                                <div id="stockOutNewStock" style="font-weight: 600; font-size: 16px; color: var(--danger);">--</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-light);">Total:</div>
                                <div id="stockOutTotal" style="font-weight: 600; font-size: 16px; color: var(--primary);">0.00 DH</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeStockOutModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-check"></i>
                            Enregistrer la Sortie
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmation pour Suppression -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirmation</h3>
                <button class="close-modal" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="confirmMessage" style="text-align: center; margin-bottom: 30px;">
                    √ätes-vous s√ªr de vouloir effectuer cette action ?
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">
                        Annuler
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">
                        <i class="fas fa-check"></i>
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAV_c5Gt_f1h5nZF47FcPjW_h4P24LYADk",
            authDomain: "commerce22-610cc.firebaseapp.com",
            databaseURL: "https://commerce22-610cc-default-rtdb.firebaseio.com",
            projectId: "commerce22-610cc",
            storageBucket: "commerce22-610cc.firebasestorage.app",
            messagingSenderId: "458158894252",
            appId: "1:458158894252:web:d1e640b2e16ef32d978309"
        };
        
        // ==================== VARIABLES GLOBALES ====================
        let database = null;
        let isConnected = false;
        let isDemoMode = false;
        let products = [];
        let categories = [];
        let stockMovements = [];
        let currentProduct = null;
        let currentCategory = null;
        let confirmAction = null;
        let confirmData = null;
        
        // R√©f√©rences pour d√©tacher les √©couteurs Firebase
        let firebaseListeners = [];
        
        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Page Produits en cours de d√©marrage...");
            
            // Initialiser le th√®me
            initTheme();
            
            // Initialiser Firebase
            initializeFirebase();
            
            // Initialiser les modals
            initModals();
            
            // Initialiser les formulaires
            initForms();
            
            // Initialiser les √©v√©nements
            initEvents();
            
            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    openAddProductModal();
                }
                
                if (e.ctrlKey && e.key === 'i') {
                    e.preventDefault();
                    openStockInModal();
                }
                
                if (e.ctrlKey && e.key === 'c') {
                    e.preventDefault();
                    openAddCategoryModal();
                }
                
                if (e.key === 'Escape') {
                    closeAllModals();
                }
                
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('productSearch').focus();
                }
                
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshProducts();
                }
            });
            
            // Ajouter un bouton de debug (optionnel)
            addDebugButton();
        });
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }
        
        function initModals() {
            // Modal Produit
            const productModal = document.getElementById('productModal');
            productModal.addEventListener('click', function(e) {
                if (e.target === productModal) closeProductModal();
            });
            
            // Modal Cat√©gorie
            const categoryModal = document.getElementById('categoryModal');
            categoryModal.addEventListener('click', function(e) {
                if (e.target === categoryModal) closeCategoryModal();
            });
            
            // Modal Entr√©e Stock
            const stockInModal = document.getElementById('stockInModal');
            stockInModal.addEventListener('click', function(e) {
                if (e.target === stockInModal) closeStockInModal();
            });
            
            // Modal Sortie Stock
            const stockOutModal = document.getElementById('stockOutModal');
            stockOutModal.addEventListener('click', function(e) {
                if (e.target === stockOutModal) closeStockOutModal();
            });
            
            // Modal Confirmation
            const confirmModal = document.getElementById('confirmModal');
            confirmModal.addEventListener('click', function(e) {
                if (e.target === confirmModal) closeConfirmModal();
            });
        }
        
        function initForms() {
            // Formulaire Produit
            document.getElementById('productForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveProduct();
            });
            
            // Formulaire Cat√©gorie
            document.getElementById('categoryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCategory();
            });
            
            // Formulaire Entr√©e Stock
            document.getElementById('stockInForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveStockIn();
            });
            
            // Formulaire Sortie Stock
            document.getElementById('stockOutForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveStockOut();
            });
            
            // Calculs Entr√©e Stock
            document.getElementById('stockInQuantity').addEventListener('input', updateStockInCalculations);
            document.getElementById('stockInUnitPrice').addEventListener('input', updateStockInCalculations);
            
            // Date par d√©faut
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('stockInDate').value = localDateTime;
            document.getElementById('stockOutDate').value = localDateTime;
        }
        
        function initEvents() {
            // Recherche avec Entr√©e
            document.getElementById('productSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchProducts();
            });
            
            // Boutons d'ouverture modals
            document.getElementById('openAddProductModal').addEventListener('click', openAddProductModal);
            document.getElementById('openStockInModal').addEventListener('click', openStockInModal);
            document.getElementById('openCategoriesModal').addEventListener('click', function() {
                switchTab('categories-tab');
            });
            
            // Filtres
            document.getElementById('categoryFilter').addEventListener('change', searchProducts);
            document.getElementById('stockFilter').addEventListener('change', searchProducts);
        }
        
        function addDebugButton() {
            const debugButton = document.createElement('button');
            debugButton.innerHTML = '<i class="fas fa-bug"></i> Debug';
            debugButton.className = 'btn btn-warning btn-small';
            debugButton.style.position = 'fixed';
            debugButton.style.bottom = '20px';
            debugButton.style.left = '20px';
            debugButton.style.zIndex = '1000';
            debugButton.style.display = 'none'; // Cach√© par d√©faut
            debugButton.onclick = function() {
                console.log('=== DEBUG INFORMATION ===');
                console.log('isConnected:', isConnected);
                console.log('isDemoMode:', isDemoMode);
                console.log('database:', database ? 'Connected' : 'Not connected');
                console.log('Products count:', products.length);
                console.log('Categories count:', categories.length);
                console.log('Movements count:', stockMovements.length);
                console.log('Firebase listeners:', firebaseListeners.length);
                console.log('=========================');
                
                // Tester la connexion Firebase
                if (database) {
                    console.log('Testing Firebase connection...');
                    database.ref('.info/connected').once('value')
                        .then(snapshot => {
                            console.log('Firebase connection test:', snapshot.val() ? 'Connected' : 'Disconnected');
                        })
                        .catch(error => {
                            console.error('Firebase test error:', error);
                        });
                }
                
                // Forcer le chargement des mouvements
                console.log('Forcing movements reload...');
                loadStockMovements();
            };
            document.body.appendChild(debugButton);
            
            // Afficher le bouton debug seulement en mode d√©veloppement
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                debugButton.style.display = 'block';
            }
        }
        
        function closeAllModals() {
            closeProductModal();
            closeCategoryModal();
            closeStockInModal();
            closeStockOutModal();
            closeConfirmModal();
        }
        
        // ==================== GESTION DES MODALS ====================
        function openAddProductModal(product = null) {
            currentProduct = product;
            const modal = document.getElementById('productModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('productForm');
            
            if (product) {
                title.textContent = 'Modifier Produit';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productPrice').value = product.price || 0;
                document.getElementById('productCost').value = product.cost || 0;
                document.getElementById('productStock').value = product.stock || 0;
                document.getElementById('productMinStock').value = product.minStock || 10;
                document.getElementById('productUnit').value = product.unit || 'unit';
                document.getElementById('productDescription').value = product.description || '';
                
                // S√©lectionner la cat√©gorie
                setTimeout(() => {
                    if (product.category) {
                        document.getElementById('productCategory').value = product.category;
                    }
                }, 100);
            } else {
                title.textContent = 'Nouveau Produit';
                form.reset();
                document.getElementById('productId').value = '';
                document.getElementById('productStock').value = 0;
                document.getElementById('productMinStock').value = 10;
                document.getElementById('productUnit').value = 'unit';
            }
            
            // Charger les cat√©gories dans le select
            loadCategoriesForSelect();
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function openAddCategoryModal(category = null) {
            currentCategory = category;
            const modal = document.getElementById('categoryModal');
            const title = document.getElementById('categoryModalTitle');
            const form = document.getElementById('categoryForm');
            
            if (category) {
                title.textContent = 'Modifier Cat√©gorie';
                document.getElementById('categoryId').value = category.id || '';
                document.getElementById('categoryOldName').value = category.name || '';
                document.getElementById('categoryName').value = category.name || '';
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryColor').value = category.color || 'primary';
                document.getElementById('categoryIcon').value = category.icon || 'fas fa-box';
                
                // S√©lectionner la couleur
                selectColor(category.color || 'primary');
            } else {
                title.textContent = 'Nouvelle Cat√©gorie';
                form.reset();
                document.getElementById('categoryId').value = '';
                document.getElementById('categoryOldName').value = '';
                document.getElementById('categoryColor').value = 'primary';
                document.getElementById('categoryIcon').value = 'fas fa-box';
                
                // R√©initialiser la couleur
                selectColor('primary');
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function openStockInModal() {
            const modal = document.getElementById('stockInModal');
            const form = document.getElementById('stockInForm');
            form.reset();
            
            // Date actuelle
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('stockInDate').value = localDateTime;
            
            // Charger la liste des produits
            loadProductsForStockIn();
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeStockInModal() {
            document.getElementById('stockInModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function openStockOutModal(product) {
            currentProduct = product;
            const modal = document.getElementById('stockOutModal');
            const form = document.getElementById('stockOutForm');
            form.reset();
            
            // Remplir les informations du produit
            document.getElementById('stockOutProductId').value = product.id;
            document.getElementById('stockOutProductName').value = product.name;
            document.getElementById('stockOutPrice').value = product.price || 0;
            document.getElementById('stockOutCurrentStock').textContent = `${product.stock || 0} ${product.unit || 'unit√©'}`;
            document.getElementById('stockOutNewStock').textContent = `${product.stock || 0} ${product.unit || 'unit√©'}`;
            
            // Date actuelle
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('stockOutDate').value = localDateTime;
            
            // Mettre √† jour les calculs
            updateStockOutCalculations();
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeStockOutModal() {
            document.getElementById('stockOutModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function openConfirmModal(message, action, data = null) {
            confirmAction = action;
            confirmData = data;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            confirmAction = null;
            confirmData = null;
        }
        
        // ==================== FONCTIONS UTILITAIRES ====================
        function showToast(message, type = "success") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 30px;
                padding: 15px 25px;
                border-radius: 8px;
                background: var(--card-bg);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 3000;
                animation: slideIn 0.3s ease;
                border-left: 4px solid;
                border-left-color: ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--danger)'};
                color: var(--text);
            `;
            
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusElement.style.background = "#10b981";
                statusElement.title = "Connect√© √† Firebase";
            } else {
                statusElement.style.background = "#ef4444";
                statusElement.title = "Non connect√©";
            }
        }
        
        function switchTab(tabId) {
            // Mettre √† jour les onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet s√©lectionn√©
            const tabElement = document.querySelector(`.tab[onclick*="${tabId}"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            document.getElementById(tabId).classList.add('active');
            
            // Charger les donn√©es si n√©cessaire
            if (tabId === 'movements-tab' && stockMovements.length === 0) {
                loadStockMovements();
            } else if (tabId === 'alerts-tab') {
                checkStockAlerts();
            } else if (tabId === 'categories-tab') {
                displayCategories();
                displayUncategorizedProducts();
            }
        }
        
        function selectColor(color) {
            // Retirer la classe selected de toutes les couleurs
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Ajouter la classe selected √† la couleur choisie
            const selectedOption = document.querySelector(`.color-option[data-color="${color}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // Mettre √† jour la valeur cach√©e
            document.getElementById('categoryColor').value = color;
        }
        
        // ==================== GESTION DES PRODUITS ====================
        function loadProductsForStockIn() {
            const select = document.getElementById('stockInProduct');
            select.innerHTML = '<option value="">S√©lectionner un produit</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (Stock: ${product.stock || 0} ${product.unit || 'unit√©'})`;
                option.dataset.price = product.cost || product.price || 0;
                option.dataset.stock = product.stock || 0;
                option.dataset.unit = product.unit || 'unit√©';
                select.appendChild(option);
            });
        }
        
        function updateStockInProduct() {
            const select = document.getElementById('stockInProduct');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                // Mettre le prix d'achat par d√©faut
                document.getElementById('stockInUnitPrice').value = selectedOption.dataset.price || 0;
                
                // Afficher le stock actuel
                const currentStock = selectedOption.dataset.stock || 0;
                const unit = selectedOption.dataset.unit || 'unit√©';
                document.getElementById('currentStockDisplay').textContent = `${currentStock} ${unit}`;
                
                // Mettre √† jour les calculs
                updateStockInCalculations();
            } else {
                document.getElementById('currentStockDisplay').textContent = '--';
                document.getElementById('newStockDisplay').textContent = '--';
                document.getElementById('stockInTotal').textContent = '0.00 DH';
            }
        }
        
        function updateStockInCalculations() {
            const quantity = parseFloat(document.getElementById('stockInQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('stockInUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            
            // Mettre √† jour le total
            document.getElementById('stockInTotal').textContent = total.toFixed(2) + ' DH';
            
            // Mettre √† jour le nouveau stock
            const select = document.getElementById('stockInProduct');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const currentStock = parseFloat(selectedOption.dataset.stock) || 0;
                const newStock = currentStock + quantity;
                const unit = selectedOption.dataset.unit || 'unit√©';
                document.getElementById('newStockDisplay').textContent = `${newStock} ${unit}`;
            }
        }
        
        function updateStockOutCalculations() {
            const quantity = parseFloat(document.getElementById('stockOutQuantity').value) || 0;
            const price = parseFloat(document.getElementById('stockOutPrice').value) || 0;
            const total = quantity * price;
            
            // Mettre √† jour le total
            document.getElementById('stockOutTotal').textContent = total.toFixed(2) + ' DH';
            
            // Mettre √† jour le nouveau stock
            if (currentProduct) {
                const currentStock = currentProduct.stock || 0;
                const newStock = currentStock - quantity;
                const unit = currentProduct.unit || 'unit√©';
                document.getElementById('stockOutNewStock').textContent = `${newStock} ${unit}`;
                
                // Changer la couleur si stock n√©gatif
                if (newStock < 0) {
                    document.getElementById('stockOutNewStock').style.color = 'var(--danger)';
                } else {
                    document.getElementById('stockOutNewStock').style.color = 'var(--danger)';
                }
            }
        }
        
        function loadCategoriesForSelect() {
            const categorySelect = document.getElementById('productCategory');
            const currentValue = categorySelect.value;
            categorySelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie</option>';
            
            // Ajouter les cat√©gories existantes
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            
            // Restaurer la valeur s√©lectionn√©e
            categorySelect.value = currentValue;
        }
        
        function saveProduct() {
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value) || 0,
                cost: parseFloat(document.getElementById('productCost').value) || 0,
                stock: parseFloat(document.getElementById('productStock').value) || 0,
                minStock: parseFloat(document.getElementById('productMinStock').value) || 10,
                unit: document.getElementById('productUnit').value,
                description: document.getElementById('productDescription').value,
                updatedAt: new Date().toISOString()
            };
            
            if (!productData.name || !productData.category) {
                showToast("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            if (productId) {
                // Mise √† jour du produit existant
                updateProduct(productId, productData);
            } else {
                // Nouveau produit
                productData.createdAt = new Date().toISOString();
                productData.active = true;
                addProduct(productData);
            }
        }
        
        function saveCategory() {
            const categoryId = document.getElementById('categoryId').value;
            const oldName = document.getElementById('categoryOldName').value;
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value,
                color: document.getElementById('categoryColor').value,
                icon: document.getElementById('categoryIcon').value,
                updatedAt: new Date().toISOString()
            };
            
            if (!categoryData.name) {
                showToast("Veuillez entrer un nom de cat√©gorie", "error");
                return;
            }
            
            // V√©rifier si le nom existe d√©j√† (sauf pour la cat√©gorie en cours de modification)
            const existingCategory = categories.find(c => 
                c.name.toLowerCase() === categoryData.name.toLowerCase() && 
                (!categoryId || c.id !== categoryId)
            );
            
            if (existingCategory) {
                showToast("Une cat√©gorie avec ce nom existe d√©j√†", "error");
                return;
            }
            
            if (categoryId) {
                // Mise √† jour de la cat√©gorie existante
                updateCategory(categoryId, categoryData, oldName);
            } else {
                // Nouvelle cat√©gorie
                categoryData.createdAt = new Date().toISOString();
                categoryData.productCount = 0;
                addCategory(categoryData);
            }
        }
        
        function saveStockIn() {
            const productId = document.getElementById('stockInProduct').value;
            const quantity = parseFloat(document.getElementById('stockInQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('stockInUnitPrice').value) || 0;
            
            if (!productId || quantity <= 0 || unitPrice <= 0) {
                showToast("Veuillez remplir tous les champs correctement", "error");
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showToast("Produit non trouv√©", "error");
                return;
            }
            
            const stockInData = {
                productId: productId,
                productName: product.name,
                type: 'in',
                quantity: quantity,
                unitPrice: unitPrice,
                total: quantity * unitPrice,
                date: document.getElementById('stockInDate').value,
                supplier: document.getElementById('stockInSupplier').value,
                reference: document.getElementById('stockInReference').value,
                notes: document.getElementById('stockInNotes').value,
                createdAt: new Date().toISOString(),
                user: 'Administrateur'
            };
            
            // Mettre √† jour le stock du produit
            const newStock = (product.stock || 0) + quantity;
            
            if (isDemoMode) {
                // Mode d√©mo
                product.stock = newStock;
                
                // Ajouter le mouvement
                stockInData.id = 'demo-' + Date.now();
                stockMovements.unshift(stockInData);
                
                showToast("Entr√©e en stock enregistr√©e (mode d√©mo)", "success");
                closeStockInModal();
                updateDashboard();
                displayProducts(products);
                loadStockMovements();
            } else {
                // Mode Firebase
                saveStockMovementToFirebase(stockInData, productId, newStock);
            }
        }
        
        function saveStockOut() {
            if (!currentProduct) {
                showToast("Produit non s√©lectionn√©", "error");
                return;
            }
            
            const quantity = parseFloat(document.getElementById('stockOutQuantity').value) || 0;
            const price = parseFloat(document.getElementById('stockOutPrice').value) || 0;
            const reason = document.getElementById('stockOutReason').value;
            
            if (quantity <= 0) {
                showToast("Veuillez entrer une quantit√© valide", "error");
                return;
            }
            
            if (quantity > currentProduct.stock) {
                showToast(`Stock insuffisant! Stock disponible: ${currentProduct.stock}`, "error");
                return;
            }
            
            const stockOutData = {
                productId: currentProduct.id,
                productName: currentProduct.name,
                type: 'out',
                quantity: quantity,
                unitPrice: price,
                total: quantity * price,
                date: document.getElementById('stockOutDate').value,
                reason: reason,
                reference: document.getElementById('stockOutReference').value,
                notes: document.getElementById('stockOutNotes').value,
                createdAt: new Date().toISOString(),
                user: 'Administrateur'
            };
            
            // Mettre √† jour le stock du produit
            const newStock = (currentProduct.stock || 0) - quantity;
            
            if (isDemoMode) {
                // Mode d√©mo
                currentProduct.stock = newStock;
                
                // Ajouter le mouvement
                stockOutData.id = 'demo-' + Date.now();
                stockMovements.unshift(stockOutData);
                
                showToast("Sortie de stock enregistr√©e (mode d√©mo)", "success");
                closeStockOutModal();
                updateDashboard();
                displayProducts(products);
                loadStockMovements();
            } else {
                // Mode Firebase
                saveStockMovementToFirebase(stockOutData, currentProduct.id, newStock);
            }
        }
        
        function updateProductQuantity(productId, quantityChange, type, reference = '') {
            const product = products.find(p => p.id === productId);
            if (!product) return false;
            
            const newStock = (product.stock || 0) + quantityChange;
            
            if (newStock < 0) {
                showToast(`Stock insuffisant pour ${product.name}!`, "error");
                return false;
            }
            
            // Enregistrer le mouvement
            const movementData = {
                productId: productId,
                productName: product.name,
                type: type,
                quantity: Math.abs(quantityChange),
                unitPrice: product.price || 0,
                total: Math.abs(quantityChange) * (product.price || 0),
                date: new Date().toISOString(),
                reference: reference,
                createdAt: new Date().toISOString(),
                user: 'Syst√®me'
            };
            
            if (isDemoMode) {
                // Mode d√©mo
                product.stock = newStock;
                movementData.id = 'demo-' + Date.now();
                stockMovements.unshift(movementData);
                
                updateDashboard();
                displayProducts(products);
                return true;
            } else {
                // Mode Firebase
                return updateStockInFirebase(productId, newStock, movementData);
            }
        }
        
        function getStockStatus(stock, minStock) {
            if (stock <= 0) return 'out';
            if (stock <= minStock) return 'low';
            if (stock <= minStock * 2) return 'medium';
            return 'high';
        }
        
        function getStockStatusText(status) {
            switch(status) {
                case 'high': return '√âlev√©';
                case 'medium': return 'Moyen';
                case 'low': return 'Bas';
                case 'out': return 'Rupture';
                default: return 'Inconnu';
            }
        }
        
        function getStockStatusClass(status) {
            switch(status) {
                case 'high': return 'stock-high';
                case 'medium': return 'stock-medium';
                case 'low': return 'stock-low';
                case 'out': return 'stock-out';
                default: return '';
            }
        }
        
        // ==================== AFFICHAGE DES DONN√âES ====================
        function displayProducts(productsList) {
            const tableBody = document.getElementById('productsTable');
            
            if (!tableBody) {
                console.error("‚ùå Table body non trouv√© pour les produits");
                return;
            }
            
            if (productsList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h3>Aucun produit trouv√©</h3>
                            <p>Cliquez sur "Nouveau Produit" pour ajouter votre premier produit</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            productsList.forEach(product => {
                const stock = product.stock || 0;
                const minStock = product.minStock || 10;
                const status = getStockStatus(stock, minStock);
                const statusText = getStockStatusText(status);
                const statusClass = getStockStatusClass(status);
                const value = stock * (product.price || 0);
                
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--light); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-box" style="color: var(--primary);"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text);">${product.name}</div>
                                    ${product.description ? `<div style="font-size: 12px; color: var(--text-light);">${product.description}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            ${product.category ? `<span class="category-badge">${product.category}</span>` : '<span style="color: var(--text-light); font-size: 12px;">Non cat√©goris√©</span>'}
                        </td>
                        <td>
                            <strong style="color: var(--primary);">${(product.price || 0).toFixed(2)} DH</strong>
                        </td>
                        <td>
                            <div>${stock} ${product.unit || 'unit√©'}</div>
                        </td>
                        <td>
                            <div>${minStock} ${product.unit || 'unit√©'}</div>
                        </td>
                        <td>
                            <strong style="color: var(--success);">${value.toFixed(2)} DH</strong>
                        </td>
                        <td>
                            <span class="stock-status ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="action-btn edit-btn" onclick="openAddProductModal(${JSON.stringify(product).replace(/"/g, '&quot;')})" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn stock-btn" onclick="openStockOutModal(${JSON.stringify(product).replace(/"/g, '&quot;')})" title="Sortie stock">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteProduct('${product.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Mettre √† jour le compteur
            const productsCountElement = document.getElementById('productsCount');
            if (productsCountElement) {
                productsCountElement.textContent = `${productsList.length} produits trouv√©s`;
            }
        }
        
        function displayStockMovements(movementsList) {
            const tableBody = document.getElementById('movementsTable');
            
            if (!tableBody) {
                console.error("‚ùå Table body non trouv√© pour les mouvements");
                return;
            }
            
            if (movementsList.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-exchange-alt"></i>
                            <h3>Aucun mouvement trouv√©</h3>
                            <p>Les mouvements de stock appara√Ætront ici</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            movementsList.forEach(movement => {
                try {
                    const date = new Date(movement.date || movement.createdAt || Date.now());
                    const dateStr = date.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const typeClass = movement.type === 'in' ? 'movement-in' : 'movement-out';
                    const typeText = movement.type === 'in' ? 'ENTR√âE' : 'SORTIE';
                    
                    // Formater les nombres
                    const quantity = parseFloat(movement.quantity) || 0;
                    const unitPrice = parseFloat(movement.unitPrice) || 0;
                    const total = parseFloat(movement.total) || 0;
                    
                    html += `
                        <tr>
                            <td>${dateStr}</td>
                            <td>${movement.productName || 'Produit inconnu'}</td>
                            <td><span class="movement-type ${typeClass}">${typeText}</span></td>
                            <td>${quantity.toFixed(2)} ${movement.unit || 'unit√©'}</td>
                            <td>${unitPrice.toFixed(2)} DH</td>
                            <td><strong style="color: ${movement.type === 'in' ? 'var(--success)' : 'var(--danger)'};">${total.toFixed(2)} DH</strong></td>
                            <td>${movement.reference || movement.supplier || '--'}</td>
                            <td>${movement.user || 'Syst√®me'}</td>
                        </tr>
                    `;
                } catch (error) {
                    console.error("‚ùå Erreur d'affichage du mouvement:", movement, error);
                }
            });
            
            tableBody.innerHTML = html;
        }
        
        function displayStockAlerts() {
            const alertsContainer = document.getElementById('alertsContainer');
            
            if (!alertsContainer) {
                console.error("‚ùå Container des alertes non trouv√©");
                return;
            }
            
            const lowStockProducts = products.filter(p => {
                const stock = p.stock || 0;
                const minStock = p.minStock || 10;
                return stock <= minStock;
            });
            
            if (lowStockProducts.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <h3>Aucune alerte</h3>
                        <p>Tous les produits ont un stock suffisant</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            lowStockProducts.forEach(product => {
                const stock = product.stock || 0;
                const minStock = product.minStock || 10;
                const alertType = stock === 0 ? 'danger' : 'warning';
                const alertIcon = stock === 0 ? 'fas fa-times-circle' : 'fas fa-exclamation-triangle';
                const alertMessage = stock === 0 
                    ? 'RUPTURE DE STOCK' 
                    : `STOCK BAS (${stock}/${minStock} ${product.unit || 'unit√©'})`;
                
                html += `
                    <div class="stock-alert alert-${alertType}">
                        <div class="alert-icon">
                            <i class="${alertIcon}"></i>
                        </div>
                        <div class="alert-content">
                            <h4>${product.name}</h4>
                            <p>${alertMessage} - Cat√©gorie: ${product.category || 'Non cat√©goris√©'}</p>
                        </div>
                        <button class="btn btn-${alertType} btn-small" onclick="openStockInModal()">
                            <i class="fas fa-arrow-down"></i>
                            R√©approvisionner
                        </button>
                    </div>
                `;
            });
            
            alertsContainer.innerHTML = html;
        }
        
        function displayCategories() {
            const categoriesContainer = document.getElementById('categoriesContainer');
            
            if (!categoriesContainer) {
                console.error("‚ùå Container des cat√©gories non trouv√©");
                return;
            }
            
            if (categories.length === 0) {
                categoriesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tags"></i>
                        <h3>Aucune cat√©gorie</h3>
                        <p>Cliquez sur "Nouvelle Cat√©gorie" pour cr√©er votre premi√®re cat√©gorie</p>
                    </div>
                `;
                return;
            }
            
            // Calculer le nombre de produits par cat√©gorie
            const categoryStats = {};
            products.forEach(product => {
                if (product.category) {
                    if (!categoryStats[product.category]) {
                        categoryStats[product.category] = 0;
                    }
                    categoryStats[product.category]++;
                }
            });
            
            let html = '<div class="categories-grid">';
            categories.forEach(category => {
                const productCount = categoryStats[category.name] || 0;
                const colorClass = `color-${category.color || 'primary'}`;
                
                html += `
                    <div class="category-card">
                        <div class="category-icon ${colorClass}">
                            <i class="${category.icon || 'fas fa-box'}"></i>
                        </div>
                        <h4>${category.name}</h4>
                        <div class="category-stats">
                            ${productCount} produit${productCount !== 1 ? 's' : ''}
                            ${category.description ? `<div style="margin-top: 5px; font-size: 11px;">${category.description}</div>` : ''}
                        </div>
                        <div class="category-actions">
                            <button class="btn btn-primary btn-small" onclick="openAddCategoryModal(${JSON.stringify(category).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit"></i>
                                Modifier
                            </button>
                            <button class="btn btn-danger btn-small" onclick="confirmDeleteCategory(${JSON.stringify(category).replace(/"/g, '&quot;')})">
                                <i class="fas fa-trash"></i>
                                Supprimer
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            categoriesContainer.innerHTML = html;
            
            const categoriesCountDisplay = document.getElementById('categoriesCountDisplay');
            if (categoriesCountDisplay) {
                categoriesCountDisplay.textContent = `${categories.length} cat√©gories`;
            }
        }
        
        function displayUncategorizedProducts() {
            const tableBody = document.getElementById('uncategorizedTable');
            
            if (!tableBody) {
                console.error("‚ùå Table body non trouv√© pour les produits non cat√©goris√©s");
                return;
            }
            
            const uncategorizedProducts = products.filter(p => !p.category || p.category === '');
            
            if (uncategorizedProducts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state" style="padding: 20px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            <h3>Tous les produits sont cat√©goris√©s</h3>
                            <p>Aucun produit sans cat√©gorie</p>
                        </td>
                    </tr>
                `;
                
                const uncategorizedCount = document.getElementById('uncategorizedCount');
                if (uncategorizedCount) {
                    uncategorizedCount.textContent = '0 produits';
                }
                return;
            }
            
            let html = '';
            uncategorizedProducts.forEach(product => {
                const stock = product.stock || 0;
                
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 30px; height: 30px; border-radius: 6px; background: var(--light); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-box" style="color: var(--warning);"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: var(--text);">${product.name}</div>
                                </div>
                            </div>
                        </td>
                        <td>${stock} ${product.unit || 'unit√©'}</td>
                        <td><strong>${(product.price || 0).toFixed(2)} DH</strong></td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-primary btn-small" onclick="assignCategoryToProduct('${product.id}')">
                                    <i class="fas fa-tag"></i>
                                    Attribuer
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            const uncategorizedCount = document.getElementById('uncategorizedCount');
            if (uncategorizedCount) {
                uncategorizedCount.textContent = `${uncategorizedProducts.length} produit${uncategorizedProducts.length !== 1 ? 's' : ''}`;
            }
        }
        
        // ==================== FONCTIONS D'INTERACTION ====================
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            let filteredProducts = products;
            
            // Filtre par recherche
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtre par cat√©gorie
            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }
            
            // Filtre par statut de stock
            if (stockFilter) {
                filteredProducts = filteredProducts.filter(p => {
                    const status = getStockStatus(p.stock || 0, p.minStock || 10);
                    return status === stockFilter;
                });
            }
            
            displayProducts(filteredProducts);
        }
        
        function filterMovements() {
            const typeFilter = document.getElementById('movementTypeFilter').value;
            const dateFilter = document.getElementById('movementDateFilter').value;
            
            let filteredMovements = stockMovements;
            
            if (typeFilter) {
                filteredMovements = filteredMovements.filter(m => m.type === typeFilter);
            }
            
            if (dateFilter) {
                const filterDate = new Date(dateFilter).toDateString();
                filteredMovements = filteredMovements.filter(m => {
                    const movementDate = new Date(m.date || m.createdAt).toDateString();
                    return movementDate === filterDate;
                });
            }
            
            displayStockMovements(filteredMovements);
        }
        
        function checkStockAlerts() {
            displayStockAlerts();
        }
        
        function refreshProducts() {
            if (isDemoMode) {
                loadDemoData();
                showToast("Produits actualis√©s (mode d√©mo)", "success");
            } else {
                loadProducts();
                showToast("Actualisation en cours...", "info");
            }
        }
        
        function refreshCategories() {
            if (isDemoMode) {
                loadDemoData();
                showToast("Cat√©gories actualis√©es (mode d√©mo)", "success");
            } else {
                loadCategoriesFromFirebase();
                showToast("Actualisation des cat√©gories...", "info");
            }
        }
        
        function exportProducts() {
            if (products.length === 0) {
                showToast("Aucun produit √† exporter", "warning");
                return;
            }
            
            const data = products.map(p => ({
                'Nom': p.name,
                'Cat√©gorie': p.category || '',
                'Prix (DH)': p.price || 0,
                'Stock': p.stock || 0,
                'Stock Min': p.minStock || 10,
                'Unit√©': p.unit || 'unit√©',
                'Valeur (DH)': (p.stock || 0) * (p.price || 0)
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `produits_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast("Export CSV termin√©", "success");
        }
        
        function exportCategories() {
            if (categories.length === 0) {
                showToast("Aucune cat√©gorie √† exporter", "warning");
                return;
            }
            
            const data = categories.map(c => ({
                'Nom': c.name,
                'Description': c.description || '',
                'Couleur': c.color || 'primary',
                'Ic√¥ne': c.icon || 'fas fa-box',
                'Date cr√©ation': c.createdAt ? new Date(c.createdAt).toLocaleDateString('fr-FR') : ''
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `categories_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast("Export CSV des cat√©gories termin√©", "success");
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const cell = row[header] !== null && row[header] !== undefined ? row[header] : '';
                    return JSON.stringify(cell);
                }).join(','))
            ];
            return csvRows.join('\n');
        }
        
        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            openConfirmModal(
                `√ätes-vous s√ªr de vouloir supprimer le produit "${product.name}" ?${product.stock > 0 ? `\n\nCe produit a encore ${product.stock} en stock.` : ''}`,
                'deleteProduct',
                productId
            );
        }
        
        function confirmDeleteCategory(category) {
            // Compter les produits dans cette cat√©gorie
            const productsInCategory = products.filter(p => p.category === category.name).length;
            
            let message = `√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${category.name}" ?`;
            
            if (productsInCategory > 0) {
                message += `\n\n‚ö†Ô∏è Attention : ${productsInCategory} produit${productsInCategory !== 1 ? 's' : ''} utilisent cette cat√©gorie. Ils seront marqu√©s comme "Non cat√©goris√©".`;
            }
            
            openConfirmModal(message, 'deleteCategory', category);
        }
        
        function assignCategoryToProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Ouvrir le modal de modification avec le produit s√©lectionn√©
            openAddProductModal(product);
        }
        
        function reorderCategories() {
            // Trier les cat√©gories par nom
            categories.sort((a, b) => a.name.localeCompare(b.name, 'fr'));
            
            // Sauvegarder l'ordre
            if (!isDemoMode) {
                saveCategoriesToFirebase();
            }
            
            // R√©afficher les cat√©gories
            displayCategories();
            loadCategoriesForSelect();
            updateCategoryFilters();
            
            showToast("Cat√©gories tri√©es par ordre alphab√©tique", "success");
        }
        
        function updateDashboard() {
            // Statistiques produits
            const totalProducts = products.length;
            const activeProducts = products.filter(p => p.active !== false).length;
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('productsDetails').textContent = `${activeProducts} actifs`;
            
            // Statistiques stock bas
            const lowStockProducts = products.filter(p => {
                const stock = p.stock || 0;
                const minStock = p.minStock || 10;
                return stock <= minStock;
            }).length;
            document.getElementById('lowStockCount').textContent = lowStockProducts;
            
            // Statistiques valeur stock
            const stockValue = products.reduce((sum, p) => {
                return sum + ((p.stock || 0) * (p.price || 0));
            }, 0);
            document.getElementById('stockValue').textContent = stockValue.toFixed(2) + ' DH';
            
            // Statistiques cat√©gories
            const uniqueCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
            document.getElementById('categoriesCount').textContent = uniqueCategories.length;
            
            // Mettre √† jour les filtres de cat√©gories
            updateCategoryFilters();
        }
        
        function updateCategoryFilters() {
            // R√©cup√©rer toutes les cat√©gories uniques
            const uniqueCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
            
            // Mettre √† jour le filtre de cat√©gorie dans l'onglet produits
            const categoryFilter = document.getElementById('categoryFilter');
            if (!categoryFilter) return;
            
            const currentValue = categoryFilter.value;
            categoryFilter.innerHTML = '<option value="">Toutes cat√©gories</option>';
            
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            // Restaurer la valeur s√©lectionn√©e
            categoryFilter.value = currentValue;
        }
        
        // ==================== MODE D√âMO ====================
        function loadDemoData() {
            console.log("üìä Chargement des donn√©es d√©mo pour les produits...");
            
            // Cat√©gories d√©mo avec m√©tadonn√©es
            categories = [
                { id: 'cat1', name: 'Mat√©riaux', description: 'Mat√©riaux de construction', color: 'primary', icon: 'fas fa-home', createdAt: new Date().toISOString(), productCount: 5 },
                { id: 'cat2', name: 'M√©tallique', description: 'Produits m√©talliques', color: 'warning', icon: 'fas fa-industry', createdAt: new Date().toISOString(), productCount: 1 },
                { id: 'cat3', name: 'Plomberie', description: 'Tuyaux et accessoires', color: 'info', icon: 'fas fa-tint', createdAt: new Date().toISOString(), productCount: 1 },
                { id: 'cat4', name: 'Peinture', description: 'Peintures et rev√™tements', color: 'danger', icon: 'fas fa-paint-roller', createdAt: new Date().toISOString(), productCount: 1 },
                { id: 'cat5', name: 'Carrelage', description: 'Carreaux et fa√Øence', color: 'success', icon: 'fas fa-cube', createdAt: new Date().toISOString(), productCount: 2 },
                { id: 'cat6', name: 'Rev√™tement', description: 'Rev√™tements muraux et sols', color: 'purple', icon: 'fas fa-layer-group', createdAt: new Date().toISOString(), productCount: 1 },
                { id: 'cat7', name: '√âlectricit√©', description: 'Mat√©riel √©lectrique', color: 'cyan', icon: 'fas fa-bolt', createdAt: new Date().toISOString(), productCount: 2 },
                { id: 'cat8', name: 'Quincaillerie', description: 'Vis, clous, accessoires', color: 'primary', icon: 'fas fa-toolbox', createdAt: new Date().toISOString(), productCount: 1 }
            ];
            
            // Produits d√©mo
            products = [
                { id: "prod1", name: "Ciment 50kg", category: "Mat√©riaux", price: 85.50, cost: 75.00, stock: 150, minStock: 20, unit: "sac", description: "Ciment Portland 50kg" },
                { id: "prod2", name: "Sable fin", category: "Mat√©riaux", price: 450.00, cost: 380.00, stock: 25, minStock: 10, unit: "m3", description: "Sable fin pour construction" },
                { id: "prod3", name: "Gravier 5/15", category: "Mat√©riaux", price: 380.00, cost: 320.00, stock: 18, minStock: 10, unit: "m3", description: "Gravier pour b√©ton" },
                { id: "prod4", name: "Briques rouges", category: "Mat√©riaux", price: 2.50, cost: 1.80, stock: 5000, minStock: 1000, unit: "unit√©", description: "Briques de construction" },
                { id: "prod5", name: "T√¥le galvanis√©e", category: "M√©tallique", price: 125.00, cost: 95.00, stock: 45, minStock: 15, unit: "m2", description: "T√¥le 1m x 2m" },
                { id: "prod6", name: "Tube PVC 100mm", category: "Plomberie", price: 45.00, cost: 32.00, stock: 8, minStock: 10, unit: "m", description: "Tube PVC diam√®tre 100mm" },
                { id: "prod7", name: "Peinture blanche", category: "Peinture", price: 180.00, cost: 140.00, stock: 22, minStock: 10, unit: "L", description: "Peinture acrylique 10L" },
                { id: "prod8", name: "Carreaux 30x30", category: "Carrelage", price: 85.00, cost: 65.00, stock: 120, minStock: 50, unit: "m2", description: "Carreaux c√©ramique" },
                { id: "prod9", name: "Parpaing 20x40", category: "Mat√©riaux", price: 4.20, cost: 3.20, stock: 1200, minStock: 200, unit: "unit√©", description: "Parpaing creux" },
                { id: "prod10", name: "Lambris PVC", category: "Rev√™tement", price: 65.00, cost: 48.00, stock: 3, minStock: 10, unit: "m2", description: "Lambris pour plafond" },
                { id: "prod11", name: "C√¢ble √©lectrique 2.5mm", category: "√âlectricit√©", price: 3.50, cost: 2.20, stock: 280, minStock: 100, unit: "m", description: "C√¢ble cuivre 2.5mm¬≤" },
                { id: "prod12", name: "Vis √† bois 4x40", category: "Quincaillerie", price: 0.15, cost: 0.08, stock: 5000, minStock: 1000, unit: "unit√©", description: "Vis √† bois galvanis√©es" },
                { id: "prod13", name: "Interrupteur simple", category: "√âlectricit√©", price: 8.50, cost: 5.20, stock: 45, minStock: 20, unit: "unit√©", description: "Interrupteur unipolaire" },
                { id: "prod14", name: "Colle carrelage", category: "Carrelage", price: 75.00, cost: 55.00, stock: 12, minStock: 10, unit: "kg", description: "Colle pour carrelage" },
                { id: "prod15", name: "Marteau", category: "", price: 45.00, cost: 32.00, stock: 7, minStock: 10, unit: "unit√©", description: "Marteau de charpentier" }
            ];
            
            // Mouvements de stock d√©mo
            stockMovements = [];
            const now = new Date();
            
            // G√©n√©rer des mouvements pour les 30 derniers jours
            for (let i = 0; i < 50; i++) {
                const date = new Date();
                date.setDate(now.getDate() - Math.floor(Math.random() * 30));
                date.setHours(Math.floor(Math.random() * 24));
                date.setMinutes(Math.floor(Math.random() * 60));
                
                const product = products[Math.floor(Math.random() * products.length)];
                const type = Math.random() > 0.3 ? 'in' : 'out';
                const quantity = type === 'in' ? 
                    Math.floor(Math.random() * 100) + 10 : 
                    Math.floor(Math.random() * 50) + 1;
                const unitPrice = product.cost || product.price || 0;
                
                const suppliers = ["Fournisseur A", "Fournisseur B", "Fournisseur C", "Import Direct"];
                const references = ["FAC-2024-", "BON-", "TRF-", "AJ-"];
                const reference = references[Math.floor(Math.random() * references.length)] + 
                                Math.floor(Math.random() * 10000);
                
                stockMovements.push({
                    id: "mov" + i,
                    productId: product.id,
                    productName: product.name,
                    type: type,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    total: quantity * unitPrice,
                    date: date.toISOString(),
                    supplier: type === 'in' ? suppliers[Math.floor(Math.random() * suppliers.length)] : '',
                    reference: reference,
                    notes: type === 'in' ? 'Livraison fournisseur' : 'Vente client',
                    createdAt: date.toISOString(),
                    user: 'Administrateur'
                });
            }
            
            // Trier les mouvements par date (du plus r√©cent au plus ancien)
            stockMovements.sort((a, b) => {
                const dateA = new Date(a.date || a.createdAt || 0);
                const dateB = new Date(b.date || b.createdAt || 0);
                return dateB - dateA;
            });
            
            updateDashboard();
            displayProducts(products);
            displayStockMovements(stockMovements);
            checkStockAlerts();
            displayCategories();
            displayUncategorizedProducts();
            
            showToast("Donn√©es d√©mo charg√©es avec succ√®s", "success");
        }
        
        // ==================== FIREBASE ====================
        
        function initializeFirebase() {
            try {
                console.log("üîß Tentative de connexion √† Firebase...");
                
                if (typeof firebase === 'undefined') {
                    console.error("‚ùå Firebase SDK non charg√©");
                    throw new Error("Firebase SDK non charg√©");
                }
                
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("‚ùå Configuration Firebase manquante");
                    throw new Error("Configuration Firebase manquante");
                }
                
                // V√©rifier si Firebase est d√©j√† initialis√©
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("‚úÖ Firebase initialis√© avec succ√®s");
                } else {
                    console.log("‚ÑπÔ∏è Firebase d√©j√† initialis√©");
                    firebase.app(); // Utiliser l'instance existante
                }
                
                database = firebase.database();
                
                // Tester la connexion
                const testRef = database.ref('.info/connected');
                
                const connectionListener = testRef.on('value', (snapshot) => {
                    const connected = snapshot.val() === true;
                    updateConnectionStatus(connected);
                    
                    if (connected) {
                        console.log("‚úÖ Connect√© √† Firebase Realtime Database");
                        isDemoMode = false;
                        loadData();
                    } else {
                        console.log("‚ùå D√©connect√© de Firebase");
                        setTimeout(() => {
                            if (!isConnected && !isDemoMode) {
                                console.log("üîÑ Passage en mode d√©mo...");
                                isDemoMode = true;
                                loadDemoData();
                            }
                        }, 3000);
                    }
                }, (error) => {
                    console.error("‚ùå Erreur de surveillance de connexion:", error);
                    updateConnectionStatus(false);
                    isDemoMode = true;
                    loadDemoData();
                });
                
                // Stocker la r√©f√©rence pour pouvoir la d√©tacher plus tard
                firebaseListeners.push({ ref: testRef, listener: connectionListener });
                
                // Timeout de connexion
                setTimeout(() => {
                    if (!isConnected && !isDemoMode) {
                        console.log("‚è±Ô∏è Timeout de connexion - Passage en mode d√©mo");
                        isDemoMode = true;
                        loadDemoData();
                    }
                }, 5000);
                
            } catch (error) {
                console.error("‚ùå Erreur d'initialisation Firebase:", error);
                updateConnectionStatus(false);
                showToast("Erreur de connexion Firebase. Mode d√©mo activ√©.", "error");
                isDemoMode = true;
                loadDemoData();
            }
        }
        
        function loadData() {
            console.log("üì• Chargement des donn√©es depuis Firebase...");
            
            // Initialiser les tableaux vides
            products = [];
            categories = [];
            stockMovements = [];
            
            // Afficher l'√©tat de chargement
            const productsTable = document.getElementById('productsTable');
            const movementsTable = document.getElementById('movementsTable');
            
            if (productsTable) {
                productsTable.innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Chargement des produits depuis Firebase...</p>
                        </td>
                    </tr>
                `;
            }
            
            if (movementsTable) {
                movementsTable.innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Chargement des mouvements depuis Firebase...</p>
                        </td>
                    </tr>
                `;
            }
            
            // Charger d'abord les cat√©gories, puis les produits, puis les mouvements
            loadCategoriesFromFirebase();
        }
        
        function loadCategoriesFromFirebase() {
            if (!database) {
                console.error("‚ùå Base de donn√©es non disponible");
                loadProducts();
                return;
            }
            
            try {
                const categoriesRef = database.ref('categories');
                
                // Utiliser once() pour une seule lecture
                categoriesRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        categories = [];
                        
                        if (data) {
                            Object.keys(data).forEach(key => {
                                categories.push({
                                    id: key,
                                    ...data[key]
                                });
                            });
                            console.log(`‚úÖ ${categories.length} cat√©gories charg√©es`);
                        } else {
                            console.log("‚ÑπÔ∏è Aucune cat√©gorie trouv√©e dans Firebase");
                        }
                        
                        // Charger les produits apr√®s les cat√©gories
                        loadProducts();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de chargement des cat√©gories:", error);
                        loadProducts(); // Continuer avec les produits m√™me en cas d'erreur
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur dans loadCategories:", error);
                loadProducts();
            }
        }
        
        function loadProducts() {
            if (!database) {
                console.error("‚ùå Base de donn√©es non disponible");
                loadStockMovements();
                return;
            }
            
            try {
                const productsRef = database.ref('products');
                
                productsRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        products = [];
                        
                        if (data) {
                            Object.keys(data).forEach(key => {
                                const product = {
                                    id: key,
                                    ...data[key]
                                };
                                // Convertir les champs num√©riques
                                product.price = parseFloat(product.price) || 0;
                                product.cost = parseFloat(product.cost) || 0;
                                product.stock = parseFloat(product.stock) || 0;
                                product.minStock = parseFloat(product.minStock) || 10;
                                products.push(product);
                            });
                            
                            console.log(`‚úÖ ${products.length} produits charg√©s`);
                            updateDashboard();
                            displayProducts(products);
                            checkStockAlerts();
                            displayCategories();
                            displayUncategorizedProducts();
                        } else {
                            console.log("‚ÑπÔ∏è Aucun produit trouv√© dans Firebase");
                            updateDashboard();
                            displayProducts([]);
                            displayCategories();
                            displayUncategorizedProducts();
                        }
                        
                        // Charger les mouvements apr√®s les produits
                        loadStockMovements();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de chargement des produits:", error);
                        showToast("Erreur de chargement des produits", "error");
                        updateDashboard();
                        displayProducts([]);
                        loadStockMovements(); // Charger les mouvements m√™me en cas d'erreur
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur dans loadProducts:", error);
                updateDashboard();
                displayProducts([]);
                loadStockMovements();
            }
        }
        
        function loadStockMovements() {
            if (isDemoMode) {
                // Mode d√©mo - afficher les mouvements d√©j√† charg√©s
                displayStockMovements(stockMovements);
                return;
            }
            
            if (!database) {
                console.error("‚ùå Base de donn√©es non disponible");
                displayStockMovements([]);
                return;
            }
            
            try {
                const movementsRef = database.ref('stockMovements');
                
                movementsRef.once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        stockMovements = [];
                        
                        if (data) {
                            Object.keys(data).forEach(key => {
                                const movement = {
                                    id: key,
                                    ...data[key]
                                };
                                // S'assurer que les champs num√©riques sont correctement convertis
                                movement.quantity = parseFloat(movement.quantity) || 0;
                                movement.unitPrice = parseFloat(movement.unitPrice) || 0;
                                movement.total = parseFloat(movement.total) || 0;
                                stockMovements.push(movement);
                            });
                            
                            // Trier par date (du plus r√©cent au plus ancien)
                            stockMovements.sort((a, b) => {
                                const dateA = new Date(a.date || a.createdAt || 0);
                                const dateB = new Date(b.date || b.createdAt || 0);
                                return dateB - dateA;
                            });
                            
                            console.log(`‚úÖ ${stockMovements.length} mouvements charg√©s`);
                            displayStockMovements(stockMovements);
                        } else {
                            console.log("‚ÑπÔ∏è Aucun mouvement trouv√© dans Firebase");
                            displayStockMovements([]);
                        }
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de chargement des mouvements:", error);
                        showToast("Erreur de chargement des mouvements", "error");
                        displayStockMovements([]);
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur dans loadStockMovements:", error);
                showToast("Erreur de chargement des mouvements", "error");
                displayStockMovements([]);
            }
        }
        
        function saveCategoriesToFirebase() {
            if (!isDemoMode && database) {
                try {
                    const categoriesRef = database.ref('categories');
                    const categoriesData = {};
                    
                    categories.forEach(category => {
                        if (category.id) {
                            categoriesData[category.id] = {
                                name: category.name,
                                description: category.description,
                                color: category.color,
                                icon: category.icon,
                                createdAt: category.createdAt,
                                updatedAt: new Date().toISOString()
                            };
                        }
                    });
                    
                    categoriesRef.set(categoriesData)
                        .then(() => console.log("‚úÖ Cat√©gories sauvegard√©es"))
                        .catch(error => console.error("‚ùå Erreur sauvegarde cat√©gories:", error));
                } catch (error) {
                    console.error("‚ùå Erreur sauvegarde cat√©gories:", error);
                }
            }
        }
        
        function addProduct(productData) {
            if (isDemoMode) {
                // Mode d√©mo
                productData.id = 'demo-' + Date.now();
                products.push(productData);
                showToast("Produit ajout√© (mode d√©mo)", "success");
                closeProductModal();
                updateDashboard();
                displayProducts(products);
                displayUncategorizedProducts();
            } else {
                // Mode Firebase
                addProductToFirebase(productData);
            }
        }
        
        function updateProduct(productId, productData) {
            if (isDemoMode) {
                // Mode d√©mo
                const index = products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    products[index] = { ...products[index], ...productData };
                    showToast("Produit mis √† jour (mode d√©mo)", "success");
                    closeProductModal();
                    updateDashboard();
                    displayProducts(products);
                    displayUncategorizedProducts();
                }
            } else {
                // Mode Firebase
                updateProductInFirebase(productId, productData);
            }
        }
        
        function addCategory(categoryData) {
            if (isDemoMode) {
                // Mode d√©mo
                categoryData.id = 'demo-' + Date.now();
                categories.push(categoryData);
                showToast("Cat√©gorie ajout√©e (mode d√©mo)", "success");
                closeCategoryModal();
                updateDashboard();
                displayCategories();
                loadCategoriesForSelect();
                updateCategoryFilters();
            } else {
                // Mode Firebase
                addCategoryToFirebase(categoryData);
            }
        }
        
        function updateCategory(categoryId, categoryData, oldName) {
            if (isDemoMode) {
                // Mode d√©mo
                const index = categories.findIndex(c => c.id === categoryId);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...categoryData };
                    
                    // Mettre √† jour les produits qui utilisent cette cat√©gorie
                    if (oldName !== categoryData.name) {
                        products.forEach(product => {
                            if (product.category === oldName) {
                                product.category = categoryData.name;
                            }
                        });
                    }
                    
                    showToast("Cat√©gorie mise √† jour (mode d√©mo)", "success");
                    closeCategoryModal();
                    updateDashboard();
                    displayProducts(products);
                    displayCategories();
                    displayUncategorizedProducts();
                    loadCategoriesForSelect();
                    updateCategoryFilters();
                }
            } else {
                // Mode Firebase
                updateCategoryInFirebase(categoryId, categoryData, oldName);
            }
        }
        
        // ==================== FONCTIONS FIREBASE ====================
        
        function addProductToFirebase(productData) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Ajout du produit en cours...", "info");
            
            try {
                const newProductRef = database.ref('products').push();
                productData.id = newProductRef.key;
                
                newProductRef.set(productData)
                    .then(() => {
                        showToast("Produit ajout√© avec succ√®s!", "success");
                        closeProductModal();
                        
                        // Ajouter √† la liste locale
                        products.push(productData);
                        updateDashboard();
                        displayProducts(products);
                        displayUncategorizedProducts();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur d'ajout du produit:", error);
                        showToast("Erreur lors de l'ajout du produit: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de l'ajout du produit: " + error.message, "error");
            }
        }
        
        function updateProductInFirebase(productId, productData) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Mise √† jour du produit en cours...", "info");
            
            try {
                const productRef = database.ref('products/' + productId);
                
                productRef.update(productData)
                    .then(() => {
                        showToast("Produit mis √† jour avec succ√®s!", "success");
                        closeProductModal();
                        
                        // Mettre √† jour la liste locale
                        const index = products.findIndex(p => p.id === productId);
                        if (index !== -1) {
                            products[index] = { ...products[index], ...productData };
                            updateDashboard();
                            displayProducts(products);
                            displayUncategorizedProducts();
                        }
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de mise √† jour du produit:", error);
                        showToast("Erreur lors de la mise √† jour du produit: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de la mise √† jour du produit: " + error.message, "error");
            }
        }
        
        function deleteProductFromFirebase(productId) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Suppression du produit en cours...", "info");
            
            try {
                const productRef = database.ref('products/' + productId);
                
                productRef.remove()
                    .then(() => {
                        showToast("Produit supprim√© avec succ√®s!", "success");
                        
                        // Retirer de la liste locale
                        products = products.filter(p => p.id !== productId);
                        updateDashboard();
                        displayProducts(products);
                        displayUncategorizedProducts();
                        closeConfirmModal();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de suppression du produit:", error);
                        showToast("Erreur lors de la suppression du produit: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de la suppression du produit: " + error.message, "error");
            }
        }
        
        function addCategoryToFirebase(categoryData) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Ajout de la cat√©gorie en cours...", "info");
            
            try {
                const newCategoryRef = database.ref('categories').push();
                categoryData.id = newCategoryRef.key;
                
                newCategoryRef.set(categoryData)
                    .then(() => {
                        showToast("Cat√©gorie ajout√©e avec succ√®s!", "success");
                        closeCategoryModal();
                        
                        // Ajouter √† la liste locale
                        categories.push(categoryData);
                        updateDashboard();
                        displayCategories();
                        loadCategoriesForSelect();
                        updateCategoryFilters();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur d'ajout de la cat√©gorie:", error);
                        showToast("Erreur lors de l'ajout de la cat√©gorie: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de l'ajout de la cat√©gorie: " + error.message, "error");
            }
        }
        
        function updateCategoryInFirebase(categoryId, categoryData, oldName) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Mise √† jour de la cat√©gorie en cours...", "info");
            
            try {
                const categoryRef = database.ref('categories/' + categoryId);
                
                categoryRef.update(categoryData)
                    .then(() => {
                        // Si le nom a chang√©, mettre √† jour les produits
                        if (oldName !== categoryData.name) {
                            const updates = {};
                            products.forEach(product => {
                                if (product.category === oldName) {
                                    updates[`products/${product.id}/category`] = categoryData.name;
                                }
                            });
                            
                            if (Object.keys(updates).length > 0) {
                                return database.ref().update(updates);
                            }
                        }
                        return Promise.resolve();
                    })
                    .then(() => {
                        showToast("Cat√©gorie mise √† jour avec succ√®s!", "success");
                        closeCategoryModal();
                        
                        // Mettre √† jour la liste locale
                        const index = categories.findIndex(c => c.id === categoryId);
                        if (index !== -1) {
                            categories[index] = { ...categories[index], ...categoryData };
                        }
                        
                        // Mettre √† jour les produits locaux
                        products.forEach(product => {
                            if (product.category === oldName) {
                                product.category = categoryData.name;
                            }
                        });
                        
                        updateDashboard();
                        displayProducts(products);
                        displayCategories();
                        displayUncategorizedProducts();
                        loadCategoriesForSelect();
                        updateCategoryFilters();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de mise √† jour de la cat√©gorie:", error);
                        showToast("Erreur lors de la mise √† jour de la cat√©gorie: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de la mise √† jour de la cat√©gorie: " + error.message, "error");
            }
        }
        
        function deleteCategoryFromFirebase(category) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Suppression de la cat√©gorie en cours...", "info");
            
            try {
                // Supprimer la cat√©gorie
                const categoryRef = database.ref('categories/' + category.id);
                
                categoryRef.remove()
                    .then(() => {
                        // Mettre √† jour les produits qui utilisent cette cat√©gorie
                        const updates = {};
                        products.forEach(product => {
                            if (product.category === category.name) {
                                updates[`products/${product.id}/category`] = '';
                            }
                        });
                        
                        if (Object.keys(updates).length > 0) {
                            return database.ref().update(updates);
                        }
                        return Promise.resolve();
                    })
                    .then(() => {
                        showToast("Cat√©gorie supprim√©e avec succ√®s!", "success");
                        closeConfirmModal();
                        
                        // Mettre √† jour les listes locales
                        categories = categories.filter(c => c.id !== category.id);
                        products.forEach(product => {
                            if (product.category === category.name) {
                                product.category = '';
                            }
                        });
                        
                        updateDashboard();
                        displayProducts(products);
                        displayCategories();
                        displayUncategorizedProducts();
                        loadCategoriesForSelect();
                        updateCategoryFilters();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur de suppression de la cat√©gorie:", error);
                        showToast("Erreur lors de la suppression de la cat√©gorie: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de la suppression de la cat√©gorie: " + error.message, "error");
            }
        }
        
        function saveStockMovementToFirebase(movementData, productId, newStock) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return;
            }
            
            showToast("Enregistrement en cours...", "info");
            
            try {
                // Pr√©parer les donn√©es du mouvement
                const movementToSave = {
                    productId: movementData.productId,
                    productName: movementData.productName,
                    type: movementData.type,
                    quantity: parseFloat(movementData.quantity) || 0,
                    unitPrice: parseFloat(movementData.unitPrice) || 0,
                    total: parseFloat(movementData.total) || 0,
                    date: movementData.date || new Date().toISOString(),
                    supplier: movementData.supplier || '',
                    reference: movementData.reference || '',
                    notes: movementData.notes || '',
                    reason: movementData.reason || '',
                    createdAt: new Date().toISOString(),
                    user: movementData.user || 'Administrateur'
                };
                
                // Enregistrer le mouvement
                const movementRef = database.ref('stockMovements').push();
                movementToSave.id = movementRef.key;
                
                movementRef.set(movementToSave)
                    .then(() => {
                        // Mettre √† jour le stock du produit
                        const productRef = database.ref('products/' + productId + '/stock');
                        return productRef.set(parseFloat(newStock) || 0);
                    })
                    .then(() => {
                        const message = movementData.type === 'in' 
                            ? "Entr√©e en stock enregistr√©e!" 
                            : "Sortie de stock enregistr√©e!";
                        showToast(message, "success");
                        
                        if (movementData.type === 'in') {
                            closeStockInModal();
                        } else {
                            closeStockOutModal();
                        }
                        
                        // Recharger les donn√©es
                        loadProducts();
                        loadStockMovements();
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur d'enregistrement:", error);
                        showToast("Erreur lors de l'enregistrement: " + error.message, "error");
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de l'enregistrement: " + error.message, "error");
            }
        }
        
        function updateStockInFirebase(productId, newStock, movementData) {
            if (!database) {
                showToast("Erreur: Base de donn√©es non connect√©e", "error");
                return false;
            }
            
            try {
                // Enregistrer le mouvement
                const movementRef = database.ref('stockMovements').push();
                movementData.id = movementRef.key;
                
                movementRef.set(movementData)
                    .then(() => {
                        // Mettre √† jour le stock du produit
                        const productRef = database.ref('products/' + productId + '/stock');
                        return productRef.set(newStock);
                    })
                    .then(() => {
                        console.log("‚úÖ Stock mis √† jour dans Firebase");
                        return true;
                    })
                    .catch((error) => {
                        console.error("‚ùå Erreur mise √† jour stock:", error);
                        showToast("Erreur lors de la mise √† jour du stock: " + error.message, "error");
                        return false;
                    });
                    
            } catch (error) {
                console.error("‚ùå Erreur:", error);
                showToast("Erreur lors de la mise √† jour du stock: " + error.message, "error");
                return false;
            }
        }
        
        // ==================== GESTION DES ACTIONS DE CONFIRMATION ====================
        
        // √âcouteur pour le bouton de confirmation
        document.getElementById('confirmActionBtn').addEventListener('click', function() {
            if (confirmAction === 'deleteProduct') {
                const productId = confirmData;
                if (isDemoMode) {
                    // Mode d√©mo
                    products = products.filter(p => p.id !== productId);
                    showToast("Produit supprim√© (mode d√©mo)", "success");
                    updateDashboard();
                    displayProducts(products);
                    displayUncategorizedProducts();
                    closeConfirmModal();
                } else {
                    // Mode Firebase
                    deleteProductFromFirebase(productId);
                }
            } else if (confirmAction === 'deleteCategory') {
                const category = confirmData;
                if (isDemoMode) {
                    // Mode d√©mo
                    categories = categories.filter(c => c.id !== category.id);
                    products.forEach(product => {
                        if (product.category === category.name) {
                            product.category = '';
                        }
                    });
                    showToast("Cat√©gorie supprim√©e (mode d√©mo)", "success");
                    updateDashboard();
                    displayProducts(products);
                    displayCategories();
                    displayUncategorizedProducts();
                    loadCategoriesForSelect();
                    updateCategoryFilters();
                    closeConfirmModal();
                } else {
                    // Mode Firebase
                    deleteCategoryFromFirebase(category);
                }
            }
        });
        
        // ==================== NETTOYAGE ====================
        
        // D√©tacher les √©couteurs Firebase quand la page se ferme
        window.addEventListener('beforeunload', function() {
            firebaseListeners.forEach(listenerInfo => {
                if (listenerInfo.ref && listenerInfo.listener) {
                    listenerInfo.ref.off('value', listenerInfo.listener);
                }
            });
            firebaseListeners = [];
        });
    </script>
</body>
</html>
