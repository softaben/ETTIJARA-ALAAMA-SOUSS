<!DOCTYPE html>
<html lang="fr" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETTIJARA ALAAMA SOUSS - Syst√®me de Ventes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --accent: #1565c0;
            --light: #e3f2fd;
            --bg: #f5f7fa;
            --text: #333333;
            --text-light: #666666;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --primary: #3949ab;
            --secondary: #1565c0;
            --accent: #42a5f5;
            --light: #1e293b;
            --bg: #0f172a;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --card-bg: #1e293b;
            --border: #334155;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #ef5350;
            --shadow: 0 3px 15px rgba(0,0,0,0.3);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text);
            direction: rtl; 
            min-height: 100vh;
        }

        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 30px; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .logo i { 
            font-size: 28px; 
        }
        
        .logo h1 { 
            font-size: 22px; 
            font-weight: 700; 
        }

        /* Navigation */
        .main-nav {
            display: flex;
            gap: 5px;
            margin-left: 30px;
            overflow-x: auto;
            max-width: 600px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(30deg);
        }

        .theme-toggle .fa-sun {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .fa-sun {
            display: block;
        }

        [data-theme="dark"] .theme-toggle .fa-moon {
            display: none;
        }
        
        /* Main Content */
        .main-content { 
            padding: 90px 30px 30px; 
            min-height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .page-header h2 {
            color: var(--primary);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-header .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #2e7d32;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Table Container */
        .table-container {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 25px;
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        select, input, textarea {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-weight: 600;
            color: var(--text);
            outline: none;
            background: var(--card-bg);
        }

        select:focus, input:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1);
        }
        
        select {
            min-width: 200px;
            cursor: pointer;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th {
            background: var(--light);
            padding: 15px;
            border-bottom: 2px solid var(--border);
            text-align: center;
            color: var(--primary);
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            color: var(--text);
            font-weight: 500;
        }
        
        tr:hover {
            background-color: var(--light);
        }
        
        /* Modal Overlay */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        /* --- MODULE IMPRESSION A5 --- */
        #a5DeliveryNote { 
            display: none; 
            width: 148mm; 
            min-height: 210mm; 
            padding: 7mm;
            background: white; 
            margin: 0 auto; 
            color: #000;
            direction: ltr;
            position: relative;
            box-sizing: border-box;
        }

        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2.5px solid #000;
            padding-bottom: 8px;
            margin-bottom: 5px;
        }
        
        .print-title {
            text-align: center;
            margin: 10px 0 5px 0;
        }
        
        .print-title h2 {
            border: 2px solid #000;
            display: inline-block;
            padding: 5px 20px;
            font-size: 16px;
            margin: 0;
        }

        /* Informations client en horizontal */
        .client-info-horizontal {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            font-size: 9.5px;
        }

        .client-info-column {
            flex: 1;
            min-width: 0;
        }

        .client-info-column p {
            margin: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* TABLEAU OPTIMIS√â */
        .print-table-container {
            margin-top: 5px;
            overflow: hidden;
        }
        
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            table-layout: fixed;
            font-size: 9px !important;
        }
        
        .print-table th, .print-table td {
            border: 1.5px solid #000;
            padding: 4px 3px !important;
            font-size: 9px !important;
            text-align: center;
            height: auto !important;
            line-height: 1.2;
            vertical-align: middle;
            min-height: 5mm;
            max-height: 6mm;
        }
        
        .print-table th {
            background: #f2f2f2 !important;
            font-weight: bold;
            padding: 5px 3px !important;
        }
        
        /* Largeurs sp√©cifiques des colonnes */
        .print-table th:nth-child(1),
        .print-table td:nth-child(1) {
            width: 7%;
        }
        
        .print-table th:nth-child(2),
        .print-table td:nth-child(2) {
            width: 53%;
            text-align: left;
            padding-left: 5px !important;
        }
        
        .print-table th:nth-child(3),
        .print-table td:nth-child(3) {
            width: 10%;
        }
        
        .print-table th:nth-child(4),
        .print-table td:nth-child(4) {
            width: 15%;
        }
        
        .print-table th:nth-child(5),
        .print-table td:nth-child(5) {
            width: 15%;
        }

        /* ÿßŸÑÿµŸÅ ÿßŸÑÿ£ÿÆŸäÿ± ŸÖÿπ ÿßŸÑÿ≠ÿØŸàÿØ ÿßŸÑŸÉÿßŸÖŸÑÿ© */
        .print-table tr:last-child td {
            border-bottom: 1.5px solid #000;
        }

        .print-footer {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding-top: 10px;
        }

        .round-stamp {
            width: 110px;
            height: 110px;
            border: 3px double var(--primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: var(--primary);
            font-weight: bold;
            transform: rotate(-12deg);
            font-size: 8px;
        }

        .round-stamp .comp-name {
            font-size: 8px;
            text-transform: uppercase;
            line-height: 1.1;
        }
        
        .round-stamp .depo-label {
            font-size: 7px;
            border-top: 1px solid var(--primary);
            width: 80%;
            margin-top: 2px;
            padding-top: 1px;
        }
        
        .round-stamp .depo-name {
            font-size: 9px;
            color: var(--danger);
            line-height: 1.1;
        }

        .sig-box {
            border-top: 1px solid #000;
            width: 140px;
            margin-top: 30px;
            text-align: center;
            font-size: 10px;
            padding-top: 3px;
        }

        .page-break {
            page-break-before: always;
            margin-top: 20mm;
        }

        /* Mode d√©mo */
        .demo-mode {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        @media print {
            body * { 
                visibility: hidden; 
            }
            
            #a5DeliveryNote, #a5DeliveryNote * { 
                visibility: visible; 
            }
            
            #a5DeliveryNote {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 148mm;
                height: 210mm;
                border: none;
                margin: 0;
                padding: 7mm;
            }
            
            .no-print { 
                display: none !important; 
            }
            
            @page { 
                size: A5 portrait; 
                margin: 0; 
            }
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .loading i {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 100px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
            color: var(--text);
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }
        
        .toast.success { 
            border-left-color: var(--success); 
        }
        
        .toast.error { 
            border-left-color: var(--danger); 
        }
        
        .toast.warning { 
            border-left-color: var(--warning); 
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background-color: rgba(217, 119, 6, 0.1);
            color: #d97706;
        }
        
        .status-processing {
            background-color: rgba(29, 78, 216, 0.1);
            color: #1d4ed8;
        }
        
        .status-delivered {
            background-color: rgba(6, 95, 70, 0.1);
            color: #065f46;
        }
        
        .status-cancelled {
            background-color: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }

        .status-paid {
            background-color: rgba(6, 95, 70, 0.1);
            color: #065f46;
        }

        .status-partial {
            background-color: rgba(217, 119, 6, 0.1);
            color: #d97706;
        }

        .status-unpaid {
            background-color: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }
        
        /* Formulaire cr√©ation bon */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* Search Input avec bouton */
        .search-input-container {
            position: relative;
        }
        
        .search-input-container .form-control {
            padding-right: 50px;
        }
        
        .search-btn {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background: var(--secondary);
        }
        
        /* Modal de recherche */
        .search-modal-content {
            max-width: 600px;
            max-height: 80vh;
        }
        
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .search-input-group {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input-group input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text);
        }
        
        .search-input-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
        }
        
        .search-result-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
        }
        
        .search-result-item:hover {
            background-color: var(--light);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .client-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .client-details {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .client-details span {
            margin-right: 10px;
        }
        
        .product-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .product-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
        }
        
        .product-price {
            font-weight: bold;
            color: var(--success);
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        /* Stats info */
        .stats-info {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-light);
            border: 1px solid var(--border);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .stat-icon.sales {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .stat-icon.revenue {
            background: linear-gradient(135deg, var(--success), #4caf50);
        }

        .stat-icon.pending {
            background: linear-gradient(135deg, var(--warning), #ff9800);
        }

        .stat-info h3 {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-info p {
            color: var(--text-light);
            font-size: 14px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .main-nav {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .controls { 
                flex-direction: column; 
                align-items: stretch; 
                gap: 15px;
            }
            
            .header { 
                padding: 0 15px; 
                height: 60px;
            }
            
            .main-content { 
                padding: 80px 15px 15px; 
            }
            
            .logo h1 {
                font-size: 18px;
            }
            
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .page-header .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            select {
                min-width: 100%;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .modal-content {
                padding: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .theme-toggle {
                width: 35px;
                height: 35px;
            }

            .quick-stats {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .print-footer {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .sig-box {
                width: 120px;
            }

            .logo h1 {
                font-size: 16px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .btn {
                padding: 8px 15px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <i class="fas fa-truck"></i>
            <h1>ETTIJARA ALAAMA SOUSS</h1>
        </div>
        
        <nav class="main-nav">
            <a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
            <a href="stock.html" class="nav-link"><i class="fas fa-boxes"></i> Stock</a>
            <a href="ventes.html" class="nav-link active"><i class="fas fa-truck"></i> Ventes</a>
            <a href="achats.html" class="nav-link"><i class="fas fa-shopping-cart"></i> Achats</a>
            <a href="clients.html" class="nav-link"><i class="fas fa-users"></i> Clients</a>
            <a href="suppliers.html" class="nav-link"><i class="fas fa-warehouse"></i> Fournisseurs</a>
            <a href="paiements.html" class="nav-link"><i class="fas fa-money-bill-wave"></i> Paiements</a>
            <a href="parametres.html" class="nav-link"><i class="fas fa-cog"></i> Param√®tres</a>
        </nav>
        
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="theme-toggle" id="themeToggle" title="Changer le th√®me">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
            <span style="font-size: 14px;">Syst√®me de Ventes</span>
            <div id="connectionStatus" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;" title="Statut de connexion"></div>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-truck"></i> Gestion des Ventes</h2>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openCreateDelivery()">
                    <i class="fas fa-plus"></i> Nouvelle Vente
                </button>
                <button class="btn btn-outline" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="stat-icon sales">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalSales">0</h3>
                    <p>Ventes aujourd'hui</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon revenue">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalRevenue">0 DH</h3>
                    <p>Chiffre d'affaires</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3 id="pendingSales">0</h3>
                    <p>Ventes en attente</p>
                </div>
            </div>
        </div>

        <div class="table-container">
            <div id="demoModeIndicator" class="demo-mode" style="display: none;">
                <i class="fas fa-info-circle"></i> Mode d√©mo activ√© - Donn√©es locales utilis√©es
            </div>
            
            <div class="controls">
                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <label><i class="fas fa-warehouse"></i> S√©lectionner le D√©p√¥t :</label>
                    <select id="depotSelector">
                        <option value="">Chargement des d√©p√¥ts...</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <select id="statusFilter" style="min-width: 150px;">
                        <option value="">Tous les statuts</option>
                        <option value="pending">En attente</option>
                        <option value="processing">En cours</option>
                        <option value="delivered">Livr√©</option>
                        <option value="cancelled">Annul√©</option>
                    </select>
                    
                    <input type="date" id="dateFilter" style="min-width: 150px;">
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>N¬∞ Bon</th>
                        <th>Client</th>
                        <th>T√©l√©phone</th>
                        <th>Date</th>
                        <th>D√©p√¥t</th>
                        <th>Total (DH)</th>
                        <th>Statut</th>
                        <th>Paiement</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="deliveriesTableBody">
                    <tr>
                        <td colspan="9" class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Connexion √† la base de donn√©es...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div class="stats-info">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="statsInfo">Chargement des statistiques...</span>
                    <span id="lastUpdate">Derni√®re mise √† jour: --:--</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal d'impression -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="no-print" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary);"><i class="fas fa-print"></i> Bon de Livraison A5</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="printDeliveryNote()">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <button class="btn btn-outline" onclick="closeModal()">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
            </div>
            <div id="a5DeliveryNote">
                <!-- Le contenu du bon sera inject√© ici -->
            </div>
        </div>
    </div>

    <!-- Modal de cr√©ation de bon -->
    <div class="modal" id="createModal" style="display: none;">
        <div class="modal-content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color: var(--primary);"><i class="fas fa-plus-circle"></i> Cr√©er une Nouvelle Vente</h3>
                <button class="btn btn-outline" onclick="closeCreateModal()">
                    <i class="fas fa-times"></i> Annuler
                </button>
            </div>
            
            <div id="createForm" style="max-height: 70vh; overflow-y: auto;">
                <div class="form-section">
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--light); padding-bottom: 8px;">
                        <i class="fas fa-info-circle"></i> Informations du Bon
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newBonNumber">Num√©ro du Bon *</label>
                            <input type="text" id="newBonNumber" class="form-control" value="BL-2024-001" readonly>
                        </div>
                        <div class="form-group">
                            <label for="newBonDate">Date du Bon *</label>
                            <input type="date" id="newBonDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newDepotSelect">D√©p√¥t *</label>
                            <select id="newDepotSelect" class="form-control">
                                <option value="">S√©lectionner un d√©p√¥t</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newDriver">Livreur</label>
                            <input type="text" id="newDriver" class="form-control" placeholder="Nom du livreur">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--light); padding-bottom: 8px;">
                        <i class="fas fa-user"></i> Informations Client
                    </h4>
                    
                    <div class="form-group search-input-container">
                        <label for="clientSearch">Rechercher Client *</label>
                        <input type="text" id="clientSearch" class="form-control" 
                               placeholder="Cliquez pour rechercher un client..." readonly
                               onclick="openClientSearch()">
                        <button class="search-btn" onclick="openClientSearch()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newClientName">Nom Complet *</label>
                            <input type="text" id="newClientName" class="form-control" readonly required>
                        </div>
                        <div class="form-group">
                            <label for="newClientPhone">T√©l√©phone *</label>
                            <input type="tel" id="newClientPhone" class="form-control" readonly required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newClientAddress">Adresse de Livraison *</label>
                        <textarea id="newClientAddress" class="form-control" rows="2" required></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--light); padding-bottom: 8px;">
                        <i class="fas fa-boxes"></i> Articles
                    </h4>
                    
                    <div id="itemsContainer">
                        <!-- Les articles seront ajout√©s ici dynamiquement -->
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn btn-primary" onclick="addNewItem()">
                            <i class="fas fa-plus"></i> Ajouter un article
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">Total G√©n√©ral:</span>
                            <span id="totalAmount" style="font-size: 18px; font-weight: bold; color: var(--primary);">0.00 DH</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--light); padding-bottom: 8px;">
                        <i class="fas fa-sticky-note"></i> Remarques et Paiement
                    </h4>
                    <div class="form-group">
                        <label for="newNotes">Remarques</label>
                        <textarea id="newNotes" class="form-control" rows="2" placeholder="Remarques suppl√©mentaires..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPaymentMethod">Mode de Paiement</label>
                            <select id="newPaymentMethod" class="form-control">
                                <option value="cash">Esp√®ces</option>
                                <option value="check">Ch√®que</option>
                                <option value="card">Carte Bancaire</option>
                                <option value="transfer">Virement</option>
                                <option value="credit">Cr√©dit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="newPaymentStatus">Statut Paiement</label>
                            <select id="newPaymentStatus" class="form-control">
                                <option value="pending">En attente</option>
                                <option value="partial">Partiel</option>
                                <option value="paid">Pay√©</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--light); display: flex; justify-content: flex-end; gap: 15px;">
                    <button type="button" class="btn btn-outline" onclick="closeCreateModal()">
                        Annuler
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveNewDelivery()">
                        <i class="fas fa-save"></i> Enregistrer et Imprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de recherche clients -->
    <div class="modal" id="clientSearchModal" style="display: none;">
        <div class="modal-content search-modal-content">
            <div class="search-header">
                <h3 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-users"></i> Recherche de Clients
                </h3>
                <button class="btn btn-outline" onclick="closeClientSearch()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
            
            <div class="search-input-group">
                <input type="text" id="clientSearchInput" placeholder="Tapez pour rechercher un client par nom ou t√©l√©phone..." 
                       onkeyup="searchClients(this.value)">
                <i class="fas fa-search"></i>
            </div>
            
            <div class="search-results" id="clientSearchResults">
                <!-- Les r√©sultats de recherche seront affich√©s ici -->
            </div>
        </div>
    </div>

    <!-- Modal de recherche produits -->
    <div class="modal" id="productSearchModal" style="display: none;">
        <div class="modal-content search-modal-content">
            <div class="search-header">
                <h3 style="color: var(--primary); margin: 0;">
                    <i class="fas fa-boxes"></i> Recherche de Produits
                </h3>
                <button class="btn btn-outline" onclick="closeProductSearch()">
                    <i class="fas fa-times"></i> Fermer
                </button>
            </div>
            
            <div class="search-input-group">
                <input type="text" id="productSearchInput" placeholder="Tapez pour rechercher un produit par nom..." 
                       onkeyup="searchProducts(this.value)">
                <i class="fas fa-search"></i>
            </div>
            
            <div class="search-results" id="productSearchResults">
                <!-- Les r√©sultats de recherche seront affich√©s ici -->
            </div>
        </div>
    </div>

    <!-- Modal de confirmation -->
    <div class="modal" id="confirmModal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                <h3 style="color: var(--text); margin-bottom: 10px;" id="confirmTitle">Confirmation</h3>
                <p id="confirmMessage">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
                <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-outline" onclick="closeConfirmModal()">
                        Annuler
                    </button>
                    <button class="btn btn-danger" id="confirmActionBtn">
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GESTION DU THEME ====================
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                showToast(`Th√®me ${newTheme === 'dark' ? 'sombre' : 'clair'} activ√©`, 'success');
            });
        }

        // ==================== CONFIGURATION FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAV_c5Gt_f1h5nZF47FcPjW_h4P24LYADk",
            authDomain: "commerce22-610cc.firebaseapp.com",
            databaseURL: "https://commerce22-610cc-default-rtdb.firebaseio.com",
            projectId: "commerce22-610cc",
            storageBucket: "commerce22-610cc.firebasestorage.app",
            messagingSenderId: "458158894252",
            appId: "1:458158894252:web:d1e640b2e16ef32d978309"
        };
        
        // ==================== VARIABLES GLOBALES ====================
        let database = null;
        let isConnected = false;
        let isDemoMode = false;
        let deliveries = [];
        let depots = [];
        let clients = [];
        let products = [];
        let currentDelivery = null;
        let currentSearchType = null;
        let currentProductInput = null;
        let confirmCallback = null;
        
        // ==================== FONCTIONS UTILITAIRES ====================
        
        function showToast(message, type = "success") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            isConnected = connected;
            
            if (connected) {
                statusElement.style.background = "#10b981";
                statusElement.title = "Connect√© √† Firebase";
                document.getElementById('demoModeIndicator').style.display = 'none';
            } else {
                statusElement.style.background = "#ef4444";
                statusElement.title = "Non connect√©";
                if (isDemoMode) {
                    document.getElementById('demoModeIndicator').style.display = 'block';
                }
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '--';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return '--';
            }
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `Derni√®re mise √† jour: ${timeString}`;
        }
        
        function generateBonNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            const todayDeliveries = deliveries.filter(d => {
                if (!d.createdAt && !d.date) return false;
                const deliveryDate = new Date(d.createdAt || d.date);
                return deliveryDate.toDateString() === date.toDateString();
            });
            
            const sequence = (todayDeliveries.length + 1).toString().padStart(3, '0');
            return `VTE-${year}${month}${day}-${sequence}`;
        }

        function getStatusText(status) {
            switch(status) {
                case 'pending': return 'En attente';
                case 'processing': return 'En cours';
                case 'delivered': return 'Livr√©';
                case 'cancelled': return 'Annul√©';
                default: return 'Inconnu';
            }
        }

        function getPaymentStatusText(status) {
            switch(status) {
                case 'paid': return 'Pay√©';
                case 'partial': return 'Partiel';
                case 'pending': return 'Impay√©';
                default: return status;
            }
        }
        
        // ==================== MODE D√âMO ====================
        
        function initializeDemoMode() {
            console.log("üöÄ Initialisation du mode d√©mo...");
            isDemoMode = true;
            updateConnectionStatus(false);
            
            // Donn√©es d√©mo pour les d√©p√¥ts
            depots = [
                {
                    id: "depot1",
                    name: "D√©p√¥t Principal",
                    city: "Agadir"
                },
                {
                    id: "depot2", 
                    name: "D√©p√¥t Secondaire",
                    city: "Ait Melloul"
                }
            ];
            
            // Donn√©es d√©mo pour les clients
            clients = [
                {
                    id: "client1",
                    name: "Mohamed Ali",
                    phone: "0612345678",
                    address: "123 Rue Principale, Agadir",
                    credit: 1500.00
                },
                {
                    id: "client2",
                    name: "Fatima Zahra",
                    phone: "0623456789", 
                    address: "456 Avenue des Orangers, Ait Melloul",
                    credit: 0.00
                },
                {
                    id: "client3",
                    name: "Karim Bennani",
                    phone: "0634567890",
                    address: "789 Boulevard Mohammed V, Inezgane",
                    credit: 3200.50
                }
            ];
            
            // Donn√©es d√©mo pour les produits
            products = [
                {
                    id: "prod1",
                    name: "Ciment 50kg",
                    price: 85.50,
                    stock: 100,
                    unit: "Sac"
                },
                {
                    id: "prod2",
                    name: "Sable fin",
                    price: 450.00,
                    stock: 500,
                    unit: "M3"
                },
                {
                    id: "prod3",
                    name: "Gravier 5/15",
                    price: 520.00,
                    stock: 300,
                    unit: "M3"
                },
                {
                    id: "prod4",
                    name: "Brique 20x40",
                    price: 3.20,
                    stock: 5000,
                    unit: "Unit√©"
                },
                {
                    id: "prod5",
                    name: "Tuyau PVC 100mm",
                    price: 125.00,
                    stock: 50,
                    unit: "ML"
                }
            ];
            
            // Donn√©es d√©mo pour les ventes
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            deliveries = [
                {
                    id: "del1",
                    bonNumber: "VTE-20240215-001",
                    bonDate: today.toISOString().split('T')[0],
                    clientName: "Mohamed Ali",
                    clientPhone: "0612345678",
                    clientAddress: "123 Rue Principale, Agadir",
                    depotId: "depot1",
                    driver: "Ahmed",
                    items: [
                        {
                            name: "Ciment 50kg",
                            quantity: 10,
                            price: 85.50,
                            total: 855.00
                        },
                        {
                            name: "Sable fin",
                            quantity: 2,
                            price: 450.00,
                            total: 900.00
                        }
                    ],
                    totalAmount: 1755.00,
                    status: "delivered",
                    paymentMethod: "cash",
                    paymentStatus: "paid",
                    notes: "Livraison urgente",
                    createdAt: today.toISOString()
                },
                {
                    id: "del2",
                    bonNumber: "VTE-20240214-001",
                    bonDate: yesterday.toISOString().split('T')[0],
                    clientName: "Fatima Zahra",
                    clientPhone: "0623456789",
                    clientAddress: "456 Avenue des Orangers, Ait Melloul",
                    depotId: "depot2",
                    driver: "Hassan",
                    items: [
                        {
                            name: "Brique 20x40",
                            quantity: 500,
                            price: 3.20,
                            total: 1600.00
                        },
                        {
                            name: "Ciment 50kg",
                            quantity: 5,
                            price: 85.50,
                            total: 427.50
                        }
                    ],
                    totalAmount: 2027.50,
                    status: "processing",
                    paymentMethod: "check",
                    paymentStatus: "pending",
                    notes: "",
                    createdAt: yesterday.toISOString()
                },
                {
                    id: "del3",
                    bonNumber: "VTE-20240213-001",
                    bonDate: "2024-02-13",
                    clientName: "Karim Bennani",
                    clientPhone: "0634567890",
                    clientAddress: "789 Boulevard Mohammed V, Inezgane",
                    depotId: "depot1",
                    driver: "Rachid",
                    items: [
                        {
                            name: "Tuyau PVC 100mm",
                            quantity: 10,
                            price: 125.00,
                            total: 1250.00
                        }
                    ],
                    totalAmount: 1250.00,
                    status: "pending",
                    paymentMethod: "credit",
                    paymentStatus: "partial",
                    notes: "Paiement partiel re√ßu",
                    createdAt: "2024-02-13T09:30:00Z"
                }
            ];
            
            updateDepotSelectors();
            updateDeliveriesTable();
            updateStats();
            updateLastUpdateTime();
            updateQuickStats();
            
            showToast("Mode d√©mo activ√©. Vous pouvez tester l'application avec des donn√©es locales.", "warning");
        }

        function updateQuickStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // Ventes aujourd'hui
            const todaySales = deliveries.filter(d => 
                d.bonDate === today || (d.createdAt && d.createdAt.split('T')[0] === today)
            ).length;
            
            // Chiffre d'affaires
            const totalRevenue = deliveries.reduce((sum, delivery) => {
                return sum + (delivery.totalAmount || 0);
            }, 0);
            
            // Ventes en attente
            const pendingSales = deliveries.filter(d => d.status === 'pending').length;
            
            document.getElementById('totalSales').textContent = todaySales;
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2) + ' DH';
            document.getElementById('pendingSales').textContent = pendingSales;
        }
        
        // ==================== GESTION DU FORMULAIRE ====================

        function openCreateDelivery() {
            console.log("üîß Ouverture du formulaire de cr√©ation...");
            
            // G√©n√©rer un nouveau num√©ro de bon
            document.getElementById('newBonNumber').value = generateBonNumber();
            
            // D√©finir la date d'aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newBonDate').value = today;
            
            // R√©initialiser le formulaire
            document.getElementById('clientSearch').value = '';
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('newClientAddress').value = '';
            document.getElementById('newDriver').value = '';
            document.getElementById('newNotes').value = '';
            document.getElementById('newPaymentMethod').value = 'cash';
            document.getElementById('newPaymentStatus').value = 'pending';
            document.getElementById('newDepotSelect').value = '';
            
            // R√©initialiser les articles
            const itemsContainer = document.getElementById('itemsContainer');
            itemsContainer.innerHTML = `
                <div class="form-row item-row">
                    <div class="form-group" style="flex: 3; position: relative;">
                        <label>D√©signation *</label>
                        <input type="text" class="form-control item-name" 
                               placeholder="Cliquez pour rechercher un produit..." 
                               onclick="openProductSearch(this)" readonly>
                        <button class="search-btn" onclick="openProductSearch(this)" 
                                style="left: 5px; top: 35px; width: 35px; height: 35px;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Quantit√© *</label>
                        <input type="number" class="form-control item-quantity" min="1" value="1" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Prix Unitaire (DH) *</label>
                        <input type="number" class="form-control item-price" min="0" step="0.01" value="0" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Total (DH)</label>
                        <input type="text" class="form-control item-total" value="0.00" readonly>
                    </div>
                    <div class="form-group" style="flex: 0.5; display: flex; align-items: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="removeItem(this)" style="padding: 12px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // R√©initialiser le total
            document.getElementById('totalAmount').textContent = '0.00 DH';
            
            // Ajouter les √©v√©nements de calcul
            attachItemCalculations();
            
            // Ouvrir la modal
            document.getElementById('createModal').style.display = 'flex';
            console.log("‚úÖ Formulaire de cr√©ation ouvert");
        }
        
        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }
        
        function addNewItem() {
            const itemsContainer = document.getElementById('itemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'form-row item-row';
            newItem.innerHTML = `
                <div class="form-group" style="flex: 3; position: relative;">
                    <label>D√©signation *</label>
                    <input type="text" class="form-control item-name" 
                           placeholder="Cliquez pour rechercher un produit..." 
                           onclick="openProductSearch(this)" readonly>
                    <button class="search-btn" onclick="openProductSearch(this)" 
                            style="left: 5px; top: 35px; width: 35px; height: 35px;">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Quantit√© *</label>
                    <input type="number" class="form-control item-quantity" min="1" value="1" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Prix Unitaire (DH) *</label>
                    <input type="number" class="form-control item-price" min="0" step="0.01" value="0" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Total (DH)</label>
                    <input type="text" class="form-control item-total" value="0.00" readonly>
                </div>
                <div class="form-group" style="flex: 0.5; display: flex; align-items: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="removeItem(this)" style="padding: 12px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            itemsContainer.appendChild(newItem);
            attachItemCalculations();
        }
        
        function removeItem(button) {
            const itemRow = button.closest('.item-row');
            if (itemRow && document.querySelectorAll('.item-row').length > 1) {
                itemRow.remove();
                calculateTotal();
            } else {
                showToast("Au moins un article est requis", "warning");
            }
        }
        
        function attachItemCalculations() {
            const quantityInputs = document.querySelectorAll('.item-quantity');
            const priceInputs = document.querySelectorAll('.item-price');
            
            quantityInputs.forEach(input => {
                input.addEventListener('input', calculateItemTotalHandler);
            });
            
            priceInputs.forEach(input => {
                input.addEventListener('input', calculateItemTotalHandler);
            });
            
            // Calculer les totaux initiaux
            document.querySelectorAll('.item-row').forEach(row => {
                calculateItemTotalForRow(row);
            });
        }
        
        function calculateItemTotalHandler(event) {
            const itemRow = event.target.closest('.item-row');
            calculateItemTotalForRow(itemRow);
        }
        
        function calculateItemTotalForRow(itemRow) {
            if (!itemRow) return;
            
            const quantity = parseFloat(itemRow.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(itemRow.querySelector('.item-price').value) || 0;
            const total = (quantity * price).toFixed(2);
            
            itemRow.querySelector('.item-total').value = total;
            calculateTotal();
        }
        
        function calculateTotal() {
            let grandTotal = 0;
            const itemRows = document.querySelectorAll('.item-row');
            
            itemRows.forEach(row => {
                const totalInput = row.querySelector('.item-total');
                const itemTotal = parseFloat(totalInput.value) || 0;
                grandTotal += itemTotal;
            });
            
            document.getElementById('totalAmount').textContent = `${grandTotal.toFixed(2)} DH`;
        }
        
        // ==================== RECHERCHE CLIENTS ET PRODUITS ====================
        
        function openClientSearch() {
            currentSearchType = 'client';
            document.getElementById('clientSearchModal').style.display = 'flex';
            document.getElementById('clientSearchInput').value = '';
            document.getElementById('clientSearchInput').focus();
            displayAllClients();
        }
        
        function closeClientSearch() {
            document.getElementById('clientSearchModal').style.display = 'none';
            currentSearchType = null;
        }
        
        function searchClients(query) {
            const resultsContainer = document.getElementById('clientSearchResults');
            
            if (!query || query.trim() === '') {
                displayAllClients();
                return;
            }
            
            query = query.toLowerCase().trim();
            const filteredClients = clients.filter(client => {
                const name = (client.name || '').toLowerCase();
                const phone = (client.phone || '').toLowerCase();
                const address = (client.address || '').toLowerCase();
                
                return name.includes(query) || phone.includes(query) || address.includes(query);
            });
            
            displayClientResults(filteredClients);
        }
        
        function displayAllClients() {
            displayClientResults(clients);
        }
        
        function displayClientResults(clientsList) {
            const resultsContainer = document.getElementById('clientSearchResults');
            
            if (clientsList.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-user-slash" style="font-size: 48px; margin-bottom: 15px; color: var(--text-light);"></i>
                        <p>Aucun client trouv√©</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            clientsList.forEach(client => {
                const credit = client.credit || 0;
                html += `
                    <div class="search-result-item" onclick="selectClient('${client.id}')">
                        <div class="client-name">${client.name || 'Nom non sp√©cifi√©'}</div>
                        <div class="client-details">
                            <span><i class="fas fa-phone"></i> ${client.phone || 'Non sp√©cifi√©'}</span>
                            ${credit > 0 ? `<span><i class="fas fa-money-bill-wave"></i> Cr√©dit: ${credit.toFixed(2)} DH</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }
        
        function selectClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showToast("Client non trouv√©", "error");
                return;
            }
            
            document.getElementById('newClientName').value = client.name || '';
            document.getElementById('newClientPhone').value = client.phone || '';
            document.getElementById('newClientAddress').value = client.address || '';
            document.getElementById('clientSearch').value = client.name || '';
            
            closeClientSearch();
            showToast(`Client "${client.name}" s√©lectionn√©`, "success");
        }
        
        function openProductSearch(inputElement) {
            currentSearchType = 'product';
            currentProductInput = inputElement;
            document.getElementById('productSearchModal').style.display = 'flex';
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productSearchInput').focus();
            displayAllProducts();
        }
        
        function closeProductSearch() {
            document.getElementById('productSearchModal').style.display = 'none';
            currentSearchType = null;
            currentProductInput = null;
        }
        
        function searchProducts(query) {
            const resultsContainer = document.getElementById('productSearchResults');
            
            if (!query || query.trim() === '') {
                displayAllProducts();
                return;
            }
            
            query = query.toLowerCase().trim();
            const filteredProducts = products.filter(product => {
                const name = (product.name || '').toLowerCase();
                const description = (product.description || '').toLowerCase();
                const code = (product.code || '').toLowerCase();
                
                return name.includes(query) || description.includes(query) || code.includes(query);
            });
            
            displayProductResults(filteredProducts);
        }
        
        function displayAllProducts() {
            displayProductResults(products);
        }
        
        function displayProductResults(productsList) {
            const resultsContainer = document.getElementById('productSearchResults');
            
            if (productsList.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 15px; color: var(--text-light);"></i>
                        <p>Aucun produit trouv√©</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            productsList.forEach(product => {
                const price = product.price || product.salePrice || 0;
                const stock = product.stock || 0;
                const unit = product.unit || '';
                
                html += `
                    <div class="search-result-item" onclick="selectProduct('${product.id}')">
                        <div class="product-name">${product.name || 'Produit sans nom'}</div>
                        <div class="product-details">
                            <div>
                                ${product.code ? `<span><i class="fas fa-barcode"></i> ${product.code}</span>` : ''}
                                ${stock > 0 ? `<span><i class="fas fa-cubes"></i> ${stock} ${unit}</span>` : ''}
                            </div>
                            <div class="product-price">${price.toFixed(2)} DH</div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
        }
        
        function selectProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showToast("Produit non trouv√©", "error");
                return;
            }
            
            if (!currentProductInput) {
                showToast("Erreur: aucun champ produit s√©lectionn√©", "error");
                return;
            }
            
            const itemRow = currentProductInput.closest('.item-row');
            if (!itemRow) {
                showToast("Erreur: ligne d'article non trouv√©e", "error");
                return;
            }
            
            itemRow.querySelector('.item-name').value = product.name || '';
            itemRow.querySelector('.item-price').value = product.price || product.salePrice || 0;
            
            calculateItemTotalForRow(itemRow);
            closeProductSearch();
            showToast(`Produit "${product.name}" s√©lectionn√©`, "success");
        }
        
        // ==================== ENREGISTREMENT DU BON ====================
        
        function saveNewDelivery() {
            console.log("üíæ Enregistrement de la vente en cours...");
            
            // Validation des champs obligatoires
            const depotId = document.getElementById('newDepotSelect').value;
            const clientName = document.getElementById('newClientName').value.trim();
            const clientPhone = document.getElementById('newClientPhone').value.trim();
            const clientAddress = document.getElementById('newClientAddress').value.trim();
            
            if (!depotId) {
                showToast("Veuillez s√©lectionner un d√©p√¥t", "error");
                return;
            }
            
            if (!clientName) {
                showToast("Veuillez saisir le nom du client", "error");
                return;
            }
            
            if (!clientPhone) {
                showToast("Veuillez saisir le t√©l√©phone du client", "error");
                return;
            }
            
            if (!clientAddress) {
                showToast("Veuillez saisir l'adresse de livraison", "error");
                return;
            }
            
            // R√©cup√©rer les articles
            const items = [];
            const itemRows = document.querySelectorAll('.item-row');
            let hasValidItems = false;
            
            itemRows.forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = parseFloat(row.querySelector('.item-total').value) || 0;
                
                if (name && quantity > 0 && price > 0) {
                    items.push({
                        name: name,
                        quantity: quantity,
                        price: price,
                        total: total
                    });
                    hasValidItems = true;
                }
            });
            
            if (!hasValidItems) {
                showToast("Veuillez ajouter au moins un article valide", "error");
                return;
            }
            
            // Calculer le total g√©n√©ral
            const totalAmount = items.reduce((sum, item) => sum + item.total, 0);
            
            // R√©cup√©rer les valeurs de statut
            const paymentMethod = document.getElementById('newPaymentMethod').value;
            const paymentStatus = document.getElementById('newPaymentStatus').value;
            const status = 'pending'; // Statut par d√©faut pour les nouvelles ventes
            
            // Pr√©parer les donn√©es de la vente
            const bonData = {
                bonNumber: document.getElementById('newBonNumber').value,
                bonDate: document.getElementById('newBonDate').value,
                clientName: clientName,
                clientPhone: clientPhone,
                clientAddress: clientAddress,
                depotId: depotId,
                driver: document.getElementById('newDriver').value.trim(),
                items: items,
                totalAmount: totalAmount,
                notes: document.getElementById('newNotes').value.trim(),
                paymentMethod: paymentMethod,
                paymentStatus: paymentStatus,
                status: status,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            console.log("üì¶ Donn√©es de la vente:", bonData);
            
            if (isDemoMode) {
                // En mode d√©mo, sauvegarder localement
                const newId = 'del' + Date.now();
                deliveries.unshift({
                    id: newId,
                    ...bonData
                });
                
                showToast("Vente cr√©√©e en mode d√©mo!", "success");
                closeCreateModal();
                refreshData();
                
                // Afficher le bon pour impression
                currentDelivery = { ...bonData, id: newId };
                setTimeout(() => {
                    showDeliveryPrint(newId);
                }, 500);
            } else {
                try {
                    // Enregistrer dans Firebase
                    const deliveriesRef = database.ref('sales');
                    const newDeliveryRef = deliveriesRef.push();
                    
                    newDeliveryRef.set(bonData)
                        .then(() => {
                            showToast("Vente cr√©√©e avec succ√®s!", "success");
                            closeCreateModal();
                            refreshData();
                            
                            // Afficher le bon pour impression
                            currentDelivery = { ...bonData, id: newDeliveryRef.key };
                            setTimeout(() => {
                                showDeliveryPrint(newDeliveryRef.key);
                            }, 500);
                        })
                        .catch(error => {
                            console.error("‚ùå Erreur d'enregistrement Firebase:", error);
                            showToast("Erreur lors de l'enregistrement de la vente", "error");
                        });
                    
                } catch (error) {
                    console.error("‚ùå Erreur dans saveNewDelivery:", error);
                    showToast("Erreur lors de l'enregistrement de la vente", "error");
                }
            }
        }
        
        // ==================== INITIALISATION FIREBASE ====================
        
        function initializeFirebase() {
            try {
                console.log("üîß Tentative de connexion √† Firebase...");
                
                // V√©rifier si Firebase est disponible
                if (typeof firebase === 'undefined') {
                    console.error("‚ùå Firebase SDK non charg√©");
                    throw new Error("Firebase SDK non charg√©");
                }
                
                // V√©rifier la configuration
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("‚ùå Configuration Firebase manquante");
                    throw new Error("Configuration Firebase manquante");
                }
                
                // Initialiser Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("‚úÖ Firebase initialis√© avec succ√®s");
                } else {
                    console.log("‚ÑπÔ∏è Firebase d√©j√† initialis√©");
                }
                
                database = firebase.database();
                
                // Tester la connexion
                const testRef = database.ref('.info/connected');
                
                testRef.on('value', (snapshot) => {
                    const connected = snapshot.val() === true;
                    updateConnectionStatus(connected);
                    
                    if (connected) {
                        console.log("‚úÖ Connect√© √† Firebase Realtime Database");
                        isDemoMode = false;
                        loadDepots();
                    } else {
                        console.log("‚ùå D√©connect√© de Firebase");
                        // Basculer en mode d√©mo apr√®s 3 secondes
                        setTimeout(() => {
                            if (!isConnected && !isDemoMode) {
                                console.log("üîÑ Passage en mode d√©mo...");
                                initializeDemoMode();
                            }
                        }, 3000);
                    }
                }, (error) => {
                    console.error("‚ùå Erreur de surveillance de connexion:", error);
                    updateConnectionStatus(false);
                    initializeDemoMode();
                });
                
                // Ajouter un timeout pour la connexion
                setTimeout(() => {
                    if (!isConnected && !isDemoMode) {
                        console.log("‚è±Ô∏è Timeout de connexion - Passage en mode d√©mo");
                        initializeDemoMode();
                    }
                }, 5000);
                
            } catch (error) {
                console.error("‚ùå Erreur d'initialisation Firebase:", error);
                updateConnectionStatus(false);
                showToast("Erreur de connexion Firebase. Mode d√©mo activ√©.", "error");
                initializeDemoMode();
            }
        }
        
        // ==================== CHARGEMENT DES DONN√âES ====================
        
        function loadDepots() {
            if (isDemoMode) {
                updateDepotSelectors();
                updateDeliveriesTable();
                updateStats();
                updateQuickStats();
                return;
            }
            
            try {
                const depotsRef = database.ref('depots');
                
                depotsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    depots = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            depots.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        console.log(`‚úÖ ${depots.length} d√©p√¥ts charg√©s`);
                        updateDepotSelectors();
                        loadClients();
                    } else {
                        console.log("‚ÑπÔ∏è Aucun d√©p√¥t trouv√©");
                        showToast("Aucun d√©p√¥t trouv√© dans la base de donn√©es", "warning");
                        updateDepotSelectors();
                        loadClients();
                    }
                    
                }, (error) => {
                    console.error("‚ùå Erreur de chargement des d√©p√¥ts:", error);
                    showToast("Erreur de chargement des d√©p√¥ts", "error");
                    updateDepotSelectors();
                    loadClients();
                });
                
            } catch (error) {
                console.error("‚ùå Erreur dans loadDepots:", error);
                updateDepotSelectors();
                loadClients();
            }
        }
        
        function loadClients() {
            if (isDemoMode) return;
            
            try {
                const clientsRef = database.ref('clients');
                
                clientsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    clients = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            clients.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        console.log(`‚úÖ ${clients.length} clients charg√©s`);
                        loadProducts();
                    } else {
                        console.log("‚ÑπÔ∏è Aucun client trouv√©");
                        clients = [];
                        loadProducts();
                    }
                    
                }, (error) => {
                    console.error("‚ùå Erreur de chargement des clients:", error);
                    clients = [];
                    loadProducts();
                });
                
            } catch (error) {
                console.error("‚ùå Erreur dans loadClients:", error);
                clients = [];
                loadProducts();
            }
        }
        
        function loadProducts() {
            if (isDemoMode) return;
            
            try {
                const productsRef = database.ref('products');
                
                productsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    products = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            products.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        console.log(`‚úÖ ${products.length} produits charg√©s`);
                        loadDeliveries();
                    } else {
                        console.log("‚ÑπÔ∏è Aucun produit trouv√©");
                        products = [];
                        loadDeliveries();
                    }
                    
                }, (error) => {
                    console.error("‚ùå Erreur de chargement des produits:", error);
                    products = [];
                    loadDeliveries();
                });
                
            } catch (error) {
                console.error("‚ùå Erreur dans loadProducts:", error);
                products = [];
                loadDeliveries();
            }
        }
        
        function loadDeliveries() {
            if (isDemoMode) {
                updateDeliveriesTable();
                updateStats();
                updateQuickStats();
                updateLastUpdateTime();
                return;
            }
            
            try {
                const deliveriesRef = database.ref('sales');
                
                deliveriesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    deliveries = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            deliveries.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        deliveries.sort((a, b) => {
                            const dateA = new Date(a.createdAt || a.date || 0);
                            const dateB = new Date(b.createdAt || b.date || 0);
                            return dateB - dateA;
                        });
                        
                        console.log(`‚úÖ ${deliveries.length} ventes charg√©es`);
                        updateDeliveriesTable();
                        updateStats();
                        updateQuickStats();
                        updateLastUpdateTime();
                        
                    } else {
                        showEmptyState();
                    }
                    
                }, (error) => {
                    console.error("‚ùå Erreur de chargement des ventes:", error);
                    showToast("Erreur de chargement des ventes", "error");
                    showEmptyState();
                });
                
            } catch (error) {
                console.error("‚ùå Erreur dans loadDeliveries:", error);
                showEmptyState();
            }
        }
        
        function updateDepotSelectors() {
            const depotSelect = document.getElementById('depotSelector');
            const newDepotSelect = document.getElementById('newDepotSelect');
            
            let options = '<option value="">Tous les d√©p√¥ts</option>';
            let newOptions = '<option value="">S√©lectionner un d√©p√¥t</option>';
            
            depots.forEach(depot => {
                const depotName = depot.name || 'D√©p√¥t sans nom';
                const depotCity = depot.city ? ` - ${depot.city}` : '';
                options += `<option value="${depot.id}">${depotName}${depotCity}</option>`;
                newOptions += `<option value="${depot.id}">${depotName}${depotCity}</option>`;
            });
            
            depotSelect.innerHTML = options;
            if (newDepotSelect) {
                newDepotSelect.innerHTML = newOptions;
            }
        }
        
        function showEmptyState() {
            const tableBody = document.getElementById('deliveriesTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucune vente trouv√©e</h3>
                        <p style="color: var(--text-light);">${isDemoMode ? 'Mode d√©mo - Cr√©ez une nouvelle vente pour tester' : 'Commencez par cr√©er une nouvelle vente'}</p>
                        <button class="btn btn-primary" onclick="openCreateDelivery()" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Cr√©er une vente
                        </button>
                    </td>
                </tr>
            `;
            updateStats();
            updateQuickStats();
        }
        
        // ==================== GESTION DES VENTES ====================
        
        function updateDeliveriesTable() {
            const tableBody = document.getElementById('deliveriesTableBody');
            const selectedDepotId = document.getElementById('depotSelector').value;
            const selectedStatus = document.getElementById('statusFilter').value;
            const selectedDate = document.getElementById('dateFilter').value;
            
            let filteredDeliveries = deliveries;
            
            // Filtrer par d√©p√¥t
            if (selectedDepotId) {
                filteredDeliveries = filteredDeliveries.filter(delivery => delivery.depotId === selectedDepotId);
            }
            
            // Filtrer par statut
            if (selectedStatus) {
                filteredDeliveries = filteredDeliveries.filter(delivery => delivery.status === selectedStatus);
            }
            
            // Filtrer par date
            if (selectedDate) {
                filteredDeliveries = filteredDeliveries.filter(delivery => {
                    const deliveryDate = delivery.bonDate || (delivery.createdAt ? delivery.createdAt.split('T')[0] : '');
                    return deliveryDate === selectedDate;
                });
            }
            
            if (filteredDeliveries.length === 0) {
                showEmptyState();
                return;
            }
            
            let html = '';
            filteredDeliveries.forEach(delivery => {
                const depot = depots.find(d => d.id === delivery.depotId);
                const depotName = depot ? depot.name : 'Non sp√©cifi√©';
                const date = formatDate(delivery.createdAt || delivery.date || delivery.bonDate);
                let totalAmount = delivery.totalAmount || 0;
                
                if (!totalAmount && delivery.items && Array.isArray(delivery.items)) {
                    totalAmount = delivery.items.reduce((sum, item) => {
                        return sum + (item.total || (item.quantity * item.price) || 0);
                    }, 0);
                }
                
                const status = delivery.status || 'pending';
                const statusClass = `status-${status}`;
                const statusText = getStatusText(status);
                
                const paymentStatus = delivery.paymentStatus || 'pending';
                const paymentStatusClass = `status-${paymentStatus}`;
                const paymentStatusText = getPaymentStatusText(paymentStatus);
                
                const bonNumber = delivery.deliveryNumber || delivery.bonNumber || delivery.id.substring(0, 8);
                
                html += `
                    <tr>
                        <td><strong style="color: var(--primary);">${bonNumber}</strong></td>
                        <td>${delivery.clientName || '--'}</td>
                        <td>${delivery.clientPhone || '--'}</td>
                        <td>${date}</td>
                        <td>${depotName}</td>
                        <td><strong>${totalAmount.toFixed(2)} DH</strong></td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${paymentStatusClass}">
                                ${paymentStatusText}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="showDeliveryPrint('${delivery.id}')" title="Voir">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="editDelivery('${delivery.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="confirmDeleteDelivery('${delivery.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        function updateStats() {
            const selectedDepotId = document.getElementById('depotSelector').value;
            const selectedStatus = document.getElementById('statusFilter').value;
            const selectedDate = document.getElementById('dateFilter').value;
            
            let filteredDeliveries = deliveries;
            
            if (selectedDepotId) {
                filteredDeliveries = filteredDeliveries.filter(delivery => delivery.depotId === selectedDepotId);
            }
            
            if (selectedStatus) {
                filteredDeliveries = filteredDeliveries.filter(delivery => delivery.status === selectedStatus);
            }
            
            if (selectedDate) {
                filteredDeliveries = filteredDeliveries.filter(delivery => {
                    const deliveryDate = delivery.bonDate || (delivery.createdAt ? delivery.createdAt.split('T')[0] : '');
                    return deliveryDate === selectedDate;
                });
            }
            
            const totalDeliveries = filteredDeliveries.length;
            const totalAmount = filteredDeliveries.reduce((sum, delivery) => {
                return sum + (delivery.totalAmount || 0);
            }, 0);
            
            const pendingCount = filteredDeliveries.filter(d => d.status === 'pending').length;
            const deliveredCount = filteredDeliveries.filter(d => d.status === 'delivered').length;
            const paidCount = filteredDeliveries.filter(d => d.paymentStatus === 'paid').length;
            
            document.getElementById('statsInfo').innerHTML = `
                <span><i class="fas fa-box"></i> ${totalDeliveries} ventes</span> |
                <span><i class="fas fa-money-bill-wave"></i> ${totalAmount.toFixed(2)} DH</span> |
                <span><i class="fas fa-clock"></i> ${pendingCount} en attente</span> |
                <span><i class="fas fa-check-circle"></i> ${deliveredCount} livr√©es</span> |
                <span><i class="fas fa-money-check"></i> ${paidCount} pay√©es</span>
            `;
        }

        function editDelivery(deliveryId) {
            showToast("Fonctionnalit√© de modification en cours de d√©veloppement", "info");
        }

        function confirmDeleteDelivery(deliveryId) {
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            document.getElementById('confirmTitle').textContent = "Supprimer la vente";
            document.getElementById('confirmMessage').textContent = `√ätes-vous s√ªr de vouloir supprimer la vente ${delivery.bonNumber || deliveryId} ? Cette action est irr√©versible.`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = () => deleteDelivery(deliveryId);
            
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function deleteDelivery(deliveryId) {
            if (isDemoMode) {
                // En mode d√©mo, supprimer localement
                deliveries = deliveries.filter(d => d.id !== deliveryId);
                showToast("Vente supprim√©e en mode d√©mo", "success");
                closeConfirmModal();
                refreshData();
            } else {
                // Supprimer de Firebase
                try {
                    const deliveryRef = database.ref('sales/' + deliveryId);
                    deliveryRef.remove()
                        .then(() => {
                            showToast("Vente supprim√©e avec succ√®s", "success");
                            closeConfirmModal();
                            refreshData();
                        })
                        .catch(error => {
                            console.error("‚ùå Erreur de suppression:", error);
                            showToast("Erreur lors de la suppression", "error");
                        });
                } catch (error) {
                    console.error("‚ùå Erreur dans deleteDelivery:", error);
                    showToast("Erreur lors de la suppression", "error");
                }
            }
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }
        
        // ==================== AFFICHAGE ET IMPRESSION ====================
        
        function showDeliveryPrint(deliveryId) {
            let delivery;
            
            if (typeof deliveryId === 'string') {
                delivery = deliveries.find(d => d.id === deliveryId);
            } else {
                delivery = currentDelivery;
            }
            
            if (!delivery) {
                showToast("Vente non trouv√©e", "error");
                return;
            }
            
            currentDelivery = delivery;
            
            const depot = depots.find(d => d.id === delivery.depotId);
            const depotName = depot ? depot.name : 'Non sp√©cifi√©';
            const depotCity = depot ? depot.city : '';
            
            const container = document.getElementById('a5DeliveryNote');
            const items = delivery.items || [];
            
            let grandTotal = 0;
            items.forEach(item => {
                const quantity = item.quantity || 0;
                const price = item.price || 0;
                const total = item.total || (quantity * price);
                grandTotal += total;
            });
            
            const bonNumber = delivery.deliveryNumber || delivery.bonNumber || delivery.id.substring(0, 8).toUpperCase();
            const creationDate = delivery.createdAt ? new Date(delivery.createdAt) : new Date();
            const formattedDate = creationDate.toLocaleDateString('fr-FR');
            const formattedTime = creationDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿ£ÿ≥ÿ∑ÿ± ÿßŸÑÿ¨ÿØŸàŸÑ ÿ®ÿØŸàŸÜ ÿ£ÿ≥ÿ∑ÿ± ŸÅÿßÿ±ÿ∫ÿ©
            let itemsHtml = '';
            const totalItems = items.length;
            
            for (let i = 0; i < totalItems; i++) {
                const item = items[i];
                const quantity = item.quantity || 0;
                const price = item.price || 0;
                const total = item.total || (quantity * price);
                
                itemsHtml += `
                    <tr>
                        <td>${i + 1}</td>
                        <td style="text-align:left; padding-left: 5px !important;">${item.name || 'Produit sans nom'}</td>
                        <td>${quantity}</td>
                        <td>${price.toFixed(2)}</td>
                        <td>${total.toFixed(2)}</td>
                    </tr>
                `;
            }
            
            container.innerHTML = `
                <div class="print-header">
                    <div style="text-align:left; flex: 1;">
                        <h3 style="margin:0; color: var(--primary); font-size: 18px; line-height: 1.2;">ETTIJARA ALAAMA SOUSS</h3>
                        <p style="font-size:9px; margin: 2px 0;">T√©l: 0525265980 | Email: ettijaraalaamasouss@gmail.com</p>
                        <p style="font-size:9px; margin-top: 5px;">
                            <strong>D√©p√¥t:</strong> ${depotName} ${depotCity ? '- ' + depotCity : ''}
                        </p>
                    </div>
                    <div style="text-align:right; font-size:10px;">
                        <div style="border: 1px solid #000; padding: 6px; border-radius: 4px;">
                            <p style="margin: 1px 0;"><strong>N¬∞ BON:</strong> ${bonNumber}</p>
                            <p style="margin: 1px 0;"><strong>DATE:</strong> ${formattedDate}</p>
                            <p style="margin: 1px 0;"><strong>HEURE:</strong> ${formattedTime}</p>
                        </div>
                    </div>
                </div>

                <div class="print-title">
                    <h2>BON DE VENTE</h2>
                </div>

                <!-- Informations client en horizontal -->
                <div class="client-info-horizontal">
                    <div class="client-info-column">
                        <p style="font-weight: bold; font-size: 10px;">INFORMATIONS CLIENT</p>
                        <p><strong>Nom:</strong> ${delivery.clientName || 'Non sp√©cifi√©'}</p>
                        <p><strong>T√©l:</strong> ${delivery.clientPhone || 'Non sp√©cifi√©'}</p>
                    </div>
                    <div class="client-info-column">
                        <p><strong>Adresse:</strong></p>
                        <p>${delivery.clientAddress || 'Non sp√©cifi√©e'}</p>
                    </div>
                    <div class="client-info-column">
                        ${delivery.driver ? `<p><strong>Livreur:</strong> ${delivery.driver}</p>` : ''}
                        ${delivery.paymentMethod ? `
                            <p><strong>Paiement:</strong> ${delivery.paymentMethod === 'cash' ? 'Esp√®ces' : 
                                                           delivery.paymentMethod === 'check' ? 'Ch√®que' : 
                                                           delivery.paymentMethod === 'card' ? 'Carte Bancaire' : 
                                                           delivery.paymentMethod === 'transfer' ? 'Virement' :
                                                           delivery.paymentMethod === 'credit' ? 'Cr√©dit' : delivery.paymentMethod}
                            </p>
                        ` : ''}
                        ${delivery.paymentStatus ? `
                            <p><strong>Statut:</strong> ${getPaymentStatusText(delivery.paymentStatus)}
                            </p>
                        ` : ''}
                    </div>
                </div>

                <div class="print-table-container">
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th width="7%">N¬∞</th>
                                <th width="53%">D√©signation</th>
                                <th width="10%">Qt√©</th>
                                <th width="15%">Prix Unitaire (DH)</th>
                                <th width="15%">Total (DH)</th>
                            </tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right; border: none; padding-top: 8px; font-weight: bold; font-size: 10px;">
                                    TOTAL G√âN√âRAL (DH) :
                                </td>
                                <td style="border: 2.5px solid #000; padding-top: 8px; background: #f9f9f9; font-weight: bold; font-size: 11px;">
                                    ${grandTotal.toFixed(2)}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                ${delivery.notes ? `
                <div style="margin-top: 8px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 9px;">
                    <strong>Remarques:</strong> ${delivery.notes}
                </div>
                ` : ''}

                <div class="print-footer">
                    <div style="text-align: center;">
                        <p style="font-size: 10px; margin-bottom: 3px;">Le client</p>
                        <div class="sig-box">
                            Signature
                        </div>
                    </div>

                    <div class="round-stamp">
                        <div class="comp-name">ETTIJARA ALAAMA SOUSS</div>
                        <div class="depo-label">D√âP√îT</div>
                        <div class="depo-name">${depotName}</div>
                    </div>

                    <div style="text-align: center;">
                        <p style="font-size: 10px; margin-bottom: 3px;">La soci√©t√©</p>
                        <div class="sig-box">
                            Signature & Cachet
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; font-size: 7px; text-align: center; color: #666; border-top: 1px dashed #ddd; padding-top: 8px;">
                    <p>
                        <strong>ETTIJARA ALAAMA SOUSS</strong> | T√©l: 0525265980 | Email: ettijaraalaamasouss@gmail.com
                    </p>
                    <p>
                        Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} 
                        | ETTIJARA ALAAMA SOUSS ¬© ${new Date().getFullYear()} | Ce document est √©mis par ordinateur, signature non requise.
                    </p>
                </div>
            `;
            
            document.getElementById('printModal').style.display = 'flex';
        }
        
        function printDeliveryNote() {
            if (!currentDelivery) {
                showToast("Aucun bon √† imprimer", "error");
                return;
            }
            
            window.print();
        }
        
        function closeModal() {
            document.getElementById('printModal').style.display = 'none';
            currentDelivery = null;
        }
        
        // ==================== UTILITAIRES ====================
        
        function refreshData() {
            if (isDemoMode) {
                showToast("Mode d√©mo - Donn√©es locales actualis√©es", "info");
                updateDeliveriesTable();
                updateStats();
                updateQuickStats();
                updateLastUpdateTime();
                return;
            }
            
            document.getElementById('deliveriesTableBody').innerHTML = `
                <tr>
                    <td colspan="9" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Actualisation des donn√©es en cours...</p>
                    </td>
                </tr>
            `;
            
            loadDepots();
            showToast("Donn√©es actualis√©es avec succ√®s", "success");
        }
        
        // ==================== INITIALISATION ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Application en cours de d√©marrage...");
            
            // Initialiser le th√®me
            initTheme();
            
            // Configurer les filtres
            document.getElementById('depotSelector').addEventListener('change', function() {
                updateDeliveriesTable();
                updateStats();
                updateQuickStats();
            });
            
            document.getElementById('statusFilter').addEventListener('change', function() {
                updateDeliveriesTable();
                updateStats();
                updateQuickStats();
            });
            
            document.getElementById('dateFilter').addEventListener('change', function() {
                updateDeliveriesTable();
                updateStats();
                updateQuickStats();
            });
            
            // D√©finir la date d'aujourd'hui comme valeur par d√©faut du filtre de date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;
            
            // Essayer de se connecter √† Firebase
            initializeFirebase();
            
            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closeCreateModal();
                    closeClientSearch();
                    closeProductSearch();
                    closeConfirmModal();
                }
                
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshData();
                }
                
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    openCreateDelivery();
                }

                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    document.getElementById('themeToggle').click();
                }
            });
            
            // Fermer les modals en cliquant en dehors
            window.addEventListener('click', function(event) {
                const modals = ['printModal', 'createModal', 'clientSearchModal', 'productSearchModal', 'confirmModal'];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (event.target === modal) {
                        if (modalId === 'printModal') closeModal();
                        if (modalId === 'createModal') closeCreateModal();
                        if (modalId === 'clientSearchModal') closeClientSearch();
                        if (modalId === 'productSearchModal') closeProductSearch();
                        if (modalId === 'confirmModal') closeConfirmModal();
                    }
                });
            });
            
            // V√©rifier la connexion apr√®s 2 secondes
            setTimeout(() => {
                if (!isConnected && !isDemoMode) {
                    console.log("üîÑ Passage automatique en mode d√©mo...");
                    initializeDemoMode();
                }
            }, 2000);
        });
    </script>
</body>
</html>
