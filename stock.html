<!DOCTYPE html>
<html lang="fr" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Syst√®me professionnel de gestion de stock pour ETTIJARA ALAAMA SOUSS">
    <meta name="theme-color" content="#1a237e">
    <title>ETTIJARA ALAAMA SOUSS - Gestion de Stock Multi-D√©p√¥ts</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --accent: #1565c0;
            --light: #e3f2fd;
            --bg: #f5f7fa;
            --text: #333333;
            --text-light: #666666;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --info: #0288d1;
            --purple: #7b1fa2;
            --cyan: #0097a7;
            --shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --primary: #3949ab;
            --secondary: #1565c0;
            --accent: #42a5f5;
            --light: #1e293b;
            --bg: #0f172a;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --card-bg: #1e293b;
            --border: #334155;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #ef5350;
            --info: #29b6f6;
            --purple: #ba68c8;
            --cyan: #26c6da;
            --shadow: 0 3px 15px rgba(0,0,0,0.3);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text);
            direction: rtl; 
            min-height: 100vh;
        }

        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 30px; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .logo i { 
            font-size: 28px; 
        }
        
        .logo h1 { 
            font-size: 22px; 
            font-weight: 700; 
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-item {
            padding: 8px 20px;
            border-radius: 6px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        /* User Menu */
        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-dropdown {
            position: absolute;
            top: 50px;
            left: 0;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-width: 200px;
            display: none;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .user-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.3s;
            border-bottom: 1px solid var(--border);
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item:hover {
            background: var(--light);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(30deg);
        }

        .theme-toggle .fa-sun {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .fa-sun {
            display: block;
        }

        [data-theme="dark"] .theme-toggle .fa-moon {
            display: none;
        }
        
        /* Main Content */
        .main-content { 
            padding: 90px 30px 30px; 
            min-height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Welcome Section */
        .welcome-section {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .welcome-text h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-text p {
            opacity: 0.9;
            font-size: 16px;
        }

        .date-display {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .date-display .day {
            font-size: 32px;
            font-weight: bold;
            line-height: 1;
        }

        .date-display .month-year {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Stats Cards Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-icon.total {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .stat-icon.low {
            background: linear-gradient(135deg, var(--warning), #ff9800);
        }

        .stat-icon.out {
            background: linear-gradient(135deg, var(--danger), #ef5350);
        }

        .stat-icon.value {
            background: linear-gradient(135deg, var(--success), #4caf50);
        }

        .stat-info h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-info .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--light);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: none;
            color: var(--text);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(26, 35, 126, 0.1);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .action-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: white;
            font-size: 24px;
        }

        .action-card h4 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--text);
        }

        .action-card p {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Filters Section */
        .filters-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .filter-input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        /* Table Container */
        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .table-header h3 {
            font-size: 18px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-toolbar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #1b5e20;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #e65100;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
            transform: translateY(-2px);
        }

        .btn-cyan {
            background: var(--cyan);
            color: white;
        }

        .btn-cyan:hover {
            background: #007c91;
            transform: translateY(-2px);
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: var(--light);
            padding: 15px;
            border-bottom: 2px solid var(--border);
            text-align: center;
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            text-align: center;
            color: var(--text);
            font-weight: 500;
            font-size: 14px;
        }
        
        tr:hover {
            background-color: var(--light);
        }

        /* Stock Status Badge */
        .stock-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .stock-high {
            background-color: rgba(6, 95, 70, 0.1);
            color: #065f46;
        }
        
        .stock-medium {
            background-color: rgba(217, 119, 6, 0.1);
            color: #d97706;
        }
        
        .stock-low {
            background-color: rgba(220, 38, 38, 0.1);
            color: #dc2626;
        }
        
        .stock-out {
            background-color: rgba(75, 85, 99, 0.1);
            color: #4b5563;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--light);
            color: var(--text);
        }

        .btn-icon:hover {
            transform: translateY(-2px);
        }

        .btn-edit:hover {
            background: var(--info);
            color: white;
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        .btn-view:hover {
            background: var(--success);
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .form-group .required {
            color: var(--danger);
        }

        .form-input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Stock By Depot Display */
        .depot-stock-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
        }

        .depot-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--light);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .depot-stock-name {
            font-weight: 600;
            color: var(--primary);
        }

        .depot-stock-quantity {
            font-weight: bold;
            color: var(--text);
        }

        /* Categories Grid */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .category-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
        }

        .category-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: var(--light);
            border-radius: 6px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 2px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .loading i {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 100px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
            color: var(--text);
            max-width: 400px;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.info {
            border-left-color: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(.disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Footer */
        .dashboard-footer {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
            font-size: 14px;
            border-top: 1px solid var(--border);
            margin-top: 30px;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { 
                padding: 0 15px; 
                height: 60px;
            }
            
            .main-content { 
                padding: 80px 15px 15px; 
            }
            
            .logo h1 {
                font-size: 18px;
            }

            .nav {
                display: none;
            }

            .welcome-section {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .categories-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .table-toolbar {
                flex-wrap: wrap;
            }

            table {
                display: block;
                overflow-x: auto;
            }

            .theme-toggle {
                width: 35px;
                height: 35px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                padding: 12px;
            }

            .toast {
                left: 15px;
                right: 15px;
                top: 80px;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                max-width: 95%;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 16px;
            }

            .welcome-text h2 {
                font-size: 22px;
            }

            .stat-card {
                padding: 15px;
            }

            .category-card {
                padding: 15px;
            }

            .category-stats {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }

            .btn-icon {
                width: 28px;
                height: 28px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <i class="fas fa-boxes"></i>
            <h1>ETTIJARA ALAAMA SOUSS - GESTION DE STOCK MULTI-D√âP√îTS</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <nav class="nav">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-boxes"></i>
                    Stock
                </a>
                <a href="sales.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    Ventes
                </a>
                <a href="purchases.html" class="nav-item">
                    <i class="fas fa-shopping-bag"></i>
                    Achats
                </a>
                <a href="clients.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    Clients
                </a>
                <a href="suppliers.html" class="nav-item">
                    <i class="fas fa-truck-loading"></i>
                    Fournisseurs
                </a>
                <a href="payments.html" class="nav-item">
                    <i class="fas fa-credit-card"></i>
                    Paiements
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    Param√®tres
                </a>
            </nav>
            
            <!-- User Menu -->
            <div class="user-menu" id="userMenu">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item">
                        <i class="fas fa-user"></i>
                        <span id="userName">Administrateur</span>
                    </div>
                    <div class="user-dropdown-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Rapports</span>
                    </div>
                    <div class="user-dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>D√©connexion</span>
                    </div>
                </div>
            </div>
            
            <button class="theme-toggle" id="themeToggle" title="Changer le th√®me">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
            <div class="connection-status">
                <div id="connectionStatus" class="status-dot disconnected" title="D√©connect√©"></div>
                <span style="color: white; font-size: 12px;">Firebase</span>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <div class="welcome-text">
                <h2>Gestion de Stock Multi-D√©p√¥ts üì¶</h2>
                <p id="welcomeMessage">G√©rez votre inventaire par d√©p√¥t, cat√©gories et mouvements de stock en temps r√©el</p>
            </div>
            <div class="date-display">
                <div class="day" id="currentDay">--</div>
                <div class="month-year" id="currentDate">-- --- ----</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="products">
                <i class="fas fa-box"></i>
                Produits
            </button>
            <button class="tab-btn" data-tab="categories">
                <i class="fas fa-tags"></i>
                Cat√©gories
            </button>
            <button class="tab-btn" data-tab="depots">
                <i class="fas fa-warehouse"></i>
                D√©p√¥ts
            </button>
            <button class="tab-btn" data-tab="movements">
                <i class="fas fa-exchange-alt"></i>
                Mouvements
            </button>
            <button class="tab-btn" data-tab="reports">
                <i class="fas fa-chart-line"></i>
                Rapports
            </button>
        </div>

        <!-- Products Tab -->
        <div id="productsTab" class="tab-content active">
            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card" onclick="openAddProductModal()">
                    <div class="action-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <h4>Nouveau Produit</h4>
                    <p>Ajouter un nouveau produit au stock</p>
                </div>
                
                <!-- Import Excel Action Card -->
                <div class="action-card" onclick="openExcelImportModal()">
                    <div class="action-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <h4>Importer Excel</h4>
                    <p>Importer les stocks depuis un fichier Excel</p>
                </div>
                
                <!-- Import Tarifs Action Card -->
                <div class="action-card" onclick="openTarifImportModal()">
                    <div class="action-icon">
                        <i class="fas fa-file-import"></i>
                    </div>
                    <h4>Importer Tarifs</h4>
                    <p>Mettre √† jour les prix depuis fichier Excel IPAR</p>
                </div>
                
                <div class="action-card" onclick="openStockAdjustmentModal()">
                    <div class="action-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h4>Ajustement Stock</h4>
                    <p>Ajuster les quantit√©s par d√©p√¥t</p>
                </div>
                
                <div class="action-card" onclick="openTransferStockModal()">
                    <div class="action-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h4>Transfert Stock</h4>
                    <p>Transf√©rer entre d√©p√¥ts</p>
                </div>
                
                <div class="action-card" onclick="exportStockToExcel()">
                    <div class="action-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h4>Exporter Excel</h4>
                    <p>Exporter le stock en format Excel</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card" onclick="filterByStockStatus('all')">
                    <div class="stat-icon total">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Produits</h3>
                        <div class="value" id="totalProducts">0</div>
                        <div class="subtitle">Enregistr√©s dans le syst√®me</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterByStockStatus('low')">
                    <div class="stat-icon low">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Stock Faible</h3>
                        <div class="value" id="lowStockCount">0</div>
                        <div class="subtitle">Besoin de r√©approvisionnement</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterByStockStatus('value')">
                    <div class="stat-icon value">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Valeur Totale</h3>
                        <div class="value" id="totalValue">0 DH</div>
                        <div class="subtitle">Valeur totale du stock</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterByStockStatus('out')">
                    <div class="stat-icon out">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Rupture Stock</h3>
                        <div class="value" id="outOfStockCount">0</div>
                        <div class="subtitle">Produits en rupture</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-bar"></i> Distribution par D√©p√¥t</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="depotsChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-pie"></i> Stock par Cat√©gorie</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoriesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="searchProduct">Rechercher Produit</label>
                        <input type="text" id="searchProduct" class="filter-input" placeholder="Nom, code ou r√©f√©rence..." oninput="filterProductsTable()">
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterCategory">Cat√©gorie</label>
                        <select id="filterCategory" class="filter-input" onchange="filterProductsTable()">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterDepot">D√©p√¥t</label>
                        <select id="filterDepot" class="filter-input" onchange="filterProductsTable()">
                            <option value="">Tous les d√©p√¥ts</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="filterStockStatus">Statut Stock</label>
                        <select id="filterStockStatus" class="filter-input" onchange="filterProductsTable()">
                            <option value="">Tous les statuts</option>
                            <option value="high">Stock √©lev√©</option>
                            <option value="medium">Stock moyen</option>
                            <option value="low">Stock bas</option>
                            <option value="out">Rupture</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Products Table -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-list"></i> Liste des Produits en Stock par D√©p√¥t</h3>
                    <div class="table-toolbar">
                        <button class="btn btn-primary" onclick="openAddProductModal()">
                            <i class="fas fa-plus"></i> Nouveau Produit
                        </button>
                        <button class="btn btn-secondary" onclick="refreshStockData()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                        <button class="btn btn-success" onclick="exportStockToExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn btn-warning" onclick="exportStockToPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-cyan" onclick="openTransferStockModal()">
                            <i class="fas fa-truck"></i> Transfert
                        </button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Produit</th>
                            <th>Cat√©gorie</th>
                            <th>Stock par D√©p√¥t</th>
                            <th>Quantit√© Totale</th>
                            <th>Seuil Min</th>
                            <th>Prix Achat</th>
                            <th>Prix Vente</th>
                            <th>Valeur Totale</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="11" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Chargement des produits...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="pagination" id="productsPagination"></div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categoriesTab" class="tab-content">
            <!-- Categories Grid -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-tags"></i> Gestion des Cat√©gories</h3>
                    <div class="table-toolbar">
                        <button class="btn btn-primary" onclick="openAddCategoryModal()">
                            <i class="fas fa-plus"></i> Nouvelle Cat√©gorie
                        </button>
                        <button class="btn btn-secondary" onclick="refreshCategories()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                        <button class="btn btn-success" onclick="exportCategoriesToExcel()">
                            <i class="fas fa-file-export"></i> Exporter
                        </button>
                    </div>
                </div>
                
                <div class="categories-grid" id="categoriesGrid">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement des cat√©gories...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Depots Tab -->
        <div id="depotsTab" class="tab-content">
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-warehouse"></i> Gestion des D√©p√¥ts</h3>
                    <div class="table-toolbar">
                        <button class="btn btn-primary" onclick="openAddDepotModal()">
                            <i class="fas fa-plus"></i> Nouveau D√©p√¥t
                        </button>
                        <button class="btn btn-secondary" onclick="refreshDepots()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                </div>
                
                <div class="categories-grid" id="depotsGrid">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement des d√©p√¥ts...</p>
                    </div>
                </div>
            </div>

            <!-- Depots Table -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-list"></i> Liste des D√©p√¥ts</h3>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Ville</th>
                            <th>Adresse</th>
                            <th>Responsable</th>
                            <th>Produits</th>
                            <th>Stock Total</th>
                            <th>Valeur</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="depotsTable">
                        <tr>
                            <td colspan="9" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Chargement des d√©p√¥ts...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Movements Tab -->
        <div id="movementsTab" class="tab-content">
            <!-- Movements Header -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-exchange-alt"></i> Historique des Mouvements</h3>
                    <div class="table-toolbar">
                        <button class="btn btn-primary" onclick="openStockAdjustmentModal()">
                            <i class="fas fa-plus"></i> Ajustement Stock
                        </button>
                        <button class="btn-cyan" onclick="openTransferStockModal()">
                            <i class="fas fa-truck"></i> Transfert
                        </button>
                        <button class="btn btn-secondary" onclick="refreshMovements()">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                        <button class="btn btn-success" onclick="exportMovementsToExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                
                <!-- Movements Filters -->
                <div class="filters-section">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label for="filterMovementType">Type de Mouvement</label>
                            <select id="filterMovementType" class="filter-input" onchange="filterMovementsTable()">
                                <option value="">Tous les types</option>
                                <option value="in">Entr√©e</option>
                                <option value="out">Sortie</option>
                                <option value="transfer">Transfert</option>
                                <option value="adjustment">Ajustement</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterMovementDateFrom">Date de D√©but</label>
                            <input type="date" id="filterMovementDateFrom" class="filter-input" onchange="filterMovementsTable()">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterMovementDateTo">Date de Fin</label>
                            <input type="date" id="filterMovementDateTo" class="filter-input" onchange="filterMovementsTable()">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filterMovementProduct">Produit</label>
                            <select id="filterMovementProduct" class="filter-input" onchange="filterMovementsTable()">
                                <option value="">Tous les produits</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Movements Table -->
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Produit</th>
                            <th>Quantit√©</th>
                            <th>D√©p√¥t Source</th>
                            <th>D√©p√¥t Dest.</th>
                            <th>Raison</th>
                            <th>R√©f√©rence</th>
                            <th>Utilisateur</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTable">
                        <tr>
                            <td colspan="9" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Chargement des mouvements...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="pagination" id="movementsPagination"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> Performance des D√©p√¥ts</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-trending-up"></i> Rotation des Stocks</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="turnoverChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div class="table-container">
                <div class="table-header">
                    <h3><i class="fas fa-chart-pie"></i> Rapports Analytiques</h3>
                    <div class="table-toolbar">
                        <button class="btn btn-primary" onclick="generateStockReport()">
                            <i class="fas fa-file-alt"></i> Rapport Stock
                        </button>
                        <button class="btn btn-success" onclick="generateLowStockReport()">
                            <i class="fas fa-exclamation-triangle"></i> Rapport Stock Bas
                        </button>
                        <button class="btn btn-warning" onclick="generateDepotReport()">
                            <i class="fas fa-warehouse"></i> Rapport D√©p√¥ts
                        </button>
                    </div>
                </div>
                
                <div class="quick-actions" style="margin: 20px;">
                    <div class="action-card" onclick="showABCReport()">
                        <div class="action-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h4>Analyse ABC</h4>
                        <p>Classification des produits par valeur</p>
                    </div>
                    
                    <div class="action-card" onclick="showAgingReport()">
                        <div class="action-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h4>Vieillissement</h4>
                        <p>Analyse du vieillissement du stock</p>
                    </div>
                    
                    <div class="action-card" onclick="showProfitabilityReport()">
                        <div class="action-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <h4>Rentabilit√©</h4>
                        <p>Analyse de rentabilit√© par produit</p>
                    </div>
                    
                    <div class="action-card" onclick="showDepotComparison()">
                        <div class="action-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <h4>Comparaison D√©p√¥ts</h4>
                        <p>Comparer les performances des d√©p√¥ts</p>
                    </div>
                </div>
                
                <div id="reportsContent" style="padding: 20px;">
                    <!-- Reports will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="dashboard-footer">
            <p>¬© 2024 ETTIJARA ALAAMA SOUSS - Syst√®me Professionnel de Gestion de Stock Multi-D√©p√¥ts</p>
            <p style="font-size: 12px; margin-top: 5px;">
                <span id="lastUpdate">Derni√®re mise √† jour: --:--</span> | 
                <span id="totalStats">0 produits | 0 d√©p√¥ts | 0 cat√©gories</span> |
                <span id="systemStatus">Syst√®me: Op√©rationnel</span>
            </p>
        </div>
    </main>

    <!-- Add/Edit Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-box"></i> <span id="productModalTitle">Nouveau Produit</span></h3>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productCode">Code Produit <span class="required">*</span></label>
                            <input type="text" id="productCode" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productName">Nom Produit <span class="required">*</span></label>
                            <input type="text" id="productName" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productCategory">Cat√©gorie <span class="required">*</span></label>
                            <select id="productCategory" class="form-input" required>
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="productInitialDepot">D√©p√¥t Initial <span class="required">*</span></label>
                            <select id="productInitialDepot" class="form-input" required>
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="productInitialQuantity">Quantit√© Initiale <span class="required">*</span></label>
                            <input type="number" id="productInitialQuantity" class="form-input" min="0" step="0.01" required value="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="productMinStock">Seuil Minimum</label>
                            <input type="number" id="productMinStock" class="form-input" min="0" step="0.01" value="10">
                        </div>
                        
                        <div class="form-group">
                            <label for="productMaxStock">Seuil Maximum</label>
                            <input type="number" id="productMaxStock" class="form-input" min="0" step="0.01" value="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="productCostPrice">Prix d'Achat (DH) <span class="required">*</span></label>
                            <input type="number" id="productCostPrice" class="form-input" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productSellPrice">Prix de Vente (DH) <span class="required">*</span></label>
                            <input type="number" id="productSellPrice" class="form-input" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" class="form-input form-textarea"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="productBarcode">Code-barres</label>
                        <input type="text" id="productBarcode" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label for="productSupplier">Fournisseur</label>
                        <input type="text" id="productSupplier" class="form-input">
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeProductModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-tag"></i> <span id="categoryModalTitle">Nouvelle Cat√©gorie</span></h3>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="categoryName">Nom de la Cat√©gorie <span class="required">*</span></label>
                            <input type="text" id="categoryName" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="categoryIcon">Ic√¥ne</label>
                            <select id="categoryIcon" class="form-input">
                                <option value="fas fa-box">üì¶ Bo√Æte</option>
                                <option value="fas fa-tools">üîß Outils</option>
                                <option value="fas fa-paint-roller">üé® Peinture</option>
                                <option value="fas fa-hammer">üî® Marteau</option>
                                <option value="fas fa-bolt">‚ö° √âlectricit√©</option>
                                <option value="fas fa-faucet">üö∞ Plomberie</option>
                                <option value="fas fa-ruler-combined">üìê Mesure</option>
                                <option value="fas fa-lightbulb">üí° Lumi√®re</option>
                                <option value="fas fa-screwdriver">ü™õ Tournevis</option>
                                <option value="fas fa-wrench">üîß Cl√©</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="categoryColor">Couleur</label>
                            <input type="color" id="categoryColor" class="form-input" value="#1a237e" style="height: 40px; padding: 5px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryDescription">Description</label>
                        <textarea id="categoryDescription" class="form-input form-textarea"></textarea>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Depot Modal -->
    <div class="modal-overlay" id="depotModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-warehouse"></i> <span id="depotModalTitle">Nouveau D√©p√¥t</span></h3>
                <button class="modal-close" onclick="closeDepotModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="depotForm">
                    <input type="hidden" id="depotId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="depotName">Nom du D√©p√¥t <span class="required">*</span></label>
                            <input type="text" id="depotName" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="depotCity">Ville <span class="required">*</span></label>
                            <input type="text" id="depotCity" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="depotAddress">Adresse <span class="required">*</span></label>
                            <input type="text" id="depotAddress" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="depotManager">Responsable</label>
                            <input type="text" id="depotManager" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label for="depotPhone">T√©l√©phone</label>
                            <input type="tel" id="depotPhone" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label for="depotStatus">Statut</label>
                            <select id="depotStatus" class="form-input">
                                <option value="active">Actif</option>
                                <option value="inactive">Inactif</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="depotCapacity">Capacit√© (m¬≤)</label>
                        <input type="number" id="depotCapacity" class="form-input" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="depotNotes">Notes</label>
                        <textarea id="depotNotes" class="form-input form-textarea"></textarea>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeDepotModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div class="modal-overlay" id="adjustmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exchange-alt"></i> Ajustement de Stock</h3>
                <button class="modal-close" onclick="closeAdjustmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="adjustmentForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="adjustmentProduct">Produit <span class="required">*</span></label>
                            <select id="adjustmentProduct" class="form-input" required onchange="updateAdjustmentProductInfo()">
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="adjustmentDepot">D√©p√¥t <span class="required">*</span></label>
                            <select id="adjustmentDepot" class="form-input" required onchange="updateAdjustmentStockInfo()">
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="adjustmentType">Type d'Ajustement <span class="required">*</span></label>
                            <select id="adjustmentType" class="form-input" required onchange="updateAdjustmentType()">
                                <option value="in">Entr√©e de stock</option>
                                <option value="out">Sortie de stock</option>
                                <option value="set">D√©finir stock</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="adjustmentQuantity">Quantit√© <span class="required">*</span></label>
                            <input type="number" id="adjustmentQuantity" class="form-input" min="1" step="0.01" required>
                        </div>
                    </div>
                    
                    <div id="adjustmentStockInfo" style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>Informations Stock Actuel</h4>
                        <div id="adjustmentStockContent">
                            <div>Stock actuel dans ce d√©p√¥t: <span id="currentStockInDepot">0</span></div>
                            <div>Stock total du produit: <span id="currentTotalStock">0</span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="adjustmentReason">Raison <span class="required">*</span></label>
                        <select id="adjustmentReason" class="form-input" required>
                            <option value="inventory">Inventaire</option>
                            <option value="purchase">Achat</option>
                            <option value="return">Retour client</option>
                            <option value="damage">Produit endommag√©</option>
                            <option value="loss">Perte</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="adjustmentNotes">Notes</label>
                        <textarea id="adjustmentNotes" class="form-input form-textarea" placeholder="Notes suppl√©mentaires..."></textarea>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeAdjustmentModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Appliquer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transfer Stock Modal -->
    <div class="modal-overlay" id="transferModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-truck"></i> Transfert de Stock entre D√©p√¥ts</h3>
                <button class="modal-close" onclick="closeTransferModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="transferProduct">Produit <span class="required">*</span></label>
                            <select id="transferProduct" class="form-input" required onchange="updateTransferProductInfo()">
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferFromDepot">D√©p√¥t Source <span class="required">*</span></label>
                            <select id="transferFromDepot" class="form-input" required onchange="updateTransferStockInfo()">
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferToDepot">D√©p√¥t Destination <span class="required">*</span></label>
                            <select id="transferToDepot" class="form-input" required>
                                <option value="">S√©lectionner...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="transferQuantity">Quantit√© <span class="required">*</span></label>
                            <input type="number" id="transferQuantity" class="form-input" min="1" step="0.01" required>
                        </div>
                    </div>
                    
                    <div id="transferStockInfo" style="background: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>Informations Stock Actuel</h4>
                        <div id="transferStockContent">
                            <div>Stock disponible dans le d√©p√¥t source: <span id="availableStockForTransfer">0</span></div>
                            <div>Stock total du produit: <span id="totalStockForTransfer">0</span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transferReason">Raison du transfert</label>
                        <input type="text" id="transferReason" class="form-input" placeholder="Ex: R√©approvisionnement, Inventaire...">
                    </div>
                    
                    <div class="form-group">
                        <label for="transferNotes">Notes</label>
                        <textarea id="transferNotes" class="form-input form-textarea" placeholder="Notes suppl√©mentaires..."></textarea>
                    </div>
                    
                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeTransferModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-exchange-alt"></i> Effectuer le Transfert
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div class="modal-overlay" id="excelImportModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-excel"></i> Importer des Stocks depuis Excel</h3>
                <button class="modal-close" onclick="closeExcelImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="excelImportForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="selectDepot">S√©lectionner le D√©p√¥t <span class="required">*</span></label>
                            <select id="selectDepot" class="form-input" required>
                                <option value="">Choisir un d√©p√¥t...</option>
                            </select>
                            <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                                Les stocks du fichier Excel seront ajout√©s √† ce d√©p√¥t
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label for="importType">Type d'Importation <span class="required">*</span></label>
                            <select id="importType" class="form-input" required>
                                <option value="add">Ajouter aux stocks existants</option>
                                <option value="replace">Remplacer les stocks</option>
                                <option value="new">Nouveaux produits seulement</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="excelFile">Fichier Excel <span class="required">*</span></label>
                        <input type="file" id="excelFile" class="form-input" accept=".xlsx,.xls,.csv" required>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                            Format attendu: Colonnes [Code, Nom, Stock] ou [ID de l'article, Nom de l'article, Stock]
                        </p>
                    </div>
                    
                    <div id="excelPreview" style="display: none; margin-top: 15px;">
                        <h4><i class="fas fa-eye"></i> Pr√©visualisation des donn√©es</h4>
                        <div style="max-height: 250px; overflow-y: auto; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px;">
                            <table id="previewTable" style="width: 100%; font-size: 12px;">
                                <thead style="background: var(--light); position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 10px; text-align: center;">Code</th>
                                        <th style="padding: 10px; text-align: right;">Nom</th>
                                        <th style="padding: 10px; text-align: center;">Stock</th>
                                        <th style="padding: 10px; text-align: center;">Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> <span id="previewCount">0</span> produits d√©tect√©s dans le fichier
                        </p>
                    </div>
                    
                    <div id="importSummary" style="display: none; margin-top: 15px; padding: 15px; background: var(--light); border-radius: 8px;">
                        <h4><i class="fas fa-chart-bar"></i> R√©sum√© de l'importation</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="summaryNew">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Nouveaux</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);" id="summaryUpdate">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Mise √† jour</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--warning);" id="summarySkip">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Ignor√©s</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                        <div style="font-size: 12px; color: var(--text-light);">
                            <i class="fas fa-info-circle"></i> Compatible avec le format de votre fichier Excel
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeExcelImportModal()">
                                Annuler
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Importer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tarif Import Modal -->
    <div class="modal-overlay" id="tarifImportModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-import"></i> Importer Tarifs depuis Excel IPAR</h3>
                <button class="modal-close" onclick="closeTarifImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tarifImportForm">
                    <div class="form-group">
                        <label for="tarifExcelFile">Fichier Excel des Tarifs <span class="required">*</span></label>
                        <input type="file" id="tarifExcelFile" class="form-input" accept=".xlsx,.xls,.csv" required>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                            Format attendu: Fichier Excel IPAR avec colonnes [CODE, Designation, prix de vente, TARIFS GROS]
                        </p>
                    </div>
                    
                    <!-- Bouton de d√©tection automatique -->
                    <div class="form-group" style="margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="autoDetectFormat()" 
                                style="font-size: 12px; padding: 5px 10px;">
                            <i class="fas fa-magic"></i> D√©tecter automatiquement le format
                        </button>
                        <p style="font-size: 11px; color: var(--text-light); margin-top: 5px;">
                            Si le fichier n'est pas d√©tect√© automatiquement, cliquez ici pour forcer la d√©tection
                        </p>
                    </div>
                    
                    <!-- Option pour cr√©er de nouveaux produits -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="createNewProducts" style="width: auto;">
                            <span>Cr√©er automatiquement les nouveaux produits non trouv√©s</span>
                        </label>
                    </div>
                    
                    <div id="tarifPreview" style="display: none; margin-top: 15px;">
                        <h4><i class="fas fa-eye"></i> Pr√©visualisation des tarifs</h4>
                        <div style="max-height: 250px; overflow-y: auto; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px;">
                            <table id="tarifPreviewTable" style="width: 100%; font-size: 12px;">
                                <thead style="background: var(--light); position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 10px; text-align: center;">CODE</th>
                                        <th style="padding: 10px; text-align: right;">Designation</th>
                                        <th style="padding: 10px; text-align: center;">Prix Vente</th>
                                        <th style="padding: 10px; text-align: center;">Tarif Gros</th>
                                        <th style="padding: 10px; text-align: center;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tarifPreviewTableBody">
                                    <!-- Data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> <span id="tarifPreviewCount">0</span> produits d√©tect√©s dans le fichier
                        </p>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="tarifUpdateStrategy">Strat√©gie de mise √† jour</label>
                        <select id="tarifUpdateStrategy" class="form-input">
                            <option value="update_all">Mettre √† jour tous les produits correspondants</option>
                            <option value="update_sell_only">Mettre √† jour seulement les prix de vente</option>
                            <option value="update_cost_only">Mettre √† jour seulement les prix d'achat</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tarifUpdateMethod">Calcul du prix d'achat</label>
                        <select id="tarifUpdateMethod" class="form-input">
                            <option value="formula">Calcul automatique (96% du tarif gros)</option>
                            <option value="manual">Utiliser prix d'achat du fichier (colonne B)</option>
                        </select>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 5px;">
                            Note: La formule automatique calcule: Prix d'achat = Tarif Gros √ó 0.96 (soit 4% de r√©duction)
                        </p>
                    </div>
                    
                    <div id="tarifSummary" style="display: none; margin-top: 15px; padding: 15px; background: var(--light); border-radius: 8px;">
                        <h4><i class="fas fa-chart-bar"></i> R√©sum√© de la mise √† jour</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="summaryTotal">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Total</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);" id="summaryMatched">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Correspondances</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--warning);" id="summaryNew">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Nouveaux</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: var(--card-bg); border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--info);" id="summarySkipped">0</div>
                                <div style="font-size: 12px; color: var(--text-light);">Ignor√©s</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                        <div style="font-size: 12px; color: var(--text-light);">
                            <i class="fas fa-info-circle"></i> Compatible avec le format de votre fichier IPAR Excel
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="closeTarifImportModal()">
                                Annuler
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sync-alt"></i> Mettre √† jour les Tarifs
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="modal-overlay" id="loadingOverlay" style="display: none; background: rgba(0,0,0,0.7);">
        <div style="text-align: center; color: white;">
            <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h3 id="loadingMessage">Chargement...</h3>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirmation</h3>
                <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">√ätes-vous s√ªr de vouloir effectuer cette action ?</p>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">
                        Annuler
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">
                        Confirmer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAV_c5Gt_f1h5nZF47FcPjW_h4P24LYADk",
            authDomain: "commerce22-610cc.firebaseapp.com",
            databaseURL: "https://commerce22-610cc-default-rtdb.firebaseio.com",
            projectId: "commerce22-610cc",
            storageBucket: "commerce22-610cc.firebasestorage.app",
            messagingSenderId: "458158894252",
            appId: "1:458158894252:web:d1e640b2e16ef32d978309"
        };

        // ==================== VARIABLES GLOBALES ====================
        let database = null;
        let auth = null;
        let currentUser = null;
        let isConnected = false;
        let products = [];
        let categories = [];
        let depots = [];
        let stockMovements = [];
        let filteredProducts = [];
        let filteredMovements = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let depotsChart = null;
        let categoriesChart = null;
        let performanceChart = null;
        let turnoverChart = null;
        let confirmCallback = null;
        let excelImportData = [];
        let tarifImportData = [];

        // ==================== SYSTEME DE LOGS ====================
        class Logger {
            static log(action, details) {
                const timestamp = new Date().toISOString();
                console.log(`[${timestamp}] ${action}:`, details);
                
                if (database && currentUser) {
                    const logEntry = {
                        action,
                        details: typeof details === 'string' ? details : JSON.stringify(details),
                        userId: currentUser.uid,
                        userName: currentUser.email,
                        timestamp,
                        userAgent: navigator.userAgent
                    };
                    
                    database.ref('logs').push(logEntry).catch(error => {
                        console.error("Erreur d'enregistrement du log:", error);
                    });
                }
            }
            
            static error(action, error) {
                const timestamp = new Date().toISOString();
                console.error(`[${timestamp}] ERREUR ${action}:`, error);
                
                if (database && currentUser) {
                    const logEntry = {
                        action: `ERROR_${action}`,
                        error: error.message || error.toString(),
                        userId: currentUser.uid,
                        userName: currentUser.email,
                        timestamp,
                        stack: error.stack
                    };
                    
                    database.ref('logs').push(logEntry).catch(logError => {
                        console.error("Erreur d'enregistrement du log d'erreur:", logError);
                    });
                }
            }
        }

        // ==================== SYSTEME DE NOTIFICATIONS ====================
        class NotificationSystem {
            static show(message, type = "info", duration = 5000) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, duration);
                
                Logger.log(`NOTIFICATION_${type.toUpperCase()}`, message);
            }
            
            static getIcon(type) {
                switch(type) {
                    case 'success': return 'check-circle';
                    case 'warning': return 'exclamation-triangle';
                    case 'error': return 'times-circle';
                    default: return 'info-circle';
                }
            }
            
            static showLoading(message = "Chargement...") {
                document.getElementById('loadingMessage').textContent = message;
                document.getElementById('loadingOverlay').style.display = 'flex';
            }
            
            static hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // ==================== GESTIONNAIRE DE STOCK MULTI-D√âP√îTS ====================
        class StockManager {
            static getStockStatus(quantity, minStock = 10, maxStock = 100) {
                if (quantity <= 0) return 'out';
                if (quantity <= minStock) return 'low';
                if (quantity > minStock * 2 && quantity <= maxStock * 0.7) return 'medium';
                return 'high';
            }
            
            static getStockStatusText(status) {
                switch(status) {
                    case 'high': return '√âlev√©';
                    case 'medium': return 'Moyen';
                    case 'low': return 'Bas';
                    case 'out': return 'Rupture';
                    default: return 'Inconnu';
                }
            }
            
            static calculateProductValue(quantity, costPrice) {
                return (quantity || 0) * (costPrice || 0);
            }
            
            static calculateMargin(sellPrice, costPrice) {
                if (!costPrice || costPrice <= 0) return 0;
                return ((sellPrice - costPrice) / costPrice) * 100;
            }
            
            static getCategoryProducts(categoryId) {
                return products.filter(p => p.category === categoryId);
            }
            
            static getProductStockInDepot(product, depotId) {
                if (!product || !product.stockByDepot) return 0;
                return product.stockByDepot[depotId] || 0;
            }
            
            static getProductsInDepot(depotId) {
                return products.filter(p => {
                    if (!p.stockByDepot) return false;
                    return p.stockByDepot[depotId] > 0;
                });
            }
            
            static getTotalStockInDepot(depotId) {
                let total = 0;
                products.forEach(product => {
                    if (product.stockByDepot && product.stockByDepot[depotId]) {
                        total += product.stockByDepot[depotId];
                    }
                });
                return total;
            }
            
            static getTotalValueInDepot(depotId) {
                let totalValue = 0;
                products.forEach(product => {
                    if (product.stockByDepot && product.stockByDepot[depotId]) {
                        const qty = product.stockByDepot[depotId];
                        totalValue += qty * (product.costPrice || 0);
                    }
                });
                return totalValue;
            }
            
            static getLowStockProducts(threshold = 10) {
                return products.filter(p => {
                    const totalStock = p.totalStock || 0;
                    const minStock = p.minStock || threshold;
                    return totalStock > 0 && totalStock <= minStock;
                });
            }
            
            static getOutOfStockProducts() {
                return products.filter(p => (p.totalStock || 0) <= 0);
            }
            
            static getProductMovements(productId) {
                return stockMovements.filter(m => m.productId === productId);
            }
            
            static calculateTurnoverRate(productId) {
                const movements = this.getProductMovements(productId);
                const outMovements = movements.filter(m => m.type === 'out');
                const totalOut = outMovements.reduce((sum, m) => sum + (m.quantity || 0), 0);
                const product = products.find(p => p.id === productId);
                const avgStock = (product?.totalStock || 0) / 2;
                
                return avgStock > 0 ? (totalOut / avgStock).toFixed(2) : 0;
            }
            
            static performABCAnalysis() {
                const sortedProducts = [...products].sort((a, b) => {
                    const aValue = this.calculateProductValue(a.totalStock, a.costPrice);
                    const bValue = this.calculateProductValue(b.totalStock, b.costPrice);
                    return bValue - aValue;
                });
                
                let cumulativeValue = 0;
                const totalValue = sortedProducts.reduce((sum, p) => 
                    sum + this.calculateProductValue(p.totalStock, p.costPrice), 0);
                
                return sortedProducts.map((product, index) => {
                    const productValue = this.calculateProductValue(product.totalStock, product.costPrice);
                    cumulativeValue += productValue;
                    const percentage = (cumulativeValue / totalValue) * 100;
                    
                    let category = 'C';
                    if (percentage <= 80) category = 'A';
                    else if (percentage <= 95) category = 'B';
                    
                    return {
                        product: product.name,
                        code: product.code,
                        value: productValue,
                        percentage: (productValue / totalValue) * 100,
                        cumulativePercentage: percentage,
                        category,
                        quantity: product.totalStock
                    };
                });
            }
            
            static calculateAgingAnalysis() {
                const now = new Date();
                return products.map(product => {
                    const movements = this.getProductMovements(product.id);
                    const lastMovement = movements.length > 0 ? 
                        movements.sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;
                    
                    let ageDays = 0;
                    if (lastMovement) {
                        const lastDate = new Date(lastMovement.date);
                        ageDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
                    }
                    
                    return {
                        product: product.name,
                        code: product.code,
                        quantity: product.totalStock,
                        lastMovement: lastMovement ? lastMovement.date : 'Jamais',
                        ageDays,
                        status: ageDays > 90 ? 'Ancien' : ageDays > 30 ? 'Moyen' : 'R√©cent'
                    };
                }).sort((a, b) => b.ageDays - a.ageDays);
            }
            
            static getDepotStockSummary(depotId) {
                const depotProducts = this.getProductsInDepot(depotId);
                const totalStock = this.getTotalStockInDepot(depotId);
                const totalValue = this.getTotalValueInDepot(depotId);
                const lowStockCount = depotProducts.filter(p => {
                    const stockInDepot = this.getProductStockInDepot(p, depotId);
                    return stockInDepot > 0 && stockInDepot <= (p.minStock || 10);
                }).length;
                
                return {
                    productCount: depotProducts.length,
                    totalStock,
                    totalValue,
                    lowStockCount
                };
            }
        }

        // ==================== SYSTEME D'EXPORT ====================
        class ExportManager {
            static exportToExcel(data, filename, sheetName = "Data") {
                try {
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
                    
                    NotificationSystem.show("Export Excel r√©ussi", "success");
                    Logger.log("EXPORT_EXCEL", { filename, rows: data.length });
                    return true;
                } catch (error) {
                    NotificationSystem.show("Erreur lors de l'export Excel", "error");
                    Logger.error("EXPORT_EXCEL", error);
                    return false;
                }
            }
            
            static exportProductsToExcel() {
                const exportData = products.map(product => {
                    const depotStocks = [];
                    if (product.stockByDepot) {
                        Object.keys(product.stockByDepot).forEach(depotId => {
                            const depotName = this.getDepotName(depotId);
                            const qty = product.stockByDepot[depotId];
                            if (qty > 0) {
                                depotStocks.push(`${depotName}: ${qty}`);
                            }
                        });
                    }
                    
                    return {
                        'Code': product.code || '',
                        'Nom': product.name || '',
                        'Cat√©gorie': this.getCategoryName(product.category),
                        'Stock par D√©p√¥t': depotStocks.join('; '),
                        'Quantit√© Totale': product.totalStock || 0,
                        'Seuil Min': product.minStock || 10,
                        'Seuil Max': product.maxStock || 100,
                        'Prix Achat': product.costPrice || 0,
                        'Prix Vente': product.sellPrice || 0,
                        'Valeur Totale': StockManager.calculateProductValue(product.totalStock, product.costPrice),
                        'Statut': StockManager.getStockStatusText(
                            StockManager.getStockStatus(product.totalStock, product.minStock, product.maxStock)
                        ),
                        'Description': product.description || '',
                        'Code-barres': product.barcode || '',
                        'Fournisseur': product.supplier || ''
                    };
                });
                
                return this.exportToExcel(exportData, "stock_produits_multi_depots", "Produits");
            }
            
            static exportMovementsToExcel() {
                const exportData = stockMovements.map(movement => {
                    const date = new Date(movement.date);
                    let typeText = '';
                    switch(movement.type) {
                        case 'in': typeText = 'Entr√©e'; break;
                        case 'out': typeText = 'Sortie'; break;
                        case 'transfer': typeText = 'Transfert'; break;
                        case 'adjustment': typeText = 'Ajustement'; break;
                        default: typeText = 'Inconnu';
                    }
                    
                    return {
                        'Date': date.toLocaleDateString('fr-FR'),
                        'Heure': date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                        'Type': typeText,
                        'Produit': movement.productName || '',
                        'Code Produit': this.getProductCode(movement.productId),
                        'Quantit√©': movement.quantity || 0,
                        'D√©p√¥t Source': this.getDepotName(movement.fromDepot),
                        'D√©p√¥t Destination': this.getDepotName(movement.toDepot),
                        'Raison': movement.reason || movement.notes || '',
                        'R√©f√©rence': movement.reference || '',
                        'Utilisateur': movement.userName || movement.userId || '',
                        'Date Cr√©ation': movement.createdAt ? new Date(movement.createdAt).toLocaleDateString('fr-FR') : ''
                    };
                });
                
                return this.exportToExcel(exportData, "mouvements_stock_multi_depots", "Mouvements");
            }
            
            static exportCategoriesToExcel() {
                const exportData = categories.map(category => {
                    const categoryProducts = StockManager.getCategoryProducts(category.id);
                    const totalValue = categoryProducts.reduce((sum, p) => 
                        sum + StockManager.calculateProductValue(p.totalStock, p.costPrice), 0);
                    
                    return {
                        'Nom': category.name,
                        'Description': category.description || '',
                        'Produits': categoryProducts.length,
                        'Valeur Totale': totalValue,
                        'Stock Moyen': categoryProducts.length > 0 ? 
                            categoryProducts.reduce((sum, p) => sum + (p.totalStock || 0), 0) / categoryProducts.length : 0,
                        'Couleur': category.color,
                        'Ic√¥ne': category.icon
                    };
                });
                
                return this.exportToExcel(exportData, "categories_stock", "Cat√©gories");
            }
            
            static exportDepotsToExcel() {
                const exportData = depots.map(depot => {
                    const summary = StockManager.getDepotStockSummary(depot.id);
                    
                    return {
                        'Nom': depot.name,
                        'Ville': depot.city,
                        'Adresse': depot.address,
                        'Responsable': depot.manager || '',
                        'Produits': summary.productCount,
                        'Stock Total': summary.totalStock,
                        'Valeur Totale': summary.totalValue,
                        'Stock Bas': summary.lowStockCount,
                        'Statut': depot.status === 'active' ? 'Actif' : 'Inactif',
                        'Capacit√©': depot.capacity || '',
                        'T√©l√©phone': depot.phone || '',
                        'Notes': depot.notes || ''
                    };
                });
                
                return this.exportToExcel(exportData, "depots_stock", "D√©p√¥ts");
            }
            
            static getCategoryName(categoryId) {
                if (!categoryId) return 'Non class√©';
                const category = categories.find(c => c.id === categoryId);
                return category ? category.name : 'Non class√©';
            }
            
            static getDepotName(depotId) {
                if (!depotId) return 'Non sp√©cifi√©';
                const depot = depots.find(d => d.id === depotId);
                return depot ? depot.name : 'Non sp√©cifi√©';
            }
            
            static getProductCode(productId) {
                if (!productId) return 'N/A';
                const product = products.find(p => p.id === productId);
                return product ? product.code : 'N/A';
            }
        }

        // ==================== V√âRIFICATION D'UNICIT√â DU CODE ====================
        async function checkProductCodeUniqueness(code, excludeProductId = null) {
            try {
                const productsRef = database.ref('products');
                const snapshot = await productsRef.once('value');
                const productsData = snapshot.val();
                
                if (!productsData) return true; // Aucun produit existant
                
                for (const productId in productsData) {
                    const product = productsData[productId];
                    
                    // V√©rifier si le produit est exclu (cas d'une modification)
                    if (excludeProductId && productId === excludeProductId) continue;
                    
                    // V√©rifier l'unicit√© du code (insensible √† la casse)
                    if (product.code && product.code.trim().toLowerCase() === code.trim().toLowerCase()) {
                        return false; // Code d√©j√† existant
                    }
                }
                
                return true; // Code unique
            } catch (error) {
                Logger.error("CHECK_PRODUCT_CODE_UNIQUENESS", error);
                return false; // En cas d'erreur, consid√©rer comme non valide
            }
        }

        // Fonction pour v√©rifier le code avant la soumission du formulaire
        async function validateProductCode() {
            const codeInput = document.getElementById('productCode');
            const code = codeInput.value.trim();
            const productId = document.getElementById('productId').value;
            
            if (!code) {
                return { isValid: false, message: "Le code produit est obligatoire" };
            }
            
            const isUnique = await checkProductCodeUniqueness(code, productId || null);
            
            if (!isUnique) {
                return { 
                    isValid: false, 
                    message: "Ce code produit existe d√©j√†. Veuillez utiliser un code unique." 
                };
            }
            
            return { isValid: true, message: "" };
        }

        // Fonction pour afficher une erreur de code
        function showCodeError(message) {
            let errorElement = document.getElementById('codeError');
            if (!errorElement) {
                const codeInput = document.getElementById('productCode');
                errorElement = document.createElement('div');
                errorElement.id = 'codeError';
                errorElement.style.color = 'var(--danger)';
                errorElement.style.fontSize = '12px';
                errorElement.style.marginTop = '5px';
                errorElement.style.padding = '5px';
                errorElement.style.borderRadius = '4px';
                errorElement.style.backgroundColor = 'rgba(198, 40, 40, 0.1)';
                codeInput.parentNode.appendChild(errorElement);
            }
            errorElement.textContent = message;
            document.getElementById('productCode').style.borderColor = 'var(--danger)';
        }

        function hideCodeError() {
            const errorElement = document.getElementById('codeError');
            if (errorElement) {
                errorElement.remove();
            }
            document.getElementById('productCode').style.borderColor = '';
        }

        // G√©n√©rer automatiquement un code unique
        function generateUniqueProductCode(baseCode = 'PROD') {
            // Essayer plusieurs formats jusqu'√† trouver un code unique
            const existingCodes = products.map(p => p.code?.toLowerCase());
            
            // Essayer PROD-0001, PROD-0002, etc.
            let counter = 1;
            while (true) {
                const candidate = `${baseCode}-${String(counter).padStart(4, '0')}`;
                if (!existingCodes.includes(candidate.toLowerCase())) {
                    return candidate;
                }
                counter++;
            }
        }

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            Logger.log("SYSTEM_START", "Syst√®me de gestion de stock multi-d√©p√¥ts d√©marr√©");
            
            // Initialiser le th√®me
            initTheme();
            
            // Mettre √† jour la date
            updateCurrentDate();
            
            // Gestion des onglets
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Gestion des menus utilisateur
            document.getElementById('userMenu').addEventListener('click', toggleUserDropdown);
            
            // Fermer les menus en cliquant ailleurs
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu')) {
                    document.getElementById('userDropdown').classList.remove('show');
                }
            });
            
            // Validation en temps r√©el du code produit
            document.getElementById('productCode')?.addEventListener('blur', async function() {
                const validation = await validateProductCode();
                if (!validation.isValid) {
                    showCodeError(validation.message);
                } else {
                    hideCodeError();
                }
            });
            
            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshStockData();
                }
                
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    document.getElementById('themeToggle').click();
                }
                
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                    if (activeTab === 'products') openAddProductModal();
                    else if (activeTab === 'categories') openAddCategoryModal();
                    else if (activeTab === 'depots') openAddDepotModal();
                }
                
                if (e.key === 'Escape') {
                    closeAllModals();
                    document.getElementById('userDropdown').classList.remove('show');
                }
            });
            
            // Form submissions
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('categoryForm').addEventListener('submit', saveCategory);
            document.getElementById('depotForm').addEventListener('submit', saveDepot);
            document.getElementById('adjustmentForm').addEventListener('submit', saveStockAdjustment);
            document.getElementById('transferForm').addEventListener('submit', saveStockTransfer);
            document.getElementById('excelImportForm').addEventListener('submit', handleExcelImport);
            document.getElementById('tarifImportForm').addEventListener('submit', handleTarifImport);
            document.getElementById('confirmActionBtn').addEventListener('click', executeConfirmAction);
            
            // Excel file change events
            document.getElementById('excelFile').addEventListener('change', handleExcelFileSelect);
            document.getElementById('tarifExcelFile').addEventListener('change', handleTarifExcelFileSelect);
            
            // Initialiser Firebase
            initializeFirebase();
            
            // Actualiser la date chaque minute
            setInterval(updateCurrentDate, 60000);
        });
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                updateCharts();
            });
        }
        
        function updateCurrentDate() {
            const now = new Date();
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const months = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            document.getElementById('currentDay').textContent = now.getDate();
            document.getElementById('currentDate').textContent = 
                `${days[now.getDay()]} ${months[now.getMonth()]} ${now.getFullYear()}`;
        }
        
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('show');
        }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}Tab`).classList.add('active');
            
            if (tabId === 'categories') {
                updateCategoriesTab();
            } else if (tabId === 'depots') {
                updateDepotsTab();
            } else if (tabId === 'movements') {
                updateMovementsTab();
            } else if (tabId === 'reports') {
                updateReportsTab();
            }
        }
        
        // ==================== FIREBASE ====================
        function initializeFirebase() {
            try {
                Logger.log("FIREBASE_INIT", "Initialisation de Firebase");
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                
                // Surveiller la connexion
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    const connected = snap.val() === true;
                    updateConnectionStatus(connected);
                    
                    if (connected) {
                        Logger.log("FIREBASE_CONNECTED", "Connect√© √† Firebase");
                        simulateUser();
                        loadInitialData();
                    } else {
                        Logger.log("FIREBASE_DISCONNECTED", "D√©connect√© de Firebase");
                    }
                });
                
            } catch (error) {
                Logger.error("FIREBASE_INIT", error);
                NotificationSystem.show("Erreur de connexion Firebase", "error");
                updateConnectionStatus(false);
            }
        }
        
        function simulateUser() {
            currentUser = {
                uid: 'admin_001',
                email: 'admin@ettijara.com',
                displayName: 'Administrateur'
            };
            
            updateUserUI();
        }
        
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userAvatar').textContent = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                document.getElementById('welcomeMessage').textContent = `Bienvenue ${currentUser.displayName || 'Administrateur'} !`;
            }
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            
            if (connected) {
                statusElement.className = "status-dot connected";
                statusElement.title = "Connect√© √† Firebase";
                document.getElementById('systemStatus').textContent = "Syst√®me: Connect√©";
            } else {
                statusElement.className = "status-dot disconnected";
                statusElement.title = "D√©connect√© de Firebase";
                document.getElementById('systemStatus').textContent = "Syst√®me: D√©connect√©";
            }
        }
        
        function loadInitialData() {
            NotificationSystem.showLoading("Chargement des donn√©es...");
            loadDepots();
        }
        
        function loadDepots() {
            try {
                const depotsRef = database.ref('depots');
                depotsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    depots = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            depots.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        Logger.log("DATA_LOADED", `${depots.length} d√©p√¥ts charg√©s`);
                    } else {
                        createDefaultDepots();
                    }
                    
                    updateDepotsFilters();
                    updateDepotsUI();
                    loadCategories();
                });
                
            } catch (error) {
                Logger.error("LOAD_DEPOTS", error);
                loadCategories();
            }
        }
        
        function createDefaultDepots() {
            if (!database) return;
            
            const defaultDepots = [
                {
                    name: "D√©p√¥t Principal",
                    city: "Agadir",
                    address: "Zone Industrielle, Agadir",
                    phone: "0528 123456",
                    manager: "Mohamed Ali",
                    status: "active",
                    capacity: 1000,
                    createdAt: new Date().toISOString()
                },
                {
                    name: "D√©p√¥t Secondaire",
                    city: "Ait Melloul",
                    address: "Ait Melloul Centre",
                    phone: "0528 654321",
                    manager: "Fatima Zahra",
                    status: "active",
                    capacity: 500,
                    createdAt: new Date().toISOString()
                },
                {
                    name: "Entrep√¥t Nord",
                    city: "Inezgane",
                    address: "Boulevard Mohammed V",
                    phone: "0528 789012",
                    manager: "Karim Bennani",
                    status: "active",
                    capacity: 750,
                    createdAt: new Date().toISOString()
                }
            ];
            
            defaultDepots.forEach(depot => {
                database.ref('depots').push(depot);
            });
            
            Logger.log("DEFAULT_DATA", "D√©p√¥ts par d√©faut cr√©√©s");
        }
        
        function loadCategories() {
            try {
                const categoriesRef = database.ref('categories');
                categoriesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    categories = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            categories.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        Logger.log("DATA_LOADED", `${categories.length} cat√©gories charg√©es`);
                    } else {
                        createDefaultCategories();
                    }
                    
                    updateCategoriesFilters();
                    updateCategoriesUI();
                    loadProducts();
                });
                
            } catch (error) {
                Logger.error("LOAD_CATEGORIES", error);
                loadProducts();
            }
        }
        
        function createDefaultCategories() {
            if (!database) return;
            
            const defaultCategories = [
                {
                    name: "Mat√©riaux de Construction",
                    description: "Ciment, sable, gravier, briques",
                    icon: "fas fa-box",
                    color: "#1a237e",
                    createdAt: new Date().toISOString()
                },
                {
                    name: "Peintures et Rev√™tements",
                    description: "Peintures, vernis, enduits",
                    icon: "fas fa-paint-roller",
                    color: "#d32f2f",
                    createdAt: new Date().toISOString()
                },
                {
                    name: "Outillage",
                    description: "Outils manuels et √©lectriques",
                    icon: "fas fa-tools",
                    color: "#388e3c",
                    createdAt: new Date().toISOString()
                },
                {
                    name: "Quincaillerie",
                    description: "Vis, clous, serrures, charni√®res",
                    icon: "fas fa-screwdriver",
                    color: "#f57c00",
                    createdAt: new Date().toISOString()
                },
                {
                    name: "Plomberie",
                    description: "Tuyaux, robinets, raccords",
                    icon: "fas fa-faucet",
                    color: "#0288d1",
                    createdAt: new Date().toISOString()
                },
                {
                    name: "√âlectricit√©",
                    description: "C√¢bles, interrupteurs, prises",
                    icon: "fas fa-bolt",
                    color: "#7b1fa2",
                    createdAt: new Date().toISOString()
                }
            ];
            
            defaultCategories.forEach(category => {
                database.ref('categories').push(category);
            });
            
            Logger.log("DEFAULT_DATA", "Cat√©gories par d√©faut cr√©√©es");
        }
        
        function loadProducts() {
            try {
                const productsRef = database.ref('products');
                productsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    products = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            const product = {
                                id: key,
                                ...data[key]
                            };
                            
                            // G√©rer la compatibilit√© avec l'ancienne structure
                            product.stockByDepot = product.stockByDepot || {};
                            
                            // Calculer le stock total
                            product.totalStock = 0;
                            if (product.stockByDepot) {
                                Object.values(product.stockByDepot).forEach(qty => {
                                    product.totalStock += qty;
                                });
                            } else if (product.depot && product.quantity !== undefined) {
                                // Compatibilit√© avec l'ancienne structure (single depot)
                                product.stockByDepot[product.depot] = product.quantity || 0;
                                product.totalStock = product.quantity || 0;
                            }
                            
                            // Calculer la valeur totale
                            product.totalValue = StockManager.calculateProductValue(product.totalStock, product.costPrice);
                            
                            // D√©terminer le statut du stock
                            product.stockStatus = StockManager.getStockStatus(
                                product.totalStock, 
                                product.minStock || 10,
                                product.maxStock || 100
                            );
                            
                            products.push(product);
                        });
                        
                        Logger.log("DATA_LOADED", `${products.length} produits charg√©s`);
                    }
                    
                    filteredProducts = [...products];
                    updateProductsTable();
                    updateStockStats();
                    updateCharts();
                    loadStockMovements();
                });
                
            } catch (error) {
                Logger.error("LOAD_PRODUCTS", error);
                loadStockMovements();
            }
        }
        
        function loadStockMovements() {
            try {
                const movementsRef = database.ref('stockMovements');
                movementsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    stockMovements = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            stockMovements.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        Logger.log("DATA_LOADED", `${stockMovements.length} mouvements charg√©s`);
                    }
                    
                    filteredMovements = [...stockMovements].sort((a, b) => 
                        new Date(b.date) - new Date(a.date));
                    
                    updateMovementsTable();
                    updateLastUpdateTime();
                    NotificationSystem.hideLoading();
                });
                
            } catch (error) {
                Logger.error("LOAD_MOVEMENTS", error);
                NotificationSystem.hideLoading();
            }
        }
        
        // ==================== FILTRES ====================
        function updateDepotsFilters() {
            const filterDepot = document.getElementById('filterDepot');
            const productInitialDepot = document.getElementById('productInitialDepot');
            const adjustmentDepot = document.getElementById('adjustmentDepot');
            const transferFromDepot = document.getElementById('transferFromDepot');
            const transferToDepot = document.getElementById('transferToDepot');
            const filterMovementProduct = document.getElementById('filterMovementProduct');
            
            let filterHtml = '<option value="">Tous les d√©p√¥ts</option>';
            let productHtml = '<option value="">S√©lectionner...</option>';
            let adjustmentHtml = '<option value="">S√©lectionner...</option>';
            let transferHtml = '<option value="">S√©lectionner...</option>';
            let productSelectHtml = '<option value="">Tous les produits</option>';
            
            depots.forEach(depot => {
                if (depot.status === 'active') {
                    filterHtml += `<option value="${depot.id}">${depot.name} - ${depot.city}</option>`;
                    productHtml += `<option value="${depot.id}">${depot.name} - ${depot.city}</option>`;
                    adjustmentHtml += `<option value="${depot.id}">${depot.name} - ${depot.city}</option>`;
                    transferHtml += `<option value="${depot.id}">${depot.name} - ${depot.city}</option>`;
                }
            });
            
            products.forEach(product => {
                productSelectHtml += `<option value="${product.id}">${product.code} - ${product.name}</option>`;
            });
            
            if (filterDepot) filterDepot.innerHTML = filterHtml;
            if (productInitialDepot) productInitialDepot.innerHTML = productHtml;
            if (adjustmentDepot) adjustmentDepot.innerHTML = adjustmentHtml;
            if (transferFromDepot) transferFromDepot.innerHTML = transferHtml;
            if (transferToDepot) transferToDepot.innerHTML = transferHtml;
            if (filterMovementProduct) filterMovementProduct.innerHTML = productSelectHtml;
        }
        
        function updateCategoriesFilters() {
            const filterCategory = document.getElementById('filterCategory');
            const productCategory = document.getElementById('productCategory');
            
            let filterHtml = '<option value="">Toutes les cat√©gories</option>';
            let productHtml = '<option value="">S√©lectionner...</option>';
            
            categories.forEach(category => {
                filterHtml += `<option value="${category.id}">${category.name}</option>`;
                productHtml += `<option value="${category.id}">${category.name}</option>`;
            });
            
            if (filterCategory) filterCategory.innerHTML = filterHtml;
            if (productCategory) productCategory.innerHTML = productHtml;
        }
        
        function updateAdjustmentProductFilter() {
            const adjustmentProduct = document.getElementById('adjustmentProduct');
            const transferProduct = document.getElementById('transferProduct');
            
            let adjustmentHtml = '<option value="">S√©lectionner un produit...</option>';
            let transferHtml = '<option value="">S√©lectionner un produit...</option>';
            
            products.forEach(product => {
                adjustmentHtml += `<option value="${product.id}">${product.code} - ${product.name}</option>`;
                transferHtml += `<option value="${product.id}">${product.code} - ${product.name}</option>`;
            });
            
            if (adjustmentProduct) adjustmentProduct.innerHTML = adjustmentHtml;
            if (transferProduct) transferProduct.innerHTML = transferHtml;
        }
        
        function filterProductsTable() {
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            const depotFilter = document.getElementById('filterDepot').value;
            const statusFilter = document.getElementById('filterStockStatus').value;
            
            filteredProducts = products.filter(product => {
                const matchesSearch = !searchTerm || 
                    (product.code && product.code.toLowerCase().includes(searchTerm)) ||
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                let matchesDepot = true;
                if (depotFilter) {
                    matchesDepot = product.stockByDepot && product.stockByDepot[depotFilter] > 0;
                }
                
                const matchesStatus = !statusFilter || product.stockStatus === statusFilter;
                
                return matchesSearch && matchesCategory && matchesDepot && matchesStatus;
            });
            
            updateProductsTable();
        }
        
        function filterByStockStatus(status) {
            document.getElementById('filterStockStatus').value = status === 'all' ? '' : status;
            filterProductsTable();
        }
        
        function filterMovementsTable() {
            const typeFilter = document.getElementById('filterMovementType').value;
            const dateFrom = document.getElementById('filterMovementDateFrom').value;
            const dateTo = document.getElementById('filterMovementDateTo').value;
            const productFilter = document.getElementById('filterMovementProduct').value;
            
            filteredMovements = stockMovements.filter(movement => {
                const matchesType = !typeFilter || movement.type === typeFilter;
                
                let matchesDate = true;
                if (dateFrom) {
                    const movementDate = new Date(movement.date).toISOString().split('T')[0];
                    if (movementDate < dateFrom) matchesDate = false;
                }
                if (dateTo) {
                    const movementDate = new Date(movement.date).toISOString().split('T')[0];
                    if (movementDate > dateTo) matchesDate = false;
                }
                
                const matchesProduct = !productFilter || movement.productId === productFilter;
                
                return matchesType && matchesDate && matchesProduct;
            });
            
            filteredMovements.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            updateMovementsTable();
        }
        
        // ==================== MISE √Ä JOUR DES TABLES ====================
        function updateProductsTable(page = 1) {
            const tableBody = document.getElementById('productsTable');
            const pagination = document.getElementById('productsPagination');
            
            if (filteredProducts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucun produit trouv√©</h3>
                            <p>${products.length === 0 ? 'Aucun produit dans la base de donn√©es' : 'Essayez de modifier vos crit√®res de recherche'}</p>
                        </td>
                    </tr>
                `;
                pagination.innerHTML = '';
                return;
            }
            
            // Pagination
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            currentPage = Math.min(Math.max(page, 1), totalPages);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            
            let html = '';
            pageProducts.forEach(product => {
                const statusText = StockManager.getStockStatusText(product.stockStatus);
                const statusClass = `stock-${product.stockStatus}`;
                const categoryName = getCategoryName(product.category);
                const margin = StockManager.calculateMargin(product.sellPrice, product.costPrice);
                
                // R√©cup√©rer les stocks par d√©p√¥t
                const depotsStock = [];
                if (product.stockByDepot) {
                    Object.keys(product.stockByDepot).forEach(depotId => {
                        const depotName = getDepotName(depotId);
                        const qty = product.stockByDepot[depotId];
                        if (qty > 0) {
                            depotsStock.push(`<div><strong>${depotName}:</strong> ${qty} unit√©s</div>`);
                        }
                    });
                }
                
                const depotInfo = depotsStock.length > 0 
                    ? depotsStock.join('')
                    : '<div style="color: var(--text-light); font-style: italic;">Aucun stock</div>';
                
                html += `
                    <tr>
                        <td><strong style="color: var(--primary);">${product.code || ''}</strong></td>
                        <td style="text-align: right;">
                            <div><strong>${product.name || ''}</strong></div>
                            ${product.description ? `<div style="font-size: 12px; color: var(--text-light);">${product.description.substring(0, 50)}...</div>` : ''}
                        </td>
                        <td>${categoryName}</td>
                        <td style="text-align: right;">
                            <div style="font-size: 12px;">
                                ${depotInfo}
                            </div>
                        </td>
                        <td><strong style="font-size: 16px;">${product.totalStock || 0}</strong></td>
                        <td>${product.minStock || 10}</td>
                        <td><strong>${formatNumber(product.costPrice || 0)}</strong></td>
                        <td><strong style="color: var(--success);">${formatNumber(product.sellPrice || 0)}</strong></td>
                        <td><strong style="color: var(--success); font-size: 14px;">${formatNumber(product.totalValue || 0)} DH</strong></td>
                        <td>
                            <span class="stock-status ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-edit" onclick="editProduct('${product.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" style="background: var(--cyan); color: white;" onclick="openTransferStockModal('${product.id}')" title="Transf√©rer">
                                    <i class="fas fa-truck"></i>
                                </button>
                                <button class="btn-icon" style="background: var(--success); color: white;" onclick="adjustStockForProduct('${product.id}')" title="Ajuster stock">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button class="btn-icon" style="background: var(--info); color: white;" onclick="viewProductHistory('${product.id}')" title="Historique">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="confirmDeleteProduct('${product.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            updatePagination(pagination, totalPages, currentPage, 'products');
        }
        
        function updateCategoriesTab() {
            updateCategoriesUI();
        }
        
        function updateCategoriesUI() {
            const grid = document.getElementById('categoriesGrid');
            
            if (categories.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-tags" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucune cat√©gorie trouv√©e</h3>
                        <p>Cliquez sur "Nouvelle Cat√©gorie" pour en cr√©er une</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            categories.forEach(category => {
                const categoryProducts = StockManager.getCategoryProducts(category.id);
                const productCount = categoryProducts.length;
                const totalValue = categoryProducts.reduce((sum, p) => sum + (p.totalValue || 0), 0);
                const avgStock = productCount > 0 ? 
                    categoryProducts.reduce((sum, p) => sum + (p.totalStock || 0), 0) / productCount : 0;
                
                html += `
                    <div class="category-card">
                        <div class="category-header">
                            <div class="category-name">
                                <div class="category-icon" style="background: ${category.color || '#1a237e'}; color: white;">
                                    <i class="${category.icon || 'fas fa-tag'}"></i>
                                </div>
                                <span>${category.name}</span>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-icon btn-edit" onclick="editCategory('${category.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="confirmDeleteCategory('${category.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 15px;">
                            ${category.description || 'Aucune description'}
                        </div>
                        
                        <div class="category-stats">
                            <div class="stat-item">
                                <div class="stat-value">${productCount}</div>
                                <div class="stat-label">Produits</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatNumber(totalValue)}</div>
                                <div class="stat-label">Valeur</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${Math.round(avgStock)}</div>
                                <div class="stat-label">Stock Moyen</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function updateDepotsTab() {
            updateDepotsUI();
        }
        
        function updateDepotsUI() {
            const grid = document.getElementById('depotsGrid');
            const tableBody = document.getElementById('depotsTable');
            
            if (depots.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-warehouse" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucun d√©p√¥t trouv√©</h3>
                        <p>Cliquez sur "Nouveau D√©p√¥t" pour en cr√©er un</p>
                    </div>
                `;
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-warehouse" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucun d√©p√¥t trouv√©</h3>
                            <p>Cliquez sur "Nouveau D√©p√¥t" pour en cr√©er un</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Grid View
            let gridHtml = '';
            depots.forEach(depot => {
                const summary = StockManager.getDepotStockSummary(depot.id);
                
                gridHtml += `
                    <div class="category-card">
                        <div class="category-header">
                            <div class="category-name">
                                <div class="category-icon" style="background: var(--primary); color: white;">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                                <span>${depot.name}</span>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-icon btn-edit" onclick="editDepot('${depot.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="confirmDeleteDepot('${depot.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 15px;">
                            <div><i class="fas fa-map-marker-alt"></i> ${depot.address}, ${depot.city}</div>
                            ${depot.manager ? `<div><i class="fas fa-user"></i> ${depot.manager}</div>` : ''}
                            ${depot.phone ? `<div><i class="fas fa-phone"></i> ${depot.phone}</div>` : ''}
                        </div>
                        
                        <div class="category-stats">
                            <div class="stat-item">
                                <div class="stat-value">${summary.productCount}</div>
                                <div class="stat-label">Produits</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${summary.totalStock}</div>
                                <div class="stat-label">Stock</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${formatNumber(summary.totalValue)}</div>
                                <div class="stat-label">Valeur</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = gridHtml;
            
            // Table View
            let tableHtml = '';
            depots.forEach(depot => {
                const summary = StockManager.getDepotStockSummary(depot.id);
                
                tableHtml += `
                    <tr>
                        <td><strong>${depot.name}</strong></td>
                        <td>${depot.city}</td>
                        <td>${depot.address}</td>
                        <td>${depot.manager || '--'}</td>
                        <td><strong>${summary.productCount}</strong></td>
                        <td><strong>${summary.totalStock}</strong></td>
                        <td><strong style="color: var(--success);">${formatNumber(summary.totalValue)} DH</strong></td>
                        <td>
                            <span style="background: ${depot.status === 'active' ? 'var(--success)' : 'var(--danger)'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${depot.status === 'active' ? 'Actif' : 'Inactif'}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon btn-edit" onclick="editDepot('${depot.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="confirmDeleteDepot('${depot.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHtml;
        }
        
        function updateMovementsTab() {
            filterMovementsTable();
        }
        
        function updateMovementsTable(page = 1) {
            const tableBody = document.getElementById('movementsTable');
            const pagination = document.getElementById('movementsPagination');
            
            if (filteredMovements.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-light);">
                            <i class="fas fa-exchange-alt" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucun mouvement trouv√©</h3>
                            <p>${stockMovements.length === 0 ? 'Aucun mouvement dans la base de donn√©es' : 'Essayez de modifier vos crit√®res de recherche'}</p>
                        </td>
                    </tr>
                `;
                pagination.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(filteredMovements.length / itemsPerPage);
            currentPage = Math.min(Math.max(page, 1), totalPages);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageMovements = filteredMovements.slice(startIndex, endIndex);
            
            let html = '';
            pageMovements.forEach(movement => {
                const date = new Date(movement.date);
                const dateStr = date.toLocaleDateString('fr-FR');
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const product = products.find(p => p.id === movement.productId);
                const productName = product ? product.name : 'Produit inconnu';
                const productCode = product ? product.code : 'N/A';
                
                let typeText = '';
                let typeClass = '';
                switch(movement.type) {
                    case 'in':
                        typeText = 'Entr√©e';
                        typeClass = 'stock-high';
                        break;
                    case 'out':
                        typeText = 'Sortie';
                        typeClass = 'stock-low';
                        break;
                    case 'transfer':
                        typeText = 'Transfert';
                        typeClass = 'stock-medium';
                        break;
                    case 'adjustment':
                        typeText = 'Ajustement';
                        typeClass = 'stock-medium';
                        break;
                    default:
                        typeText = 'Inconnu';
                        typeClass = '';
                }
                
                html += `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${dateStr}</div>
                            <div style="font-size: 12px; color: var(--text-light);">${timeStr}</div>
                        </td>
                        <td>
                            <span class="stock-status ${typeClass}">
                                ${typeText}
                            </span>
                        </td>
                        <td>
                            <div><strong>${productCode}</strong></div>
                            <div style="font-size: 12px; color: var(--text-light);">${productName}</div>
                        </td>
                        <td><strong>${movement.quantity}</strong></td>
                        <td>${getDepotName(movement.fromDepot) || 'N/A'}</td>
                        <td>${getDepotName(movement.toDepot) || 'N/A'}</td>
                        <td>${movement.reason || movement.notes || 'N/A'}</td>
                        <td>${movement.reference || 'N/A'}</td>
                        <td>${movement.userName || movement.userId || 'N/A'}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            updatePagination(pagination, totalPages, currentPage, 'movements');
        }
        
        function updatePagination(container, totalPages, currentPage, type) {
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                     onclick="changePage('${type}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                     <i class="fas fa-chevron-right"></i></button>`;
            
            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" 
                         onclick="changePage('${type}', ${i})">${i}</button>`;
            }
            
            // Next button
            html += `<button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                     onclick="changePage('${type}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                     <i class="fas fa-chevron-left"></i></button>`;
            
            container.innerHTML = html;
        }
        
        function changePage(type, page) {
            if (type === 'products') {
                updateProductsTable(page);
            } else if (type === 'movements') {
                updateMovementsTable(page);
            }
        }
        
        // ==================== MISE √Ä JOUR DES STATS ====================
        function updateStockStats() {
            const totalProducts = products.length;
            
            let totalValue = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            
            products.forEach(product => {
                totalValue += product.totalValue || 0;
                
                if (product.stockStatus === 'low') lowStockCount++;
                if (product.stockStatus === 'out') outOfStockCount++;
            });
            
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalValue').textContent = formatNumber(totalValue) + ' DH';
            document.getElementById('lowStockCount').textContent = lowStockCount;
            document.getElementById('outOfStockCount').textContent = outOfStockCount;
            
            // Mettre √† jour les stats du footer
            document.getElementById('totalStats').textContent = 
                `${totalProducts} produits | ${depots.length} d√©p√¥ts | ${categories.length} cat√©gories`;
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `Derni√®re mise √† jour: ${timeString}`;
        }
        
        // ==================== GESTION DES CHARTS ====================
        function updateCharts() {
            updateDepotsChart();
            updateCategoriesChart();
            updatePerformanceChart();
            updateTurnoverChart();
        }
        
        function updateDepotsChart() {
            const ctx = document.getElementById('depotsChart')?.getContext('2d');
            if (!ctx) return;
            
            const depotData = {};
            const depotColors = {};
            
            depots.forEach(depot => {
                if (depot.status === 'active') {
                    const summary = StockManager.getDepotStockSummary(depot.id);
                    depotData[depot.name] = summary.totalStock;
                    depotColors[depot.name] = getRandomColor();
                }
            });
            
            const labels = Object.keys(depotData);
            const data = Object.values(depotData);
            const colors = labels.map(label => depotColors[label]);
            
            if (depotsChart) {
                depotsChart.destroy();
            }
            
            const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
            const textLightColor = getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim();
            const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
            
            depotsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stock par D√©p√¥t',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: borderColor
                            },
                            ticks: {
                                color: textLightColor
                            },
                            title: {
                                display: true,
                                text: 'Quantit√©',
                                color: textColor
                            }
                        },
                        x: {
                            grid: {
                                color: borderColor
                            },
                            ticks: {
                                color: textLightColor,
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        function updateCategoriesChart() {
            const ctx = document.getElementById('categoriesChart')?.getContext('2d');
            if (!ctx) return;
            
            const categoryData = {};
            
            products.forEach(product => {
                const category = categories.find(c => c.id === product.category);
                const categoryName = category ? category.name : 'Non class√©';
                
                if (!categoryData[categoryName]) {
                    categoryData[categoryName] = 0;
                }
                categoryData[categoryName] += product.totalStock || 0;
            });
            
            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const colors = labels.map(label => {
                const category = categories.find(c => c.name === label);
                return category ? category.color : getRandomColor();
            });
            
            if (categoriesChart) {
                categoriesChart.destroy();
            }
            
            const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
            
            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: cardBg,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }
        
        function updateReportsTab() {
            updatePerformanceChart();
            updateTurnoverChart();
        }
        
        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart')?.getContext('2d');
            if (!ctx) return;
            
            const depotNames = depots.filter(d => d.status === 'active').map(d => d.name);
            const depotValues = depotNames.map(name => {
                const depot = depots.find(d => d.name === name);
                if (depot) {
                    const summary = StockManager.getDepotStockSummary(depot.id);
                    return summary.totalValue / 1000; // Convertir en k DH
                }
                return 0;
            });
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
            const textLightColor = getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim();
            const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: depotNames,
                    datasets: [{
                        label: 'Valeur Stock (k DH)',
                        data: depotValues,
                        backgroundColor: primaryColor + '80',
                        borderColor: primaryColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: borderColor
                            },
                            ticks: {
                                color: textLightColor
                            },
                            title: {
                                display: true,
                                text: 'Valeur (k DH)',
                                color: textColor
                            }
                        },
                        x: {
                            grid: {
                                color: borderColor
                            },
                            ticks: {
                                color: textLightColor,
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        function updateTurnoverChart() {
            const ctx = document.getElementById('turnoverChart')?.getContext('2d');
            if (!ctx) return;
            
            const last30Days = stockMovements.filter(m => {
                const movementDate = new Date(m.date);
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                return movementDate >= thirtyDaysAgo;
            });
            
            const depotMovements = {};
            depots.forEach(depot => {
                if (depot.status === 'active') {
                    depotMovements[depot.name] = {
                        in: 0,
                        out: 0
                    };
                }
            });
            
            last30Days.forEach(movement => {
                if (movement.type === 'in' && movement.toDepot) {
                    const depotName = getDepotName(movement.toDepot);
                    if (depotMovements[depotName]) {
                        depotMovements[depotName].in += movement.quantity || 0;
                    }
                } else if (movement.type === 'out' && movement.fromDepot) {
                    const depotName = getDepotName(movement.fromDepot);
                    if (depotMovements[depotName]) {
                        depotMovements[depotName].out += movement.quantity || 0;
                    }
                }
            });
            
            const labels = Object.keys(depotMovements);
            const inData = labels.map(name => depotMovements[name].in);
            const outData = labels.map(name => depotMovements[name].out);
            
            if (turnoverChart) {
                turnoverChart.destroy();
            }
            
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success').trim();
            const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
            const textLightColor = getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim();
            const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
            
            turnoverChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entr√©es',
                            data: inData,
                            backgroundColor: successColor + '80',
                            borderColor: successColor,
                            borderWidth: 1
                        },
                        {
                            label: 'Sorties',
                            data: outData,
                            backgroundColor: dangerColor + '80',
                            borderColor: dangerColor,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: borderColor
                            },
                            ticks: {
                                color: textLightColor
                            },
                            title: {
                                display: true,
                                text: 'Quantit√©',
                                color: textColor
                            }
                        },
                        x: {
                            grid: {
                                color: borderColor
                            },
                            ticks: {
                                color: textLightColor,
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== GESTION DES MODALES ====================
        function openAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Nouveau Produit';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            
            // G√©n√©rer un code produit automatique et unique
            const uniqueCode = generateUniqueProductCode();
            document.getElementById('productCode').value = uniqueCode;
            document.getElementById('productInitialQuantity').value = '0';
            document.getElementById('productMinStock').value = '10';
            document.getElementById('productMaxStock').value = '100';
            
            // Cacher les erreurs
            hideCodeError();
            
            document.getElementById('productModal').classList.add('active');
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = 'Modifier Produit';
            document.getElementById('productId').value = product.id;
            document.getElementById('productCode').value = product.code;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            
            // Pour le d√©p√¥t initial, prendre le premier d√©p√¥t avec du stock
            let firstDepotWithStock = '';
            if (product.stockByDepot) {
                const depotIds = Object.keys(product.stockByDepot);
                if (depotIds.length > 0) {
                    firstDepotWithStock = depotIds[0];
                }
            }
            document.getElementById('productInitialDepot').value = firstDepotWithStock;
            
            document.getElementById('productInitialQuantity').value = product.totalStock || 0;
            document.getElementById('productMinStock').value = product.minStock || 10;
            document.getElementById('productMaxStock').value = product.maxStock || 100;
            document.getElementById('productCostPrice').value = product.costPrice || 0;
            document.getElementById('productSellPrice').value = product.sellPrice || 0;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productBarcode').value = product.barcode || '';
            document.getElementById('productSupplier').value = product.supplier || '';
            
            // Cacher les erreurs
            hideCodeError();
            
            document.getElementById('productModal').classList.add('active');
        }
        
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            hideCodeError();
        }
        
        function openAddCategoryModal() {
            document.getElementById('categoryModalTitle').textContent = 'Nouvelle Cat√©gorie';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryColor').value = '#1a237e';
            document.getElementById('categoryIcon').value = 'fas fa-tag';
            
            document.getElementById('categoryModal').classList.add('active');
        }
        
        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            document.getElementById('categoryModalTitle').textContent = 'Modifier Cat√©gorie';
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryIcon').value = category.icon || 'fas fa-tag';
            document.getElementById('categoryColor').value = category.color || '#1a237e';
            document.getElementById('categoryDescription').value = category.description || '';
            
            document.getElementById('categoryModal').classList.add('active');
        }
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }
        
        function openAddDepotModal() {
            document.getElementById('depotModalTitle').textContent = 'Nouveau D√©p√¥t';
            document.getElementById('depotForm').reset();
            document.getElementById('depotId').value = '';
            document.getElementById('depotStatus').value = 'active';
            
            document.getElementById('depotModal').classList.add('active');
        }
        
        function editDepot(depotId) {
            const depot = depots.find(d => d.id === depotId);
            if (!depot) return;
            
            document.getElementById('depotModalTitle').textContent = 'Modifier D√©p√¥t';
            document.getElementById('depotId').value = depot.id;
            document.getElementById('depotName').value = depot.name;
            document.getElementById('depotCity').value = depot.city;
            document.getElementById('depotAddress').value = depot.address;
            document.getElementById('depotManager').value = depot.manager || '';
            document.getElementById('depotPhone').value = depot.phone || '';
            document.getElementById('depotStatus').value = depot.status || 'active';
            document.getElementById('depotCapacity').value = depot.capacity || '';
            document.getElementById('depotNotes').value = depot.notes || '';
            
            document.getElementById('depotModal').classList.add('active');
        }
        
        function closeDepotModal() {
            document.getElementById('depotModal').classList.remove('active');
        }
        
        function openStockAdjustmentModal() {
            document.getElementById('adjustmentModal').classList.add('active');
            updateAdjustmentProductFilter();
        }
        
        function adjustStockForProduct(productId) {
            openStockAdjustmentModal();
            document.getElementById('adjustmentProduct').value = productId;
            updateAdjustmentProductInfo();
        }
        
        function updateAdjustmentProductInfo() {
            const productId = document.getElementById('adjustmentProduct').value;
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    updateAdjustmentStockInfo();
                }
            }
        }
        
        function updateAdjustmentStockInfo() {
            const productId = document.getElementById('adjustmentProduct').value;
            const depotId = document.getElementById('adjustmentDepot').value;
            
            if (productId && depotId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const stockInDepot = StockManager.getProductStockInDepot(product, depotId);
                    document.getElementById('currentStockInDepot').textContent = stockInDepot;
                    document.getElementById('currentTotalStock').textContent = product.totalStock || 0;
                    
                    document.getElementById('adjustmentStockInfo').style.display = 'block';
                }
            } else {
                document.getElementById('adjustmentStockInfo').style.display = 'none';
            }
        }
        
        function updateAdjustmentType() {
            const type = document.getElementById('adjustmentType').value;
            const quantityInput = document.getElementById('adjustmentQuantity');
            
            if (type === 'set') {
                quantityInput.placeholder = 'Nouvelle quantit√© dans ce d√©p√¥t';
            } else {
                quantityInput.placeholder = 'Quantit√©';
            }
        }
        
        function closeAdjustmentModal() {
            document.getElementById('adjustmentModal').classList.remove('active');
            document.getElementById('adjustmentForm').reset();
            document.getElementById('adjustmentStockInfo').style.display = 'none';
        }
        
        function openTransferStockModal(productId = null) {
            document.getElementById('transferModal').classList.add('active');
            updateAdjustmentProductFilter();
            
            if (productId) {
                document.getElementById('transferProduct').value = productId;
                updateTransferProductInfo();
            }
        }
        
        function updateTransferProductInfo() {
            const productId = document.getElementById('transferProduct').value;
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    updateTransferStockInfo();
                }
            }
        }
        
        function updateTransferStockInfo() {
            const productId = document.getElementById('transferProduct').value;
            const fromDepotId = document.getElementById('transferFromDepot').value;
            
            if (productId && fromDepotId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    const stockInDepot = StockManager.getProductStockInDepot(product, fromDepotId);
                    document.getElementById('availableStockForTransfer').textContent = stockInDepot;
                    document.getElementById('totalStockForTransfer').textContent = product.totalStock || 0;
                    
                    document.getElementById('transferStockInfo').style.display = 'block';
                }
            } else {
                document.getElementById('transferStockInfo').style.display = 'none';
            }
        }
        
        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('active');
            document.getElementById('transferForm').reset();
            document.getElementById('transferStockInfo').style.display = 'none';
        }
        
        // ==================== EXCEL IMPORT MODAL ====================
        function openExcelImportModal() {
            document.getElementById('excelImportModal').classList.add('active');
            
            // Populate depot dropdown
            const depotSelect = document.getElementById('selectDepot');
            let depotHtml = '<option value="">Choisir un d√©p√¥t...</option>';
            
            depots.forEach(depot => {
                if (depot.status === 'active') {
                    depotHtml += `<option value="${depot.id}">${depot.name} - ${depot.city}</option>`;
                }
            });
            
            depotSelect.innerHTML = depotHtml;
            
            // Reset form and hide preview
            document.getElementById('excelImportForm').reset();
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('importSummary').style.display = 'none';
            excelImportData = [];
        }
        
        function closeExcelImportModal() {
            document.getElementById('excelImportModal').classList.remove('active');
            excelImportData = [];
        }
        
        function handleExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Parse data
                    const parsedData = parseExcelData(jsonData);
                    excelImportData = parsedData;
                    
                    // Display preview
                    displayExcelPreview(parsedData);
                    
                    // Update summary
                    updateImportSummary(parsedData);
                    
                } catch (error) {
                    Logger.error("EXCEL_PARSE", error);
                    NotificationSystem.show("Erreur lors de la lecture du fichier Excel", "error");
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function parseExcelData(jsonData) {
            const parsedData = [];
            
            if (jsonData.length === 0) return parsedData;
            
            // Try to detect column positions
            let codeCol = -1, nameCol = -1, stockCol = -1;
            
            // Look for header row (usually first row)
            const firstRow = jsonData[0] || [];
            
            // Check common French column names
            for (let i = 0; i < firstRow.length; i++) {
                const cellValue = String(firstRow[i] || '').toLowerCase();
                
                if (cellValue.includes('code') || cellValue.includes('id') || cellValue.includes('r√©f√©rence') || cellValue.includes('article')) {
                    codeCol = i;
                } else if (cellValue.includes('nom') || cellValue.includes('produit') || cellValue.includes('d√©signation')) {
                    nameCol = i;
                } else if (cellValue.includes('stock') || cellValue.includes('quantit√©') || cellValue.includes('qte')) {
                    stockCol = i;
                }
            }
            
            // If headers not found in first row, try to infer from data patterns
            if (codeCol === -1 || nameCol === -1 || stockCol === -1) {
                // Try to find data pattern in first few rows
                for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (!row) continue;
                    
                    for (let j = 0; j < row.length; j++) {
                        const cellValue = String(row[j] || '');
                        
                        if (codeCol === -1) {
                            // Check for product code pattern (e.g., CO-0052, US-2222)
                            if (cellValue.match(/^[A-Z]{2}-[0-9]{4}$/) || 
                                cellValue.match(/^[A-Z]{2}-[0-9]{3,}$/) ||
                                cellValue.match(/^[A-Z0-9]{4,}-[0-9]{2,}$/)) {
                                codeCol = j;
                            }
                        }
                        
                        if (nameCol === -1) {
                            // Check for product name (long text)
                            if (cellValue.length > 10 && cellValue.includes(' ')) {
                                nameCol = j;
                            }
                        }
                        
                        if (stockCol === -1) {
                            // Check for stock (numeric)
                            if (!isNaN(parseFloat(cellValue)) && cellValue.trim() !== '') {
                                stockCol = j;
                            }
                        }
                    }
                }
            }
            
            // If still not found, use default positions (0, 1, 2)
            if (codeCol === -1) codeCol = 0;
            if (nameCol === -1) nameCol = 1;
            if (stockCol === -1) stockCol = 2;
            
            // Extract data (skip header row if it contains non-numeric stock)
            let startRow = 0;
            if (jsonData.length > 0) {
                const firstRowStock = jsonData[0] && jsonData[0][stockCol];
                if (firstRowStock && isNaN(parseFloat(firstRowStock))) {
                    startRow = 1; // Skip header row
                }
            }
            
            // V√©rifier les doublons dans le fichier
            const codesInFile = new Set();
            const duplicatesInFile = new Set();
            
            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                const code = String(row[codeCol] || '').trim();
                const name = String(row[nameCol] || '').trim();
                const stock = parseFloat(row[stockCol]) || 0;
                
                // Skip empty rows
                if (code === '' && name === '' && stock === 0) continue;
                
                // Only add if we have at least a code or name
                if (code || name) {
                    // V√©rifier les doublons dans le fichier
                    if (code && codesInFile.has(code.toLowerCase())) {
                        duplicatesInFile.add(code.toLowerCase());
                        continue; // Ignorer les doublons dans le fichier
                    }
                    
                    if (code) {
                        codesInFile.add(code.toLowerCase());
                    }
                    
                    parsedData.push({
                        code: code,
                        name: name,
                        stock: stock,
                        matchedProduct: null
                    });
                }
            }
            
            // Avertissement pour les doublons dans le fichier
            if (duplicatesInFile.size > 0) {
                console.warn("Codes en double dans le fichier Excel:", Array.from(duplicatesInFile));
                NotificationSystem.show(`${duplicatesInFile.size} codes en double d√©tect√©s dans le fichier et ignor√©s`, "warning");
            }
            
            // Try to match with existing products
            parsedData.forEach(item => {
                // Try exact code match first
                let matchedProduct = products.find(p => p.code && p.code.toLowerCase() === item.code.toLowerCase());
                
                // If not found, try name similarity
                if (!matchedProduct && item.name) {
                    matchedProduct = products.find(p => 
                        p.name && (p.name.toLowerCase().includes(item.name.toLowerCase()) ||
                        item.name.toLowerCase().includes(p.name.toLowerCase()))
                    );
                }
                
                item.matchedProduct = matchedProduct;
            });
            
            return parsedData;
        }
        
        function displayExcelPreview(data) {
            const previewTableBody = document.getElementById('previewTableBody');
            const previewCount = document.getElementById('previewCount');
            const previewSection = document.getElementById('excelPreview');
            
            if (data.length === 0) {
                previewTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: var(--text-light);">
                            Aucune donn√©e valide trouv√©e
                        </td>
                    </tr>
                `;
                previewCount.textContent = '0';
                previewSection.style.display = 'block';
                return;
            }
            
            let html = '';
            const previewLimit = Math.min(20, data.length);
            
            for (let i = 0; i < previewLimit; i++) {
                const item = data[i];
                const status = item.matchedProduct ? 'Existant' : 'Nouveau';
                const statusClass = item.matchedProduct ? 'success' : 'primary';
                
                html += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center; font-family: monospace;">
                            ${item.code || '<span style="color: var(--text-light); font-style: italic;">N/A</span>'}
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: right;">
                            ${item.name.substring(0, 40)}${item.name.length > 40 ? '...' : ''}
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center;">
                            <strong>${item.stock}</strong>
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center;">
                            <span style="background: var(--${statusClass}); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            if (data.length > previewLimit) {
                html += `
                    <tr>
                        <td colspan="4" style="padding: 10px; text-align: center; color: var(--text-light); font-style: italic;">
                            ... et ${data.length - previewLimit} autres produits
                        </td>
                    </tr>
                `;
            }
            
            previewTableBody.innerHTML = html;
            previewCount.textContent = data.length;
            previewSection.style.display = 'block';
        }
        
        function updateImportSummary(data) {
            const importType = document.getElementById('importType').value;
            let newCount = 0;
            let updateCount = 0;
            let skipCount = 0;
            
            data.forEach(item => {
                if (item.matchedProduct) {
                    if (importType === 'new') {
                        skipCount++;
                    } else {
                        updateCount++;
                    }
                } else {
                    newCount++;
                }
            });
            
            document.getElementById('summaryNew').textContent = newCount;
            document.getElementById('summaryUpdate').textContent = updateCount;
            document.getElementById('summarySkip').textContent = skipCount;
            document.getElementById('importSummary').style.display = 'block';
        }
        
        async function handleExcelImport(e) {
            e.preventDefault();
            
            const depotId = document.getElementById('selectDepot').value;
            const importType = document.getElementById('importType').value;
            
            if (!depotId) {
                NotificationSystem.show("Veuillez s√©lectionner un d√©p√¥t", "error");
                return;
            }
            
            if (excelImportData.length === 0) {
                NotificationSystem.show("Aucune donn√©e √† importer", "error");
                return;
            }
            
            const depot = depots.find(d => d.id === depotId);
            if (!depot) {
                NotificationSystem.show("D√©p√¥t non trouv√©", "error");
                return;
            }
            
            NotificationSystem.showLoading("Importation des donn√©es Excel...");
            
            try {
                const results = await importStockFromExcel(excelImportData, depotId, importType);
                
                // Show results
                let message = `Importation termin√©e : `;
                message += `${results.newProducts} nouveaux produits, `;
                message += `${results.updatedProducts} produits mis √† jour`;
                
                if (results.skippedProducts > 0) {
                    message += `, ${results.skippedProducts} produits ignor√©s`;
                }
                
                if (results.duplicateCodes > 0) {
                    message += `, ${results.duplicateCodes} codes en double ignor√©s`;
                }
                
                NotificationSystem.show(message, "success");
                
                // Refresh data
                refreshStockData();
                
                // Close modal
                closeExcelImportModal();
                
                Logger.log("EXCEL_IMPORT_SUCCESS", results);
                
            } catch (error) {
                Logger.error("EXCEL_IMPORT", error);
                NotificationSystem.show("Erreur lors de l'importation: " + error.message, "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        async function importStockFromExcel(data, depotId, importType) {
            const results = {
                newProducts: 0,
                updatedProducts: 0,
                skippedProducts: 0,
                duplicateCodes: 0,
                totalProducts: data.length
            };
            
            const depot = depots.find(d => d.id === depotId);
            if (!depot) throw new Error("D√©p√¥t non trouv√©");
            
            // V√©rifier les doublons avant l'importation
            const existingCodes = new Set(products.map(p => p.code?.toLowerCase()));
            const codesToImport = new Set();
            const duplicateCodes = new Set();
            
            // V√©rifier les doublons dans les donn√©es √† importer
            data.forEach(item => {
                const normalizedCode = item.code?.toLowerCase();
                if (normalizedCode) {
                    if (codesToImport.has(normalizedCode)) {
                        duplicateCodes.add(normalizedCode);
                        results.duplicateCodes++;
                    } else {
                        codesToImport.add(normalizedCode);
                    }
                }
            });
            
            // Process each product
            for (const item of data) {
                try {
                    // Ignorer les doublons dans le fichier
                    const normalizedCode = item.code?.toLowerCase();
                    if (normalizedCode && duplicateCodes.has(normalizedCode)) {
                        results.skippedProducts++;
                        continue;
                    }
                    
                    if (item.matchedProduct) {
                        // Product exists
                        if (importType === 'new') {
                            results.skippedProducts++;
                            continue;
                        }
                        
                        const product = item.matchedProduct;
                        const currentStock = StockManager.getProductStockInDepot(product, depotId);
                        let newStock = currentStock;
                        
                        if (importType === 'add') {
                            newStock = currentStock + item.stock;
                        } else if (importType === 'replace') {
                            newStock = item.stock;
                        }
                        
                        // Update product stock
                        const updates = {};
                        updates[`products/${product.id}/stockByDepot/${depotId}`] = newStock;
                        
                        // Recalculate total stock
                        const updatedStockByDepot = {
                            ...(product.stockByDepot || {}),
                            [depotId]: newStock
                        };
                        
                        let newTotalStock = 0;
                        Object.values(updatedStockByDepot).forEach(qty => {
                            newTotalStock += qty;
                        });
                        
                        updates[`products/${product.id}/totalStock`] = newTotalStock;
                        updates[`products/${product.id}/updatedAt`] = new Date().toISOString();
                        
                        await database.ref().update(updates);
                        
                        // Record stock movement if stock changed
                        if (newStock !== currentStock) {
                            const movementType = newStock > currentStock ? 'in' : 'out';
                            const quantity = Math.abs(newStock - currentStock);
                            
                            await recordStockMovement({
                                productId: product.id,
                                productName: product.name,
                                depotId: depotId,
                                type: movementType,
                                quantity: quantity,
                                reason: 'import_excel',
                                notes: `Importation depuis Excel (${importType})`,
                                previousStock: currentStock,
                                newStock: newStock,
                                date: new Date().toISOString(),
                                userName: currentUser?.email || 'Administrateur',
                                createdAt: new Date().toISOString()
                            });
                        }
                        
                        results.updatedProducts++;
                        
                    } else {
                        // New product
                        // V√©rifier si le code existe d√©j√† dans la base
                        if (item.code && existingCodes.has(item.code.toLowerCase())) {
                            results.skippedProducts++;
                            results.duplicateCodes++;
                            continue;
                        }
                        
                        // Find a category for the new product
                        let categoryId = '';
                        if (categories.length > 0) {
                            // Try to find a default category
                            const defaultCategory = categories.find(c => 
                                c.name.toLowerCase().includes('divers') || 
                                c.name.toLowerCase().includes('autre') ||
                                c.name === 'Non class√©'
                            );
                            categoryId = defaultCategory ? defaultCategory.id : categories[0].id;
                        }
                        
                        const newProductData = {
                            code: item.code || `IMP-${Date.now()}-${results.newProducts}`,
                            name: item.name,
                            category: categoryId,
                            stockByDepot: {
                                [depotId]: item.stock
                            },
                            totalStock: item.stock,
                            minStock: 10,
                            maxStock: 100,
                            costPrice: 0,
                            sellPrice: 0,
                            description: `Import√© depuis Excel le ${new Date().toLocaleDateString('fr-FR')} dans le d√©p√¥t ${depot.name}`,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            createdBy: currentUser?.email || 'Administrateur'
                        };
                        
                        const newRef = database.ref('products').push();
                        await newRef.set(newProductData);
                        
                        // Record initial stock movement
                        await recordStockMovement({
                            productId: newRef.key,
                            productName: item.name,
                            depotId: depotId,
                            type: 'in',
                            quantity: item.stock,
                            reason: 'import_excel_new',
                            notes: 'Nouveau produit import√© depuis Excel',
                            previousStock: 0,
                            newStock: item.stock,
                            date: new Date().toISOString(),
                            userName: currentUser?.email || 'Administrateur',
                            createdAt: new Date().toISOString()
                        });
                        
                        results.newProducts++;
                    }
                    
                } catch (error) {
                    Logger.error("IMPORT_PRODUCT", {
                        product: item,
                        error: error.message
                    });
                    // Continue with next product even if one fails
                }
            }
            
            return results;
        }
        
        // ==================== TARIF IMPORT MODAL ====================
        function openTarifImportModal() {
            document.getElementById('tarifImportModal').classList.add('active');
            
            // Reset form and hide preview
            document.getElementById('tarifImportForm').reset();
            document.getElementById('tarifPreview').style.display = 'none';
            document.getElementById('tarifSummary').style.display = 'none';
            tarifImportData = [];
        }
        
        function closeTarifImportModal() {
            document.getElementById('tarifImportModal').classList.remove('active');
            tarifImportData = [];
        }
        
        function handleTarifExcelFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Parse tarif data
                    const parsedData = parseTarifExcelData(jsonData);
                    tarifImportData = parsedData;
                    
                    // Display preview
                    displayTarifPreview(parsedData);
                    
                    // Update summary
                    updateTarifSummary(parsedData);
                    
                } catch (error) {
                    Logger.error("TARIF_EXCEL_PARSE", error);
                    NotificationSystem.show("Erreur lors de la lecture du fichier Excel", "error");
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ==================== FONCTIONS DE D√âTECTION DE FORMAT ====================
        function detectExcelFormat(jsonData) {
            const formatInfo = {
                codeColumn: -1,
                nameColumn: -1,
                sellPriceColumn: -1,
                grosPriceColumn: -1,
                purchasePriceColumn: -1,
                hasHeaders: false
            };
            
            if (!jsonData || jsonData.length === 0) return formatInfo;
            
            // Analyser les premi√®res lignes
            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                // V√©rifier si la ligne contient des en-t√™tes
                let headerCount = 0;
                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j] || '').toLowerCase().trim();
                    if (cell.includes('code') || cell.includes('d√©signation') || cell.includes('prix') || cell.includes('tarif')) {
                        headerCount++;
                    }
                }
                
                if (headerCount >= 2) {
                    formatInfo.hasHeaders = true;
                    // Mettre √† jour les colonnes bas√©es sur les en-t√™tes
                    for (let j = 0; j < row.length; j++) {
                        const cell = String(row[j] || '').toLowerCase().trim();
                        if (cell.includes('code') || cell.includes('us-') || cell.includes('r√©f√©rence') || cell.includes('article') || cell.includes('id')) {
                            formatInfo.codeColumn = j;
                        } else if (cell.includes('designation') || cell.includes('d√©signation') || cell.includes('nom') || cell.includes('produit') || cell.includes('libell√©')) {
                            formatInfo.nameColumn = j;
                        } else if (cell.includes('prix de vente') || cell.includes('prix vente') || cell.includes('vente') || cell.includes('pvente') || cell.includes('pv')) {
                            formatInfo.sellPriceColumn = j;
                        } else if (cell.includes('tarif') && cell.includes('gros') || cell.includes('gros') || cell.includes('ptarif')) {
                            formatInfo.grosPriceColumn = j;
                        } else if (cell.includes('prix d\'achat') || cell.includes('achat') || cell.includes('pac') || cell.includes('pachat')) {
                            formatInfo.purchasePriceColumn = j;
                        }
                    }
                    break;
                }
            }
            
            // Si pas d'en-t√™tes d√©tect√©s, essayer de deviner
            if (!formatInfo.hasHeaders) {
                // Analyser les 10 premi√®res lignes pour trouver des motifs
                const columnStats = {};
                
                for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (!row) continue;
                    
                    for (let j = 0; j < row.length; j++) {
                        const cell = String(row[j] || '').trim();
                        
                        if (!columnStats[j]) {
                            columnStats[j] = { codes: 0, names: 0, prices: 0 };
                        }
                        
                        // V√©rifier le type de contenu
                        if (cell.match(/^[A-Z]{2}-[0-9]{3,}$/i)) {
                            columnStats[j].codes++;
                        } else if (cell.length > 10 && cell.includes(' ')) {
                            columnStats[j].names++;
                        } else if (!isNaN(parseFloat(cell)) && cell !== '') {
                            columnStats[j].prices++;
                        }
                    }
                }
                
                // D√©terminer les colonnes les plus probables
                let maxCodes = 0, maxNames = 0, maxPrices1 = 0, maxPrices2 = 0;
                
                Object.keys(columnStats).forEach(col => {
                    const stats = columnStats[col];
                    if (stats.codes > maxCodes) {
                        maxCodes = stats.codes;
                        formatInfo.codeColumn = parseInt(col);
                    }
                    if (stats.names > maxNames) {
                        maxNames = stats.names;
                        formatInfo.nameColumn = parseInt(col);
                    }
                    if (stats.prices > maxPrices1) {
                        maxPrices2 = maxPrices1;
                        maxPrices1 = stats.prices;
                        formatInfo.sellPriceColumn = parseInt(col);
                    } else if (stats.prices > maxPrices2) {
                        maxPrices2 = stats.prices;
                        formatInfo.grosPriceColumn = parseInt(col);
                    }
                });
            }
            
            return formatInfo;
        }
        
        function parseTarifExcelData(jsonData) {
            const parsedData = [];
            
            if (jsonData.length === 0) return parsedData;
            
            // D√©tecter les colonnes bas√©es sur le format Excel IPAR
            let codeCol = -1, designationCol = -1, sellPriceCol = -1, grosPriceCol = -1, purchasePriceCol = -1;
            
            // Chercher les en-t√™tes - analyser les 5 premi√®res lignes
            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                for (let j = 0; j < row.length; j++) {
                    const cellValue = String(row[j] || '').toLowerCase().trim();
                    
                    if (cellValue.includes('code') || cellValue === 'us-' || cellValue.includes('r√©f√©rence') || cellValue.includes('article') || cellValue.includes('id')) {
                        codeCol = j;
                    } else if (cellValue.includes('designation') || cellValue.includes('d√©signation') || cellValue.includes('produit') || cellValue.includes('nom') || cellValue.includes('libell√©')) {
                        designationCol = j;
                    } else if (cellValue.includes('prix de vente') || cellValue.includes('prix vente') || cellValue.includes('vente') || cellValue.includes('pvente') || cellValue.includes('pv')) {
                        sellPriceCol = j;
                    } else if (cellValue.includes('tarif') && cellValue.includes('gros') || cellValue.includes('gros') || cellValue.includes('ptarif')) {
                        grosPriceCol = j;
                    } else if (cellValue.includes('prix d\'achat') || cellValue.includes('achat') || cellValue.includes('pac') || cellValue.includes('pachat')) {
                        purchasePriceCol = j;
                    }
                }
                
                // Si on a trouv√© des en-t√™tes, on peut commencer √† partir de la ligne suivante
                if (codeCol !== -1 || designationCol !== -1) {
                    // D√©terminer la premi√®re ligne de donn√©es (ignorer les lignes vides et en-t√™tes)
                    const startRow = i + 1;
                    
                    for (let k = startRow; k < jsonData.length; k++) {
                        const dataRow = jsonData[k];
                        if (!dataRow || dataRow.length === 0) continue;
                        
                        // Extraire les valeurs
                        const code = dataRow[codeCol] ? String(dataRow[codeCol]).trim() : '';
                        const designation = dataRow[designationCol] ? String(dataRow[designationCol]).trim() : '';
                        
                        // Essayer plusieurs colonnes pour les prix
                        let sellPrice = 0;
                        if (sellPriceCol !== -1) sellPrice = parseFloat(dataRow[sellPriceCol]) || 0;
                        
                        let grosPrice = 0;
                        if (grosPriceCol !== -1) grosPrice = parseFloat(dataRow[grosPriceCol]) || 0;
                        
                        let purchasePrice = 0;
                        if (purchasePriceCol !== -1) purchasePrice = parseFloat(dataRow[purchasePriceCol]) || 0;
                        
                        // Si pas de prix de vente mais un tarif gros, utiliser le tarif gros
                        if (sellPrice === 0 && grosPrice > 0) {
                            sellPrice = grosPrice;
                        }
                        
                        // Skip empty rows
                        if (!code && !designation) continue;
                        
                        // V√©rifier si c'est une ligne avec formule ou total
                        if (code.startsWith('=') || designation.startsWith('=') || 
                            code.toLowerCase().includes('total') || designation.toLowerCase().includes('total') ||
                            code.toLowerCase().includes('somme') || designation.toLowerCase().includes('somme')) {
                            continue;
                        }
                        
                        // Chercher le produit correspondant dans notre base
                        let matchedProduct = null;
                        if (code) {
                            // Chercher par code exact
                            matchedProduct = products.find(p => p.code && p.code.toLowerCase() === code.toLowerCase());
                            
                            // Si non trouv√©, chercher par similarit√© de code (ignorer les espaces, caract√®res sp√©ciaux)
                            if (!matchedProduct) {
                                const normalizedCode = code.replace(/\s+/g, '').toLowerCase();
                                matchedProduct = products.find(p => 
                                    p.code && p.code.replace(/\s+/g, '').toLowerCase() === normalizedCode
                                );
                            }
                            
                            // Si non trouv√©, chercher par similarit√© de nom
                            if (!matchedProduct && designation) {
                                matchedProduct = products.find(p => 
                                    p.name && (p.name.toLowerCase().includes(designation.toLowerCase()) ||
                                    designation.toLowerCase().includes(p.name.toLowerCase()) ||
                                    p.name.toLowerCase().replace(/\s+/g, '') === designation.toLowerCase().replace(/\s+/g, ''))
                                );
                            }
                        }
                        
                        parsedData.push({
                            code: code,
                            designation: designation,
                            sellPrice: sellPrice,
                            grosPrice: grosPrice,
                            purchasePrice: purchasePrice,
                            matchedProduct: matchedProduct,
                            rowIndex: k
                        });
                    }
                    
                    break;
                }
            }
            
            // Si pas d'en-t√™tes trouv√©s, utiliser des positions par d√©faut et essayer de d√©tecter automatiquement
            if (parsedData.length === 0 && jsonData.length > 0) {
                // Essayer de d√©tecter les colonnes par motif
                const potentialDataRows = [];
                
                for (let i = 0; i < Math.min(100, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (!row || row.length < 3) continue;
                    
                    // Chercher un code produit (ex: US-2066, CO-0052, etc.)
                    for (let j = 0; j < row.length; j++) {
                        const cellValue = String(row[j] || '').trim();
                        
                        // Pattern pour les codes produits
                        if (cellValue.match(/^[A-Z]{2}-[0-9]{4}$/i) || 
                            cellValue.match(/^[A-Z]{2}-[0-9]{3,}$/i) ||
                            cellValue.match(/^[A-Z0-9]{4,}-[0-9]{2,}$/i) ||
                            cellValue.match(/^[A-Z]{2}[0-9]{4,}$/i)) {
                            
                            // C'est probablement une ligne de produit
                            const code = cellValue;
                            let designation = '';
                            let sellPrice = 0;
                            let grosPrice = 0;
                            
                            // Chercher la d√©signation (colonne suivante)
                            if (j + 1 < row.length) {
                                designation = String(row[j + 1] || '').trim();
                            }
                            
                            // Chercher les prix (colonne suivante ou apr√®s)
                            for (let k = j + 2; k < Math.min(j + 5, row.length); k++) {
                                const priceValue = parseFloat(row[k]) || 0;
                                if (priceValue > 0) {
                                    if (sellPrice === 0) {
                                        sellPrice = priceValue;
                                    } else if (grosPrice === 0) {
                                        grosPrice = priceValue;
                                    }
                                }
                            }
                            
                            let matchedProduct = products.find(p => p.code && p.code.toLowerCase() === code.toLowerCase());
                            
                            potentialDataRows.push({
                                code: code,
                                designation: designation,
                                sellPrice: sellPrice,
                                grosPrice: grosPrice,
                                purchasePrice: 0,
                                matchedProduct: matchedProduct,
                                rowIndex: i
                            });
                            
                            break;
                        }
                    }
                }
                
                // Prendre les premi√®res lignes de donn√©es trouv√©es
                parsedData.push(...potentialDataRows.slice(0, 100));
            }
            
            // Filtrer les doublons
            const uniqueData = [];
            const seenCodes = new Set();
            
            parsedData.forEach(item => {
                const key = item.code || item.designation;
                if (key && !seenCodes.has(key.toLowerCase())) {
                    seenCodes.add(key.toLowerCase());
                    uniqueData.push(item);
                }
            });
            
            return uniqueData;
        }
        
        function parseTarifExcelDataWithFormat(jsonData, formatInfo) {
            const parsedData = [];
            
            if (jsonData.length === 0) return parsedData;
            
            const startRow = formatInfo.hasHeaders ? 1 : 0;
            
            for (let i = startRow; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row) continue;
                
                const code = formatInfo.codeColumn >= 0 ? String(row[formatInfo.codeColumn] || '').trim() : '';
                const designation = formatInfo.nameColumn >= 0 ? String(row[formatInfo.nameColumn] || '').trim() : '';
                
                let sellPrice = 0;
                if (formatInfo.sellPriceColumn >= 0) {
                    sellPrice = parseFloat(row[formatInfo.sellPriceColumn]) || 0;
                }
                
                let grosPrice = 0;
                if (formatInfo.grosPriceColumn >= 0) {
                    grosPrice = parseFloat(row[formatInfo.grosPriceColumn]) || 0;
                }
                
                // Skip empty rows
                if (!code && !designation) continue;
                
                // Skip totals or formulas
                if (code.startsWith('=') || code.toLowerCase().includes('total') || 
                    designation.toLowerCase().includes('total')) {
                    continue;
                }
                
                // Chercher le produit correspondant
                let matchedProduct = null;
                if (code) {
                    matchedProduct = products.find(p => p.code && p.code.toLowerCase() === code.toLowerCase());
                }
                
                parsedData.push({
                    code: code,
                    designation: designation,
                    sellPrice: sellPrice,
                    grosPrice: grosPrice,
                    purchasePrice: 0,
                    matchedProduct: matchedProduct,
                    rowIndex: i
                });
            }
            
            return parsedData;
        }
        
        function displayTarifPreview(data) {
            const previewTableBody = document.getElementById('tarifPreviewTableBody');
            const previewCount = document.getElementById('tarifPreviewCount');
            const previewSection = document.getElementById('tarifPreview');
            
            if (data.length === 0) {
                previewTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-light);">
                            Aucune donn√©e de tarif valide trouv√©e
                        </td>
                    </tr>
                `;
                previewCount.textContent = '0';
                previewSection.style.display = 'block';
                return;
            }
            
            let html = '';
            const previewLimit = Math.min(15, data.length);
            
            for (let i = 0; i < previewLimit; i++) {
                const item = data[i];
                const status = item.matchedProduct ? 'Mise √† jour' : 'Nouveau produit';
                const statusClass = item.matchedProduct ? 'success' : 'primary';
                
                // Calculer le prix d'achat selon la formule (96% du tarif gros)
                const calculatedPurchasePrice = item.grosPrice * 0.96;
                
                html += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center; font-family: monospace;">
                            ${item.code || '<span style="color: var(--text-light); font-style: italic;">N/A</span>'}
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: right; font-size: 11px;">
                            ${item.designation.substring(0, 30)}${item.designation.length > 30 ? '...' : ''}
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center;">
                            <strong>${item.sellPrice.toFixed(2)}</strong> DH
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center;">
                            ${item.grosPrice.toFixed(2)} DH
                        </td>
                        <td style="padding: 8px; border-bottom: 1px solid var(--border); text-align: center;">
                            <span style="background: var(--${statusClass}); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            }
            
            if (data.length > previewLimit) {
                html += `
                    <tr>
                        <td colspan="5" style="padding: 10px; text-align: center; color: var(--text-light); font-style: italic;">
                            ... et ${data.length - previewLimit} autres produits
                        </td>
                    </tr>
                `;
            }
            
            previewTableBody.innerHTML = html;
            previewCount.textContent = data.length;
            previewSection.style.display = 'block';
        }
        
        function updateTarifSummary(data) {
            let total = data.length;
            let matched = data.filter(item => item.matchedProduct).length;
            let newProducts = data.filter(item => !item.matchedProduct).length;
            let skipped = 0; // Pourrait √™tre utilis√© pour des produits ignor√©s
            
            document.getElementById('summaryTotal').textContent = total;
            document.getElementById('summaryMatched').textContent = matched;
            document.getElementById('summaryNew').textContent = newProducts;
            document.getElementById('summarySkipped').textContent = skipped;
            
            document.getElementById('tarifSummary').style.display = 'block';
        }
        
        function autoDetectFormat() {
            const fileInput = document.getElementById('tarifExcelFile');
            if (!fileInput.files[0]) {
                NotificationSystem.show("Veuillez d'abord s√©lectionner un fichier", "warning");
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // D√©tecter le format
                    const formatInfo = detectExcelFormat(jsonData);
                    
                    // Afficher les informations de d√©tection
                    let detectionMessage = `Format d√©tect√©: `;
                    if (formatInfo.hasHeaders) {
                        detectionMessage += `Avec en-t√™tes | `;
                    } else {
                        detectionMessage += `Sans en-t√™tes | `;
                    }
                    
                    detectionMessage += `Colonne Code: ${formatInfo.codeColumn >= 0 ? formatInfo.codeColumn + 1 : 'Non d√©tect√©e'} | `;
                    detectionMessage += `Colonne Nom: ${formatInfo.nameColumn >= 0 ? formatInfo.nameColumn + 1 : 'Non d√©tect√©e'} | `;
                    detectionMessage += `Colonne Prix Vente: ${formatInfo.sellPriceColumn >= 0 ? formatInfo.sellPriceColumn + 1 : 'Non d√©tect√©e'}`;
                    
                    NotificationSystem.show(detectionMessage, "info");
                    
                    // Re-parser avec les informations d√©tect√©es
                    const parsedData = parseTarifExcelDataWithFormat(jsonData, formatInfo);
                    tarifImportData = parsedData;
                    
                    // Afficher la pr√©visualisation
                    displayTarifPreview(parsedData);
                    updateTarifSummary(parsedData);
                    
                } catch (error) {
                    Logger.error("AUTO_DETECT_FORMAT", error);
                    NotificationSystem.show("Erreur lors de la d√©tection du format", "error");
                }
            };
            
            reader.readAsArrayBuffer(fileInput.files[0]);
        }
        
        async function handleTarifImport(e) {
            e.preventDefault();
            
            if (tarifImportData.length === 0) {
                NotificationSystem.show("Aucune donn√©e de tarif √† importer", "error");
                return;
            }
            
            NotificationSystem.showLoading("Mise √† jour des tarifs depuis Excel IPAR...");
            
            try {
                const updateStrategy = document.getElementById('tarifUpdateStrategy').value;
                const updateMethod = document.getElementById('tarifUpdateMethod').value;
                const createNewProducts = document.getElementById('createNewProducts').checked;
                
                const results = await updatePricesFromTarifData(tarifImportData, updateStrategy, updateMethod, createNewProducts);
                
                // Afficher les r√©sultats
                let message = `Mise √† jour des tarifs termin√©e : `;
                message += `${results.updatedProducts} produits mis √† jour`;
                
                if (results.newProducts > 0) {
                    message += `, ${results.newProducts} nouveaux produits cr√©√©s`;
                }
                
                if (results.skippedProducts > 0) {
                    message += `, ${results.skippedProducts} produits ignor√©s`;
                }
                
                if (results.failedProducts > 0) {
                    message += `, ${results.failedProducts} √©checs`;
                }
                
                NotificationSystem.show(message, "success");
                
                // Rafra√Æchir les donn√©es
                refreshStockData();
                
                // Fermer la modal
                closeTarifImportModal();
                
                Logger.log("TARIF_IMPORT_SUCCESS", results);
                
            } catch (error) {
                Logger.error("TARIF_IMPORT", error);
                NotificationSystem.show("Erreur lors de la mise √† jour des tarifs: " + error.message, "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        async function updatePricesFromTarifData(data, strategy, method, createNewProductsFlag) {
            const results = {
                updatedProducts: 0,
                newProducts: 0,
                skippedProducts: 0,
                failedProducts: 0,
                duplicateCodes: 0,
                totalProcessed: data.length
            };
            
            const existingCodes = new Set(products.map(p => p.code?.toLowerCase()));
            const codesInFile = new Set();
            const duplicatesInFile = new Set();
            
            // V√©rifier les doublons dans le fichier
            data.forEach(item => {
                const normalizedCode = item.code?.toLowerCase();
                if (normalizedCode) {
                    if (codesInFile.has(normalizedCode)) {
                        duplicatesInFile.add(normalizedCode);
                        results.duplicateCodes++;
                    } else {
                        codesInFile.add(normalizedCode);
                    }
                }
            });
            
            // Avertissement pour les doublons dans le fichier
            if (duplicatesInFile.size > 0) {
                console.warn("Codes en double dans le fichier tarif:", Array.from(duplicatesInFile));
                NotificationSystem.show(`${duplicatesInFile.size} codes en double d√©tect√©s dans le fichier et ignor√©s`, "warning");
            }
            
            const updates = {};
            const newProducts = [];
            const movements = [];
            
            // Traiter chaque produit du fichier tarif
            for (const item of data) {
                try {
                    // Ignorer les doublons dans le fichier
                    const normalizedCode = item.code?.toLowerCase();
                    if (normalizedCode && duplicatesInFile.has(normalizedCode)) {
                        results.skippedProducts++;
                        continue;
                    }
                    
                    if (item.matchedProduct) {
                        // Produit existant - mettre √† jour les prix
                        const product = item.matchedProduct;
                        const productId = product.id;
                        
                        // V√©rifier si les prix ont chang√©
                        const currentSellPrice = product.sellPrice || 0;
                        const currentCostPrice = product.costPrice || 0;
                        
                        // D√©terminer le prix d'achat selon la m√©thode choisie
                        let newPurchasePrice = currentCostPrice;
                        if (method === 'formula') {
                            // Calculer selon la formule: 96% du tarif gros
                            newPurchasePrice = item.grosPrice * 0.96;
                        } else if (method === 'manual' && item.purchasePrice > 0) {
                            // Utiliser le prix d'achat du fichier
                            newPurchasePrice = item.purchasePrice;
                        } else if (item.grosPrice > 0) {
                            // Par d√©faut, utiliser la formule
                            newPurchasePrice = item.grosPrice * 0.96;
                        }
                        
                        const newSellPrice = item.sellPrice || currentSellPrice;
                        
                        // V√©rifier si les prix ont r√©ellement chang√©
                        const sellPriceChanged = Math.abs(newSellPrice - currentSellPrice) > 0.01;
                        const costPriceChanged = Math.abs(newPurchasePrice - currentCostPrice) > 0.01;
                        
                        if (sellPriceChanged || costPriceChanged) {
                            // Appliquer la strat√©gie de mise √† jour
                            if (strategy === 'update_all') {
                                updates[`products/${productId}/costPrice`] = parseFloat(newPurchasePrice.toFixed(2));
                                updates[`products/${productId}/sellPrice`] = parseFloat(newSellPrice.toFixed(2));
                            } else if (strategy === 'update_sell_only' && sellPriceChanged) {
                                updates[`products/${productId}/sellPrice`] = parseFloat(newSellPrice.toFixed(2));
                            } else if (strategy === 'update_cost_only' && costPriceChanged) {
                                updates[`products/${productId}/costPrice`] = parseFloat(newPurchasePrice.toFixed(2));
                            }
                            
                            // Mettre √† jour la date de modification
                            updates[`products/${productId}/updatedAt`] = new Date().toISOString();
                            updates[`products/${productId}/lastPriceUpdate`] = new Date().toISOString();
                            
                            // Ajouter au log des mouvements
                            movements.push({
                                productId: productId,
                                productName: product.name,
                                productCode: product.code,
                                previousSellPrice: currentSellPrice,
                                newSellPrice: newSellPrice,
                                previousCostPrice: currentCostPrice,
                                newCostPrice: newPurchasePrice,
                                updateDate: new Date().toISOString()
                            });
                            
                            results.updatedProducts++;
                        } else {
                            results.skippedProducts++;
                        }
                        
                    } else if (item.code && item.code.trim() !== '' && createNewProductsFlag) {
                        // V√©rifier si le code existe d√©j√† dans la base
                        if (existingCodes.has(item.code.toLowerCase())) {
                            results.skippedProducts++;
                            results.duplicateCodes++;
                            continue;
                        }
                        
                        // Nouveau produit - option pour cr√©er automatiquement
                        // Trouver une cat√©gorie par d√©faut
                        let categoryId = '';
                        if (categories.length > 0) {
                            // Chercher une cat√©gorie "Divers" ou prendre la premi√®re
                            const defaultCategory = categories.find(c => 
                                c.name.toLowerCase().includes('divers') || 
                                c.name.toLowerCase().includes('autre') ||
                                c.name === 'Non class√©'
                            );
                            categoryId = defaultCategory ? defaultCategory.id : categories[0].id;
                        }
                        
                        // Calculer le prix d'achat
                        let purchasePrice = 0;
                        if (method === 'formula') {
                            purchasePrice = item.grosPrice * 0.96;
                        } else if (method === 'manual' && item.purchasePrice > 0) {
                            purchasePrice = item.purchasePrice;
                        } else if (item.grosPrice > 0) {
                            purchasePrice = item.grosPrice * 0.96;
                        }
                        
                        const newProductData = {
                            code: item.code,
                            name: item.designation || `Produit ${item.code}`,
                            category: categoryId,
                            stockByDepot: {},
                            totalStock: 0,
                            minStock: 10,
                            maxStock: 100,
                            costPrice: parseFloat(purchasePrice.toFixed(2)),
                            sellPrice: parseFloat((item.sellPrice || 0).toFixed(2)),
                            description: `Import√© depuis fichier tarif le ${new Date().toLocaleDateString('fr-FR')}`,
                            supplier: 'IPAR',
                            barcode: '',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            createdBy: currentUser?.email || 'Administrateur',
                            importSource: 'tarif_excel'
                        };
                        
                        newProducts.push(newProductData);
                        results.newProducts++;
                    } else {
                        results.skippedProducts++;
                    }
                    
                } catch (error) {
                    Logger.error("UPDATE_PRODUCT_PRICE", {
                        item: item,
                        error: error.message
                    });
                    results.failedProducts++;
                }
            }
            
            try {
                // Appliquer toutes les mises √† jour en une seule transaction
                if (Object.keys(updates).length > 0) {
                    await database.ref().update(updates);
                    
                    // Enregistrer un log de la mise √† jour des tarifs
                    await recordStockMovement({
                        type: 'adjustment',
                        reason: 'tarif_update',
                        notes: `Mise √† jour des tarifs depuis Excel IPAR: ${results.updatedProducts} produits mis √† jour`,
                        details: JSON.stringify({
                            strategy: strategy,
                            method: method,
                            results: results,
                            movementsCount: movements.length
                        }),
                        date: new Date().toISOString(),
                        userName: currentUser?.email || 'Administrateur',
                        createdAt: new Date().toISOString()
                    });
                    
                    // Enregistrer les d√©tails des changements de prix
                    if (movements.length > 0) {
                        const priceChangesRef = database.ref('priceChanges');
                        movements.forEach(async (change) => {
                            await priceChangesRef.push(change);
                        });
                    }
                }
                
                // Cr√©er les nouveaux produits si n√©cessaire
                for (const newProduct of newProducts) {
                    try {
                        const newRef = database.ref('products').push();
                        await newRef.set(newProduct);
                        
                        // Enregistrer le mouvement pour le nouveau produit
                        await recordStockMovement({
                            productId: newRef.key,
                            productName: newProduct.name,
                            type: 'in',
                            reason: 'new_product_from_tarif',
                            notes: `Nouveau produit cr√©√© √† partir du fichier tarif: ${newProduct.code}`,
                            date: new Date().toISOString(),
                            userName: currentUser?.email || 'Administrateur',
                            createdAt: new Date().toISOString()
                        });
                        
                    } catch (error) {
                        Logger.error("CREATE_NEW_PRODUCT_FROM_TARIF", error);
                        results.failedProducts++;
                    }
                }
                
                // G√©n√©rer un rapport de mise √† jour
                generateUpdateReport(results, movements);
                
            } catch (error) {
                Logger.error("APPLY_TARIF_UPDATES", error);
                throw error;
            }
            
            return results;
        }
        
        // ==================== FONCTIONS DE RAPPORTS ====================
        function generateUpdateReport(results, movements) {
            let reportHtml = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-top: 20px;">
                    <h3><i class="fas fa-clipboard-check"></i> Rapport de Mise √† Jour des Tarifs</h3>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString('fr-FR')} ${new Date().toLocaleTimeString('fr-FR')}</p>
                    
                    <div class="stats-grid" style="margin: 20px 0;">
                        <div class="stat-card">
                            <div class="stat-icon total">
                                <i class="fas fa-file-import"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Total Trait√©</h3>
                                <div class="value">${results.totalProcessed}</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Mis √† Jour</h3>
                                <div class="value">${results.updatedProducts}</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Nouveaux</h3>
                                <div class="value">${results.newProducts}</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-minus-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>Ignor√©s</h3>
                                <div class="value">${results.skippedProducts}</div>
                            </div>
                        </div>
                    </div>
            `;
            
            if (movements.length > 0) {
                reportHtml += `
                    <h4>D√©tail des Changements de Prix</h4>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                        <table style="width: 100%; font-size: 12px;">
                            <thead style="background: var(--light); position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 8px;">Produit</th>
                                    <th style="padding: 8px;">Code</th>
                                    <th style="padding: 8px;">Ancien Prix</th>
                                    <th style="padding: 8px;">Nouveau Prix</th>
                                    <th style="padding: 8px;">Variation</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                movements.slice(0, 50).forEach(movement => {
                    const variationSell = movement.newSellPrice - movement.previousSellPrice;
                    const variationPercent = movement.previousSellPrice > 0 ? 
                        ((variationSell / movement.previousSellPrice) * 100).toFixed(2) : '100.00';
                    
                    reportHtml += `
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid var(--border);">${movement.productName}</td>
                            <td style="padding: 8px; border-bottom: 1px solid var(--border);">${movement.productCode}</td>
                            <td style="padding: 8px; border-bottom: 1px solid var(--border);">${formatNumber(movement.previousSellPrice)} DH</td>
                            <td style="padding: 8px; border-bottom: 1px solid var(--border);">
                                <strong>${formatNumber(movement.newSellPrice)} DH</strong>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid var(--border); color: ${variationSell >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                ${variationSell >= 0 ? '+' : ''}${formatNumber(variationSell)} DH (${variationPercent}%)
                            </td>
                        </tr>
                    `;
                });
                
                if (movements.length > 50) {
                    reportHtml += `
                        <tr>
                            <td colspan="5" style="padding: 10px; text-align: center; color: var(--text-light);">
                                ... et ${movements.length - 50} autres changements
                            </td>
                        </tr>
                    `;
                }
                
                reportHtml += `
                        </tbody>
                    </table>
                </div>
                `;
            }
            
            reportHtml += `
                    <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                        <h4><i class="fas fa-download"></i> Exporter le Rapport</h4>
                        <button onclick="exportUpdateReport(${JSON.stringify(results)}, ${JSON.stringify(movements)})" 
                                class="btn btn-success" style="margin-top: 10px;">
                            <i class="fas fa-file-excel"></i> Exporter en Excel
                        </button>
                    </div>
                </div>
            `;
            
            // Afficher le rapport dans la section rapports
            const reportsContent = document.getElementById('reportsContent');
            if (reportsContent) {
                reportsContent.innerHTML = reportHtml;
                switchTab('reports');
            }
        }
        
        function exportUpdateReport(results, movements) {
            const exportData = movements.map(movement => {
                const variation = movement.newSellPrice - movement.previousSellPrice;
                const variationPercent = movement.previousSellPrice > 0 ? 
                    ((variation / movement.previousSellPrice) * 100).toFixed(2) : '100.00';
                
                return {
                    'Code Produit': movement.productCode,
                    'Nom Produit': movement.productName,
                    'Ancien Prix Vente': movement.previousSellPrice,
                    'Nouveau Prix Vente': movement.newSellPrice,
                    'Variation (DH)': variation,
                    'Variation (%)': variationPercent,
                    'Ancien Prix Achat': movement.previousCostPrice || 0,
                    'Nouveau Prix Achat': movement.newCostPrice || 0,
                    'Date Mise √† Jour': new Date(movement.updateDate).toLocaleDateString('fr-FR'),
                    'Heure Mise √† Jour': new Date(movement.updateDate).toLocaleTimeString('fr-FR')
                };
            });
            
            // Ajouter un r√©sum√©
            const summary = [{
                'R√©sum√©': '=== RAPPORT DE MISE √Ä JOUR DES TARIFS ===',
                '': '',
                'Date': new Date().toLocaleDateString('fr-FR'),
                'Heure': new Date().toLocaleTimeString('fr-FR'),
                'Total Produits Trait√©s': results.totalProcessed,
                'Produits Mis √† Jour': results.updatedProducts,
                'Nouveaux Produits': results.newProducts,
                'Produits Ignor√©s': results.skippedProducts,
                '√âchecs': results.failedProducts
            }];
            
            const allData = [...summary, ...exportData];
            
            ExportManager.exportToExcel(allData, "rapport_mise_a_jour_tarifs", "Mise √† jour tarifs");
        }
        
        function openConfirmModal(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        }
        
        function executeConfirmAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }
        
        function closeAllModals() {
            closeProductModal();
            closeCategoryModal();
            closeDepotModal();
            closeAdjustmentModal();
            closeTransferModal();
            closeExcelImportModal();
            closeTarifImportModal();
            closeConfirmModal();
        }
        
        // ==================== GESTION DES PRODUITS ====================
        async function saveProduct(e) {
            e.preventDefault();
            
            NotificationSystem.showLoading("Enregistrement du produit...");
            
            // V√©rifier l'unicit√© du code avant de continuer
            const codeValidation = await validateProductCode();
            if (!codeValidation.isValid) {
                NotificationSystem.show(codeValidation.message, "error");
                NotificationSystem.hideLoading();
                return;
            }
            
            const productId = document.getElementById('productId').value;
            const isNew = !productId;
            
            const initialDepot = document.getElementById('productInitialDepot').value;
            const initialQuantity = parseFloat(document.getElementById('productInitialQuantity').value) || 0;
            
            const productData = {
                code: document.getElementById('productCode').value.trim(),
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                costPrice: parseFloat(document.getElementById('productCostPrice').value) || 0,
                sellPrice: parseFloat(document.getElementById('productSellPrice').value) || 0,
                minStock: parseFloat(document.getElementById('productMinStock').value) || 10,
                maxStock: parseFloat(document.getElementById('productMaxStock').value) || 100,
                description: document.getElementById('productDescription').value,
                barcode: document.getElementById('productBarcode').value,
                supplier: document.getElementById('productSupplier').value,
                updatedAt: new Date().toISOString()
            };
            
            if (isNew) {
                // Nouveau produit : cr√©er stockByDepot avec le d√©p√¥t initial
                productData.stockByDepot = {
                    [initialDepot]: initialQuantity
                };
                productData.totalStock = initialQuantity;
                productData.createdAt = new Date().toISOString();
                productData.createdBy = currentUser?.email;
                
                try {
                    const newRef = database.ref('products').push();
                    const newProductId = newRef.key;
                    await newRef.set(productData);
                    
                    // Enregistrer le mouvement de stock initial
                    await recordStockMovement({
                        productId: newProductId,
                        productName: productData.name,
                        depotId: initialDepot,
                        type: 'in',
                        quantity: initialQuantity,
                        reason: 'initial_stock',
                        previousStock: 0,
                        newStock: initialQuantity,
                        date: new Date().toISOString(),
                        userName: currentUser?.email || 'Administrateur',
                        createdAt: new Date().toISOString()
                    });
                    
                    Logger.log("PRODUCT_CREATED", productData);
                    NotificationSystem.show("Produit ajout√© avec succ√®s", "success");
                    closeProductModal();
                    NotificationSystem.hideLoading();
                    
                } catch (error) {
                    Logger.error("SAVE_PRODUCT", error);
                    NotificationSystem.show("Erreur lors de l'enregistrement", "error");
                    NotificationSystem.hideLoading();
                }
            } else {
                // Modification : conserver les stocks existants
                const existingProduct = products.find(p => p.id === productId);
                if (existingProduct && existingProduct.stockByDepot) {
                    productData.stockByDepot = existingProduct.stockByDepot;
                    // Recalculer le stock total
                    productData.totalStock = 0;
                    Object.values(productData.stockByDepot).forEach(qty => {
                        productData.totalStock += qty;
                    });
                } else {
                    // Si pas de stockByDepot, le cr√©er avec les donn√©es existantes
                    productData.stockByDepot = {};
                    if (existingProduct && existingProduct.depot) {
                        productData.stockByDepot[existingProduct.depot] = existingProduct.quantity || 0;
                    }
                    productData.totalStock = existingProduct ? (existingProduct.quantity || 0) : 0;
                }
                
                try {
                    await database.ref(`products/${productId}`).update(productData);
                    
                    Logger.log("PRODUCT_UPDATED", { id: productId, ...productData });
                    NotificationSystem.show("Produit modifi√© avec succ√®s", "success");
                    closeProductModal();
                    NotificationSystem.hideLoading();
                    
                } catch (error) {
                    Logger.error("SAVE_PRODUCT", error);
                    NotificationSystem.show("Erreur lors de l'enregistrement", "error");
                    NotificationSystem.hideLoading();
                }
            }
        }
        
        function confirmDeleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            openConfirmModal(
                `√ätes-vous s√ªr de vouloir supprimer le produit "${product.name}" ? Cette action est irr√©versible.`,
                () => deleteProduct(productId)
            );
        }
        
        async function deleteProduct(productId) {
            NotificationSystem.showLoading("Suppression du produit...");
            
            try {
                const product = products.find(p => p.id === productId);
                await database.ref(`products/${productId}`).remove();
                
                Logger.log("PRODUCT_DELETED", { id: productId, name: product?.name });
                NotificationSystem.show("Produit supprim√© avec succ√®s", "success");
                
            } catch (error) {
                Logger.error("DELETE_PRODUCT", error);
                NotificationSystem.show("Erreur lors de la suppression", "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        function viewProductHistory(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const productMovements = StockManager.getProductMovements(productId);
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-history"></i> Historique des mouvements - ${product.name}</h3>
                    <p><strong>Code:</strong> ${product.code} | <strong>Stock total:</strong> ${product.totalStock}</p>
                    <div class="depot-stock-list">
            `;
            
            // Afficher les stocks par d√©p√¥t
            if (product.stockByDepot) {
                Object.keys(product.stockByDepot).forEach(depotId => {
                    const depotName = getDepotName(depotId);
                    const qty = product.stockByDepot[depotId];
                    if (qty > 0) {
                        html += `
                            <div class="depot-stock-item">
                                <span class="depot-stock-name">${depotName}</span>
                                <span class="depot-stock-quantity">${qty} unit√©s</span>
                            </div>
                        `;
                    }
                });
            }
            
            html += `</div></div>`;
            
            if (productMovements.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-history" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucun mouvement</h3>
                        <p>Aucun mouvement enregistr√© pour ce produit</p>
                    </div>
                `;
            } else {
                html += `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>D√©p√¥t</th>
                                    <th>Quantit√©</th>
                                    <th>Stock Avant</th>
                                    <th>Stock Apr√®s</th>
                                    <th>Raison</th>
                                    <th>Utilisateur</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                productMovements.slice(0, 20).forEach(movement => {
                    const date = new Date(movement.date);
                    const dateStr = date.toLocaleDateString('fr-FR');
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    let typeText = '';
                    switch(movement.type) {
                        case 'in': typeText = 'Entr√©e'; break;
                        case 'out': typeText = 'Sortie'; break;
                        case 'transfer': typeText = 'Transfert'; break;
                        case 'adjustment': typeText = 'Ajustement'; break;
                        default: typeText = 'Inconnu';
                    }
                    
                    const depotName = movement.type === 'transfer' ? 
                        `${getDepotName(movement.fromDepot)} ‚Üí ${getDepotName(movement.toDepot)}` :
                        getDepotName(movement.fromDepot || movement.toDepot);
                    
                    html += `
                        <tr>
                            <td>
                                <div>${dateStr}</div>
                                <div style="font-size: 12px; color: var(--text-light);">${timeStr}</div>
                            </td>
                            <td>${typeText}</td>
                            <td>${depotName}</td>
                            <td><strong>${movement.quantity}</strong></td>
                            <td>${movement.previousStock || ''}</td>
                            <td>${movement.newStock || ''}</td>
                            <td>${movement.reason || movement.notes || ''}</td>
                            <td>${movement.userName || ''}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Afficher dans les rapports
            switchTab('reports');
            document.getElementById('reportsContent').innerHTML = html;
        }
        
        // ==================== GESTION DES CAT√âGORIES ====================
        async function saveCategory(e) {
            e.preventDefault();
            
            NotificationSystem.showLoading("Enregistrement de la cat√©gorie...");
            
            const categoryId = document.getElementById('categoryId').value;
            const isNew = !categoryId;
            
            const categoryData = {
                name: document.getElementById('categoryName').value,
                icon: document.getElementById('categoryIcon').value,
                color: document.getElementById('categoryColor').value,
                description: document.getElementById('categoryDescription').value,
                updatedAt: new Date().toISOString()
            };
            
            if (isNew) {
                categoryData.createdAt = new Date().toISOString();
            }
            
            try {
                if (isNew) {
                    const newRef = database.ref('categories').push();
                    await newRef.set(categoryData);
                    
                    Logger.log("CATEGORY_CREATED", categoryData);
                    NotificationSystem.show("Cat√©gorie ajout√©e avec succ√®s", "success");
                } else {
                    await database.ref(`categories/${categoryId}`).update(categoryData);
                    
                    Logger.log("CATEGORY_UPDATED", { id: categoryId, ...categoryData });
                    NotificationSystem.show("Cat√©gorie modifi√©e avec succ√®s", "success");
                }
                
                closeCategoryModal();
                NotificationSystem.hideLoading();
                
            } catch (error) {
                Logger.error("SAVE_CATEGORY", error);
                NotificationSystem.show("Erreur lors de l'enregistrement", "error");
                NotificationSystem.hideLoading();
            }
        }
        
        function confirmDeleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            const productsInCategory = StockManager.getCategoryProducts(categoryId);
            
            if (productsInCategory.length > 0) {
                openConfirmModal(
                    `Impossible de supprimer cette cat√©gorie. ${productsInCategory.length} produit(s) l'utilisent. Voulez-vous r√©affecter ces produits avant de supprimer ?`,
                    () => reassignProductsAndDeleteCategory(categoryId, category.name)
                );
            } else {
                openConfirmModal(
                    `√ätes-vous s√ªr de vouloir supprimer la cat√©gorie "${category.name}" ?`,
                    () => deleteCategory(categoryId)
                );
            }
        }
        
        async function reassignProductsAndDeleteCategory(categoryId, categoryName) {
            // Demander une nouvelle cat√©gorie
            const newCategoryName = prompt(`Entrez le nom de la nouvelle cat√©gorie pour les produits actuellement dans "${categoryName}":`);
            
            if (!newCategoryName || newCategoryName.trim() === '') {
                NotificationSystem.show("Op√©ration annul√©e", "warning");
                return;
            }
            
            // Trouver la nouvelle cat√©gorie
            const targetCategory = categories.find(c => c.name === newCategoryName.trim());
            if (!targetCategory) {
                NotificationSystem.show("Cat√©gorie non trouv√©e", "error");
                return;
            }
            
            NotificationSystem.showLoading("R√©affectation des produits...");
            
            // Mettre √† jour les produits
            const updates = {};
            products.forEach(product => {
                if (product.category === categoryId) {
                    updates[`products/${product.id}/category`] = targetCategory.id;
                }
            });
            
            try {
                await database.ref().update(updates);
                
                // Supprimer la cat√©gorie
                await database.ref(`categories/${categoryId}`).remove();
                
                NotificationSystem.show("Cat√©gorie supprim√©e et produits r√©affect√©s", "success");
                
            } catch (error) {
                Logger.error("REASSIGN_PRODUCTS_CATEGORY", error);
                NotificationSystem.show("Erreur lors de l'op√©ration", "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        async function deleteCategory(categoryId) {
            NotificationSystem.showLoading("Suppression de la cat√©gorie...");
            
            try {
                const category = categories.find(c => c.id === categoryId);
                await database.ref(`categories/${categoryId}`).remove();
                
                Logger.log("CATEGORY_DELETED", { id: categoryId, name: category?.name });
                NotificationSystem.show("Cat√©gorie supprim√©e avec succ√®s", "success");
                
            } catch (error) {
                Logger.error("DELETE_CATEGORY", error);
                NotificationSystem.show("Erreur lors de la suppression", "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        // ==================== GESTION DES D√âP√îTS ====================
        async function saveDepot(e) {
            e.preventDefault();
            
            NotificationSystem.showLoading("Enregistrement du d√©p√¥t...");
            
            const depotId = document.getElementById('depotId').value;
            const isNew = !depotId;
            
            const depotData = {
                name: document.getElementById('depotName').value,
                city: document.getElementById('depotCity').value,
                address: document.getElementById('depotAddress').value,
                manager: document.getElementById('depotManager').value || '',
                phone: document.getElementById('depotPhone').value || '',
                status: document.getElementById('depotStatus').value,
                capacity: parseFloat(document.getElementById('depotCapacity').value) || 0,
                notes: document.getElementById('depotNotes').value || '',
                updatedAt: new Date().toISOString()
            };
            
            if (isNew) {
                depotData.createdAt = new Date().toISOString();
            }
            
            try {
                if (isNew) {
                    const newRef = database.ref('depots').push();
                    await newRef.set(depotData);
                    
                    Logger.log("DEPOT_CREATED", depotData);
                    NotificationSystem.show("D√©p√¥t ajout√© avec succ√®s", "success");
                } else {
                    await database.ref(`depots/${depotId}`).update(depotData);
                    
                    Logger.log("DEPOT_UPDATED", { id: depotId, ...depotData });
                    NotificationSystem.show("D√©p√¥t modifi√© avec succ√®s", "success");
                }
                
                closeDepotModal();
                NotificationSystem.hideLoading();
                
            } catch (error) {
                Logger.error("SAVE_DEPOT", error);
                NotificationSystem.show("Erreur lors de l'enregistrement", "error");
                NotificationSystem.hideLoading();
            }
        }
        
        function confirmDeleteDepot(depotId) {
            const depot = depots.find(d => d.id === depotId);
            if (!depot) return;
            
            // V√©rifier si des produits utilisent ce d√©p√¥t
            const productsUsingDepot = StockManager.getProductsInDepot(depotId);
            
            if (productsUsingDepot.length > 0) {
                openConfirmModal(
                    `Impossible de supprimer ce d√©p√¥t. ${productsUsingDepot.length} produit(s) y sont stock√©s. Voulez-vous r√©affecter ces stocks avant de supprimer ?`,
                    () => reassignProductsAndDeleteDepot(depotId)
                );
            } else {
                openConfirmModal(
                    `√ätes-vous s√ªr de vouloir supprimer le d√©p√¥t "${depot.name}" ?`,
                    () => deleteDepot(depotId)
                );
            }
        }
        
        async function reassignProductsAndDeleteDepot(depotId) {
            // Trouver un autre d√©p√¥t actif
            const otherDepot = depots.find(d => d.id !== depotId && d.status === 'active');
            
            if (!otherDepot) {
                NotificationSystem.show("Aucun autre d√©p√¥t actif disponible", "error");
                return;
            }
            
            NotificationSystem.showLoading("Transfert des stocks...");
            
            try {
                // Mettre √† jour les produits
                const updates = {};
                products.forEach(product => {
                    if (product.stockByDepot && product.stockByDepot[depotId]) {
                        const stockInDepot = product.stockByDepot[depotId];
                        const currentStockInOther = product.stockByDepot[otherDepot.id] || 0;
                        
                        updates[`products/${product.id}/stockByDepot/${depotId}`] = null; // Supprimer
                        updates[`products/${product.id}/stockByDepot/${otherDepot.id}`] = currentStockInOther + stockInDepot;
                        
                        // Enregistrer le mouvement de transfert
                        recordStockMovement({
                            productId: product.id,
                            productName: product.name,
                            fromDepot: depotId,
                            toDepot: otherDepot.id,
                            type: 'transfer',
                            quantity: stockInDepot,
                            reason: 'depot_deletion',
                            notes: `Transfert automatique lors de la suppression du d√©p√¥t ${depot.name}`,
                            date: new Date().toISOString(),
                            userName: currentUser?.email || 'Administrateur',
                            createdAt: new Date().toISOString()
                        });
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await database.ref().update(updates);
                }
                
                // Supprimer le d√©p√¥t
                await database.ref(`depots/${depotId}`).remove();
                
                NotificationSystem.show("D√©p√¥t supprim√© et stocks transf√©r√©s", "success");
                
            } catch (error) {
                Logger.error("REASSIGN_PRODUCTS_DEPOT", error);
                NotificationSystem.show("Erreur lors de l'op√©ration", "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        async function deleteDepot(depotId) {
            NotificationSystem.showLoading("Suppression du d√©p√¥t...");
            
            try {
                const depot = depots.find(d => d.id === depotId);
                await database.ref(`depots/${depotId}`).remove();
                
                Logger.log("DEPOT_DELETED", { id: depotId, name: depot?.name });
                NotificationSystem.show("D√©p√¥t supprim√© avec succ√®s", "success");
                
            } catch (error) {
                Logger.error("DELETE_DEPOT", error);
                NotificationSystem.show("Erreur lors de la suppression", "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
        
        // ==================== GESTION DES MOUVEMENTS DE STOCK ====================
        async function saveStockAdjustment(e) {
            e.preventDefault();
            
            NotificationSystem.showLoading("Application de l'ajustement...");
            
            const productId = document.getElementById('adjustmentProduct').value;
            const depotId = document.getElementById('adjustmentDepot').value;
            const type = document.getElementById('adjustmentType').value;
            const quantity = parseFloat(document.getElementById('adjustmentQuantity').value) || 0;
            const reason = document.getElementById('adjustmentReason').value;
            const notes = document.getElementById('adjustmentNotes').value;
            
            if (!productId || !depotId || quantity <= 0) {
                NotificationSystem.show("Veuillez remplir tous les champs obligatoires", "error");
                NotificationSystem.hideLoading();
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                NotificationSystem.show("Produit non trouv√©", "error");
                NotificationSystem.hideLoading();
                return;
            }
            
            // R√©cup√©rer le stock actuel pour ce d√©p√¥t
            const currentStockInDepot = StockManager.getProductStockInDepot(product, depotId);
            let newStockInDepot = currentStockInDepot;
            let adjustmentQuantity = quantity;
            
            switch (type) {
                case 'in':
                    newStockInDepot += quantity;
                    break;
                case 'out':
                    if (quantity > currentStockInDepot) {
                        NotificationSystem.show(`Quantit√© insuffisante dans ce d√©p√¥t. Stock disponible: ${currentStockInDepot}`, "error");
                        NotificationSystem.hideLoading();
                        return;
                    }
                    newStockInDepot -= quantity;
                    break;
                case 'set':
                    newStockInDepot = quantity;
                    adjustmentQuantity = Math.abs(quantity - currentStockInDepot);
                    break;
            }
            
            try {
                // Pr√©parer les mises √† jour
                const updates = {};
                
                // Mettre √† jour le stock pour le d√©p√¥t sp√©cifique
                updates[`products/${productId}/stockByDepot/${depotId}`] = newStockInDepot;
                
                // Recalculer le stock total
                const updatedStockByDepot = {
                    ...(product.stockByDepot || {}),
                    [depotId]: newStockInDepot
                };
                
                // Calculer le nouveau total
                let newTotalStock = 0;
                Object.values(updatedStockByDepot).forEach(qty => {
                    newTotalStock += qty;
                });
                
                updates[`products/${productId}/totalStock`] = newTotalStock;
                updates[`products/${productId}/updatedAt`] = new Date().toISOString();
                
                // Appliquer les mises √† jour
                await database.ref().update(updates);
                
                // Enregistrer le mouvement de stock
                await recordStockMovement({
                    productId: productId,
                    productName: product.name,
                    depotId: depotId,
                    type: type === 'set' ? (quantity > currentStockInDepot ? 'in' : 'out') : type,
                    quantity: adjustmentQuantity,
                    reason: reason,
                    notes: notes,
                    previousStock: currentStockInDepot,
                    newStock: newStockInDepot,
                    date: new Date().toISOString(),
                    userName: currentUser?.email || 'Administrateur',
                    createdAt: new Date().toISOString()
                });
                
                Logger.log("STOCK_ADJUSTMENT", {
                    productId,
                    productName: product.name,
                    depotId,
                    type,
                    quantity: adjustmentQuantity,
                    reason,
                    previousStock: currentStockInDepot,
                    newStock: newStockInDepot
                });
                
                NotificationSystem.show("Ajustement de stock appliqu√© avec succ√®s!", "success");
                closeAdjustmentModal();
                NotificationSystem.hideLoading();
                
            } catch (error) {
                Logger.error("SAVE_STOCK_ADJUSTMENT", error);
                NotificationSystem.show("Erreur lors de l'ajustement du stock", "error");
                NotificationSystem.hideLoading();
            }
        }
        
        async function saveStockTransfer(e) {
            e.preventDefault();
            
            NotificationSystem.showLoading("Ex√©cution du transfert...");
            
            const productId = document.getElementById('transferProduct').value;
            const fromDepotId = document.getElementById('transferFromDepot').value;
            const toDepotId = document.getElementById('transferToDepot').value;
            const quantity = parseFloat(document.getElementById('transferQuantity').value) || 0;
            const reason = document.getElementById('transferReason').value || 'transfert';
            const notes = document.getElementById('transferNotes').value;
            
            if (fromDepotId === toDepotId) {
                NotificationSystem.show("Les d√©p√¥ts source et destination doivent √™tre diff√©rents", "error");
                NotificationSystem.hideLoading();
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                NotificationSystem.show("Produit non trouv√©", "error");
                NotificationSystem.hideLoading();
                return;
            }
            
            const availableStock = StockManager.getProductStockInDepot(product, fromDepotId);
            
            if (quantity > availableStock) {
                NotificationSystem.show(`Quantit√© insuffisante. Stock disponible: ${availableStock}`, "error");
                NotificationSystem.hideLoading();
                return;
            }
            
            try {
                // Pr√©parer les mises √† jour
                const updates = {};
                
                // Diminuer le stock du d√©p√¥t source
                const newStockFrom = availableStock - quantity;
                updates[`products/${productId}/stockByDepot/${fromDepotId}`] = newStockFrom;
                
                // Augmenter le stock du d√©p√¥t destination
                const currentStockTo = StockManager.getProductStockInDepot(product, toDepotId);
                const newStockTo = currentStockTo + quantity;
                updates[`products/${productId}/stockByDepot/${toDepotId}`] = newStockTo;
                
                // Le stock total reste le m√™me, pas besoin de le recalculer
                updates[`products/${productId}/updatedAt`] = new Date().toISOString();
                
                // Appliquer les mises √† jour
                await database.ref().update(updates);
                
                // Enregistrer le mouvement de transfert
                await recordStockMovement({
                    productId: productId,
                    productName: product.name,
                    fromDepot: fromDepotId,
                    toDepot: toDepotId,
                    type: 'transfer',
                    quantity: quantity,
                    reason: reason,
                    notes: notes,
                    previousStock: availableStock,
                    newStock: newStockFrom,
                    date: new Date().toISOString(),
                    userName: currentUser?.email || 'Administrateur',
                    createdAt: new Date().toISOString()
                });
                
                Logger.log("STOCK_TRANSFER", {
                    productId,
                    productName: product.name,
                    fromDepotId,
                    toDepotId,
                    quantity,
                    reason,
                    notes
                });
                
                NotificationSystem.show("Transfert effectu√© avec succ√®s", "success");
                closeTransferModal();
                NotificationSystem.hideLoading();
                
            } catch (error) {
                Logger.error("SAVE_STOCK_TRANSFER", error);
                NotificationSystem.show("Erreur lors du transfert", "error");
                NotificationSystem.hideLoading();
            }
        }
        
        // Fonction pour enregistrer les mouvements de stock
        async function recordStockMovement(movementData) {
            try {
                const movementRef = database.ref('stockMovements').push();
                await movementRef.set(movementData);
                return movementRef.key;
            } catch (error) {
                Logger.error("RECORD_STOCK_MOVEMENT", error);
                throw error;
            }
        }
        
        // ==================== RAPPORTS ====================
        function generateStockReport() {
            const totalValue = products.reduce((sum, p) => sum + (p.totalValue || 0), 0);
            const lowStockProducts = StockManager.getLowStockProducts();
            const outOfStockProducts = StockManager.getOutOfStockProducts();
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-file-alt"></i> Rapport d'√âtat des Stocks Multi-D√©p√¥ts</h3>
                    <p><strong>Date de g√©n√©ration:</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
                </div>
                
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Produits</h3>
                            <div class="value">${products.length}</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon value">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Valeur Totale</h3>
                            <div class="value">${formatNumber(totalValue)} DH</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon low">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Stock Bas</h3>
                            <div class="value">${lowStockProducts.length}</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon out">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Rupture</h3>
                            <div class="value">${outOfStockProducts.length}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3><i class="fas fa-warehouse"></i> Stock par D√©p√¥t</h3>
                    <div style="overflow-x: auto; margin-top: 15px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>D√©p√¥t</th>
                                    <th>Ville</th>
                                    <th>Produits</th>
                                    <th>Stock Total</th>
                                    <th>Valeur</th>
                                    <th>Stock Bas</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            depots.filter(d => d.status === 'active').forEach(depot => {
                const summary = StockManager.getDepotStockSummary(depot.id);
                
                html += `
                    <tr>
                        <td><strong>${depot.name}</strong></td>
                        <td>${depot.city}</td>
                        <td>${summary.productCount}</td>
                        <td><strong>${summary.totalStock}</strong></td>
                        <td><strong style="color: var(--success);">${formatNumber(summary.totalValue)} DH</strong></td>
                        <td><span style="color: ${summary.lowStockCount > 0 ? 'var(--warning)' : 'var(--success)'}">${summary.lowStockCount}</span></td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Rapport d'√©tat des stocks multi-d√©p√¥ts");
        }
        
        function generateLowStockReport() {
            const lowStockProducts = StockManager.getLowStockProducts();
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Rapport des Stocks Bas par D√©p√¥t</h3>
                    <p><strong>Produits n√©cessitant r√©approvisionnement:</strong> ${lowStockProducts.length}</p>
                </div>
            `;
            
            if (lowStockProducts.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-light); margin-bottom: 10px;">Aucun stock bas</h3>
                        <p>Tous les produits ont un stock suffisant</p>
                    </div>
                `;
            } else {
                html += `
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Code</th>
                                    <th>Cat√©gorie</th>
                                    <th>Stock par D√©p√¥t</th>
                                    <th>Total</th>
                                    <th>Seuil Min</th>
                                    <th>Diff√©rence</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                lowStockProducts.forEach(product => {
                    const difference = (product.totalStock || 0) - (product.minStock || 10);
                    const status = difference <= 0 ? 'Urgent' : 'Attention';
                    
                    // R√©cup√©rer les stocks par d√©p√¥t
                    const depotsStock = [];
                    if (product.stockByDepot) {
                        Object.keys(product.stockByDepot).forEach(depotId => {
                            const depotName = getDepotName(depotId);
                            const qty = product.stockByDepot[depotId];
                            if (qty > 0) {
                                depotsStock.push(`${depotName}: ${qty}`);
                            }
                        });
                    }
                    
                    const depotInfo = depotsStock.length > 0 
                        ? depotsStock.join('<br>')
                        : 'Aucun stock';
                    
                    html += `
                        <tr>
                            <td>${product.name}</td>
                            <td>${product.code}</td>
                            <td>${getCategoryName(product.category)}</td>
                            <td style="font-size: 12px;">${depotInfo}</td>
                            <td><strong>${product.totalStock}</strong></td>
                            <td>${product.minStock || 10}</td>
                            <td style="color: ${difference < 0 ? 'var(--danger)' : 'var(--warning)'}">
                                ${difference}
                            </td>
                            <td>
                                <span class="stock-status ${difference < 0 ? 'stock-out' : 'stock-low'}">
                                    ${status}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Rapport des stocks bas par d√©p√¥t");
        }
        
        function generateDepotReport() {
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-warehouse"></i> Rapport D√©tail des D√©p√¥ts</h3>
                    <p><strong>Date de g√©n√©ration:</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
                </div>
            `;
            
            depots.filter(d => d.status === 'active').forEach(depot => {
                const summary = StockManager.getDepotStockSummary(depot.id);
                const depotProducts = StockManager.getProductsInDepot(depot.id);
                
                html += `
                    <div style="background: var(--light); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h4>${depot.name} - ${depot.city}</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div style="background: var(--card-bg); padding: 15px; border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${summary.productCount}</div>
                                <div style="font-size: 14px; color: var(--text-light);">Produits</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 15px; border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">${summary.totalStock}</div>
                                <div style="font-size: 14px; color: var(--text-light);">Stock Total</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 15px; border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">${formatNumber(summary.totalValue)}</div>
                                <div style="font-size: 14px; color: var(--text-light);">Valeur Totale</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 15px; border-radius: 6px;">
                                <div style="font-size: 24px; font-weight: bold; color: ${summary.lowStockCount > 0 ? 'var(--warning)' : 'var(--success)'}">${summary.lowStockCount}</div>
                                <div style="font-size: 14px; color: var(--text-light);">Stock Bas</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5>Produits en stock:</h5>
                `;
                
                if (depotProducts.length === 0) {
                    html += `<p style="color: var(--text-light); font-style: italic;">Aucun produit dans ce d√©p√¥t</p>`;
                } else {
                    html += `
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Code</th>
                                        <th>Quantit√©</th>
                                        <th>Valeur</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    depotProducts.forEach(product => {
                        const stockInDepot = StockManager.getProductStockInDepot(product, depot.id);
                        const valueInDepot = stockInDepot * (product.costPrice || 0);
                        const status = StockManager.getStockStatus(stockInDepot, product.minStock, product.maxStock);
                        const statusText = StockManager.getStockStatusText(status);
                        const statusClass = `stock-${status}`;
                        
                        html += `
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.code}</td>
                                <td><strong>${stockInDepot}</strong></td>
                                <td><strong style="color: var(--success);">${formatNumber(valueInDepot)} DH</strong></td>
                                <td>
                                    <span class="stock-status ${statusClass}" style="font-size: 11px;">
                                        ${statusText}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
            });
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Rapport d√©tail des d√©p√¥ts");
        }
        
        function showABCReport() {
            const abcAnalysis = StockManager.performABCAnalysis();
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-chart-bar"></i> Analyse ABC des Stocks Multi-D√©p√¥ts</h3>
                    <p>Classification des produits par valeur (80/20)</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Classement</th>
                                <th>Produit</th>
                                <th>Code</th>
                                <th>Stock Total</th>
                                <th>Valeur</th>
                                <th>% Total</th>
                                <th>% Cumul√©</th>
                                <th>Cat√©gorie</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            abcAnalysis.forEach((item, index) => {
                const categoryColor = item.category === 'A' ? 'var(--danger)' : 
                                    item.category === 'B' ? 'var(--warning)' : 'var(--success)';
                
                html += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>${item.product}</td>
                        <td>${item.code}</td>
                        <td>${item.quantity}</td>
                        <td><strong>${formatNumber(item.value)} DH</strong></td>
                        <td>${item.percentage.toFixed(2)}%</td>
                        <td>${item.cumulativePercentage.toFixed(2)}%</td>
                        <td>
                            <span style="background: ${categoryColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${item.category}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                    <h4>L√©gende:</h4>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <div><span style="background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px;">A</span> - Produits √† haute valeur (80% de la valeur totale)</div>
                        <div><span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px;">B</span> - Produits √† valeur moyenne (15% suivants)</div>
                        <div><span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px;">C</span> - Produits √† faible valeur (5% restants)</div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Analyse ABC multi-d√©p√¥ts");
        }
        
        function showAgingReport() {
            const agingAnalysis = StockManager.calculateAgingAnalysis();
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-clock"></i> Analyse du Vieillissement des Stocks</h3>
                    <p>Temps √©coul√© depuis le dernier mouvement</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Code</th>
                                <th>Stock Total</th>
                                <th>Dernier Mouvement</th>
                                <th>√Çge (jours)</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            agingAnalysis.forEach(item => {
                let statusColor = 'var(--success)';
                if (item.ageDays > 90) statusColor = 'var(--danger)';
                else if (item.ageDays > 30) statusColor = 'var(--warning)';
                
                html += `
                    <tr>
                        <td>${item.product}</td>
                        <td>${item.code}</td>
                        <td>${item.quantity}</td>
                        <td>${item.lastMovement}</td>
                        <td>${item.ageDays}</td>
                        <td>
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${item.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                    <h4>L√©gende:</h4>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <div><span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 4px;">R√©cent</span> - ‚â§ 30 jours</div>
                        <div><span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px;">Moyen</span> - 31 √† 90 jours</div>
                        <div><span style="background: var(--danger); color: white; padding: 4px 8px; border-radius: 4px;">Ancien</span> - > 90 jours</div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Analyse du vieillissement");
        }
        
        function showProfitabilityReport() {
            // Calculer la rentabilit√© par produit
            const profitability = products.map(product => {
                const margin = StockManager.calculateMargin(product.sellPrice, product.costPrice);
                const totalProfit = (product.totalStock || 0) * (product.sellPrice - product.costPrice);
                
                return {
                    product: product.name,
                    code: product.code,
                    quantity: product.totalStock,
                    costPrice: product.costPrice,
                    sellPrice: product.sellPrice,
                    margin: margin,
                    totalProfit: totalProfit,
                    status: margin >= 50 ? '√âlev√©e' : margin >= 20 ? 'Moyenne' : 'Faible'
                };
            }).sort((a, b) => b.margin - a.margin);
            
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-money-bill-wave"></i> Analyse de Rentabilit√©</h3>
                    <p>Marge b√©n√©ficiaire par produit</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Code</th>
                                <th>Stock Total</th>
                                <th>Prix Achat</th>
                                <th>Prix Vente</th>
                                <th>Marge %</th>
                                <th>Profit Total</th>
                                <th>Rentabilit√©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            profitability.forEach(item => {
                let statusColor = 'var(--danger)';
                if (item.margin >= 50) statusColor = 'var(--success)';
                else if (item.margin >= 20) statusColor = 'var(--warning)';
                
                html += `
                    <tr>
                        <td>${item.product}</td>
                        <td>${item.code}</td>
                        <td>${item.quantity}</td>
                        <td>${formatNumber(item.costPrice)} DH</td>
                        <td>${formatNumber(item.sellPrice)} DH</td>
                        <td><strong>${item.margin.toFixed(2)}%</strong></td>
                        <td><strong style="color: ${item.totalProfit >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatNumber(item.totalProfit)} DH</strong></td>
                        <td>
                            <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${item.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Analyse de rentabilit√©");
        }
        
        function showDepotComparison() {
            let html = `
                <div style="background: var(--card-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3><i class="fas fa-warehouse"></i> Comparaison des Performances des D√©p√¥ts</h3>
                    <p>Analyse comparative entre les d√©p√¥ts</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>D√©p√¥t</th>
                                <th>Ville</th>
                                <th>Produits</th>
                                <th>Stock Total</th>
                                <th>Valeur</th>
                                <th>Stock Bas</th>
                                <th>Taux Rotation</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            depots.filter(d => d.status === 'active').forEach(depot => {
                const summary = StockManager.getDepotStockSummary(depot.id);
                
                // Calculer le taux de rotation (simplifi√©)
                const depotMovements = stockMovements.filter(m => 
                    (m.fromDepot === depot.id && m.type === 'out') || 
                    (m.toDepot === depot.id && m.type === 'in')
                );
                
                const totalIn = depotMovements.filter(m => m.type === 'in')
                    .reduce((sum, m) => sum + (m.quantity || 0), 0);
                const totalOut = depotMovements.filter(m => m.type === 'out')
                    .reduce((sum, m) => sum + (m.quantity || 0), 0);
                
                const turnoverRate = summary.totalStock > 0 ? 
                    ((totalOut || 1) / (summary.totalStock || 1)).toFixed(2) : 0;
                
                let performance = 'Moyenne';
                let performanceColor = 'var(--warning)';
                
                if (turnoverRate > 1.5) {
                    performance = '√âlev√©e';
                    performanceColor = 'var(--success)';
                } else if (turnoverRate < 0.5) {
                    performance = 'Faible';
                    performanceColor = 'var(--danger)';
                }
                
                html += `
                    <tr>
                        <td><strong>${depot.name}</strong></td>
                        <td>${depot.city}</td>
                        <td>${summary.productCount}</td>
                        <td><strong>${summary.totalStock}</strong></td>
                        <td><strong style="color: var(--success);">${formatNumber(summary.totalValue)} DH</strong></td>
                        <td style="color: ${summary.lowStockCount > 0 ? 'var(--warning)' : 'var(--success)'}">
                            ${summary.lowStockCount}
                        </td>
                        <td><strong>${turnoverRate}</strong></td>
                        <td>
                            <span style="background: ${performanceColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                ${performance}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: 8px;">
                    <h4>Indicateurs de Performance:</h4>
                    <ul style="margin-top: 10px;">
                        <li><strong>Taux de Rotation:</strong> Rapport entre les sorties et le stock moyen</li>
                        <li><strong>Performance √âlev√©e:</strong> Taux > 1.5 (rotation rapide)</li>
                        <li><strong>Performance Moyenne:</strong> Taux entre 0.5 et 1.5</li>
                        <li><strong>Performance Faible:</strong> Taux < 0.5 (rotation lente)</li>
                        <li><strong>Stock Bas:</strong> Nombre de produits n√©cessitant r√©approvisionnement</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('reportsContent').innerHTML = html;
            switchTab('reports');
            
            Logger.log("REPORT_GENERATED", "Comparaison des performances des d√©p√¥ts");
        }
        
        // ==================== FONCTIONS UTILITAIRES ====================
        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }
        
        function getCategoryName(categoryId) {
            if (!categoryId) return 'Non class√©';
            const category = categories.find(c => c.id === categoryId);
            return category ? category.name : 'Non class√©';
        }
        
        function getDepotName(depotId) {
            if (!depotId) return 'Non sp√©cifi√©';
            const depot = depots.find(d => d.id === depotId);
            return depot ? depot.name : 'Non sp√©cifi√©';
        }
        
        function getRandomColor() {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                '#8AC926', '#1982C4', '#6A4C93', '#F15BB5', '#00BBF9', '#00F5D4'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ==================== FONCTIONS D'EXPORT ====================
        function exportStockToExcel() {
            ExportManager.exportProductsToExcel();
        }
        
        function exportStockToPDF() {
            NotificationSystem.show("Export PDF en d√©veloppement", "info");
        }
        
        function exportCategoriesToExcel() {
            ExportManager.exportCategoriesToExcel();
        }
        
        function exportMovementsToExcel() {
            ExportManager.exportMovementsToExcel();
        }
        
        function exportDepotsToExcel() {
            ExportManager.exportDepotsToExcel();
        }
        
        // ==================== FONCTIONS DE RAFRAICHISSEMENT ====================
        function refreshStockData() {
            NotificationSystem.show("Actualisation des donn√©es...", "info");
            loadProducts();
            loadStockMovements();
        }
        
        function refreshCategories() {
            NotificationSystem.show("Actualisation des cat√©gories...", "info");
            loadCategories();
        }
        
        function refreshDepots() {
            NotificationSystem.show("Actualisation des d√©p√¥ts...", "info");
            loadDepots();
        }
        
        function refreshMovements() {
            NotificationSystem.show("Actualisation des mouvements...", "info");
            loadStockMovements();
        }
        
        // ==================== MIGRATION DES DONN√âES ====================
        async function migrateDataToNewStructure() {
            const confirmMigrate = confirm("Voulez-vous migrer les donn√©es vers la structure multi-d√©p√¥ts ? Cette op√©ration peut prendre quelques instants.");
            if (!confirmMigrate) return;
            
            NotificationSystem.showLoading("Migration des donn√©es...");
            
            try {
                const productsRef = database.ref('products');
                const snapshot = await productsRef.once('value');
                const productsData = snapshot.val();
                const updates = {};
                
                Object.keys(productsData).forEach(productId => {
                    const product = productsData[productId];
                    
                    // Si le produit a un champ depot, le convertir en stockByDepot
                    if (product.depot && (!product.stockByDepot || Object.keys(product.stockByDepot).length === 0)) {
                        const stockByDepot = {};
                        stockByDepot[product.depot] = product.quantity || product.currentStock || 0;
                        
                        updates[`products/${productId}/stockByDepot`] = stockByDepot;
                        updates[`products/${productId}/totalStock`] = product.quantity || product.currentStock || 0;
                        
                        // Supprimer l'ancien champ depot
                        updates[`products/${productId}/depot`] = null;
                        if (product.currentStock !== undefined) {
                            updates[`products/${productId}/currentStock`] = null;
                        }
                    }
                });
                
                if (Object.keys(updates).length > 0) {
                    await database.ref().update(updates);
                    NotificationSystem.show("Migration des donn√©es termin√©e avec succ√®s!", "success");
                    Logger.log("DATA_MIGRATION", "Migration vers structure multi-d√©p√¥ts");
                } else {
                    NotificationSystem.show("Aucune donn√©e √† migrer", "info");
                }
                
            } catch (error) {
                Logger.error("DATA_MIGRATION", error);
                NotificationSystem.show("Erreur lors de la migration des donn√©es", "error");
            } finally {
                NotificationSystem.hideLoading();
            }
        }
    </script>
</body>
</html>
