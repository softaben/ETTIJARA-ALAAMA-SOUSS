<!DOCTYPE html>
<html lang="fr" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETTIJARA ALAAMA SOUSS - Paramètres</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --accent: #1565c0;
            --light: #e3f2fd;
            --bg: #f5f7fa;
            --text: #333333;
            --text-light: #666666;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --info: #0288d1;
            --purple: #7b1fa2;
            --cyan: #0097a7;
            --shadow: 0 3px 15px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --primary: #3949ab;
            --secondary: #1565c0;
            --accent: #42a5f5;
            --light: #1e293b;
            --bg: #0f172a;
            --text: #e2e8f0;
            --text-light: #94a3b8;
            --card-bg: #1e293b;
            --border: #334155;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #ef5350;
            --info: #29b6f6;
            --purple: #ba68c8;
            --cyan: #26c6da;
            --shadow: 0 3px 15px rgba(0,0,0,0.3);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text);
            direction: rtl; 
            min-height: 100vh;
        }

        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 30px; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .logo i { 
            font-size: 28px; 
        }

        .logo-img {
            height: 40px;
            width: auto;
            max-width: 150px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .logo h1 { 
            font-size: 22px; 
            font-weight: 700; 
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-item {
            padding: 8px 20px;
            border-radius: 6px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        /* User Menu */
        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-dropdown {
            position: absolute;
            top: 50px;
            left: 0;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-width: 200px;
            display: none;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .user-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        .user-dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.3s;
            border-bottom: 1px solid var(--border);
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item:hover {
            background: var(--light);
        }

        /* Theme Toggle */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(30deg);
        }

        .theme-toggle .fa-sun {
            display: none;
        }

        [data-theme="dark"] .theme-toggle .fa-sun {
            display: block;
        }

        [data-theme="dark"] .theme-toggle .fa-moon {
            display: none;
        }
        
        /* Main Content */
        .main-content { 
            padding: 90px 30px 30px; 
            min-height: calc(100vh - 70px);
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Welcome Section */
        .welcome-section {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .welcome-text h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-text p {
            opacity: 0.9;
            font-size: 16px;
        }

        /* Settings Container */
        .settings-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .settings-container {
                grid-template-columns: 1fr;
            }
        }

        /* Settings Sidebar */
        .settings-sidebar {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .settings-nav {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .settings-nav-item {
            padding: 12px 15px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .settings-nav-item:hover {
            background: var(--light);
        }

        .settings-nav-item.active {
            background: var(--primary);
            color: white;
        }

        /* Settings Content */
        .settings-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .settings-section {
            margin-bottom: 40px;
        }

        .settings-section h3 {
            font-size: 20px;
            color: var(--text);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* Settings Card */
        .settings-card {
            background: var(--light);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .settings-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-card-header h4 {
            font-size: 18px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-card-header .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        /* Danger Zone */
        .danger-zone {
            background: linear-gradient(135deg, rgba(198, 40, 40, 0.1), rgba(239, 83, 80, 0.05));
            border: 2px solid var(--danger);
        }

        .danger-zone .settings-card-header h4 {
            color: var(--danger);
        }

        .danger-zone .settings-card-header .icon {
            background: linear-gradient(135deg, var(--danger), #e53935);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Logo Preview */
        .logo-preview-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .logo-preview {
            width: 120px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Image Upload */
        .image-upload-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .image-preview {
            width: 100px;
            height: 60px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: var(--card-bg);
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 35, 126, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e53935);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(198, 40, 40, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff9800);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 124, 0, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #29b6f6);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(2, 136, 209, 0.3);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .stat-card .number {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 13px;
            color: var(--text-light);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            top: 100px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
            color: var(--text);
            max-width: 400px;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.info {
            border-left-color: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--danger), #e53935);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .loading i {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { 
                padding: 0 15px; 
                height: 60px;
            }
            
            .main-content { 
                padding: 80px 15px 15px; 
            }
            
            .logo h1 {
                font-size: 18px;
            }

            .nav {
                display: none;
            }

            .welcome-section {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .settings-content {
                padding: 20px;
            }

            .settings-card {
                padding: 15px;
            }

            .logo-preview-container {
                flex-direction: column;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 16px;
            }

            .welcome-section {
                padding: 20px;
            }

            .welcome-text h2 {
                font-size: 22px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Help text */
        .help-text {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* URL Preview */
        .url-preview {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            margin-top: 10px;
            font-size: 12px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="" id="headerLogo" class="logo-img" alt="Logo ETTIJARA" style="display: none;">
            <i class="fas fa-cog" id="headerIcon"></i>
            <h1>ETTIJARA ALAAMA SOUSS - PARAMÈTRES</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <nav class="nav">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard
                </a>
                <a href="stock.html" class="nav-item">
                    <i class="fas fa-warehouse"></i>
                    Stock
                </a>
                <a href="sales.html" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    Ventes
                </a>
                <a href="purchases.html" class="nav-item">
                    <i class="fas fa-shopping-basket"></i>
                    Achats
                </a>
                <a href="clients.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    Clients
                </a>
                <a href="suppliers.html" class="nav-item">
                    <i class="fas fa-truck-loading"></i>
                    Fournisseurs
                </a>
                <a href="payments.html" class="nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    Paiements
                </a>
                <a href="settings.html" class="nav-item active">
                    <i class="fas fa-cog"></i>
                    Paramètres
                </a>
            </nav>
            
            <!-- User Menu -->
            <div class="user-menu" id="userMenu">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item">
                        <i class="fas fa-user"></i>
                        <span id="userName">Administrateur</span>
                    </div>
                    <div class="user-dropdown-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Rapports</span>
                    </div>
                    <div class="user-dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Déconnexion</span>
                    </div>
                </div>
            </div>
            
            <button class="theme-toggle" id="themeToggle" title="Changer le thème">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
            </button>
            <div class="connection-status">
                <div id="connectionStatus" class="status-dot disconnected" title="Déconnecté"></div>
                <span style="color: white; font-size: 12px;">Firebase</span>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <div class="welcome-text">
                <h2>Paramètres du Système ⚙️</h2>
                <p>Gérez les paramètres et la configuration de votre système</p>
            </div>
            <div style="display: flex; align-items: center; gap: 10px; color: white;">
                <i class="fas fa-shield-alt" style="font-size: 32px;"></i>
            </div>
        </div>

        <div class="settings-container">
            <!-- Sidebar Navigation -->
            <div class="settings-sidebar">
                <div class="settings-nav">
                    <a href="#general" class="settings-nav-item active" data-section="general">
                        <i class="fas fa-cog"></i>
                        Général
                    </a>
                    <a href="#company" class="settings-nav-item" data-section="company">
                        <i class="fas fa-building"></i>
                        Entreprise
                    </a>
                    <a href="#database" class="settings-nav-item" data-section="database">
                        <i class="fas fa-database"></i>
                        Base de données
                    </a>
                    <a href="#backup" class="settings-nav-item" data-section="backup">
                        <i class="fas fa-save"></i>
                        Sauvegarde
                    </a>
                    <a href="#users" class="settings-nav-item" data-section="users">
                        <i class="fas fa-users-cog"></i>
                        Utilisateurs
                    </a>
                    <a href="#security" class="settings-nav-item" data-section="security">
                        <i class="fas fa-shield-alt"></i>
                        Sécurité
                    </a>
                    <a href="#about" class="settings-nav-item" data-section="about">
                        <i class="fas fa-info-circle"></i>
                        À propos
                    </a>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="settings-content">
                <!-- Section Général (par défaut) -->
                <div class="settings-section" id="general-section">
                    <h3><i class="fas fa-cog"></i> Paramètres Généraux</h3>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-language"></i>
                                </div>
                                <h4>Préférences de Langue</h4>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Langue de l'interface</label>
                            <select class="form-control" id="languageSelect">
                                <option value="fr">Français</option>
                                <option value="ar">العربية</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Devise</label>
                            <select class="form-control" id="currencySelect">
                                <option value="MAD">DH (Dirham marocain)</option>
                                <option value="EUR">€ (Euro)</option>
                                <option value="USD">$ (Dollar US)</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveGeneralSettings()">
                                <i class="fas fa-save"></i>
                                Enregistrer les préférences
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <h4>Apparence</h4>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Thème</label>
                                <select class="form-control" id="themeSelect">
                                    <option value="light">Clair</option>
                                    <option value="dark">Sombre</option>
                                    <option value="auto">Automatique</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Taille de police</label>
                                <select class="form-control" id="fontSizeSelect">
                                    <option value="small">Petite</option>
                                    <option value="medium" selected>Moyenne</option>
                                    <option value="large">Grande</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="applyAppearanceSettings()">
                                <i class="fas fa-check"></i>
                                Appliquer l'apparence
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section Entreprise -->
                <div class="settings-section" id="company-section" style="display: none;">
                    <h3><i class="fas fa-building"></i> Informations de l'Entreprise</h3>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <h4>Détails de l'entreprise</h4>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Nom de l'entreprise *</label>
                            <input type="text" class="form-control" id="companyName" placeholder="ETTIJARA ALAAMA SOUSS" value="ETTIJARA ALAAMA SOUSS">
                        </div>
                        
                        <div class="form-group">
                            <label>Slogan / Description</label>
                            <input type="text" class="form-control" id="companyTagline" placeholder="Système de Gestion Commerciale">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" class="form-control" id="companyPhone" placeholder="0525265980">
                            </div>
                            
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" id="companyEmail" placeholder="ettijaraalaamasouss@gmail.com">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Adresse</label>
                            <textarea class="form-control" id="companyAddress" rows="3" placeholder="Adresse complète de l'entreprise"></textarea>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveCompanyInfo()">
                                <i class="fas fa-save"></i>
                                Enregistrer les informations
                            </button>
                        </div>
                    </div>
                    
                    <!-- Logo Settings -->
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                <h4>Logo de l'entreprise</h4>
                            </div>
                        </div>
                        
                        <div class="logo-preview-container">
                            <div class="logo-preview">
                                <img id="logoPreviewImg" src="" alt="Aperçu du logo">
                                <div id="logoPreviewPlaceholder" style="color: var(--text-light); text-align: center;">
                                    <i class="fas fa-image" style="font-size: 24px;"></i>
                                    <div style="font-size: 12px; margin-top: 5px;">Aucun logo</div>
                                </div>
                            </div>
                            <div>
                                <h5 style="color: var(--text); margin-bottom: 5px;">Aperçu du logo</h5>
                                <p style="color: var(--text-light); font-size: 13px;">Le logo s'affichera dans l'en-tête et sur les documents</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>URL du logo</label>
                            <div class="image-upload-container">
                                <input type="text" class="form-control" id="logoUrl" placeholder="https://exemple.com/logo.png" style="flex: 1;">
                                <button class="btn btn-info btn-small" onclick="testLogoUrl()">
                                    <i class="fas fa-eye"></i>
                                    Tester
                                </button>
                            </div>
                            <div class="help-text">
                                Entrez l'URL complète de l'image du logo (format PNG, JPG ou SVG)
                            </div>
                            
                            <div id="urlPreview" class="url-preview" style="display: none;">
                                <strong>URL actuelle:</strong>
                                <span id="currentLogoUrl"></span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>OU Télécharger une image</label>
                            <input type="file" class="form-control" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)">
                            <div class="help-text">
                                Formats acceptés: JPG, PNG, GIF, SVG (taille max: 2MB)
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>URL alternative (fallback)</label>
                            <input type="text" class="form-control" id="logoFallbackUrl" placeholder="URL de secours si la principale ne fonctionne pas">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Hauteur du logo (px)</label>
                                <input type="number" class="form-control" id="logoHeight" value="40" min="20" max="100">
                            </div>
                            
                            <div class="form-group">
                                <label>Affichage par défaut</label>
                                <select class="form-control" id="logoDisplay">
                                    <option value="both">Logo + Texte</option>
                                    <option value="logo">Logo uniquement</option>
                                    <option value="text">Texte uniquement</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="saveLogoConfig()">
                                <i class="fas fa-save"></i>
                                Enregistrer le logo
                            </button>
                            <button class="btn btn-secondary" onclick="resetLogoConfig()">
                                <i class="fas fa-undo"></i>
                                Réinitialiser
                            </button>
                            <button class="btn btn-danger" onclick="removeLogo()">
                                <i class="fas fa-trash"></i>
                                Supprimer le logo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section Base de données -->
                <div class="settings-section" id="database-section" style="display: none;">
                    <h3><i class="fas fa-database"></i> Gestion de la Base de Données</h3>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number" id="clientsCount">0</div>
                            <div class="label">Clients</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="productsCount">0</div>
                            <div class="label">Produits</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="deliveriesCount">0</div>
                            <div class="label">Ventes</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="suppliersCount">0</div>
                            <div class="label">Fournisseurs</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="depotsCount">0</div>
                            <div class="label">Dépôts</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="categoriesCount">0</div>
                            <div class="label">Catégories</div>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <h4>Synchronisation des données</h4>
                            </div>
                        </div>
                        
                        <p style="margin-bottom: 20px; color: var(--text-light);">
                            Synchronisez manuellement les données avec Firebase pour vous assurer que toutes les informations sont à jour.
                        </p>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="syncData()">
                                <i class="fas fa-sync-alt"></i>
                                Synchroniser maintenant
                            </button>
                            <button class="btn btn-secondary" onclick="refreshDatabaseStats()">
                                <i class="fas fa-redo"></i>
                                Actualiser les statistiques
                            </button>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="settings-card danger-zone">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h4>Zone de Danger</h4>
                            </div>
                        </div>
                        
                        <p style="margin-bottom: 20px; color: var(--danger);">
                            <i class="fas fa-exclamation-circle"></i>
                            <strong>Attention :</strong> Les actions dans cette section sont irréversibles. Veuillez procéder avec prudence.
                        </p>
                        
                        <div class="form-group">
                            <label>Supprimer toutes les données (sauf les dépôts et catégories)</label>
                            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                                Cette action supprimera définitivement tous les clients, produits, ventes, fournisseurs et mouvements de stock.
                                <br>
                                <strong>Les dépôts et catégories seront conservés.</strong>
                            </p>
                            
                            <div style="background: rgba(198, 40, 40, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--danger);">
                                <div style="display: flex; align-items: center; gap: 10px; color: var(--danger); margin-bottom: 10px;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Données qui seront supprimées :</strong>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                    <div><i class="fas fa-trash" style="color: var(--danger);"></i> Tous les clients</div>
                                    <div><i class="fas fa-trash" style="color: var(--danger);"></i> Tous les produits</div>
                                    <div><i class="fas fa-trash" style="color: var(--danger);"></i> Toutes les ventes</div>
                                    <div><i class="fas fa-trash" style="color: var(--danger);"></i> Tous les fournisseurs</div>
                                    <div><i class="fas fa-trash" style="color: var(--danger);"></i> Tous les mouvements de stock</div>
                                    <div><i class="fas fa-trash" style="color: var(--danger);"></i> Tous les paiements</div>
                                </div>
                                
                                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(198, 40, 40, 0.3);">
                                    <div style="display: flex; align-items: center; gap: 10px; color: var(--success);">
                                        <i class="fas fa-check-circle"></i>
                                        <strong>Données qui seront conservées :</strong>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px; margin-top: 5px;">
                                        <div><i class="fas fa-check" style="color: var(--success);"></i> Tous les dépôts</div>
                                        <div><i class="fas fa-check" style="color: var(--success);"></i> Toutes les catégories</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmationText">Pour confirmer, tapez "SUPPRIMER" ci-dessous :</label>
                                <input type="text" id="confirmationText" class="form-control" placeholder="SUPPRIMER">
                            </div>
                            
                            <button class="btn btn-danger" onclick="confirmDeleteAllData()" id="deleteAllDataBtn" disabled>
                                <i class="fas fa-trash"></i>
                                Supprimer toutes les données
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section Sauvegarde -->
                <div class="settings-section" id="backup-section" style="display: none;">
                    <h3><i class="fas fa-save"></i> Sauvegarde et Restauration</h3>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h4>Sauvegarde des données</h4>
                            </div>
                        </div>
                        
                        <p style="margin-bottom: 20px; color: var(--text-light);">
                            Créez une sauvegarde de toutes vos données. La sauvegarde sera téléchargée au format JSON.
                        </p>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="createBackup()">
                                <i class="fas fa-download"></i>
                                Créer une sauvegarde
                            </button>
                            <button class="btn btn-secondary" onclick="scheduleAutoBackup()">
                                <i class="fas fa-calendar-alt"></i>
                                Planifier sauvegarde automatique
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-cloud-download-alt"></i>
                                </div>
                                <h4>Restauration des données</h4>
                            </div>
                        </div>
                        
                        <p style="margin-bottom: 20px; color: var(--text-light);">
                            Restaurez vos données à partir d'une sauvegarde précédente.
                        </p>
                        
                        <div class="form-group">
                            <label>Fichier de sauvegarde (.json)</label>
                            <input type="file" id="backupFile" class="form-control" accept=".json">
                        </div>
                        
                        <button class="btn btn-warning" onclick="restoreBackup()">
                            <i class="fas fa-upload"></i>
                            Restaurer à partir du fichier
                        </button>
                    </div>
                </div>

                <!-- Section Utilisateurs -->
                <div class="settings-section" id="users-section" style="display: none;">
                    <h3><i class="fas fa-users-cog"></i> Gestion des Utilisateurs</h3>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <h4>Ajouter un nouvel utilisateur</h4>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nom complet</label>
                                <input type="text" class="form-control" id="newUserName" placeholder="Nom et prénom">
                            </div>
                            
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" id="newUserEmail" placeholder="email@exemple.com">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Rôle</label>
                                <select class="form-control" id="newUserRole">
                                    <option value="admin">Administrateur</option>
                                    <option value="manager">Gestionnaire</option>
                                    <option value="user">Utilisateur</option>
                                    <option value="viewer">Observateur</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Mot de passe</label>
                                <input type="password" class="form-control" id="newUserPassword" placeholder="••••••••">
                            </div>
                        </div>
                        
                        <button class="btn btn-success" onclick="addNewUser()">
                            <i class="fas fa-user-plus"></i>
                            Ajouter l'utilisateur
                        </button>
                    </div>
                </div>

                <!-- Section Sécurité -->
                <div class="settings-section" id="security-section" style="display: none;">
                    <h3><i class="fas fa-shield-alt"></i> Sécurité</h3>
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div>
                                <div class="icon">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <h4>Mot de passe et authentification</h4>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ancien mot de passe</label>
                            <input type="password" class="form-control" id="oldPassword">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nouveau mot de passe</label>
                                <input type="password" class="form-control" id="newPassword">
                            </div>
                            
                            <div class="form-group">
                                <label>Confirmer le nouveau mot de passe</label>
                                <input type="password" class="form-control" id="confirmPassword">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="changePassword()">
                            <i class="fas fa-key"></i>
                            Changer le mot de passe
                        </button>
                    </div>
                </div>

                <!-- Section À propos -->
                <div class="settings-section" id="about-section" style="display: none;">
                    <h3><i class="fas fa-info-circle"></i> À propos du système</h3>
                    
                    <div class="settings-card">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-chart-line" style="font-size: 64px; color: var(--primary); margin-bottom: 20px;"></i>
                            <h3 style="color: var(--primary); margin-bottom: 10px;">ETTIJARA ALAAMA SOUSS</h3>
                            <p style="color: var(--text-light); margin-bottom: 20px;">
                                Système de Gestion Commerciale
                            </p>
                        </div>
                        
                        <div style="background: var(--light); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: var(--text);">Informations système</h4>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <strong>Version :</strong>
                                    <span id="systemVersion">1.0.0</span>
                                </div>
                                <div>
                                    <strong>Dernière mise à jour :</strong>
                                    <span id="lastUpdateDate">--/--/----</span>
                                </div>
                                <div>
                                    <strong>Base de données :</strong>
                                    <span id="databaseType">Firebase Realtime Database</span>
                                </div>
                                <div>
                                    <strong>Statut :</strong>
                                    <span id="systemStatus" style="color: var(--success);">Actif</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; padding-top: 20px; border-top: 1px solid var(--border);">
                            <p style="color: var(--text-light); font-size: 14px;">
                                © 2024 ETTIJARA ALAAMA SOUSS. Tous droits réservés.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de confirmation pour suppression des données -->
    <div class="modal-overlay" id="confirmDeleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirmer la suppression</h3>
                <button class="close-modal" onclick="closeConfirmModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 30px;">
                    <i class="fas fa-trash" style="font-size: 64px; color: var(--danger); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--danger); margin-bottom: 10px;">Attention !</h3>
                    <p style="color: var(--text); margin-bottom: 10px;">
                        Vous êtes sur le point de supprimer <strong>TOUTES LES DONNÉES</strong> (sauf les dépôts et catégories).
                    </p>
                    <p style="color: var(--text-light); font-size: 14px;">
                        Cette action est <strong>IRRÉVERSIBLE</strong>. Tous les clients, produits, ventes, fournisseurs et mouvements de stock seront définitivement supprimés.
                    </p>
                </div>
                
                <div style="background: rgba(198, 40, 40, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--danger);">
                    <div style="color: var(--danger); font-weight: bold; margin-bottom: 10px;">
                        <i class="fas fa-exclamation-circle"></i>
                        RÉSUMÉ DE LA SUPPRESSION :
                    </div>
                    <div id="deleteSummary">
                        <!-- Le résumé sera injecté ici -->
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">
                        Annuler
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllData()" id="finalDeleteBtn">
                        <i class="fas fa-trash"></i>
                        Confirmer la suppression
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAV_c5Gt_f1h5nZF47FcPjW_h4P24LYADk",
            authDomain: "commerce22-610cc.firebaseapp.com",
            databaseURL: "https://commerce22-610cc-default-rtdb.firebaseio.com",
            projectId: "commerce22-610cc",
            storageBucket: "commerce22-610cc.firebasestorage.app",
            messagingSenderId: "458158894252",
            appId: "1:458158894252:web:d1e640b2e16ef32d978309"
        };

        // ==================== VARIABLES GLOBALES ====================
        let database = null;
        let isConnected = false;
        let currentUser = null;
        let dbStats = {
            clients: 0,
            products: 0,
            deliveries: 0,
            suppliers: 0,
            depots: 0,
            categories: 0,
            stockMovements: 0,
            payments: 0
        };

        // Configuration du logo
        let logoConfig = {
            url: '',
            fallbackUrl: '',
            height: 40,
            display: 'both',
            lastUpdated: null
        };

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("⚙️ Page Paramètres en cours de démarrage...");
            
            // Initialiser le thème
            initTheme();
            
            // Initialiser Firebase
            initializeFirebase();
            
            // Initialiser la navigation
            initNavigation();
            
            // Initialiser les listeners
            initListeners();
            
            // Simuler l'utilisateur
            simulateUser();
            
            // Charger les statistiques
            loadDatabaseStats();
            
            // Charger la configuration du logo
            loadLogoConfig();
            
            // Charger les informations de l'entreprise
            loadCompanyInfo();
            
            // Mettre à jour la date
            updateLastUpdateDate();
        });
        
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            // Remplir le sélecteur de thème
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.value = savedTheme;
            }
        }
        
        function initNavigation() {
            const navItems = document.querySelectorAll('.settings-nav-item');
            const sections = document.querySelectorAll('.settings-section');
            
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Retirer la classe active de tous les items
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // Ajouter la classe active à l'item cliqué
                    this.classList.add('active');
                    
                    // Récupérer la section cible
                    const targetSection = this.getAttribute('data-section');
                    
                    // Masquer toutes les sections
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // Afficher la section cible
                    document.getElementById(`${targetSection}-section`).style.display = 'block';
                });
            });
        }
        
        function initListeners() {
            // Gestion des menus utilisateur
            document.getElementById('userMenu').addEventListener('click', toggleUserDropdown);
            
            // Fermer les menus en cliquant ailleurs
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu')) {
                    document.getElementById('userDropdown').classList.remove('show');
                }
            });
            
            // Confirmation text pour suppression
            const confirmationText = document.getElementById('confirmationText');
            const deleteBtn = document.getElementById('deleteAllDataBtn');
            
            if (confirmationText && deleteBtn) {
                confirmationText.addEventListener('input', function() {
                    deleteBtn.disabled = this.value !== 'SUPPRIMER';
                });
            }
            
            // Modal de confirmation
            const modal = document.getElementById('confirmDeleteModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeConfirmModal();
                });
            }
        }
        
        function toggleUserDropdown() {
            document.getElementById('userDropdown').classList.toggle('show');
        }
        
        function simulateUser() {
            currentUser = {
                uid: 'admin_001',
                email: 'admin@ettijara.com',
                displayName: 'Administrateur'
            };
            
            updateUserUI();
        }
        
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userAvatar').textContent = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
            }
        }
        
        function updateLastUpdateDate() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('lastUpdateDate').textContent = formattedDate;
        }

        // ==================== GESTION DU LOGO ====================
        
        function loadLogoConfig() {
            const savedConfig = localStorage.getItem('logoConfig');
            if (savedConfig) {
                try {
                    logoConfig = JSON.parse(savedConfig);
                    applyLogoConfig();
                } catch (error) {
                    console.error("❌ Erreur chargement configuration logo:", error);
                }
            }
            
            // Mettre à jour les champs du formulaire
            document.getElementById('logoUrl').value = logoConfig.url || '';
            document.getElementById('logoFallbackUrl').value = logoConfig.fallbackUrl || '';
            document.getElementById('logoHeight').value = logoConfig.height || 40;
            document.getElementById('logoDisplay').value = logoConfig.display || 'both';
            
            // Afficher l'aperçu
            updateLogoPreview();
            
            // Afficher l'URL actuelle si elle existe
            if (logoConfig.url) {
                document.getElementById('urlPreview').style.display = 'block';
                document.getElementById('currentLogoUrl').textContent = logoConfig.url;
            }
        }
        
        function applyLogoConfig() {
            const headerLogo = document.getElementById('headerLogo');
            const headerIcon = document.getElementById('headerIcon');
            
            if (logoConfig.url && logoConfig.display !== 'text') {
                // Afficher le logo
                headerLogo.src = logoConfig.url;
                headerLogo.style.display = 'block';
                headerLogo.style.height = `${logoConfig.height}px`;
                
                // Masquer l'icône si on affiche le logo uniquement
                if (logoConfig.display === 'logo') {
                    headerIcon.style.display = 'none';
                    document.querySelector('.logo h1').style.display = 'none';
                } else {
                    headerIcon.style.display = 'inline-block';
                    document.querySelector('.logo h1').style.display = 'block';
                }
            } else {
                // Afficher l'icône par défaut
                headerLogo.style.display = 'none';
                headerIcon.style.display = 'inline-block';
                document.querySelector('.logo h1').style.display = 'block';
            }
            
            // Gestion du fallback
            headerLogo.onerror = function() {
                console.warn("⚠️ URL du logo principale échouée, tentative avec fallback...");
                if (logoConfig.fallbackUrl) {
                    this.src = logoConfig.fallbackUrl;
                } else {
                    this.style.display = 'none';
                    headerIcon.style.display = 'inline-block';
                }
            };
        }
        
        function updateLogoPreview() {
            const previewImg = document.getElementById('logoPreviewImg');
            const previewPlaceholder = document.getElementById('logoPreviewPlaceholder');
            const url = document.getElementById('logoUrl').value || logoConfig.url;
            
            if (url) {
                previewImg.src = url;
                previewImg.style.display = 'block';
                previewPlaceholder.style.display = 'none';
                
                // Gestion d'erreur pour l'aperçu
                previewImg.onerror = function() {
                    console.warn("⚠️ URL du logo invalide pour l'aperçu");
                    this.style.display = 'none';
                    previewPlaceholder.style.display = 'block';
                };
            } else {
                previewImg.style.display = 'none';
                previewPlaceholder.style.display = 'block';
            }
        }
        
        function testLogoUrl() {
            const url = document.getElementById('logoUrl').value;
            if (!url) {
                showToast("Veuillez entrer une URL", "warning");
                return;
            }
            
            showToast("Test de l'URL en cours...", "info");
            
            // Créer une image pour tester l'URL
            const testImage = new Image();
            testImage.onload = function() {
                showToast("✅ URL valide - Image chargée avec succès", "success");
                updateLogoPreview();
            };
            
            testImage.onerror = function() {
                showToast("❌ URL invalide - Impossible de charger l'image", "error");
            };
            
            testImage.src = url;
        }
        
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Vérifier la taille du fichier (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast("Fichier trop volumineux (max 2MB)", "error");
                return;
            }
            
            // Vérifier le type de fichier
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/svg+xml'];
            if (!validTypes.includes(file.type)) {
                showToast("Format non supporté (JPG, PNG, GIF, SVG uniquement)", "error");
                return;
            }
            
            showToast("Téléchargement du logo...", "info");
            
            // Lire le fichier et le convertir en URL de données
            const reader = new FileReader();
            reader.onload = function(e) {
                // Utiliser l'URL de données comme source
                const dataUrl = e.target.result;
                document.getElementById('logoUrl').value = dataUrl;
                updateLogoPreview();
                showToast("✅ Logo téléchargé avec succès", "success");
            };
            
            reader.onerror = function() {
                showToast("❌ Erreur lors du téléchargement", "error");
            };
            
            reader.readAsDataURL(file);
        }
        
        function saveLogoConfig() {
            logoConfig = {
                url: document.getElementById('logoUrl').value.trim(),
                fallbackUrl: document.getElementById('logoFallbackUrl').value.trim(),
                height: parseInt(document.getElementById('logoHeight').value) || 40,
                display: document.getElementById('logoDisplay').value,
                lastUpdated: new Date().toISOString()
            };
            
            // Sauvegarder dans le localStorage
            try {
                localStorage.setItem('logoConfig', JSON.stringify(logoConfig));
                
                // Appliquer la configuration
                applyLogoConfig();
                
                // Mettre à jour l'affichage de l'URL
                if (logoConfig.url) {
                    document.getElementById('urlPreview').style.display = 'block';
                    document.getElementById('currentLogoUrl').textContent = logoConfig.url;
                } else {
                    document.getElementById('urlPreview').style.display = 'none';
                }
                
                showToast("✅ Configuration du logo enregistrée", "success");
                
                // Sauvegarder également dans Firebase si connecté
                if (database && isConnected) {
                    saveLogoConfigToFirebase();
                }
                
            } catch (error) {
                console.error("❌ Erreur sauvegarde configuration logo:", error);
                showToast("Erreur lors de l'enregistrement", "error");
            }
        }
        
        async function saveLogoConfigToFirebase() {
            if (!database || !isConnected) return;
            
            try {
                await database.ref('systemConfig/logo').set(logoConfig);
                console.log("✅ Configuration logo sauvegardée dans Firebase");
            } catch (error) {
                console.error("❌ Erreur sauvegarde Firebase:", error);
            }
        }
        
        async function loadLogoConfigFromFirebase() {
            if (!database || !isConnected) return;
            
            try {
                const snapshot = await database.ref('systemConfig/logo').once('value');
                if (snapshot.exists()) {
                    const firebaseConfig = snapshot.val();
                    logoConfig = { ...logoConfig, ...firebaseConfig };
                    applyLogoConfig();
                    
                    // Mettre à jour les champs du formulaire
                    document.getElementById('logoUrl').value = logoConfig.url || '';
                    document.getElementById('logoFallbackUrl').value = logoConfig.fallbackUrl || '';
                    document.getElementById('logoHeight').value = logoConfig.height || 40;
                    document.getElementById('logoDisplay').value = logoConfig.display || 'both';
                    
                    updateLogoPreview();
                }
            } catch (error) {
                console.error("❌ Erreur chargement logo Firebase:", error);
            }
        }
        
        function resetLogoConfig() {
            logoConfig = {
                url: '',
                fallbackUrl: '',
                height: 40,
                display: 'both',
                lastUpdated: null
            };
            
            // Réinitialiser les champs
            document.getElementById('logoUrl').value = '';
            document.getElementById('logoFallbackUrl').value = '';
            document.getElementById('logoHeight').value = 40;
            document.getElementById('logoDisplay').value = 'both';
            document.getElementById('urlPreview').style.display = 'none';
            
            // Mettre à jour l'aperçu
            updateLogoPreview();
            
            showToast("Configuration du logo réinitialisée", "info");
        }
        
        function removeLogo() {
            const confirmRemove = confirm("Êtes-vous sûr de vouloir supprimer le logo ?");
            if (!confirmRemove) return;
            
            resetLogoConfig();
            
            // Supprimer du localStorage
            localStorage.removeItem('logoConfig');
            
            // Supprimer de Firebase
            if (database && isConnected) {
                database.ref('systemConfig/logo').remove()
                    .then(() => console.log("✅ Logo supprimé de Firebase"))
                    .catch(error => console.error("❌ Erreur suppression logo Firebase:", error));
            }
            
            showToast("✅ Logo supprimé", "success");
        }

        // ==================== GESTION DES INFORMATIONS DE L'ENTREPRISE ====================
        
        function loadCompanyInfo() {
            const savedInfo = localStorage.getItem('companyInfo');
            if (savedInfo) {
                try {
                    const companyInfo = JSON.parse(savedInfo);
                    
                    // Remplir les champs
                    document.getElementById('companyName').value = companyInfo.name || 'ETTIJARA ALAAMA SOUSS';
                    document.getElementById('companyTagline').value = companyInfo.tagline || '';
                    document.getElementById('companyPhone').value = companyInfo.phone || '';
                    document.getElementById('companyEmail').value = companyInfo.email || '';
                    document.getElementById('companyAddress').value = companyInfo.address || '';
                } catch (error) {
                    console.error("❌ Erreur chargement informations entreprise:", error);
                }
            }
        }
        
        function saveCompanyInfo() {
            const companyInfo = {
                name: document.getElementById('companyName').value.trim(),
                tagline: document.getElementById('companyTagline').value.trim(),
                phone: document.getElementById('companyPhone').value.trim(),
                email: document.getElementById('companyEmail').value.trim(),
                address: document.getElementById('companyAddress').value.trim(),
                lastUpdated: new Date().toISOString()
            };
            
            // Validation basique
            if (!companyInfo.name) {
                showToast("Le nom de l'entreprise est requis", "error");
                return;
            }
            
            try {
                localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
                
                // Mettre à jour le titre si c'est le nom de l'entreprise
                if (companyInfo.name !== 'ETTIJARA ALAAMA SOUSS') {
                    document.title = `${companyInfo.name} - Paramètres`;
                    document.querySelector('.logo h1').textContent = `${companyInfo.name} - PARAMÈTRES`;
                }
                
                // Sauvegarder dans Firebase si connecté
                if (database && isConnected) {
                    saveCompanyInfoToFirebase(companyInfo);
                }
                
                showToast("✅ Informations de l'entreprise enregistrées", "success");
                
            } catch (error) {
                console.error("❌ Erreur sauvegarde informations entreprise:", error);
                showToast("Erreur lors de l'enregistrement", "error");
            }
        }
        
        async function saveCompanyInfoToFirebase(companyInfo) {
            if (!database || !isConnected) return;
            
            try {
                await database.ref('systemConfig/company').set(companyInfo);
                console.log("✅ Informations entreprise sauvegardées dans Firebase");
            } catch (error) {
                console.error("❌ Erreur sauvegarde Firebase:", error);
            }
        }
        
        // ==================== FIREBASE ====================
        
        function initializeFirebase() {
            try {
                console.log("🔧 Tentative de connexion à Firebase...");
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log("✅ Firebase initialisé avec succès");
                }
                
                database = firebase.database();
                
                // Surveiller la connexion
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    const connected = snap.val() === true;
                    updateConnectionStatus(connected);
                    
                    if (connected) {
                        console.log("✅ Connecté à Firebase");
                        // Charger la configuration depuis Firebase
                        loadLogoConfigFromFirebase();
                        loadCompanyInfoFromFirebase();
                    } else {
                        console.log("❌ Déconnecté de Firebase");
                    }
                });
                
            } catch (error) {
                console.error("❌ Erreur d'initialisation Firebase:", error);
                updateConnectionStatus(false);
                showToast("Erreur de connexion Firebase", "error");
            }
        }
        
        async function loadCompanyInfoFromFirebase() {
            if (!database || !isConnected) return;
            
            try {
                const snapshot = await database.ref('systemConfig/company').once('value');
                if (snapshot.exists()) {
                    const companyInfo = snapshot.val();
                    localStorage.setItem('companyInfo', JSON.stringify(companyInfo));
                    loadCompanyInfo(); // Recharger dans le formulaire
                }
            } catch (error) {
                console.error("❌ Erreur chargement infos entreprise Firebase:", error);
            }
        }
        
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            
            if (connected) {
                statusElement.className = "status-dot connected";
                statusElement.title = "Connecté à Firebase";
            } else {
                statusElement.className = "status-dot disconnected";
                statusElement.title = "Déconnecté de Firebase";
            }
        }
        
        // ==================== GESTION DES DONNÉES ====================
        
        async function loadDatabaseStats() {
            if (!database) {
                showToast("Base de données non connectée", "error");
                return;
            }
            
            try {
                // Charger le nombre d'éléments pour chaque table
                const tables = ['clients', 'products', 'deliveries', 'suppliers', 'depots', 'categories', 'stockMovements', 'payments'];
                
                const promises = tables.map(async (table) => {
                    try {
                        const snapshot = await database.ref(table).once('value');
                        const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                        dbStats[table] = count;
                        return { table, count };
                    } catch (error) {
                        console.error(`❌ Erreur chargement ${table}:`, error);
                        return { table, count: 0 };
                    }
                });
                
                const results = await Promise.all(promises);
                
                // Mettre à jour l'interface
                results.forEach(result => {
                    const element = document.getElementById(`${result.table}Count`);
                    if (element) {
                        element.textContent = result.count;
                    }
                });
                
                console.log("📊 Statistiques chargées:", dbStats);
                
            } catch (error) {
                console.error("❌ Erreur chargement statistiques:", error);
                showToast("Erreur chargement statistiques", "error");
            }
        }
        
        function refreshDatabaseStats() {
            showToast("Actualisation des statistiques...", "info");
            loadDatabaseStats();
        }
        
        function syncData() {
            showToast("Synchronisation en cours...", "info");
            // Ici, vous pourriez ajouter une logique de synchronisation
            setTimeout(() => {
                showToast("Données synchronisées avec succès", "success");
                loadDatabaseStats();
            }, 1000);
        }
        
        // ==================== SUPPRESSION DES DONNÉES ====================
        
        function confirmDeleteAllData() {
            if (!database) {
                showToast("Base de données non connectée", "error");
                return;
            }
            
            const confirmationText = document.getElementById('confirmationText');
            if (!confirmationText || confirmationText.value !== 'SUPPRIMER') {
                showToast("Veuillez taper 'SUPPRIMER' pour confirmer", "error");
                return;
            }
            
            // Créer le résumé de suppression
            const summary = document.getElementById('deleteSummary');
            if (summary) {
                summary.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div><i class="fas fa-users" style="color: var(--danger);"></i> ${dbStats.clients} clients</div>
                        <div><i class="fas fa-box" style="color: var(--danger);"></i> ${dbStats.products} produits</div>
                        <div><i class="fas fa-shopping-cart" style="color: var(--danger);"></i> ${dbStats.deliveries} ventes</div>
                        <div><i class="fas fa-truck-loading" style="color: var(--danger);"></i> ${dbStats.suppliers} fournisseurs</div>
                        <div><i class="fas fa-exchange-alt" style="color: var(--danger);"></i> ${dbStats.stockMovements} mouvements</div>
                        <div><i class="fas fa-money-bill-wave" style="color: var(--danger);"></i> ${dbStats.payments} paiements</div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(198, 40, 40, 0.3);">
                        <div style="display: flex; align-items: center; gap: 5px; color: var(--success);">
                            <i class="fas fa-check-circle"></i>
                            Données conservées : ${dbStats.depots} dépôts et ${dbStats.categories} catégories
                        </div>
                    </div>
                `;
            }
            
            // Ouvrir le modal de confirmation
            document.getElementById('confirmDeleteModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmDeleteModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        async function deleteAllData() {
            if (!database) {
                showToast("Base de données non connectée", "error");
                closeConfirmModal();
                return;
            }
            
            // Désactiver le bouton pour éviter les doubles clics
            const deleteBtn = document.getElementById('finalDeleteBtn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Suppression en cours...';
            }
            
            showToast("Suppression des données en cours...", "info");
            
            try {
                // Liste des tables à supprimer (sauf depots et categories)
                const tablesToDelete = ['clients', 'products', 'deliveries', 'suppliers', 'stockMovements', 'payments'];
                
                // Supprimer chaque table
                const deletePromises = tablesToDelete.map(async (table) => {
                    try {
                        await database.ref(table).remove();
                        console.log(`✅ Table ${table} supprimée`);
                        return true;
                    } catch (error) {
                        console.error(`❌ Erreur suppression ${table}:`, error);
                        return false;
                    }
                });
                
                const results = await Promise.all(deletePromises);
                const successfulDeletions = results.filter(r => r).length;
                
                // Réinitialiser les compteurs de stock dans les dépôts
                const depotsSnapshot = await database.ref('depots').once('value');
                if (depotsSnapshot.exists()) {
                    const depots = depotsSnapshot.val();
                    const depotIds = Object.keys(depots);
                    
                    // Réinitialiser le stock de chaque produit dans chaque dépôt
                    const stockUpdates = {};
                    const productsSnapshot = await database.ref('products').once('value');
                    if (productsSnapshot.exists()) {
                        const products = productsSnapshot.val();
                        Object.keys(products).forEach(productId => {
                            depotIds.forEach(depotId => {
                                stockUpdates[`products/${productId}/stockByDepot/${depotId}`] = 0;
                            });
                            stockUpdates[`products/${productId}/totalStock`] = 0;
                            stockUpdates[`products/${productId}/updatedAt`] = new Date().toISOString();
                        });
                        
                        await database.ref().update(stockUpdates);
                        console.log("✅ Stock réinitialisé dans tous les dépôts");
                    }
                }
                
                closeConfirmModal();
                
                if (successfulDeletions === tablesToDelete.length) {
                    showToast("✅ Toutes les données ont été supprimées avec succès !", "success");
                    
                    // Réinitialiser le champ de confirmation
                    const confirmationText = document.getElementById('confirmationText');
                    if (confirmationText) {
                        confirmationText.value = '';
                    }
                    
                    // Réactiver le bouton
                    if (deleteBtn) {
                        setTimeout(() => {
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Confirmer la suppression';
                        }, 1000);
                    }
                    
                    // Actualiser les statistiques
                    setTimeout(() => {
                        loadDatabaseStats();
                    }, 2000);
                    
                } else {
                    showToast("Certaines données n'ont pas pu être supprimées", "warning");
                }
                
            } catch (error) {
                console.error("❌ Erreur lors de la suppression des données:", error);
                showToast("Erreur lors de la suppression: " + error.message, "error");
                closeConfirmModal();
            }
        }
        
        // ==================== SAUVEGARDE ET RESTAURATION ====================
        
        async function createBackup() {
            if (!database) {
                showToast("Base de données non connectée", "error");
                return;
            }
            
            showToast("Création de la sauvegarde...", "info");
            
            try {
                // Récupérer toutes les données
                const tables = ['clients', 'products', 'deliveries', 'suppliers', 'depots', 'categories', 'stockMovements', 'payments'];
                const backupData = {};
                
                const promises = tables.map(async (table) => {
                    try {
                        const snapshot = await database.ref(table).once('value');
                        backupData[table] = snapshot.exists() ? snapshot.val() : {};
                        return true;
                    } catch (error) {
                        console.error(`❌ Erreur sauvegarde ${table}:`, error);
                        return false;
                    }
                });
                
                await Promise.all(promises);
                
                // Ajouter des métadonnées
                backupData.metadata = {
                    version: "1.0.0",
                    date: new Date().toISOString(),
                    system: "ETTIJARA ALAAMA SOUSS",
                    tables: tables.length,
                    totalRecords: Object.values(backupData).reduce((sum, table) => sum + Object.keys(table).length, 0)
                };
                
                // Créer et télécharger le fichier
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const date = new Date();
                const filename = `backup_ettijara_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}.json`;
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = filename;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
                
                showToast(`Sauvegarde créée et téléchargée (${filename})`, "success");
                
            } catch (error) {
                console.error("❌ Erreur création sauvegarde:", error);
                showToast("Erreur création sauvegarde: " + error.message, "error");
            }
        }
        
        function scheduleAutoBackup() {
            showToast("Fonctionnalité en cours de développement", "info");
            // Implémenter la planification des sauvegardes automatiques
        }
        
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            if (!fileInput.files.length) {
                showToast("Veuillez sélectionner un fichier de sauvegarde", "error");
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.metadata) {
                        showToast("Fichier de sauvegarde invalide", "error");
                        return;
                    }
                    
                    const confirmRestore = confirm(
                        `Restaurer la sauvegarde du ${new Date(backupData.metadata.date).toLocaleDateString('fr-FR')} ?\n\n` +
                        `Cette opération écrasera les données actuelles.\n` +
                        `Tables: ${backupData.metadata.tables}\n` +
                        `Enregistrements: ${backupData.metadata.totalRecords}`
                    );
                    
                    if (!confirmRestore) return;
                    
                    showToast("Restauration en cours...", "info");
                    
                    // Restaurer chaque table
                    const tables = Object.keys(backupData).filter(key => key !== 'metadata');
                    let restoredCount = 0;
                    
                    for (const table of tables) {
                        try {
                            await database.ref(table).set(backupData[table]);
                            restoredCount++;
                            console.log(`✅ Table ${table} restaurée`);
                        } catch (error) {
                            console.error(`❌ Erreur restauration ${table}:`, error);
                        }
                    }
                    
                    showToast(`${restoredCount}/${tables.length} tables restaurées avec succès`, "success");
                    
                    // Actualiser les statistiques
                    setTimeout(() => {
                        loadDatabaseStats();
                    }, 2000);
                    
                } catch (error) {
                    console.error("❌ Erreur restauration:", error);
                    showToast("Erreur restauration: " + error.message, "error");
                }
            };
            
            reader.onerror = function() {
                showToast("Erreur lecture du fichier", "error");
            };
            
            reader.readAsText(file);
        }
        
        // ==================== GESTION DES UTILISATEURS ====================
        
        function addNewUser() {
            // Implémenter l'ajout d'utilisateur
            showToast("Fonctionnalité en cours de développement", "info");
        }
        
        function changePassword() {
            // Implémenter le changement de mot de passe
            showToast("Fonctionnalité en cours de développement", "info");
        }
        
        // ==================== PARAMÈTRES GÉNÉRAUX ====================
        
        function saveGeneralSettings() {
            const language = document.getElementById('languageSelect').value;
            const currency = document.getElementById('currencySelect').value;
            
            localStorage.setItem('language', language);
            localStorage.setItem('currency', currency);
            
            showToast("Préférences enregistrées avec succès", "success");
        }
        
        function applyAppearanceSettings() {
            const theme = document.getElementById('themeSelect').value;
            const fontSize = document.getElementById('fontSizeSelect').value;
            
            // Appliquer le thème
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                localStorage.setItem('theme', 'auto');
            } else {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            }
            
            // Appliquer la taille de police
            document.body.style.fontSize = fontSize === 'small' ? '14px' : fontSize === 'large' ? '18px' : '16px';
            localStorage.setItem('fontSize', fontSize);
            
            showToast("Apparence appliquée avec succès", "success");
        }
        
        // ==================== UTILITAIRES ====================
        
        function showToast(message, type = "success") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
