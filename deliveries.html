<!DOCTYPE html>
<html lang="fr" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETTIJARA ALAAMA SOUSS - Gestion des Livraisons</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #0d47a1;
            --accent: #1565c0;
            --light: #e3f2fd;
            --bg: #f5f7fa;
            --success: #2e7d32;
            --warning: #f57c00;
            --danger: #c62828;
            --info: #0288d1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg); direction: rtl; color: #333; }

        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 30px; 
            position: fixed; 
            width: 100%; 
            top: 0; 
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo i { font-size: 28px; }
        .logo h1 { font-size: 22px; font-weight: 700; }
        .logo span { color: #bbdefb; font-size: 14px; margin-top: 3px; }
        
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 70px;
            width: 250px;
            height: calc(100vh - 70px);
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
            padding: 20px 0;
            overflow-y: auto;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: #555;
            text-decoration: none;
            transition: all 0.3s;
            border-right: 3px solid transparent;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background: var(--light);
            color: var(--primary);
            border-right-color: var(--primary);
        }
        .sidebar-item i { width: 20px; }
        
        /* Main Content */
        .main-content { 
            margin-right: 250px; 
            padding: 90px 30px 30px; 
            min-height: calc(100vh - 70px);
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .page-header h2 {
            font-size: 28px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page-header .actions {
            display: flex;
            gap: 15px;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover {
            background-color: var(--light);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .stat-icon.pending { background-color: #fff3e0; color: var(--warning); }
        .stat-icon.in-progress { background-color: #e3f2fd; color: var(--info); }
        .stat-icon.delivered { background-color: #e8f5e8; color: var(--success); }
        .stat-icon.cancelled { background-color: #ffebee; color: var(--danger); }
        .stat-icon.total { background-color: #f3e5f5; color: #7b1fa2; }
        .stat-details h3 { font-size: 12px; color: #666; margin-bottom: 5px; }
        .stat-details .value { font-size: 24px; font-weight: 700; }
        .stat-details .change { font-size: 12px; }
        .stat-details .change.positive { color: var(--success); }
        .stat-details .change.negative { color: var(--danger); }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        /* Search and Filter */
        .search-filter {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        .filter-select {
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            min-width: 150px;
        }
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .date-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Deliveries Table */
        .deliveries-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        .table-responsive {
            overflow-x: auto;
        }
        .deliveries-table {
            width: 100%;
            border-collapse: collapse;
        }
        .deliveries-table th {
            background-color: var(--light);
            color: var(--primary);
            padding: 15px;
            text-align: right;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        .deliveries-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .deliveries-table tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .status-pending { background-color: #fff3e0; color: var(--warning); }
        .status-processing { background-color: #e3f2fd; color: var(--info); }
        .status-in-transit { background-color: #e1f5fe; color: var(--primary); }
        .status-delivered { background-color: #e8f5e8; color: var(--success); }
        .status-cancelled { background-color: #ffebee; color: var(--danger); }
        .status-returned { background-color: #f3e5f5; color: #7b1fa2; }
        
        /* Priority Badges */
        .priority-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .priority-high { background-color: #ffebee; color: var(--danger); }
        .priority-medium { background-color: #fff3e0; color: var(--warning); }
        .priority-low { background-color: #e8f5e8; color: var(--success); }
        
        /* Client Info */
        .client-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .client-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
        }
        
        /* Delivery Info */
        .delivery-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .delivery-route {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        .delivery-route i {
            color: var(--primary);
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 5px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-btn.view { background-color: #e8f5e8; color: var(--success); }
        .action-btn.edit { background-color: #e3f2fd; color: var(--primary); }
        .action-btn.delete { background-color: #ffebee; color: var(--danger); }
        .action-btn.track { background-color: #fff3e0; color: var(--warning); }
        .action-btn.print { background-color: #f3e5f5; color: #7b1fa2; }
        .action-btn:hover { opacity: 0.8; }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 5px;
        }
        .pagination-btn {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .pagination-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .pagination-btn:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            color: var(--primary);
            font-size: 20px;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        .modal-body {
            padding: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Delivery Details */
        .delivery-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .detail-card {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
        }
        .detail-card h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 16px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
        }
        .detail-item:last-child {
            border-bottom: none;
        }
        .detail-label {
            color: #666;
        }
        .detail-value {
            font-weight: 600;
            color: #333;
        }
        
        /* Items Table in Modal */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .items-table th {
            background-color: #f5f5f5;
            padding: 10px;
            text-align: right;
            font-weight: 600;
            color: #555;
        }
        .items-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        .timeline::before {
            content: '';
            position: absolute;
            right: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ddd;
        }
        .timeline-item {
            position: relative;
            padding-right: 50px;
            margin-bottom: 20px;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            right: 16px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--primary);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }
        .timeline-item.completed::before {
            background-color: var(--success);
            box-shadow: 0 0 0 2px var(--success);
        }
        .timeline-item.current::before {
            background-color: var(--warning);
            box-shadow: 0 0 0 2px var(--warning);
        }
        .timeline-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .timeline-content {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading i {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #555;
        }
        
        /* Notification Toast */
        .toast {
            position: fixed;
            top: 100px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { border-right: 4px solid var(--success); }
        .toast.error { border-right: 4px solid var(--danger); }
        .toast.info { border-right: 4px solid var(--primary); }
        .toast.warning { border-right: 4px solid var(--warning); }
        
        /* Map Container */
        .map-container {
            height: 300px;
            background: #f5f5f5;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .sidebar { width: 70px; }
            .sidebar-item span { display: none; }
            .main-content { margin-right: 70px; }
            .search-box { min-width: 100%; }
            .date-filter { flex-direction: column; }
            .form-row { flex-direction: column; }
        }
        @media (max-width: 768px) {
            .page-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .deliveries-table th, .deliveries-table td { padding: 10px; }
            .action-buttons { flex-direction: column; }
            .action-btn { width: 100%; }
            .stats-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <i class="fas fa-truck"></i>
            <div>
                <h1>ETTIJARA ALAAMA SOUSS</h1>
                <span>Système de Gestion des Livraisons</span>
            </div>
        </div>
        <div class="user-info">
            <span>Admin User</span>
            <img src="https://ui-avatars.com/api/?name=Admin+User&background=0D47A1&color=fff" alt="User">
        </div>
    </header>

    <nav class="sidebar">
        <a href="dashboard.html" class="sidebar-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>Tableau de Bord</span>
        </a>
        <a href="deliveries.html" class="sidebar-item active">
            <i class="fas fa-truck"></i>
            <span>Livraisons</span>
        </a>
        <a href="clients.html" class="sidebar-item">
            <i class="fas fa-users"></i>
            <span>Clients</span>
        </a>
        <a href="products.html" class="sidebar-item">
            <i class="fas fa-boxes"></i>
            <span>Produits</span>
        </a>
        <a href="depots.html" class="sidebar-item">
            <i class="fas fa-warehouse"></i>
            <span>Dépôts</span>
        </a>
        <a href="reports.html" class="sidebar-item">
            <i class="fas fa-chart-bar"></i>
            <span>Rapports</span>
        </a>
        <a href="print.html" class="sidebar-item">
            <i class="fas fa-print"></i>
            <span>Impression</span>
        </a>
        <a href="settings.html" class="sidebar-item">
            <i class="fas fa-cog"></i>
            <span>Paramètres</span>
        </a>
        <div style="padding: 20px 25px; margin-top: 30px; border-top: 1px solid #eee;">
            <a href="index.html" class="sidebar-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-truck"></i> Gestion des Livraisons</h2>
            <div class="actions">
                <button class="btn btn-outline" id="exportBtn">
                    <i class="fas fa-download"></i> Exporter
                </button>
                <button class="btn btn-primary" id="addDeliveryBtn">
                    <i class="fas fa-plus"></i> Nouvelle Livraison
                </button>
            </div>
        </div>
        
        <div class="stats-cards">
            <div class="stat-card" onclick="filterByStatus('pending')">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-details">
                    <h3>EN ATTENTE</h3>
                    <div class="value" id="pendingCount">0</div>
                    <div class="change positive" id="pendingChange">+0%</div>
                </div>
            </div>
            <div class="stat-card" onclick="filterByStatus('processing')">
                <div class="stat-icon in-progress">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-details">
                    <h3>EN TRAITEMENT</h3>
                    <div class="value" id="processingCount">0</div>
                    <div class="change positive" id="processingChange">+0%</div>
                </div>
            </div>
            <div class="stat-card" onclick="filterByStatus('in-transit')">
                <div class="stat-icon in-progress">
                    <i class="fas fa-shipping-fast"></i>
                </div>
                <div class="stat-details">
                    <h3>EN TRANSIT</h3>
                    <div class="value" id="transitCount">0</div>
                    <div class="change positive" id="transitChange">+0%</div>
                </div>
            </div>
            <div class="stat-card" onclick="filterByStatus('delivered')">
                <div class="stat-icon delivered">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-details">
                    <h3>LIVRÉES</h3>
                    <div class="value" id="deliveredCount">0</div>
                    <div class="change positive" id="deliveredChange">+0%</div>
                </div>
            </div>
            <div class="stat-card" onclick="filterByStatus('all')">
                <div class="stat-icon total">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="stat-details">
                    <h3>TOTAL LIVRAISONS</h3>
                    <div class="value" id="totalCount">0</div>
                    <div class="change positive" id="totalChange">+0%</div>
                </div>
            </div>
        </div>
        
        <div class="quick-actions">
            <button class="btn btn-outline btn-sm" onclick="assignDeliveries()">
                <i class="fas fa-user-check"></i> Assigner au Livreur
            </button>
            <button class="btn btn-outline btn-sm" onclick="updateStatusBulk()">
                <i class="fas fa-sync-alt"></i> Mettre à jour Statut
            </button>
            <button class="btn btn-outline btn-sm" onclick="printDeliveryNotes()">
                <i class="fas fa-print"></i> Imprimer Bordereaux
            </button>
            <button class="btn btn-outline btn-sm" onclick="showTodayDeliveries()">
                <i class="fas fa-calendar-day"></i> Livraisons du Jour
            </button>
            <button class="btn btn-outline btn-sm" onclick="showDelayedDeliveries()">
                <i class="fas fa-exclamation-triangle"></i> Retardées
            </button>
        </div>
        
        <div class="search-filter">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Rechercher par numéro, client, adresse...">
            </div>
            <select class="filter-select" id="statusFilter">
                <option value="all">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="processing">En traitement</option>
                <option value="in-transit">En transit</option>
                <option value="delivered">Livrée</option>
                <option value="cancelled">Annulée</option>
                <option value="returned">Retournée</option>
            </select>
            <select class="filter-select" id="driverFilter">
                <option value="all">Tous les livreurs</option>
                <!-- Dynamically populated -->
            </select>
            <div class="date-filter">
                <input type="date" id="dateFrom" class="date-input">
                <span>à</span>
                <input type="date" id="dateTo" class="date-input">
            </div>
            <button class="btn btn-outline" id="resetFiltersBtn">
                <i class="fas fa-redo"></i> Réinitialiser
            </button>
        </div>
        
        <div class="deliveries-container">
            <div class="table-responsive">
                <table class="deliveries-table">
                    <thead>
                        <tr>
                            <th>NUMÉRO</th>
                            <th>CLIENT</th>
                            <th>ADRESSE</th>
                            <th>LIVREUR</th>
                            <th>DATE</th>
                            <th>MONTANT</th>
                            <th>STATUT</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="deliveriesTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <div>Chargement des livraisons...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination will be generated here -->
            </div>
        </div>
    </main>
    
    <!-- Modal Ajouter/Modifier Livraison -->
    <div class="modal" id="deliveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nouvelle Livraison</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="deliveryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientSelect">Client *</label>
                            <select id="clientSelect" class="form-control" required>
                                <option value="">Sélectionner un client</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate">Date de Livraison *</label>
                            <input type="datetime-local" id="deliveryDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="depotSelect">Dépôt de départ *</label>
                            <select id="depotSelect" class="form-control" required>
                                <option value="">Sélectionner un dépôt</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="driverSelect">Livreur</label>
                            <select id="driverSelect" class="form-control">
                                <option value="">Non assigné</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="deliveryAddress">Adresse de Livraison *</label>
                        <textarea id="deliveryAddress" class="form-control" rows="2" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientPhone">Téléphone Client *</label>
                            <input type="tel" id="clientPhone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="clientEmail">Email Client</label>
                            <input type="email" id="clientEmail" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="priority">Priorité</label>
                            <select id="priority" class="form-control">
                                <option value="low">Basse</option>
                                <option value="medium" selected>Moyenne</option>
                                <option value="high">Haute</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryStatus">Statut</label>
                            <select id="deliveryStatus" class="form-control">
                                <option value="pending">En attente</option>
                                <option value="processing">En traitement</option>
                                <option value="in-transit">En transit</option>
                                <option value="delivered">Livrée</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Articles à Livrer</label>
                        <div class="items-container" id="itemsContainer">
                            <!-- Items will be added here -->
                            <div class="form-row item-row">
                                <div class="form-group" style="flex: 2;">
                                    <select class="form-control product-select">
                                        <option value="">Sélectionner produit</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <input type="number" class="form-control quantity" placeholder="Quantité" min="1" value="1">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <input type="number" class="form-control price" placeholder="Prix unitaire" step="0.01">
                                </div>
                                <div class="form-group" style="flex: 1; display: flex; align-items: center;">
                                    <button type="button" class="btn btn-outline btn-sm" onclick="removeItem(this)">×</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addItem()" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Ajouter un article
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" class="form-control" rows="3" placeholder="Notes internes ou instructions spéciales..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalAmount">Montant Total</label>
                            <input type="number" id="totalAmount" class="form-control" step="0.01" readonly>
                        </div>
                        <div class="form-group">
                            <label for="paymentStatus">Statut Paiement</label>
                            <select id="paymentStatus" class="form-control">
                                <option value="pending">En attente</option>
                                <option value="partial">Partiel</option>
                                <option value="paid">Payé</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="deliveryId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelBtn">Annuler</button>
                <button class="btn btn-primary" id="saveDeliveryBtn">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Détails Livraison -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Détails de la Livraison</h3>
                <button class="close-modal" id="closeDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="deliveryDetails">
                    <!-- Delivery details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="printDetailBtn">
                    <i class="fas fa-print"></i> Imprimer
                </button>
                <button class="btn btn-primary" id="editDeliveryBtn">
                    <i class="fas fa-edit"></i> Modifier
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Suivi Livraison -->
    <div class="modal" id="trackModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> Suivi de Livraison</h3>
                <button class="close-modal" id="closeTrackModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="delivery-info">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Numéro:</label>
                            <div class="form-control" style="background: #f5f5f5;" id="trackDeliveryNumber">--</div>
                        </div>
                        <div class="form-group">
                            <label>Statut:</label>
                            <div class="form-control" style="background: #f5f5f5;" id="trackDeliveryStatus">--</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Adresse:</label>
                        <div class="form-control" style="background: #f5f5f5;" id="trackDeliveryAddress">--</div>
                    </div>
                    
                    <div class="map-container">
                        <i class="fas fa-map-marked-alt" style="font-size: 48px; color: #ccc;"></i>
                        <div style="text-align: center; margin-left: 15px;">
                            <h4>Carte de suivi</h4>
                            <p>Position actuelle du livreur</p>
                        </div>
                    </div>
                    
                    <div class="timeline">
                        <h4 style="margin-bottom: 15px; color: var(--primary);">Historique du trajet</h4>
                        <div class="timeline-item completed">
                            <div class="timeline-date">Aujourd'hui, 08:30</div>
                            <div class="timeline-content">
                                <strong>Commande préparée</strong>
                                <p>Préparation terminée au dépôt principal</p>
                            </div>
                        </div>
                        <div class="timeline-item current">
                            <div class="timeline-date">Aujourd'hui, 09:45</div>
                            <div class="timeline-content">
                                <strong>En route vers le client</strong>
                                <p>Le livreur a quitté le dépôt</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-date">Estimation: 10:30</div>
                            <div class="timeline-content">
                                <strong>Arrivée prévue</strong>
                                <p>Livraison estimée dans 45 minutes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="closeTrackBtn">Fermer</button>
                <button class="btn btn-primary" id="refreshTrackBtn">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Assignation Livreur -->
    <div class="modal" id="assignModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-check"></i> Assigner au Livreur</h3>
                <button class="close-modal" id="closeAssignModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assignForm">
                    <div class="form-group">
                        <label for="assignDelivery">Livraison à assigner</label>
                        <select id="assignDelivery" class="form-control" required>
                            <option value="">Sélectionner une livraison</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignDriver">Livreur *</label>
                        <select id="assignDriver" class="form-control" required>
                            <option value="">Sélectionner un livreur</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignNotes">Instructions pour le livreur</label>
                        <textarea id="assignNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="assignVehicle">Véhicule</label>
                        <select id="assignVehicle" class="form-control">
                            <option value="">Sélectionner un véhicule</option>
                            <option value="van">Camionnette</option>
                            <option value="truck">Camion</option>
                            <option value="motorcycle">Moto</option>
                            <option value="car">Voiture</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelAssignBtn">Annuler</button>
                <button class="btn btn-primary" id="saveAssignBtn">Assigner</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Confirmation -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirmation</h3>
                <button class="close-modal" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Êtes-vous sûr de vouloir effectuer cette action ?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelConfirmBtn">Annuler</button>
                <button class="btn btn-danger" id="confirmActionBtn">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAV_c5Gt_f1h5nZF47FcPjW_h4P24LYADk",
            authDomain: "commerce22-610cc.firebaseapp.com",
            databaseURL: "https://commerce22-610cc-default-rtdb.firebaseio.com",
            projectId: "commerce22-610cc",
            storageBucket: "commerce22-610cc.firebasestorage.app",
            messagingSenderId: "458158894252",
            appId: "1:458158894252:web:d1e640b2e16ef32d978309"
        };
        
        // Initialiser Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialisé avec succès");
        } catch (error) {
            console.error("Erreur d'initialisation Firebase:", error);
            showToast("Erreur de connexion à la base de données", "error");
        }
        
        const database = firebase.database();
        
        // Variables globales
        let deliveries = [];
        let clients = [];
        let drivers = [];
        let depots = [];
        let products = [];
        let currentPage = 1;
        const deliveriesPerPage = 10;
        let filteredDeliveries = [];
        let selectedDeliveryId = null;
        let isEditMode = false;
        let currentAction = null;
        let actionData = null;
        
        // Fonction pour afficher une notification
        function showToast(message, type = "info") {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 
                  type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Charger les données initiales
        function loadInitialData() {
            loadDeliveries();
            loadClients();
            loadDrivers();
            loadDepots();
            loadProducts();
        }
        
        // Charger les livraisons
        function loadDeliveries() {
            try {
                const deliveriesRef = database.ref('deliveries');
                
                deliveriesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    deliveries = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            deliveries.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        // Trier par date (plus récent en premier)
                        deliveries.sort((a, b) => new Date(b.createdAt || b.deliveryDate) - new Date(a.createdAt || a.deliveryDate));
                        
                        // Mettre à jour les statistiques
                        updateStats();
                        
                        // Appliquer les filtres
                        applyFilters();
                        
                        // Mettre à jour l'affichage
                        displayDeliveries();
                        
                        // Mettre à jour le sélecteur d'assignation
                        updateAssignDeliverySelector();
                    } else {
                        showEmptyState();
                    }
                    
                }, (error) => {
                    console.error("Erreur de chargement des livraisons:", error);
                    showToast("Erreur de chargement des livraisons", "error");
                });
                
            } catch (error) {
                console.error("Erreur dans loadDeliveries:", error);
            }
        }
        
        // Charger les clients
        function loadClients() {
            try {
                const clientsRef = database.ref('clients');
                
                clientsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    clients = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            clients.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        // Mettre à jour le sélecteur de clients
                        updateClientSelector();
                    }
                    
                }, (error) => {
                    console.error("Erreur de chargement des clients:", error);
                });
                
            } catch (error) {
                console.error("Erreur dans loadClients:", error);
            }
        }
        
        // Charger les livreurs
        function loadDrivers() {
            try {
                const driversRef = database.ref('drivers');
                
                driversRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    drivers = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            drivers.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        // Mettre à jour le sélecteur de livreurs
                        updateDriverSelectors();
                    }
                    
                }, (error) => {
                    console.error("Erreur de chargement des livreurs:", error);
                });
                
            } catch (error) {
                console.error("Erreur dans loadDrivers:", error);
            }
        }
        
        // Charger les dépôts
        function loadDepots() {
            try {
                const depotsRef = database.ref('depots');
                
                depotsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    depots = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            depots.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        // Mettre à jour le sélecteur de dépôts
                        updateDepotSelector();
                    }
                    
                }, (error) => {
                    console.error("Erreur de chargement des dépôts:", error);
                });
                
            } catch (error) {
                console.error("Erreur dans loadDepots:", error);
            }
        }
        
        // Charger les produits
        function loadProducts() {
            try {
                const productsRef = database.ref('products');
                
                productsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    products = [];
                    
                    if (data) {
                        Object.keys(data).forEach(key => {
                            products.push({
                                id: key,
                                ...data[key]
                            });
                        });
                        
                        // Mettre à jour le sélecteur de produits
                        updateProductSelectors();
                    }
                    
                }, (error) => {
                    console.error("Erreur de chargement des produits:", error);
                });
                
            } catch (error) {
                console.error("Erreur dans loadProducts:", error);
            }
        }
        
        // Mettre à jour les sélecteurs
        function updateClientSelector() {
            const clientSelect = document.getElementById('clientSelect');
            let options = '<option value="">Sélectionner un client</option>';
            
            clients.forEach(client => {
                options += `<option value="${client.id}">${client.name} - ${client.phone || ''}</option>`;
            });
            
            clientSelect.innerHTML = options;
        }
        
        function updateDriverSelectors() {
            const driverSelect = document.getElementById('driverSelect');
            const assignDriver = document.getElementById('assignDriver');
            const driverFilter = document.getElementById('driverFilter');
            
            let options = '<option value="">Non assigné</option>';
            let filterOptions = '<option value="all">Tous les livreurs</option>';
            let assignOptions = '<option value="">Sélectionner un livreur</option>';
            
            drivers.forEach(driver => {
                options += `<option value="${driver.id}">${driver.name} - ${driver.vehicle || ''}</option>`;
                filterOptions += `<option value="${driver.id}">${driver.name}</option>`;
                assignOptions += `<option value="${driver.id}">${driver.name} (${driver.vehicle || 'Sans véhicule'})</option>`;
            });
            
            driverSelect.innerHTML = options;
            driverFilter.innerHTML = filterOptions;
            assignDriver.innerHTML = assignOptions;
        }
        
        function updateDepotSelector() {
            const depotSelect = document.getElementById('depotSelect');
            let options = '<option value="">Sélectionner un dépôt</option>';
            
            depots.forEach(depot => {
                options += `<option value="${depot.id}">${depot.name} - ${depot.city}</option>`;
            });
            
            depotSelect.innerHTML = options;
        }
        
        function updateProductSelectors() {
            const productSelects = document.querySelectorAll('.product-select');
            
            productSelects.forEach(select => {
                let options = '<option value="">Sélectionner produit</option>';
                
                products.forEach(product => {
                    options += `<option value="${product.id}" data-price="${product.salePrice || product.price || 0}">
                        ${product.name} (${product.code}) - ${(product.salePrice || product.price || 0).toFixed(2)} DH
                    </option>`;
                });
                
                select.innerHTML = options;
            });
        }
        
        function updateAssignDeliverySelector() {
            const assignDelivery = document.getElementById('assignDelivery');
            let options = '<option value="">Sélectionner une livraison</option>';
            
            // Afficher seulement les livraisons non assignées ou en attente
            const pendingDeliveries = deliveries.filter(d => 
                !d.driverId || d.status === 'pending' || d.status === 'processing'
            );
            
            pendingDeliveries.forEach(delivery => {
                const client = clients.find(c => c.id === delivery.clientId);
                options += `<option value="${delivery.id}">
                    ${delivery.deliveryNumber || delivery.id.substring(0, 8)} - 
                    ${client ? client.name : 'Client inconnu'}
                </option>`;
            });
            
            assignDelivery.innerHTML = options;
        }
        
        // Mettre à jour les statistiques
        function updateStats() {
            const total = deliveries.length;
            const pending = deliveries.filter(d => d.status === 'pending').length;
            const processing = deliveries.filter(d => d.status === 'processing').length;
            const inTransit = deliveries.filter(d => d.status === 'in-transit').length;
            const delivered = deliveries.filter(d => d.status === 'delivered').length;
            
            // Calculer les pourcentages
            const pendingPercent = total > 0 ? Math.round((pending / total) * 100) : 0;
            const processingPercent = total > 0 ? Math.round((processing / total) * 100) : 0;
            const transitPercent = total > 0 ? Math.round((inTransit / total) * 100) : 0;
            const deliveredPercent = total > 0 ? Math.round((delivered / total) * 100) : 0;
            
            // Mettre à jour les compteurs
            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('processingCount').textContent = processing;
            document.getElementById('transitCount').textContent = inTransit;
            document.getElementById('deliveredCount').textContent = delivered;
            
            // Mettre à jour les pourcentages
            document.getElementById('pendingChange').textContent = `${pendingPercent}%`;
            document.getElementById('processingChange').textContent = `${processingPercent}%`;
            document.getElementById('transitChange').textContent = `${transitPercent}%`;
            document.getElementById('deliveredChange').textContent = `${deliveredPercent}%`;
            document.getElementById('totalChange').textContent = '+100%';
        }
        
        // Obtenir le nom du statut
        function getStatusName(status) {
            const statusNames = {
                'pending': 'En attente',
                'processing': 'En traitement',
                'in-transit': 'En transit',
                'delivered': 'Livrée',
                'cancelled': 'Annulée',
                'returned': 'Retournée'
            };
            
            return statusNames[status] || status;
        }
        
        // Obtenir la classe CSS pour le statut
        function getStatusClass(status) {
            const statusClasses = {
                'pending': 'status-pending',
                'processing': 'status-processing',
                'in-transit': 'status-in-transit',
                'delivered': 'status-delivered',
                'cancelled': 'status-cancelled',
                'returned': 'status-returned'
            };
            
            return statusClasses[status] || 'status-pending';
        }
        
        // Obtenir l'icône du statut
        function getStatusIcon(status) {
            const statusIcons = {
                'pending': 'fas fa-clock',
                'processing': 'fas fa-cogs',
                'in-transit': 'fas fa-shipping-fast',
                'delivered': 'fas fa-check-circle',
                'cancelled': 'fas fa-times-circle',
                'returned': 'fas fa-undo'
            };
            
            return statusIcons[status] || 'fas fa-clock';
        }
        
        // Obtenir le nom du client
        function getClientName(clientId) {
            const client = clients.find(c => c.id === clientId);
            return client ? client.name : 'Client inconnu';
        }
        
        // Obtenir le nom du livreur
        function getDriverName(driverId) {
            if (!driverId) return 'Non assigné';
            const driver = drivers.find(d => d.id === driverId);
            return driver ? driver.name : 'Livreur inconnu';
        }
        
        // Obtenir le nom du dépôt
        function getDepotName(depotId) {
            const depot = depots.find(d => d.id === depotId);
            return depot ? depot.name : 'Dépôt inconnu';
        }
        
        // Obtenir le nom du produit
        function getProductName(productId) {
            const product = products.find(p => p.id === productId);
            return product ? product.name : 'Produit inconnu';
        }
        
        // Formater la date
        function formatDate(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Formater la devise
        function formatCurrency(amount) {
            if (!amount) return '0.00 DH';
            return parseFloat(amount).toFixed(2) + ' DH';
        }
        
        // Afficher les livraisons
        function displayDeliveries() {
            const tableBody = document.getElementById('deliveriesTableBody');
            
            if (filteredDeliveries.length === 0) {
                showEmptyState();
                return;
            }
            
            // Calculer les indices pour la pagination
            const startIndex = (currentPage - 1) * deliveriesPerPage;
            const endIndex = startIndex + deliveriesPerPage;
            const pageDeliveries = filteredDeliveries.slice(startIndex, endIndex);
            
            let html = '';
            
            pageDeliveries.forEach(delivery => {
                const clientName = getClientName(delivery.clientId);
                const driverName = getDriverName(delivery.driverId);
                const statusClass = getStatusClass(delivery.status);
                const statusName = getStatusName(delivery.status);
                const statusIcon = getStatusIcon(delivery.status);
                
                html += `
                    <tr>
                        <td>
                            <strong>${delivery.deliveryNumber || delivery.id.substring(0, 8)}</strong>
                            ${delivery.priority === 'high' ? '<span class="priority-badge priority-high">Haute</span>' : 
                              delivery.priority === 'medium' ? '<span class="priority-badge priority-medium">Moyenne</span>' : 
                              delivery.priority === 'low' ? '<span class="priority-badge priority-low">Basse</span>' : ''}
                        </td>
                        <td>
                            <div class="client-info">
                                <div class="client-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <strong>${clientName}</strong><br>
                                    <small>${delivery.clientPhone || ''}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="delivery-info">
                                <strong>${delivery.deliveryAddress ? delivery.deliveryAddress.substring(0, 30) + '...' : 'Non spécifiée'}</strong>
                                <div class="delivery-route">
                                    <i class="fas fa-warehouse"></i>
                                    <span>${getDepotName(delivery.depotId)}</span>
                                    <i class="fas fa-arrow-left"></i>
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Client</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <strong>${driverName}</strong>
                        </td>
                        <td>
                            <strong>${formatDate(delivery.deliveryDate)}</strong>
                        </td>
                        <td>
                            <div class="price">${formatCurrency(delivery.totalAmount)}</div>
                            <small>${delivery.paymentStatus === 'paid' ? 'Payé' : 
                                    delivery.paymentStatus === 'partial' ? 'Partiel' : 'En attente'}</small>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i class="${statusIcon}"></i>
                                ${statusName}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewDelivery('${delivery.id}')" title="Détails">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit" onclick="editDelivery('${delivery.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn track" onclick="trackDelivery('${delivery.id}')" title="Suivre">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                                <button class="action-btn print" onclick="printDelivery('${delivery.id}')" title="Imprimer">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            updatePagination();
        }
        
        // Afficher l'état vide
        function showEmptyState() {
            const tableBody = document.getElementById('deliveriesTableBody');
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <h3>Aucune livraison trouvée</h3>
                        <p>Il n'y a aucune livraison correspondant à vos critères</p>
                        <button class="btn btn-primary" onclick="openAddModal()" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Créer une livraison
                        </button>
                    </td>
                </tr>
            `;
            
            // Cacher la pagination
            document.getElementById('pagination').innerHTML = '';
        }
        
        // Appliquer les filtres
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const driverFilter = document.getElementById('driverFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            filteredDeliveries = deliveries.filter(delivery => {
                // Filtre de recherche
                const matchesSearch = !searchTerm || 
                    (delivery.deliveryNumber && delivery.deliveryNumber.toLowerCase().includes(searchTerm)) ||
                    (delivery.deliveryAddress && delivery.deliveryAddress.toLowerCase().includes(searchTerm)) ||
                    (getClientName(delivery.clientId).toLowerCase().includes(searchTerm)) ||
                    (delivery.clientPhone && delivery.clientPhone.toLowerCase().includes(searchTerm));
                
                // Filtre par statut
                const matchesStatus = statusFilter === 'all' || delivery.status === statusFilter;
                
                // Filtre par livreur
                const matchesDriver = driverFilter === 'all' || delivery.driverId === driverFilter;
                
                // Filtre par date
                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const deliveryDate = new Date(delivery.deliveryDate || delivery.createdAt);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo + 'T23:59:59') : null;
                    
                    if (fromDate && deliveryDate < fromDate) matchesDate = false;
                    if (toDate && deliveryDate > toDate) matchesDate = false;
                }
                
                return matchesSearch && matchesStatus && matchesDriver && matchesDate;
            });
            
            currentPage = 1; // Retour à la première page
        }
        
        // Mettre à jour la pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredDeliveries.length / deliveriesPerPage);
            const paginationDiv = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Bouton Précédent
            html += `
                <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                                onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span class="pagination-btn">...</span>`;
                }
            }
            
            // Bouton Suivant
            html += `
                <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            paginationDiv.innerHTML = html;
        }
        
        // Changer de page
        function changePage(page) {
            const totalPages = Math.ceil(filteredDeliveries.length / deliveriesPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayDeliveries();
        }
        
        // Filtrer par statut
        function filterByStatus(status) {
            if (status === 'all') {
                document.getElementById('statusFilter').value = 'all';
            } else {
                document.getElementById('statusFilter').value = status;
            }
            applyFilters();
            displayDeliveries();
        }
        
        // Ouvrir modal d'ajout
        function openAddModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'Nouvelle Livraison';
            document.getElementById('deliveryForm').reset();
            document.getElementById('deliveryId').value = '';
            
            // Définir la date par défaut (aujourd'hui + 1 jour)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('deliveryDate').value = tomorrow.toISOString().slice(0, 16);
            
            // Réinitialiser les articles
            const itemsContainer = document.getElementById('itemsContainer');
            itemsContainer.innerHTML = `
                <div class="form-row item-row">
                    <div class="form-group" style="flex: 2;">
                        <select class="form-control product-select" onchange="updatePrice(this)">
                            <option value="">Sélectionner produit</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="number" class="form-control quantity" placeholder="Quantité" min="1" value="1" onchange="calculateTotal()">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <input type="number" class="form-control price" placeholder="Prix unitaire" step="0.01" onchange="calculateTotal()">
                    </div>
                    <div class="form-group" style="flex: 1; display: flex; align-items: center;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="removeItem(this)">×</button>
                    </div>
                </div>
            `;
            
            // Mettre à jour les sélecteurs de produits
            updateProductSelectors();
            
            // Calculer le total initial
            calculateTotal();
            
            document.getElementById('deliveryModal').style.display = 'flex';
        }
        
        // Ajouter un article
        function addItem() {
            const itemsContainer = document.getElementById('itemsContainer');
            const itemRow = document.createElement('div');
            itemRow.className = 'form-row item-row';
            itemRow.innerHTML = `
                <div class="form-group" style="flex: 2;">
                    <select class="form-control product-select" onchange="updatePrice(this)">
                        <option value="">Sélectionner produit</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="number" class="form-control quantity" placeholder="Quantité" min="1" value="1" onchange="calculateTotal()">
                </div>
                <div class="form-group" style="flex: 1;">
                    <input type="number" class="form-control price" placeholder="Prix unitaire" step="0.01" onchange="calculateTotal()">
                </div>
                <div class="form-group" style="flex: 1; display: flex; align-items: center;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="removeItem(this)">×</button>
                </div>
            `;
            
            itemsContainer.appendChild(itemRow);
            updateProductSelectors();
        }
        
        // Supprimer un article
        function removeItem(button) {
            const itemRow = button.closest('.item-row');
            if (itemRow && document.querySelectorAll('.item-row').length > 1) {
                itemRow.remove();
                calculateTotal();
            }
        }
        
        // Mettre à jour le prix quand un produit est sélectionné
        function updatePrice(select) {
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const priceInput = select.closest('.item-row').querySelector('.price');
            
            if (price && priceInput) {
                priceInput.value = price;
                calculateTotal();
            }
        }
        
        // Calculer le total
        function calculateTotal() {
            let total = 0;
            const itemRows = document.querySelectorAll('.item-row');
            
            itemRows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                total += quantity * price;
            });
            
            document.getElementById('totalAmount').value = total.toFixed(2);
        }
        
        // Ouvrir modal d'édition
        function editDelivery(deliveryId) {
            isEditMode = true;
            selectedDeliveryId = deliveryId;
            
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;
            
            document.getElementById('modalTitle').textContent = 'Modifier Livraison';
            document.getElementById('deliveryId').value = deliveryId;
            document.getElementById('clientSelect').value = delivery.clientId || '';
            document.getElementById('deliveryDate').value = delivery.deliveryDate ? new Date(delivery.deliveryDate).toISOString().slice(0, 16) : '';
            document.getElementById('depotSelect').value = delivery.depotId || '';
            document.getElementById('driverSelect').value = delivery.driverId || '';
            document.getElementById('deliveryAddress').value = delivery.deliveryAddress || '';
            document.getElementById('clientPhone').value = delivery.clientPhone || '';
            document.getElementById('clientEmail').value = delivery.clientEmail || '';
            document.getElementById('priority').value = delivery.priority || 'medium';
            document.getElementById('deliveryStatus').value = delivery.status || 'pending';
            document.getElementById('notes').value = delivery.notes || '';
            document.getElementById('paymentStatus').value = delivery.paymentStatus || 'pending';
            document.getElementById('totalAmount').value = delivery.totalAmount || '0.00';
            
            // Charger les articles
            const itemsContainer = document.getElementById('itemsContainer');
            itemsContainer.innerHTML = '';
            
            if (delivery.items && delivery.items.length > 0) {
                delivery.items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'form-row item-row';
                    itemRow.innerHTML = `
                        <div class="form-group" style="flex: 2;">
                            <select class="form-control product-select" onchange="updatePrice(this)">
                                <option value="">Sélectionner produit</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" class="form-control quantity" placeholder="Quantité" min="1" value="${item.quantity || 1}" onchange="calculateTotal()">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" class="form-control price" placeholder="Prix unitaire" step="0.01" value="${item.price || 0}" onchange="calculateTotal()">
                        </div>
                        <div class="form-group" style="flex: 1; display: flex; align-items: center;">
                            <button type="button" class="btn btn-outline btn-sm" onclick="removeItem(this)">×</button>
                        </div>
                    `;
                    itemsContainer.appendChild(itemRow);
                    
                    // Sélectionner le produit
                    setTimeout(() => {
                        const select = itemRow.querySelector('.product-select');
                        if (select && item.productId) {
                            select.value = item.productId;
                        }
                    }, 100);
                });
            } else {
                addItem(); // Ajouter un article vide
            }
            
            // Mettre à jour les sélecteurs de produits
            updateProductSelectors();
            
            document.getElementById('deliveryModal').style.display = 'flex';
        }
        
        // Voir les détails d'une livraison
        function viewDelivery(deliveryId) {
            selectedDeliveryId = deliveryId;
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;
            
            const client = clients.find(c => c.id === delivery.clientId);
            const driver = drivers.find(d => d.id === delivery.driverId);
            const depot = depots.find(d => d.id === delivery.depotId);
            
            let itemsHtml = '';
            if (delivery.items && delivery.items.length > 0) {
                itemsHtml = `
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${delivery.items.map(item => `
                                <tr>
                                    <td>${getProductName(item.productId)}</td>
                                    <td>${item.quantity || 1}</td>
                                    <td>${formatCurrency(item.price || 0)}</td>
                                    <td>${formatCurrency((item.quantity || 1) * (item.price || 0))}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            const detailsHtml = `
                <div class="delivery-details">
                    <div class="detail-card">
                        <h4><i class="fas fa-info-circle"></i> Informations</h4>
                        <div class="detail-item">
                            <span class="detail-label">Numéro:</span>
                            <span class="detail-value">${delivery.deliveryNumber || delivery.id.substring(0, 8)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value">${formatDate(delivery.deliveryDate)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Statut:</span>
                            <span class="status-badge ${getStatusClass(delivery.status)}">
                                ${getStatusName(delivery.status)}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Priorité:</span>
                            <span class="detail-value">
                                ${delivery.priority === 'high' ? 'Haute' : 
                                  delivery.priority === 'medium' ? 'Moyenne' : 'Basse'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <h4><i class="fas fa-user"></i> Client</h4>
                        <div class="detail-item">
                            <span class="detail-label">Nom:</span>
                            <span class="detail-value">${client ? client.name : 'Non spécifié'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Téléphone:</span>
                            <span class="detail-value">${delivery.clientPhone || client?.phone || 'Non spécifié'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${delivery.clientEmail || client?.email || 'Non spécifié'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <h4><i class="fas fa-shipping-fast"></i> Livraison</h4>
                        <div class="detail-item">
                            <span class="detail-label">Adresse:</span>
                            <span class="detail-value">${delivery.deliveryAddress || 'Non spécifiée'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Dépôt:</span>
                            <span class="detail-value">${depot ? depot.name : 'Non spécifié'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Livreur:</span>
                            <span class="detail-value">${driver ? driver.name : 'Non assigné'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Véhicule:</span>
                            <span class="detail-value">${driver?.vehicle || 'Non spécifié'}</span>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <h4><i class="fas fa-money-bill-wave"></i> Paiement</h4>
                        <div class="detail-item">
                            <span class="detail-label">Montant total:</span>
                            <span class="detail-value">${formatCurrency(delivery.totalAmount)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Statut:</span>
                            <span class="detail-value">
                                ${delivery.paymentStatus === 'paid' ? 'Payé' : 
                                  delivery.paymentStatus === 'partial' ? 'Partiellement payé' : 'En attente'}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Mode:</span>
                            <span class="detail-value">${delivery.paymentMethod || 'Non spécifié'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Notes:</label>
                    <div class="form-control" style="background: #f5f5f5; min-height: 80px;">
                        ${delivery.notes || 'Aucune note'}
                    </div>
                </div>
                
                <h4 style="margin-top: 20px; color: var(--primary);">Articles</h4>
                ${itemsHtml || '<p>Aucun article</p>'}
            `;
            
            document.getElementById('deliveryDetails').innerHTML = detailsHtml;
            document.getElementById('detailModal').style.display = 'flex';
        }
        
        // Suivre une livraison
        function trackDelivery(deliveryId) {
            selectedDeliveryId = deliveryId;
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;
            
            document.getElementById('trackDeliveryNumber').textContent = 
                delivery.deliveryNumber || delivery.id.substring(0, 8);
            document.getElementById('trackDeliveryStatus').innerHTML = 
                `<span class="status-badge ${getStatusClass(delivery.status)}">
                    ${getStatusName(delivery.status)}
                </span>`;
            document.getElementById('trackDeliveryAddress').textContent = 
                delivery.deliveryAddress || 'Non spécifiée';
            
            document.getElementById('trackModal').style.display = 'flex';
        }
        
        // Imprimer une livraison
        function printDelivery(deliveryId) {
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) return;
            
            // Créer une fenêtre d'impression avec les détails
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>Bordereau de Livraison - ${delivery.deliveryNumber || delivery.id.substring(0, 8)}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #1a237e; }
                        .info-section { margin-bottom: 20px; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
                        .info-item { margin-bottom: 10px; }
                        .label { font-weight: bold; color: #555; }
                        .value { margin-right: 10px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background-color: #e3f2fd; padding: 10px; text-align: right; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        .total { text-align: left; font-size: 18px; font-weight: bold; margin-top: 20px; }
                        .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
                        .signature { margin-top: 50px; display: flex; justify-content: space-between; }
                        .signature-box { width: 200px; border-top: 1px solid #000; padding-top: 10px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ETTIJARA ALAAMA SOUSS</h1>
                        <h2>Bordereau de Livraison</h2>
                        <p>Numéro: ${delivery.deliveryNumber || delivery.id.substring(0, 8)}</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-section">
                            <h3>Informations Client</h3>
                            <div class="info-item"><span class="label">Nom:</span> <span class="value">${getClientName(delivery.clientId)}</span></div>
                            <div class="info-item"><span class="label">Téléphone:</span> <span class="value">${delivery.clientPhone || ''}</span></div>
                            <div class="info-item"><span class="label">Adresse:</span> <span class="value">${delivery.deliveryAddress || ''}</span></div>
                        </div>
                        
                        <div class="info-section">
                            <h3>Informations Livraison</h3>
                            <div class="info-item"><span class="label">Date:</span> <span class="value">${formatDate(delivery.deliveryDate)}</span></div>
                            <div class="info-item"><span class="label">Livreur:</span> <span class="value">${getDriverName(delivery.driverId)}</span></div>
                            <div class="info-item"><span class="label">Statut:</span> <span class="value">${getStatusName(delivery.status)}</span></div>
                        </div>
                    </div>
                    
                    <h3>Articles</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${delivery.items ? delivery.items.map(item => `
                                <tr>
                                    <td>${getProductName(item.productId)}</td>
                                    <td>${item.quantity || 1}</td>
                                    <td>${formatCurrency(item.price || 0)}</td>
                                    <td>${formatCurrency((item.quantity || 1) * (item.price || 0))}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4">Aucun article</td></tr>'}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        <strong>Total: ${formatCurrency(delivery.totalAmount)}</strong>
                    </div>
                    
                    <div class="signature">
                        <div class="signature-box">
                            <p>Signature du client</p>
                        </div>
                        <div class="signature-box">
                            <p>Signature du livreur</p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>ETTIJARA ALAAMA SOUSS - Système de Gestion des Livraisons</p>
                        <p>Imprimé le ${new Date().toLocaleDateString('fr-FR')}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }
        
        // Assigner des livraisons
        function assignDeliveries() {
            document.getElementById('assignModal').style.display = 'flex';
        }
        
        // Afficher les livraisons du jour
        function showTodayDeliveries() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFrom').value = today;
            document.getElementById('dateTo').value = today;
            applyFilters();
            displayDeliveries();
            showToast(`Affichage des livraisons du ${today}`, "info");
        }
        
        // Afficher les livraisons retardées
        function showDelayedDeliveries() {
            const today = new Date();
            const delayedDeliveries = deliveries.filter(d => {
                const deliveryDate = new Date(d.deliveryDate || d.createdAt);
                return deliveryDate < today && 
                       (d.status === 'pending' || d.status === 'processing' || d.status === 'in-transit');
            });
            
            if (delayedDeliveries.length === 0) {
                showToast("Aucune livraison retardée", "info");
            } else {
                filteredDeliveries = delayedDeliveries;
                currentPage = 1;
                displayDeliveries();
                showToast(`${delayedDeliveries.length} livraison(s) retardée(s)`, "warning");
            }
        }
        
        // Mettre à jour le statut en masse
        function updateStatusBulk() {
            const selectedDeliveries = filteredDeliveries.filter(d => d.status !== 'delivered' && d.status !== 'cancelled');
            
            if (selectedDeliveries.length === 0) {
                showToast("Aucune livraison à mettre à jour", "info");
                return;
            }
            
            currentAction = 'updateStatusBulk';
            actionData = selectedDeliveries;
            document.getElementById('confirmMessage').textContent = 
                `Mettre à jour le statut de ${selectedDeliveries.length} livraison(s) ?`;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        
        // Imprimer les bordereaux
        function printDeliveryNotes() {
            const selectedDeliveries = filteredDeliveries.filter(d => 
                d.status === 'pending' || d.status === 'processing' || d.status === 'in-transit'
            );
            
            if (selectedDeliveries.length === 0) {
                showToast("Aucun bordereau à imprimer", "info");
                return;
            }
            
            selectedDeliveries.forEach(delivery => {
                printDelivery(delivery.id);
            });
            
            showToast(`${selectedDeliveries.length} bordereau(x) envoyé(s) à l'impression`, "success");
        }
        
        // Enregistrer une livraison
        function saveDelivery() {
            // Récupérer les données du formulaire
            const deliveryId = document.getElementById('deliveryId').value;
            const clientId = document.getElementById('clientSelect').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const depotId = document.getElementById('depotSelect').value;
            const driverId = document.getElementById('driverSelect').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const clientPhone = document.getElementById('clientPhone').value.trim();
            const clientEmail = document.getElementById('clientEmail').value.trim();
            const priority = document.getElementById('priority').value;
            const status = document.getElementById('deliveryStatus').value;
            const notes = document.getElementById('notes').value.trim();
            const paymentStatus = document.getElementById('paymentStatus').value;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            
            // Validation
            if (!clientId || !deliveryDate || !depotId || !deliveryAddress || !clientPhone) {
                showToast("Veuillez remplir tous les champs obligatoires (*)", "error");
                return;
            }
            
            // Récupérer les articles
            const items = [];
            const itemRows = document.querySelectorAll('.item-row');
            let validItems = true;
            
            itemRows.forEach(row => {
                const productId = row.querySelector('.product-select').value;
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                
                if (productId && quantity > 0 && price > 0) {
                    items.push({
                        productId,
                        quantity,
                        price,
                        total: quantity * price
                    });
                } else if (productId || quantity > 0 || price > 0) {
                    validItems = false;
                }
            });
            
            if (!validItems) {
                showToast("Veuillez remplir correctement tous les champs des articles", "error");
                return;
            }
            
            if (items.length === 0) {
                showToast("Veuillez ajouter au moins un article valide", "error");
                return;
            }
            
            // Créer l'objet de données
            const deliveryData = {
                clientId,
                deliveryDate,
                depotId,
                driverId: driverId || null,
                deliveryAddress,
                clientPhone,
                clientEmail: clientEmail || null,
                priority,
                status,
                notes: notes || null,
                paymentStatus,
                totalAmount,
                items,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (isEditMode && deliveryId) {
                    // Mise à jour d'une livraison existante
                    const deliveryRef = database.ref(`deliveries/${deliveryId}`);
                    
                    deliveryRef.update(deliveryData)
                        .then(() => {
                            showToast("Livraison modifiée avec succès!", "success");
                            closeModal();
                        })
                        .catch(error => {
                            console.error("Erreur de mise à jour:", error);
                            showToast("Erreur lors de la modification de la livraison", "error");
                        });
                    
                } else {
                    // Création d'une nouvelle livraison
                    deliveryData.createdAt = new Date().toISOString();
                    deliveryData.deliveryNumber = generateDeliveryNumber();
                    
                    const newDeliveryRef = database.ref('deliveries').push();
                    
                    newDeliveryRef.set(deliveryData)
                        .then(() => {
                            showToast("Livraison créée avec succès!", "success");
                            closeModal();
                        })
                        .catch(error => {
                            console.error("Erreur de création:", error);
                            showToast("Erreur lors de la création de la livraison", "error");
                        });
                }
                
            } catch (error) {
                console.error("Erreur dans saveDelivery:", error);
                showToast("Erreur lors de l'enregistrement de la livraison", "error");
            }
        }
        
        // Générer un numéro de livraison
        function generateDeliveryNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `DLV-${year}${month}${day}-${random}`;
        }
        
        // Assigner un livreur
        function assignDriver() {
            const deliveryId = document.getElementById('assignDelivery').value;
            const driverId = document.getElementById('assignDriver').value;
            const assignNotes = document.getElementById('assignNotes').value.trim();
            const vehicle = document.getElementById('assignVehicle').value;
            
            if (!deliveryId || !driverId) {
                showToast("Veuillez sélectionner une livraison et un livreur", "error");
                return;
            }
            
            const delivery = deliveries.find(d => d.id === deliveryId);
            if (!delivery) {
                showToast("Livraison non trouvée", "error");
                return;
            }
            
            const updateData = {
                driverId,
                updatedAt: new Date().toISOString()
            };
            
            if (assignNotes) {
                updateData.driverNotes = assignNotes;
            }
            
            if (vehicle) {
                updateData.vehicle = vehicle;
            }
            
            // Si la livraison était en attente, la passer en traitement
            if (delivery.status === 'pending') {
                updateData.status = 'processing';
            }
            
            try {
                const deliveryRef = database.ref(`deliveries/${deliveryId}`);
                
                deliveryRef.update(updateData)
                    .then(() => {
                        showToast("Livreur assigné avec succès!", "success");
                        closeAssignModal();
                        
                        // Notifier le livreur (simulation)
                        const driver = drivers.find(d => d.id === driverId);
                        if (driver && driver.phone) {
                            console.log(`SMS envoyé au livreur ${driver.name}: Nouvelle livraison assignée`);
                        }
                    })
                    .catch(error => {
                        console.error("Erreur d'assignation:", error);
                        showToast("Erreur lors de l'assignation du livreur", "error");
                    });
                
            } catch (error) {
                console.error("Erreur dans assignDriver:", error);
                showToast("Erreur lors de l'assignation du livreur", "error");
            }
        }
        
        // Exporter les livraisons
        function exportDeliveries() {
            if (filteredDeliveries.length === 0) {
                showToast("Aucune livraison à exporter", "error");
                return;
            }
            
            // Simple export CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Numéro,Client,Téléphone,Adresse,Livreur,Date,Statut,Montant,Statut Paiement,Notes\n";
            
            filteredDeliveries.forEach(delivery => {
                const row = [
                    delivery.deliveryNumber || delivery.id.substring(0, 8),
                    getClientName(delivery.clientId),
                    delivery.clientPhone || '',
                    delivery.deliveryAddress || '',
                    getDriverName(delivery.driverId),
                    formatDate(delivery.deliveryDate),
                    getStatusName(delivery.status),
                    formatCurrency(delivery.totalAmount),
                    delivery.paymentStatus === 'paid' ? 'Payé' : delivery.paymentStatus === 'partial' ? 'Partiel' : 'En attente',
                    delivery.notes || ''
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + "\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `livraisons_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`${filteredDeliveries.length} livraison(s) exportée(s) avec succès`, "success");
        }
        
        // Fermer les modals
        function closeModal() {
            document.getElementById('deliveryModal').style.display = 'none';
        }
        
        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function closeTrackModal() {
            document.getElementById('trackModal').style.display = 'none';
        }
        
        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
            document.getElementById('assignForm').reset();
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            currentAction = null;
            actionData = null;
        }
        
        // Initialiser l'application
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier la connexion Firebase et charger les données
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", function(snap) {
                if (snap.val() === true) {
                    loadInitialData();
                }
            });
            
            // Événements de recherche/filtre
            document.getElementById('searchInput').addEventListener('input', function() {
                applyFilters();
                displayDeliveries();
            });
            
            document.getElementById('statusFilter').addEventListener('change', function() {
                applyFilters();
                displayDeliveries();
            });
            
            document.getElementById('driverFilter').addEventListener('change', function() {
                applyFilters();
                displayDeliveries();
            });
            
            document.getElementById('dateFrom').addEventListener('change', function() {
                applyFilters();
                displayDeliveries();
            });
            
            document.getElementById('dateTo').addEventListener('change', function() {
                applyFilters();
                displayDeliveries();
            });
            
            document.getElementById('resetFiltersBtn').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = 'all';
                document.getElementById('driverFilter').value = 'all';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                applyFilters();
                displayDeliveries();
            });
            
            // Événements modals
            document.getElementById('addDeliveryBtn').addEventListener('click', openAddModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('saveDeliveryBtn').addEventListener('click', saveDelivery);
            
            document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
            document.getElementById('printDetailBtn').addEventListener('click', function() {
                if (selectedDeliveryId) {
                    printDelivery(selectedDeliveryId);
                }
            });
            document.getElementById('editDeliveryBtn').addEventListener('click', function() {
                if (selectedDeliveryId) {
                    closeDetailModal();
                    setTimeout(() => editDelivery(selectedDeliveryId), 300);
                }
            });
            
            document.getElementById('closeTrackModal').addEventListener('click', closeTrackModal);
            document.getElementById('closeTrackBtn').addEventListener('click', closeTrackModal);
            document.getElementById('refreshTrackBtn').addEventListener('click', function() {
                showToast("Position actualisée", "info");
            });
            
            document.getElementById('closeAssignModal').addEventListener('click', closeAssignModal);
            document.getElementById('cancelAssignBtn').addEventListener('click', closeAssignModal);
            document.getElementById('saveAssignBtn').addEventListener('click', assignDriver);
            
            document.getElementById('closeConfirmModal').addEventListener('click', closeConfirmModal);
            document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirmActionBtn').addEventListener('click', function() {
                if (currentAction === 'updateStatusBulk' && actionData) {
                    // Mettre à jour le statut des livraisons sélectionnées
                    const updates = {};
                    actionData.forEach(delivery => {
                        let newStatus = 'processing';
                        if (delivery.status === 'processing') newStatus = 'in-transit';
                        if (delivery.status === 'in-transit') newStatus = 'delivered';
                        
                        updates[`deliveries/${delivery.id}/status`] = newStatus;
                        updates[`deliveries/${delivery.id}/updatedAt`] = new Date().toISOString();
                    });
                    
                    database.ref().update(updates)
                        .then(() => {
                            showToast(`${actionData.length} livraison(s) mise(s) à jour`, "success");
                            closeConfirmModal();
                        })
                        .catch(error => {
                            console.error("Erreur de mise à jour:", error);
                            showToast("Erreur lors de la mise à jour des statuts", "error");
                        });
                }
            });
            
            // Export
            document.getElementById('exportBtn').addEventListener('click', exportDeliveries);
            
            // Fermer modal en cliquant en dehors
            window.addEventListener('click', function(event) {
                const deliveryModal = document.getElementById('deliveryModal');
                const detailModal = document.getElementById('detailModal');
                const trackModal = document.getElementById('trackModal');
                const assignModal = document.getElementById('assignModal');
                const confirmModal = document.getElementById('confirmModal');
                
                if (event.target === deliveryModal) closeModal();
                if (event.target === detailModal) closeDetailModal();
                if (event.target === trackModal) closeTrackModal();
                if (event.target === assignModal) closeAssignModal();
                if (event.target === confirmModal) closeConfirmModal();
            });
            
            // Soumission des formulaires avec Entrée
            document.getElementById('deliveryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveDelivery();
            });
            
            document.getElementById('assignForm').addEventListener('submit', function(e) {
                e.preventDefault();
                assignDriver();
            });
            
            // Rafraîchir automatiquement toutes les 30 secondes
            setInterval(() => {
                if (deliveries.length === 0) {
                    loadDeliveries();
                }
            }, 30000);
        });
    </script>
</body>
</html>
